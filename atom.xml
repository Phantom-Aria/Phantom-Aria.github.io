<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>我的小破站</title>
  
  
  <link href="http://www.shelven.com/atom.xml" rel="self"/>
  
  <link href="http://www.shelven.com/"/>
  <updated>2023-10-23T16:11:19.000Z</updated>
  <id>http://www.shelven.com/</id>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>记一次PostgreSQL漏洞引起的kdevtmpfsi挖矿病毒攻击</title>
    <link href="http://www.shelven.com/2023/10/24/a.html"/>
    <id>http://www.shelven.com/2023/10/24/a.html</id>
    <published>2023-10-23T16:07:37.000Z</published>
    <updated>2023-10-23T16:11:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>事情是这样的，为了存放qq机器人的用户数据，昨天我下载了PostgreSQL的docker镜像，当时docker运行一切正常。然后今天下午3点过，服务器商那边发了个邮件提醒服务器存在恶意文件，一连发了三条：</p><span id="more"></span><p><img src="https://www.shelven.com/tuchuang/20231023/1.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>好家伙，赶紧ssh登录服务器，一眼就看到cpu被干爆了（直接100%占用，还能ssh上也挺神奇的）。</p><h2 id="1-分析排查"><a href="#1-分析排查" class="headerlink" title="1. 分析排查"></a>1. 分析排查</h2><div class="story post-story"><p>首先用<code>top</code>看看什么程序占用了cpu资源：</p><p><img src="https://www.shelven.com/tuchuang/20231023/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>一个名为<code>kdevtmpfsi</code>的进程占用了几乎所有cpu算力资源，想都不用想，这肯定是一个挖矿病毒了，赶紧百度查了下确实如此：</p><p><a href="https://worktile.com/kb/ask/36677.html">centos病毒有哪些 • Worktile社区</a></p><p>还好这个病毒并不会破坏计算机内的文件，只是占用你的CPU。这个病毒还有一个<strong>守护进程</strong>名字是<code>kinsing</code> 。</p><p>服务器商提醒我恶意文件来自于<code>/tmp/kdevtmpfsi</code>、<code>/var/tmp/kdevtmpfsi</code>和<code>/tmp/kinsing</code>，然而我在主机相应路径下并没有找到对应的文件，要么就两种情况，病毒在执行文件后删除了原文件，或者这个病毒在docker文件中。</p><p>直接在进程中查这两个程序对应的PID：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -aux | grep kinsing</span><br><span class="line">ps -aux | grep kdevtmpfsi</span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20231023/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后直接kill掉（先kill守护进程<code>kinsing</code>，再kill挖矿病毒<code>kdevtmpfsi</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 7842</span><br><span class="line"><span class="built_in">kill</span> -9 12201</span><br></pre></td></tr></table></figure><p>直接kill是因为现在需要先把CPU资源暂时释放出来，防止你在登录界面卡死。这种病毒一般会隔一段时间重新运行，因此我们需要找到问题的根源在哪。</p><p>从根目录开始找这两个文件的位置，并删除：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">find / -name kdevtmpfsi</span><br><span class="line">/var/lib/docker/overlay2/cb454dcc5c6592a9389757846a15e41d8bf6d68a7480f59aab579bd307baaeca/diff/var/tmp/kdevtmpfsi</span><br><span class="line">/var/lib/docker/overlay2/cb454dcc5c6592a9389757846a15e41d8bf6d68a7480f59aab579bd307baaeca/merged/var/tmp/kdevtmpfsi</span><br><span class="line"></span><br><span class="line">find / -name kinsing</span><br><span class="line">/var/lib/docker/overlay2/cb454dcc5c6592a9389757846a15e41d8bf6d68a7480f59aab579bd307baaeca/diff/tmp/kinsing</span><br><span class="line">/var/lib/docker/overlay2/cb454dcc5c6592a9389757846a15e41d8bf6d68a7480f59aab579bd307baaeca/merged/tmp/kinsing</span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20231023/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我这里仍然不清楚为什么搜到两个文件却只能删一个，可能在删除的时候已经引起病毒脚本删除另一个文件了？总之能找到文件就删，一个不要放过。</p><p>接下来检查是否有异常启动的定时任务（因为这个病毒会定时重启，所以要考虑这种可能）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br><span class="line"></span><br><span class="line">*/5 * * * * flock -xn /tmp/stargate.lock -c <span class="string">&#x27;/usr/local/qcloud/stargate/admin/start.sh &gt; /dev/null 2&gt;&amp;1 &amp;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 后来发现这个是腾讯云的云监控控制台设置的定时任务，删了就删了</span></span><br></pre></td></tr></table></figure><p>这里能看到有一个定时任务，我印象里没有制定过定时任务，所以直接将账户的定时任务取消（<strong>谨慎！不可恢复，看到来自别的ip的可疑定时任务，建议用crontab -e进入配置界面，删除异常定时任务，wq保存退出</strong>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -r<span class="comment"># 不建议这样做！这里只是记录我的操作</span></span><br></pre></td></tr></table></figure><p>还有一种方法可以查所有账户的定时任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd | <span class="built_in">cut</span> -f 1 -d : |xargs -I &#123;&#125; crontab -l -u &#123;&#125;</span><br></pre></td></tr></table></figure><p>这里相当于将所有用户名提取出来，执行<code>crontab -l</code>，同样是发现异常定时任务的话删除。</p></div><h2 id="2-病毒溯源"><a href="#2-病毒溯源" class="headerlink" title="2. 病毒溯源"></a>2. 病毒溯源</h2><div class="story post-story"><p>在一边删除病毒的同时，我这里一边在溯源病毒的来源&#x3D; &#x3D;</p><p>首先看看是否有人用ssh黑入root账户：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less /var/log/secure|grep <span class="string">&#x27;Accepted&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20231023/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然而ip登录地址全是我常用的ip地址，说明不是通过ssh登录root账号注入的病毒。</p><p>再看看TCP连接和监听端口是否运行可疑程序：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -anltp</span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20231023/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>并没有任何可疑程序的运行。</p><p>这个时候我发现这些病毒文件<strong>毫无例外</strong>来自于<code>docker</code>的<code>overlay2</code>文件系统，想着最近用过的只有<code>PostgreSQL</code>容器，内鬼八成是它了。</p><p>查看我的本地docker镜像库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line"></span><br><span class="line">REPOSITORY      TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">postgres        latest    f7d9a0d4223b   5 weeks ago    417MB</span><br><span class="line">xzhouqd/qsign   8.9.63    153680998c24   3 months ago   558MB</span><br><span class="line">hello-world     latest    9c7a54a9a43c   5 months ago   13.3kB</span><br></pre></td></tr></table></figure><p>前面查到的<code>kinsing</code>和<code>kdevtmpfsi</code>文件来自于以下文件夹：</p><p><code>/var/lib/docker/overlay2/cb454dcc5c6592a9389757846a15e41d8bf6d68a7480f59aab579bd307baaeca</code></p><p>问题来了，怎么查看后面这一长串哈希值文件对应哪个镜像？</p><p>查看现在正在运行的docker镜像：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a </span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20231023/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>查看可疑的postgresql镜像元数据：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 27d1f4378405</span><br></pre></td></tr></table></figure><p>返回的是一个json格式的元数据，也可以参数-f获得更具体的key：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;.GraphDriver.Data&#125;&#125;&#x27;</span> 27d1f4378405</span><br></pre></td></tr></table></figure><p>好家伙，在得到的postgresql镜像元数据中可以找到上面那个一长串哈希值文件夹，真相大白了：<strong>病毒就是从postgresql容器注入的</strong>。</p><p>找到病毒起源后，那就是停止删除一条龙，拜拜了您内~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker stop pgsql<span class="comment"># 停止实例</span></span><br><span class="line">docker <span class="built_in">rm</span> pgsql<span class="comment"># 删除实例</span></span><br><span class="line">docker rmi postgres<span class="comment"># 删除本地仓库</span></span><br></pre></td></tr></table></figure><p>其实在上面删除病毒源文件和进程后，病毒就已经不再重新运行了。此时我的数据库已经因为不明原因被破坏，且查到了病毒来源的docker镜像，就顺便删了&#x3D; &#x3D;</p></div><h2 id="3-复盘攻击原因"><a href="#3-复盘攻击原因" class="headerlink" title="3. 复盘攻击原因"></a>3. 复盘攻击原因</h2><div class="story post-story"><p>一开始我以为这个病毒是通过端口扫描工具，找到端口漏洞后注入病毒的，然而并不是。</p><p>在找到<code>kinsing</code>和<code>kdevtmpfsi</code>两个文件的时候，我还在同一个文件夹中找到<code>curl</code>文件，基本上可以确定这个挖矿病毒是通过<code>curl</code>命令不断下载病毒并执行的。容器一开始是不存在问题的，病毒为何在两天后突然爆发？</p><p>从一开始服务器商提醒有恶意文件开始，那个时候并没有在对应的位置发现有恶意文件，而docker中可以找到，也可以说明<strong>是docker被入侵导致的注入病毒程序</strong>。可惜docker被我删除了，无法进一步看到病毒在我的postgresql容器中具体做了哪些文件的改动。</p><p>复盘前两天的操作，我在运行postgresql的docker镜像后，为了方便远程连接数据库以及可视化操作，我开放了postgresql的默认端口，并改为了所有ip均可接入（0.0.0.0&#x2F;0）。postgresql的默认用户是<code>postgres</code>，当然，我为了安全起见更改了密码（纯字母和下划线），不限制ip段的接入，可能给了黑客广撒网的机会，暴力攻破我的密码并下载了病毒（postgres账户下）。<strong>由于我的postgresql是在容器中运行的</strong>，所以病毒能在docker的<code>overlay2</code>文件系统中找到，它不能改变我宿主机的文件系统，作为一个挖矿病毒，只要能用上我宿主机的算力即可。</p><p>以下这篇文章支持我的假想，具体说了黑客如何利用PostgreSQL的远程代码执行漏洞（RCE）攻击数据库服务器进行加密货币挖矿，一旦攻破数据库账户，就可以用PostgreSQL的“复制程序”功能下载并启动挖矿脚本：</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzNDYxOTA1NA==&mid=2247507579&idx=3&sn=89c43bc8a22c9882335604af7808abdd&chksm=fa9368bacde4e1acbf59ad8dcf3cfb88e311e40b94d7c618a20a16626466a90e8a710e1049e1&scene=27">PGMiner：利用PostgreSQL漏洞的新的加密货币挖矿僵尸网络 (qq.com)</a></p><p>还是要多注意自己的数据库安全，<strong>设置复杂一些的密码，并且限制ip段接入</strong>才是避免黑客攻击的最好方法。还有经过这次攻击后，我也顺便改了服务器的登录密码，关闭了一些用不到的端口，小心驶得万年船~</p><p>这次入侵的病毒文件我也下载到本地了，本来想了解一下是怎么实现的，可惜是二进制文件，没办法就去google了一下，果然有做网安的大佬详细解释了<code>kinsing</code>作为守护进程是如何运作的，以及挖矿病毒<code>kdevtmpfsi</code>的详细运作方式：</p><p><a href="https://sysdig.com/blog/zoom-into-kinsing-kdevtmpfsi/">Learn the Attack Patterns of Kinsing with Sysdig</a></p><p>因为我是docker被入侵，直接删了出问题的镜像一了百了，<strong>如果你是linux服务器被入侵，这里有几个细节值得注意</strong>：</p><p><code>kinsing</code>会添加定时任务，一定要删除（我应该是docker中被添加了，所以宿主机中找不到）；这个守护进程会检查<code>kdevtmpfsi</code>进程的状态，若被删除会重启，所以要先删除这个守护进程；并且这个守护进程会读取系统中的SSH密钥，通过密钥横向转移到你其他机子上：</p><p><img src="https://www.shelven.com/tuchuang/20231023/8.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231023/8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>所以最好再看看自己的密钥中是否有可疑的数据，防止黑客留下后门。</p><p>至于这个<code>kdevtmpfsi</code>挖矿病毒如何分配你的系统资源，何如与矿池通信，都可以在上面的文章中看到。既然是个linux二进制可执行文件，反汇编拿到源码也不是不行，现在看看病毒原理就好，其他的就不整了。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;事情是这样的，为了存放qq机器人的用户数据，昨天我下载了PostgreSQL的docker镜像，当时docker运行一切正常。然后今天下午3点过，服务器商那边发了个邮件提醒服务器存在恶意文件，一连发了三条：&lt;/p&gt;</summary>
    
    
    
    <category term="网络相关" scheme="http://www.shelven.com/categories/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3/"/>
    
    
    <category term="PostgreSQL" scheme="http://www.shelven.com/tags/PostgreSQL/"/>
    
    <category term="kdevtmpfsi" scheme="http://www.shelven.com/tags/kdevtmpfsi/"/>
    
    <category term="kinsing" scheme="http://www.shelven.com/tags/kinsing/"/>
    
  </entry>
  
  <entry>
    <title>基于近缘物种参考基因组的染色体水平组装和注释</title>
    <link href="http://www.shelven.com/2023/10/19/a.html"/>
    <id>http://www.shelven.com/2023/10/19/a.html</id>
    <published>2023-10-19T07:08:13.000Z</published>
    <updated>2023-10-19T07:20:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>有的时候存在这种情况：我手上有两个近缘植物的基因组测序数据，这两个物种可能没有人做过，或者别人做过但是没有提供参考基因组。而课题组因为经费不足，只测了一个物种的Hi-C<del>（嗯，说的就是我）</del>，那如何以组装的基因组为参考，把另一个近缘物种基因组也组装到染色体级别呢？</p><p>记录一下基于近缘物种参考基因组的染色体水平组装和注释，用到的软件是<code>RagTag</code>以及配套的<code>Liftoff</code>。</p><span id="more"></span><h2 id="1-RagTag"><a href="#1-RagTag" class="headerlink" title="1. RagTag"></a>1. RagTag</h2><div class="story post-story"><p>RagTag是一个纯python编写的软件工具集（但并不是所有功能都是python实现的，比如<code>minimap2/Nucmer/unimap</code>是通过<code>subprocess</code>模块调用命令行使用，产生子进程实现的），用于将组装的contig级别的基因组提高到染色体级别。具体来说可以做到以下三个功能：</p><ul><li>基于同源的组装错误纠正</li><li>基于同源的scaffold组装以及修补（也就是填补gap）</li><li>scaffold合并（不同方式得到的scaffold合并）</li></ul><p>同时官方提供了处理常见基因组组装文件格式的命令行实用程序，也是纯python编写的，都在<code>file utilities</code>文件夹中，主要是实现以下几种功能：</p><ul><li><p><code>agp2fa</code>： 将<code>AGP</code>文件转换成<code>fasta</code>文件。AGP文件是描述<strong>contig</strong>如何构建成<strong>scaffold</strong>的，可以看NCBI对该文件类型的描述：<a href="https://www.ncbi.nlm.nih.gov/assembly/agp/AGP_Specification/">AGP Specification v2.1 (nih.gov)</a></p></li><li><p><code>agpcheck</code>： 验证<code>AGP</code>格式是否正确</p></li><li><p><code>asmstats</code>： 统计assembly序列的信息</p></li><li><p><code>splitasm</code>： 按照gap分隔assembly序列，为后续处理提供<code>AGP</code>文件</p></li><li><p><code>delta2paf</code>： 转化<code>delta</code>文件到<code>PAF</code>文件。<a href="https://mummer.sourceforge.net/manual/#nucmer">delta</a>文件是<code>NUCmer</code>基因组比对软件（NUCleotide MUMmer）产生的结果文件，作用是记录每个联配的坐标，每个联配中的插入和缺失的距离。<a href="https://lh3.github.io/minimap2/minimap2.html">PAF</a>文件也是类似描述两组序列之间近似的联配位置的文件，是<code>minimap2</code>的输出文件。点击蓝色字体可以看两种格式的具体样式。</p></li><li><p><code>paf2delta</code>： 和上面相反</p></li><li><p><code>updategff</code>： 根据RagTag的AGP文件更新gff文件（<strong>不是得到最终基因组的gff文件</strong>，要想得到基因组的gff文件，作者推荐用配套的软件<a href="https://github.com/agshumate/Liftoff">Liftoff</a>）</p></li></ul><p>RagTag运行流程主要分4步：</p><p><img src="https://www.shelven.com/tuchuang/20231018/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231018/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>官方仓库：<a href="https://github.com/malonge/RagTag">RagTag&#x2F;ragtag_correct.py at master · malonge&#x2F;RagTag (github.com)</a></p><h3 id="1-1-correct"><a href="#1-1-correct" class="headerlink" title="1.1 correct"></a>1.1 correct</h3><p>RagTag的校正模块，使用参考基因组来识别和校正基因组中潜在的错误组装。这一步直会将可能存在错误组装的序列打断，<strong>不会增加或者减少原序列大小</strong>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">usage: ragtag.py correct &lt;reference.fa&gt; &lt;query.fa&gt;</span><br><span class="line"></span><br><span class="line">Homology-based misassembly correction: Correct sequences in &#x27;query.fa&#x27; by comparing them to sequences in &#x27;reference.fa&#x27;&gt;</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  &lt;reference.fa&gt;        reference fasta file (uncompressed or bgzipped)</span><br><span class="line">  &lt;query.fa&gt;            query fasta file (uncompressed or bgzipped)</span><br></pre></td></tr></table></figure><p>详细参数<code>-h</code>可以查看，需要注意<code>reference.fa</code>是参考基因组（同一个物种或者近缘物种），<code>query.fa</code>是我们需要组装的contigs（contigs是通过二代+三代测序下机数据组装的）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#SBATCH -n 5</span></span><br><span class="line"><span class="comment">#SBATCH -t 7200</span></span><br><span class="line"></span><br><span class="line">ragtag.py correct ../../Genome/Ap.fa Av.fasta -t 5</span><br></pre></td></tr></table></figure><p>得到的结果文件：</p><p>├── ragtag_output<br>│   ├── ragtag.correct.agp<br>│   ├── ragtag.correct.asm.paf<br>│   ├── ragtag.correct.asm.paf.log<br>│   ├── ragtag.correct.err<br>│   ├── ragtag.correct.fasta</p><p>可以看到contigs从原来的38条被切断成了519条：</p><p><img src="https://www.shelven.com/tuchuang/20231018/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231018/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="1-2-scaffold"><a href="#1-2-scaffold" class="headerlink" title="1.2 scaffold"></a>1.2 scaffold</h3><p>RagTag的脚手架（scaffold）组装模块，将组装的草稿（draft assembly）序列排序和重定向为更长的序列。使用上一步纠错后的contigs比对参考基因组序列，contigs之间的gap使用N（默认100个）填充，同样这一步不会改变原来的序列。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">usage: ragtag.py scaffold &lt;reference.fa&gt; &lt;query.fa&gt;</span><br><span class="line"></span><br><span class="line">Homology-based assembly scaffolding: Order and orient sequences in &#x27;query.fa&#x27; by comparing them to sequences in &#x27;reference.fa&#x27;</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  &lt;reference.fa&gt;       reference fasta file (uncompressed or bgzipped)</span><br><span class="line">  &lt;query.fa&gt;           query fasta file (uncompressed or bgzipped)</span><br></pre></td></tr></table></figure><p>详细参数<code>-h</code>可以查看，<code>reference.fa</code>是参考基因组，<code>query.fa</code>是上一步纠错后的序列。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#SBATCH -n 5</span></span><br><span class="line"><span class="comment">#SBATCH -t 7200</span></span><br><span class="line"></span><br><span class="line">ragtag.py scaffold ../../Genome/Ap.fa ragtag_output/ragtag.correct.fasta -t 5 -C -u</span><br></pre></td></tr></table></figure><p><code>-C</code>这个参数可以把没有比对上的序列都放在<code>chr0</code>这条假想的染色体上。</p><p>得到的结果文件：</p><p>├── ragtag_output<br>│   ├── ragtag.scaffold.agp<br>│   ├── ragtag.scaffold.asm.paf<br>│   ├── ragtag.scaffold.asm.paf.log<br>│   ├── ragtag.scaffold.confidence.txt<br>│   ├── ragtag.scaffold.err<br>│   ├── ragtag.scaffold.fasta<br>│   └── ragtag.scaffold.stats</p><p>统计下各scaffold序列的长度：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ seqkit fx2tab --length --name --header-line ragtag_output/ragtag.scaffold.fasta</span><br><span class="line"></span><br><span class="line">#name   length</span><br><span class="line">LG01_RagTag     20785546</span><br><span class="line">LG02_RagTag     20079267</span><br><span class="line">LG03_RagTag     17989129</span><br><span class="line">LG04_RagTag     19176014</span><br><span class="line">LG05_RagTag     22754901</span><br><span class="line">LG06_RagTag     24973536</span><br><span class="line">LG07_RagTag     20015323</span><br><span class="line">LG08_RagTag     20197945</span><br><span class="line">LG09_RagTag     17850387</span><br><span class="line">LG10_RagTag     23023498</span><br><span class="line">LG11_RagTag     18329485</span><br><span class="line">Chr0_RagTag     5764532</span><br></pre></td></tr></table></figure><p>因为我的参考基因组是11条染色体，这里大部分contig都能比对上，长度也正常，剩下的contig都在<code>Chr0_RagTag</code>这条序列。</p><p><code>ragtag.scaffold.stats</code>这个文件可以查看比对上scaffold上的contig信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> ragtag.scaffold.stats | column -t -s $<span class="string">&#x27;\t&#x27;</span></span><br><span class="line"></span><br><span class="line">placed_sequences  placed_bp  unplaced_sequences  unplaced_bp  gap_bp  gap_sequences</span><br><span class="line">90                225167131  429                 5721732      50700   507</span><br></pre></td></tr></table></figure><p>第一步拆分的519条contigs有90条可以比对上，429条未比对上参考基因组，但是这429条序列总长度却只有5721732 bp。根据上面的信息也可以知道，产生的507个gap中有428个在<code>Chr0_RagTag</code>这条序列中（unplaced_sequences都在这），真正在染色体上的gap数量是79，可以写个脚本统计一下各条染色体上gap数量：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># count_gap.py 作用是统计这一步产生的各scaffold上的gap数量</span></span><br><span class="line"></span><br><span class="line">sequence = &#123;&#125;   <span class="comment"># 用于存储序列信息的字典</span></span><br><span class="line">gap = &#123;&#125;    <span class="comment"># 用于存储序列gap信息的字典</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store_sequence</span>(<span class="params">file_name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        header = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        seq = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> header:</span><br><span class="line">                    sequence[header] = seq</span><br><span class="line">                header = line[<span class="number">1</span>:]</span><br><span class="line">                seq = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                seq += line</span><br><span class="line">        sequence[header] = seq  <span class="comment"># 加入最后一条序列</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_gap</span>():</span><br><span class="line">    <span class="keyword">for</span> header <span class="keyword">in</span> sequence:</span><br><span class="line">        seq = sequence[header]</span><br><span class="line">        count = seq.count(<span class="string">&#x27;N&#x27;</span>)/<span class="number">100</span></span><br><span class="line">        gap[header] = count</span><br><span class="line"></span><br><span class="line">store_sequence(<span class="string">&#x27;ragtag.scaffold.fasta&#x27;</span>)</span><br><span class="line">count_gap()</span><br><span class="line"><span class="keyword">for</span> header <span class="keyword">in</span> gap:</span><br><span class="line">    header = header</span><br><span class="line">    counts = gap[header]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;scaffold：<span class="subst">&#123;header&#125;</span>\tgap数量:<span class="subst">&#123;counts&#125;</span>&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">scaffold：LG01_RagTag   gap数量:21.0</span></span><br><span class="line"><span class="string">scaffold：LG02_RagTag   gap数量:5.0</span></span><br><span class="line"><span class="string">scaffold：LG03_RagTag   gap数量:5.0</span></span><br><span class="line"><span class="string">scaffold：LG04_RagTag   gap数量:6.0</span></span><br><span class="line"><span class="string">scaffold：LG05_RagTag   gap数量:7.0</span></span><br><span class="line"><span class="string">scaffold：LG06_RagTag   gap数量:0.0</span></span><br><span class="line"><span class="string">scaffold：LG07_RagTag   gap数量:7.0</span></span><br><span class="line"><span class="string">scaffold：LG08_RagTag   gap数量:2.0</span></span><br><span class="line"><span class="string">scaffold：LG09_RagTag   gap数量:4.0</span></span><br><span class="line"><span class="string">scaffold：LG10_RagTag   gap数量:12.0</span></span><br><span class="line"><span class="string">scaffold：LG11_RagTag   gap数量:10.0</span></span><br><span class="line"><span class="string">scaffold：Chr0_RagTag   gap数量:428.0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>可以对上gap数量，没有问题。</p><h3 id="1-3-patch"><a href="#1-3-patch" class="headerlink" title="1.3 patch"></a>1.3 patch</h3><p>RagTag的填补模块，关于这个模块，国内的各方帖子都说是填补上一步骤产生的有gap的scaffold序列。<strong>对，但是不完全对。</strong><code>patch</code>和<code>scaffold</code>是两个独立的模块，<strong>且两者都可以独立完成scaffolding的过程</strong>。</p><p><code>scaffold</code>模块中，我们以参考基因组序列为基准，将contig定向和排序成为scaffold，整个过程没有发生contig序列的增加或者减少。</p><p><code>patch</code>模块和gap填补软件类似，一般情况下是用三代长读长序列（ONT Ultra-long reads这种）填补gap，<strong>但是这里用的是assembly序列</strong>，且填补前后序列会发生变化。<code>patch</code>模块有两种运行模式：</p><blockquote><p><code>--fill-only</code> 只填补已存在的gap，就和传统的gap填补工具类似</p><p><code>--join-only</code> 不填补已存在的gap， 会对contig重新进行定向和排序，这会产生新的gap，且填补的是<strong>新产生的gap</strong></p></blockquote><p>fill模式的原理如下：</p><p><img src="https://www.shelven.com/tuchuang/20231018/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231018/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>默认情况下，两种运行模式都会进行，可以看到填补的基础是需要另一条同一个物种的<strong>assembly序列</strong>。</p><p>如果你前一步跑了<code>scaffold</code>模块，仅仅只需要填补该过程产生的gap，那麽只要以<code>--fill-only</code>的模式运行<code>patch</code>模块即可。</p><p>因为我没有其他assembly序列，所以跑<code>scaffold</code>模块就够了，为了测试一下这个模块，我又用原始assembly序列跑了一遍：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">usage: ragtag.py patch &lt;target.fa&gt; &lt;query.fa&gt;</span><br><span class="line"></span><br><span class="line">Homology-based assembly patching: Make continuous joins and fill gaps in &#x27;target.fa&#x27; using sequences from &#x27;query.fa&#x27;</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  &lt;target.fa&gt;          target fasta file (uncompressed or bgzipped)</span><br><span class="line">  &lt;query.fa&gt;           query fasta file (uncompressed or bgzipped)</span><br></pre></td></tr></table></figure><p>详细参数<code>-h</code>可以查看，这里<code>target.fa</code>是上一步产生的scaffold序列，<code>query.fa</code>是我一开始跑correct模块的原始assembly序列。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#SBATCH -n 5</span></span><br><span class="line"><span class="comment">#SBATCH -t 7200</span></span><br><span class="line"></span><br><span class="line">ragtag.py patch ragtag_output/ragtag.scaffold.fasta Av.fasta -t 5 -u -i 0.05</span><br></pre></td></tr></table></figure><p>得到的结果文件：</p><p>├── ragtag_output<br>│   ├── ragtag.patch.agp<br>│   ├── ragtag.patch.asm.delta<br>│   ├── ragtag.patch.asm.delta.log<br>│   ├── ragtag.patch.asm.paf<br>│   ├── ragtag.patch.comps.fasta<br>│   ├── ragtag.patch.comps.fasta.fai<br>│   ├── ragtag.patch.ctg.agp<br>│   ├── ragtag.patch.ctg.fasta<br>│   ├── ragtag.patch.ctg.fasta.fai<br>│   ├── ragtag.patch.err<br>│   ├── ragtag.patch.fasta<br>│   ├── ragtag.patch.rename.agp<br>│   ├── ragtag.patch.rename.fasta<br>│   ├── ragtag.patch.rename.fasta.fai</p><p>这里结果文件较多，有必要说一下几个文件的作用（来自官网）：</p><blockquote><table><thead><tr><th>file name</th><th>Description</th></tr></thead><tbody><tr><td><code>ragtag.patch.agp</code></td><td>The final AGP file defining how <code>ragtag.patch.fasta</code> is built</td></tr><tr><td><code>ragtag.patch.asm.*</code></td><td>Assembly alignment files</td></tr><tr><td><code>ragtag.patch.comps.fasta</code></td><td>The split target assembly and the renamed query assembly combined into one FASTA file. This file contains all components in <code>ragtag.patch.agp</code></td></tr><tr><td><code>ragtag.patch.ctg.agp</code></td><td>An AGP file defining how the target assembly was split at gaps</td></tr><tr><td><code>ragtag.patch.ctg.fasta</code></td><td>The target assembly split at gaps</td></tr><tr><td><code>ragtag.patch.err</code></td><td>Standard error logging for all external RagTag commands</td></tr><tr><td><code>ragtag.patch.fasta</code></td><td>The final FASTA file containing the patched assembly</td></tr><tr><td><code>ragtag.patch.rename.agp</code></td><td>An AGP file defining the new names for query sequences</td></tr><tr><td><code>ragtag.patch.rename.fasta</code></td><td>A FASTA file with the original query sequence, but with new names</td></tr></tbody></table></blockquote><p>我们关注的是最后的结果文件<code>ragtag.patch.fasta</code>。这一步运行的时间很长，多长呢？和前面两个步骤放一起感受一下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sacct --format=JobName,Start,End,Elapsed,NCPUS</span><br><span class="line"></span><br><span class="line">   JobName               Start                 End    Elapsed      NCPUS </span><br><span class="line">---------- ------------------- ------------------- ---------- ---------- </span><br><span class="line">   correct 2023-10-18T14:41:49 2023-10-18T14:44:50   00:03:01          5 </span><br><span class="line">  scaffold 2023-10-18T15:02:21 2023-10-18T15:03:13   00:00:52          5 </span><br><span class="line">     patch 2023-10-18T15:31:30 2023-10-18T17:25:49   01:54:19          5  </span><br><span class="line">     </span><br><span class="line"># 已隐去多余信息</span><br></pre></td></tr></table></figure><p>前两步分分钟完成，<code>patch</code>这一步需要花2小时。</p><p>还有一点需要注意，如果用来填补gap的序列是<strong>T2T</strong>或者<strong>近似T2T</strong>的序列，需要考虑到它们包含大量的高度重复的序列，RagTag的<code>pactch</code>模块是通过query contig和至少两个target contig之间的唯一比对（unique alignments），来确定潜在的填补区域。大量的重复区域会导致唯一比对出现大量的gap，从而误判这个区域不是潜在的填补区域。</p><p>作者提出的建议是加入参数<code>-i</code>并调整这个值，来控制最大对齐中断长度（maximum alignment break length），可以更大限度容忍唯一比对中出现的长gap区域。或者直接将query序列重复区域打断（也就消除了重复序列导致的非唯一比对）。</p><p>看了下结果文件，几乎和<code>scaffold</code>模块一样，就填补了几个gap（因为我没有其他assembly序列），而且对<code>Chr0_RagTag</code>这条多余contig合在一起的序列，填补gap完全没意义，于我而言这步结果意义不大且更不可信，只是为了测试这个模块。主要还是用上一步的<code>ragtag.scaffold.fasta</code>文件。</p><h3 id="1-4-merge"><a href="#1-4-merge" class="headerlink" title="1.4 merge"></a>1.4 merge</h3><p>RagTag的合并scaffolding结果的模块，起到改进scaffolding结果的作用。</p><p>因为scaffolding过程可以使用多种方式，比如使用Hi-C技术、Bionano的光学图谱技术、遗传图谱等等，而<code>merge</code>模块的作用是将各种技术的scaffolding结果（AGP格式）合并到一起，提高基因组组装草图的精度。</p><p>这一步我没有Hi-C数据做测试了，就放一下官方的使用方法，用到再做详解：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">usage: ragtag.py merge &lt;asm.fa&gt; &lt;scf1.agp&gt; &lt;scf2.agp&gt; [...]</span><br><span class="line"></span><br><span class="line">Scaffold merging: derive a consensus scaffolding solution by reconciling distinct scaffoldings of &#x27;asm.fa&#x27;</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  &lt;asm.fasta&gt;           assembly fasta file (uncompressed or bgzipped)</span><br><span class="line">  &lt;scf1.agp&gt; &lt;scf2.agp&gt; [...]</span><br><span class="line">                        scaffolding AGP files</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br></pre></td></tr></table></figure></div><h2 id="2-Liftoff"><a href="#2-Liftoff" class="headerlink" title="2. Liftoff"></a>2. Liftoff</h2><div class="story post-story"><p>Liftoff软件的作用是将同一或者近缘物种的基因组注释映射到组装的基因组中。输入文件很简单，一个组装的基因组，一个参考基因组以及注释文件即可。</p><p>这款软件是使用<code>Minimap2</code>将基因序列从一个基因组比对到另一个基因组（不是基因组之间的比对），每个基因都会寻找外显子的比对，以最大限度提高序列的同一性，同时保留转录本和基因结构。如果两个基因都比对到overlapping位置，还会判断哪个基因最有可能是错误比对，并进行重新比对（挺好奇怎么实现的？）。</p><p>官方仓库：<a href="https://github.com/agshumate/Liftoff">agshumate&#x2F;Liftoff: An accurate GFF3&#x2F;GTF lift over pipeline (github.com)</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">usage: liftoff [-h] (-g GFF | -db DB) [-o FILE] [-u FILE] [-exclude_partial]</span><br><span class="line">               [-dir DIR] [-mm2_options =STR] [-a A] [-s S] [-d D] [-flank F]</span><br><span class="line">               [-V] [-p P] [-m PATH] [-f TYPES] [-infer_genes]</span><br><span class="line">               [-infer_transcripts] [-chroms TXT] [-unplaced TXT] [-copies]</span><br><span class="line">               [-sc SC] [-overlap O] [-mismatch M] [-gap_open GO]</span><br><span class="line">               [-gap_extend GE]</span><br><span class="line">               target reference</span><br><span class="line"></span><br><span class="line">Lift features from one genome assembly to another</span><br><span class="line"></span><br><span class="line">Required input (sequences):</span><br><span class="line">  target              target fasta genome to lift genes to</span><br><span class="line">  reference           reference fasta genome to lift genes from</span><br><span class="line"></span><br><span class="line">Required input (annotation):</span><br><span class="line">  -g GFF              annotation file to lift over in GFF or GTF format</span><br><span class="line">  -db DB              name of feature database; if not specified, the -g</span><br><span class="line">                      argument must be provided and a database will be built</span><br><span class="line">                      automatically</span><br></pre></td></tr></table></figure><p>详细参数<code>-h</code>可以查看，跑一个流程试试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#SBATCH -n 20</span></span><br><span class="line"><span class="comment">#SBATCH -t 7200</span></span><br><span class="line"></span><br><span class="line">gff_path=/public/home/wlxie/biosoft/braker3/Ap_mydb/Ap_rmTE_1.gff3</span><br><span class="line">target=/public/home/wlxie/biosoft/ragtag/ragtag_output/ragtag.scaffold.fasta</span><br><span class="line">reference=/public/home/wlxie/Genome/Ap.fa</span><br><span class="line"></span><br><span class="line">liftoff -g <span class="variable">$&#123;gff_path&#125;</span> -o Av.gff3 -p 20 <span class="variable">$&#123;target&#125;</span> <span class="variable">$&#123;reference&#125;</span></span><br></pre></td></tr></table></figure><p>两分钟就可以跑完，结果文件如下：<br>├── Av.gff3<br>├── intermediate_files<br>│   ├── reference_all_genes.fa<br>│   └── reference_all_to_target_all.sam<br>└── unmapped_features.txt</p><p>gff3文件是我们要的结果，<code>intermediate_files</code>文件夹中放的是中间文件，没啥用；<code>unmapped_features.txt</code>记录的是没比对上的基因。</p><p>提取一下CDS序列和蛋白序列：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gffread Av.gff3 -g ragtag.scaffold.fasta -x Av.codingseq</span><br><span class="line"></span><br><span class="line">$ gffread Av.gff3 -g ragtag.scaffold.fasta -y Av.aa</span><br></pre></td></tr></table></figure></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;有的时候存在这种情况：我手上有两个近缘植物的基因组测序数据，这两个物种可能没有人做过，或者别人做过但是没有提供参考基因组。而课题组因为经费不足，只测了一个物种的Hi-C&lt;del&gt;（嗯，说的就是我）&lt;/del&gt;，那如何以组装的基因组为参考，把另一个近缘物种基因组也组装到染色体级别呢？&lt;/p&gt;
&lt;p&gt;记录一下基于近缘物种参考基因组的染色体水平组装和注释，用到的软件是&lt;code&gt;RagTag&lt;/code&gt;以及配套的&lt;code&gt;Liftoff&lt;/code&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="基因组三代测序分析" scheme="http://www.shelven.com/categories/%E5%9F%BA%E5%9B%A0%E7%BB%84%E4%B8%89%E4%BB%A3%E6%B5%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="RagTag" scheme="http://www.shelven.com/tags/RagTag/"/>
    
    <category term="Liftoff" scheme="http://www.shelven.com/tags/Liftoff/"/>
    
  </entry>
  
  <entry>
    <title>关于braker3 UTR区域注释的踩坑记录以及补充</title>
    <link href="http://www.shelven.com/2023/10/13/a.html"/>
    <id>http://www.shelven.com/2023/10/13/a.html</id>
    <published>2023-10-13T13:43:20.000Z</published>
    <updated>2023-10-14T09:09:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>在<a href="https://www.shelven.com/2023/04/03/a.html">基因组注释（4）——基因预测</a>这篇博客中记录了怎么用<code>braker3</code>进行蛋白编码基因的预测，当时为了方便安装和使用，直接下载了官方的<code>singularity</code>容器。用过braker3的朋友会发现，<strong>官方给的BRAKER标准运行流程中是不包括UTR区域预测的</strong>，也就是说，最后得到的gtf&#x2F;gff文件中没有3’或者5’UTR区域的信息。</p><p>前排提示，以下操作是个人尝试，不保证一定正确。</p><span id="more"></span><h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><div class="story post-story"><p>当你要克隆某个基因，如果设计的引物不包含UTR区域，会导致pcr出来的基因不完整，为了长远考虑还是要把UTR信息加到注释结果中。怎么才能在braker结果中添加UTR区域的注释呢？</p></div><h2 id="官方注释策略"><a href="#官方注释策略" class="headerlink" title="官方注释策略"></a>官方注释策略</h2><div class="story post-story"><p>Braker3官方提供了两种注释策略，其实就是两个参数<code>--UTR=on</code>和<code>--addUTR=on</code>。这两个参数不能同时使用，<code>--UTR=on</code>会根据RNA-seq的数据训练AUGUSTUS的UTR模型，并最终生成包含utr注释信息的gtf文件。看似一步到位，实际上有诸多问题，看官方的issues中很多人提到utr注释信息和基因不匹配，有些utr区域与CDS区域相隔甚远，这明显不符合常理。开发者的回复是使用<code>--UTR=on</code>参数会对UTR进行训练和预测，可能会使UTR注释结果变糟糕，需要谨慎使用：</p><p><img src="https://www.shelven.com/tuchuang/20231013/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231013/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><code>--addUTR=on</code>参数是在AUGUSTUS预测基因的结果上，直接提取RNAseq比对产生的bam文件中的coverage信息，不进行UTR的训练和预测，直接将UTR加到AUGUSTUS的结果文件中（实现方式是通过开发者编写的软件<a href="https://github.com/Gaius-Augustus/GUSHR">GUSHR</a>）。<strong>需要注意这个参数并不是在第一遍跑BRAKER3的时候加的</strong>，我们需要正常流程（不加–UTR&#x3D;on这个参数）跑一遍，得到结果文件后，再用braker.pl跑一遍下面得命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">braker.pl --genome=../genome.fa --addUTR=on \</span><br><span class="line">    --bam=../RNAseq.bam --workingdir=$wd \</span><br><span class="line">    --AUGUSTUS_hints_preds=augustus.hints.gtf --threads=8 \</span><br><span class="line">    --skipAllTraining --species=somespecies</span><br></pre></td></tr></table></figure><p>刚需是<code>--genome</code>、<code>--bam</code>、<code>--AUGUSTUS_hints_preds</code>和<code>--skipAllTraining</code>这四个参数，<code>augustus.hints.gtf</code>这个文件可以从braker结果文件的AUGUSTUS文件夹中找到。</p></div><h2 id="使用singularity碰到的问题"><a href="#使用singularity碰到的问题" class="headerlink" title="使用singularity碰到的问题"></a>使用singularity碰到的问题</h2><div class="story post-story"><p>如果你和我一样用的singularity容器，你会很尴尬的发现加上上面任意一个参数都运行不了，会报错JAVA_PATH无法找到或者其他java相关的问题，我先后遇到了下面的场景：</p><p><a href="https://github.com/Gaius-Augustus/BRAKER/issues/638">JAVA error when adding UTR options · Issue #638 · Gaius-Augustus&#x2F;BRAKER (github.com)</a></p><p><a href="https://github.com/Gaius-Augustus/BRAKER/issues/584">set_JAVA_PATH bug…? · Issue #584 · Gaius-Augustus&#x2F;BRAKER (github.com)</a></p><p>即使我知道报错的地方想修改braker.pl文件，但是我们这个singularity只提供只读的仓库啊（<del>singularity的缺点又体现了可恶……</del>），我试了3.0.3版本和2.0.2版本都存在这个问题，所以如果用了singularity镜像仓库，就不要想着直接加参数预测UTR区域了……</p><p>针对将UTR信息加入到<code>braker.gtf</code>文件的需求，开发者两周前又更新了一个将stringtie组装转录本的中间文件信息加入到<code>braker.gtf</code>文件的脚本：</p><p><img src="https://www.shelven.com/tuchuang/20231013/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231013/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>地址如下：</p><p><a href="https://github.com/Gaius-Augustus/BRAKER/blob/utr_from_stringtie/scripts/stringtie2utr.py">https://github.com/Gaius-Augustus/BRAKER/blob/utr_from_stringtie/scripts/stringtie2utr.py</a></p><p>很可惜的是……<code>transcripts_merged.gff</code>是个中间文件，正常情况下跑完braker就被自动删除了……（你可以在braker的log文件中看到它是啥时候被删的）也不要试图自己再跑一遍stringtie，亲自试了下就算最终得到stringtie的gff文件，跑上面的流程也是跑不通的，得用braker流程的stringtie中间文件（格式不兼容）。</p></div><h2 id="比较坎坷的解决方案"><a href="#比较坎坷的解决方案" class="headerlink" title="比较坎坷的解决方案"></a>比较坎坷的解决方案</h2><div class="story post-story"><p>当然也不是完全没办法，用开发者写的软件<a href="https://github.com/Gaius-Augustus/GUSHR">GUSHR</a>，只需要用hisat将RNA-seq数据比对参考基因组，比对文件转成bam文件后作为输入文件直接用，起到和braker运行加入参数<code>--addUTR=on</code>一样的效果。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#SBATCH -n 20</span><br><span class="line"></span><br><span class="line">genome_path=/public/home/wlxie/Genome/Ap.fasta</span><br><span class="line">fq_path=/public/home/wlxie/Sequencing_data/BYT2022020901/Apocynum_pictum/</span><br><span class="line"></span><br><span class="line"># hisat2 构建索引，比对参考基因组</span><br><span class="line">hisat2-build $&#123;genome_path&#125; genome</span><br><span class="line">hisat2 -p 20 -x genome -S out.sam  -1 $&#123;fq_path&#125;4-216031965_raw_1.fq -2 $&#123;fq_path&#125;4-216031965_raw_2.fq</span><br><span class="line"></span><br><span class="line"># samtools转sam为bam并排序</span><br><span class="line">samtools sort -@ 20 -o RNAseq.bam out.sam</span><br><span class="line"></span><br><span class="line"># 删除中间文件</span><br><span class="line">rm -rf genome.*</span><br><span class="line">rm -rf out.sam</span><br></pre></td></tr></table></figure><p>上面的脚本处理转录组下机数据，最终得到<code>RNAseq.bam</code>文件。</p><p>接着克隆GUSHR的github镜像仓库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://ghproxy.com/https://github.com/Gaius-Augustus/GUSHR.git</span><br></pre></td></tr></table></figure><p>下载<code>gtf2gff.pl</code>：<a href="https://github.com/Gaius-Augustus/Augustus/blob/cc41cd053721756dd6c0aba2f5c306054edd9151/scripts/gtf2gff.pl#L347">Augustus&#x2F;scripts&#x2F;gtf2gff.pl at cc41cd053721756dd6c0aba2f5c306054edd9151 · Gaius-Augustus&#x2F;Augustus (github.com)</a></p><p>因为不想改环境变量，直接改了下<code>gushr.py</code>的源码，把<code>gtf2gff.pl</code>文件绝对位置写在gtf2gff变量里。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 197行</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27; Find AUGUSTUS script gtf2gff.pl &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">gtf2gff = <span class="string">&quot;/public/home/wlxie/biosoft/braker3/GUSHR/gtf2gff.pl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">if args.verbosity &gt; 0:</span></span><br><span class="line"><span class="string">    print(&quot;Searching for gtf2gff.pl:&quot;)</span></span><br><span class="line"><span class="string">if args.AUGUSTUS_SCRIPTS_PATH:</span></span><br><span class="line"><span class="string">    gtf2gff = args.AUGUSTUS_SCRIPTS_PATH + &quot;/gtf2gff.pl&quot;</span></span><br><span class="line"><span class="string">    if not(os.access(gtf2gff, os.X_OK)):</span></span><br><span class="line"><span class="string">        frameinfo = getframeinfo(currentframe())</span></span><br><span class="line"><span class="string">        print(&#x27;Error in file &#x27; + frameinfo.filename + &#x27; at line &#x27; +</span></span><br><span class="line"><span class="string">              str(frameinfo.lineno) + &#x27;: &#x27; + gtf2gff + &quot; is not executable!&quot;)</span></span><br><span class="line"><span class="string">        exit(1)</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        if args.verbosity &gt; 0:</span></span><br><span class="line"><span class="string">            print(&quot;Will use &quot; + gtf2gff)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    if shutil.which(&quot;gtf2gff.pl&quot;) is not None:</span></span><br><span class="line"><span class="string">        gtf2gff = shutil.which(&quot;gtf2gff.pl&quot;)</span></span><br><span class="line"><span class="string">        if args.verbosity &gt; 0:</span></span><br><span class="line"><span class="string">            print(&quot;Will use &quot; + gtf2gff)</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        frameinfo = getframeinfo(currentframe())</span></span><br><span class="line"><span class="string">        print(&#x27;Error in file &#x27; + frameinfo.filename + &#x27; at line &#x27; +</span></span><br><span class="line"><span class="string">              str(frameinfo.lineno) + &#x27;: &#x27;</span></span><br><span class="line"><span class="string">              + &quot;Unable to locate gtf2gff.pl!&quot;)</span></span><br><span class="line"><span class="string">        print(&quot;gtf2gff.pl is part of AUGUSTUS scripts.&quot;)</span></span><br><span class="line"><span class="string">        print(&quot;You can obtain it &quot; +</span></span><br><span class="line"><span class="string">              &quot;from github with:&quot;)</span></span><br><span class="line"><span class="string">        print(&quot;git clone https://github.com/Gaius-Augustus/Augustus.git&quot;)</span></span><br><span class="line"><span class="string">        print(&quot;Compilation and full installation of AUGUSTUS is not &quot; +</span></span><br><span class="line"><span class="string">              &quot;required for excuting this script. You only need to add &quot; +</span></span><br><span class="line"><span class="string">              &quot;the missing script to your $PATH.&quot;)</span></span><br><span class="line"><span class="string">        exit(1)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27; Find bash sort &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>可以先跑一个test测试一下（需要另外下载bam文件），没有问题就可以带入自己相关的文件跑这个脚本了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gushr.py -t ~/biosoft/braker3/Ap_mydb/Augustus/augustus.hints.gtf -b Ap/RNAseq.bam -g ~/Genome/Ap.fasta -o utrs</span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20231013/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231013/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>可以看到最后的<code>utrs.gtf</code>文件中注释上了UTR区域（并不是每个基因都能注释到）。</p><p>需要注意的是，这里是给AUGUSTUS结果<code>augustus.hints.gtf</code>加上UTR注释信息，而不是<code>braker.gtf</code>（用这个文件跑上面的程序也是会报错的）。开发者对两个gtf有如下的解释：</p><blockquote><p>you have two options:</p><ul><li><strong>augustus.hints.</strong>*: This is the final output of AUGUSTUS with protein hints.</li><li><strong>braker.{gtf,gtf3}</strong>: This is a union of <strong>augustus.hints.</strong>* and most reliable genes from GeneMark-EP+ prediction, which is a part of the BRAKER2 pipeline with proteins. Thus, this set is generally more sensitive (more genes correctly predicted) and can be less specific (more false-positive predictions can be present).</li><li>The remaining files are intermediate results that are useful for development and debugging purposes.</li></ul><p>The results of <strong>augustus.hints.</strong>* and <strong>braker.{gtf,gtf3}</strong> will be quite similar, if you prefer sensitivity, use <strong>braker.{gtf,gtf3}</strong>. Use <strong>augustus.hints.</strong>* otherwise.</p></blockquote><p>也就是两个文件差别不大，<code>braker.gtf</code>灵敏度高，但是假阳性多。</p><p>也有人提过将braker预测结果直接加入UTR注释（非AUGUSTUS训练UTR模型，因为结果不稳定），开发者提到这并不是一件容易的事，因为<code>braker.gtf</code>格式与UTR预测不兼容……原话如下：</p><blockquote><p>there is currently no easy way to do this because the format of <code>braker.gtf</code> is not compatible with UTR procedure.</p><p>How many extra genes do you have in <code>braker.gtf</code> compared to <code>augustus.hints.gtf</code>? In case it’s not many genes, it should be OK to just use <code>augustus.hints_utr.gtf</code> and add the extra genes from <code>braker.gtf</code> to the result (the extra genes will have <code>GeneMark.hmm</code> in the second column).</p></blockquote><p><a href="https://github.com/Gaius-Augustus/BRAKER/issues/373">Updating previous braker.gtf with addUTR output for non-fungal eukaryotic genome · Issue #373 · Gaius-Augustus&#x2F;BRAKER (github.com)</a></p><p>然而这两个文件的基因和转录本编号并不是一一对应的……直接将<code>braker.gtf</code>第二列<code>GeneMark.hmm</code>加到刚刚UTR注释的<code>augustus.hints.gtf</code>中会导致基因和转录本id混杂，并且有些AUGUSTUS预测的基因位置会和GeneMark标的基因位置重复。</p><p>权衡了一下，还是直接用<code>augustus.hints.gtf</code>作为结果文件比较合适，经过上面的UTR注释后，这个gtf文件整体会小一圈，因为删除了intron和exon信息，只保留了CDS、start_codon、stop_codon、transcript、gene以及5‘和3’-UTR。</p><p>别忘了这个gtf是非标准的gtf文件，还需要经过两步处理…..（真的头疼）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 转换该gtf文件为gff3文件</span><br><span class="line">cat utrs.gtf | perl -ne &#x27;if(m/\tAUGUSTUS\t/ or m/\tAnnotationFinalizer\t/ or m/\tGUSHR\t/) &#123;print $_;&#125;&#x27; | perl gtf2gff.pl --gff3 --out=result.gff3</span><br></pre></td></tr></table></figure><p>perl文件来自于braker singularity容器的<code>/usr/share/augustus/scripts/gtf2gff.pl</code>。或者可以到AUGUSTUS官方仓库取：</p><p><a href="https://github.com/Gaius-Augustus/Augustus/blob/cc41cd053721756dd6c0aba2f5c306054edd9151/scripts/gtf2gff.pl">Augustus&#x2F;scripts&#x2F;gtf2gff.pl at cc41cd053721756dd6c0aba2f5c306054edd9151 · Gaius-Augustus&#x2F;Augustus (github.com)</a></p><p>这个是开发者写的gtf转gff3脚本，然而转了以后还存在空格问题，无法被常规的gff软件解析，如下：</p><p><img src="https://www.shelven.com/tuchuang/20231013/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231013/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>需要自己再处理一下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将含有AnnotationFinalizer和GUSHR字段的行提取，去除空格</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;result.gff3&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file, <span class="built_in">open</span>(<span class="string">&#x27;final.gff3&#x27;</span>, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> final:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;AnnotationFinalizer&quot;</span> <span class="keyword">in</span> line <span class="keyword">or</span> <span class="string">&quot;GUSHR&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">            line_list = line.split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(line_list)-<span class="number">1</span>):</span><br><span class="line">                line_list[i] = line_list[i].strip()</span><br><span class="line">                line = <span class="string">&quot;\t&quot;</span>.join(line_list)</span><br><span class="line">            final.write(line)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            final.write(line)</span><br></pre></td></tr></table></figure></div><h2 id="最后的问题"><a href="#最后的问题" class="headerlink" title="最后的问题"></a>最后的问题</h2><div class="story post-story"><p>最后这个final.gff3文件表面风平浪静，实际还存在一些问题需要手动排查：</p><p><img src="https://www.shelven.com/tuchuang/20231013/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20231013/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我跑了一遍有三十多个基因存在start位置大于end位置的情况，这可以手动修改。但是预测的5’和3’UTR区域<strong>不止一个</strong>，有的也会相隔甚远，基本上来说，只有最后一个5’UTR区域和第一个3’UTR区域比较靠谱，所以仍然要写脚本筛选UTR，并修改gene和mRNA所在的位置。</p><p>这种问题就要扒<code>gushr.py</code>的源码看作者对UTR区域筛选的处理方式了……emmmmm还是直接说结论吧，braker的结果对UTR区域的注释确实不那么友好，现阶段我只能给出上面的思路，最后还是要写脚本自己处理gff文件筛选UTR区域，以后有空再去实现了。</p><h3 id="现在比较着急想要某基因的CDS上下游区域怎么办呢？"><a href="#现在比较着急想要某基因的CDS上下游区域怎么办呢？" class="headerlink" title="现在比较着急想要某基因的CDS上下游区域怎么办呢？"></a>现在比较着急想要某基因的CDS上下游区域怎么办呢？</h3><p>从注释文件中查找到目的基因，拿gff文件和基因组文件，直接提取braker预测的基因上下游一段区域，自己取舍一下。</p><h3 id="有没有更好的方式注释UTR区域呢？"><a href="#有没有更好的方式注释UTR区域呢？" class="headerlink" title="有没有更好的方式注释UTR区域呢？"></a>有没有更好的方式注释UTR区域呢？</h3><p>我的理解是最好测一个全长转录组，以组装的基因组做参考基因组，拼接非冗余的全长转录本，可以比较明确的区分各基因的UTR区域。最后记得导入UCSC基因组浏览器看一看结果。</p><p>总之这么长一串的踩坑和处理记录，估计别人也都用不了，就当是自己操作的备份吧hhhhhhhhh</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;在&lt;a href=&quot;https://www.shelven.com/2023/04/03/a.html&quot;&gt;基因组注释（4）——基因预测&lt;/a&gt;这篇博客中记录了怎么用&lt;code&gt;braker3&lt;/code&gt;进行蛋白编码基因的预测，当时为了方便安装和使用，直接下载了官方的&lt;code&gt;singularity&lt;/code&gt;容器。用过braker3的朋友会发现，&lt;strong&gt;官方给的BRAKER标准运行流程中是不包括UTR区域预测的&lt;/strong&gt;，也就是说，最后得到的gtf&amp;#x2F;gff文件中没有3’或者5’UTR区域的信息。&lt;/p&gt;
&lt;p&gt;前排提示，以下操作是个人尝试，不保证一定正确。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="基因组三代测序分析" scheme="http://www.shelven.com/categories/%E5%9F%BA%E5%9B%A0%E7%BB%84%E4%B8%89%E4%BB%A3%E6%B5%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Barker3" scheme="http://www.shelven.com/tags/Barker3/"/>
    
  </entry>
  
  <entry>
    <title>Hard-masking和Soft-masking结果相互转化</title>
    <link href="http://www.shelven.com/2023/10/10/a.html"/>
    <id>http://www.shelven.com/2023/10/10/a.html</id>
    <published>2023-10-10T12:48:19.000Z</published>
    <updated>2023-10-10T12:52:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>在<a href="https://www.shelven.com/2023/03/12/a.html">串联重复序列注释</a>这篇笔记里记录了如何用TRF软件进行TR预测，这款软件可以使用-m参数得到屏蔽后的序列，当时没写如何把Hard masking结果转换成Soft masking，这里就补个档。这两种屏蔽方式的结果文件是可以相互转换的。</p><span id="more"></span><h2 id="1-Hardmasking转Softmasking"><a href="#1-Hardmasking转Softmasking" class="headerlink" title="1. Hardmasking转Softmasking"></a>1. Hardmasking转Softmasking</h2><div class="story post-story"><p>因为每个人的基因组文件可能各不相同，有的序列大小写混杂，有的60个核苷酸或者80个核苷酸换一行，为了方便起见，首先将基因组文件以及hard masking之后的序列文件转换成以下fasta格式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># transform.py </span></span><br><span class="line"><span class="comment"># 每条序列两行数据形式存储，所有序列用大写字母</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">input_file, output_file</span>):</span><br><span class="line">    sequence = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> input_f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> input_f:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> sequence:</span><br><span class="line">                    sequence = <span class="string">&quot;&quot;</span>.join(sequence).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).upper()<span class="comment"># 合并分行的序列以及转换成大写字母</span></span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> new:</span><br><span class="line">                        new.write(sequence + <span class="string">&#x27;\n&#x27;</span> + line)</span><br><span class="line">                    sequence = []</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> new: <span class="comment"># 第一条序列的处理方式</span></span><br><span class="line">                        new.write(line)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                sequence.append(line)</span><br><span class="line">        sequence = <span class="string">&quot;&quot;</span>.join(sequence).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)  <span class="comment"># 处理最后一条序列处理方式</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> new:</span><br><span class="line">            new.write(sequence)</span><br><span class="line"></span><br><span class="line">transform(<span class="string">&#x27;genome.fa&#x27;</span>, <span class="string">&#x27;standard_genome.fa&#x27;</span>)</span><br></pre></td></tr></table></figure><p>NCI官网有fasta标准格式要求，这个要求还是相当宽泛的，但是不方便我们做转换，所以还是有必要统一一下。</p><p><a href="https://www.ncbi.nlm.nih.gov/genbank/fastaformat/">FASTA Format for Nucleotide Sequences (nih.gov)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hard2soft.py</span></span><br><span class="line"><span class="comment"># hardmasking文件为input_file，想要得到的softmasking文件为output_file，基因组文件为reference_file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hard2soft</span>(<span class="params">input_file, output_file, reference_file</span>):</span><br><span class="line">    reference_sequences = &#123;&#125;<span class="comment"># 序列名称和对应的序列储存在字典中</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(reference_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> ref:</span><br><span class="line">        sequence_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        sequence = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> ref:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> sequence_name:</span><br><span class="line">                    reference_sequences[sequence_name] = sequence</span><br><span class="line">                sequence_name = line[<span class="number">1</span>:]</span><br><span class="line">                sequence = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                sequence += line</span><br><span class="line">        <span class="keyword">if</span> sequence_name:   <span class="comment"># 处理最后一条序列</span></span><br><span class="line">            reference_sequences[sequence_name] = sequence</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> input_f, <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> output_f:</span><br><span class="line">        sequence_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> input_f:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):</span><br><span class="line">                sequence_name = line[<span class="number">1</span>:]</span><br><span class="line">                output_f.write(line + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                sequence = line</span><br><span class="line">                <span class="keyword">if</span> sequence_name <span class="keyword">in</span> reference_sequences:</span><br><span class="line">                    reference_sequence = reference_sequences[sequence_name]</span><br><span class="line">                    replaced_sequence = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(sequence)):</span><br><span class="line">                        <span class="keyword">if</span> sequence[i] == <span class="string">&#x27;N&#x27;</span>:  </span><br><span class="line">                            <span class="keyword">if</span> reference_sequence[i] == <span class="string">&#x27;N&#x27;</span>:    <span class="comment"># 如果基因组中原本就有N(填补gap产生的)，则无需转换</span></span><br><span class="line">                                replaced_sequence += <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                replaced_sequence += reference_sequence[i].lower()</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            replaced_sequence += sequence[i]</span><br><span class="line">                    output_f.write(replaced_sequence + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    output_f.write(sequence + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">hard2soft(<span class="string">&#x27;hardmask.fa&#x27;</span>, <span class="string">&#x27;softmask.fa&#x27;</span>, <span class="string">&#x27;standard_genome.fa&#x27;</span>)</span><br></pre></td></tr></table></figure><p>需要注意，如果基因组中原本就有填补gap产生的N，就不需要转换，直接用N表示。</p></div><h2 id="2-Softmasking转Hardmasking"><a href="#2-Softmasking转Hardmasking" class="headerlink" title="2. Softmasking转Hardmasking"></a>2. Softmasking转Hardmasking</h2><div class="story post-story"><p>Softmasking转Hardmasking的情况就要简单多了，直接搜序列中的小写字母再用N替代即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># soft2hard.py</span></span><br><span class="line"><span class="comment"># softmasking文件为input_file,hardmasking文件为output_file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">soft2hard</span>(<span class="params">input_file, output_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> input_f, <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> output_f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> input_f:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):</span><br><span class="line">                output_f.write(line + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                sequence = line</span><br><span class="line">                replaced_sequence = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(sequence)):</span><br><span class="line">                    <span class="keyword">if</span> sequence[i].islower():</span><br><span class="line">                        replaced_sequence += <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        replaced_sequence += sequence[i]</span><br><span class="line">                output_f.write(replaced_sequence + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">soft2hard(<span class="string">&#x27;softmask.txt&#x27;</span>, <span class="string">&#x27;hardmask.txt&#x27;</span>)</span><br></pre></td></tr></table></figure><p>不管用哪种方式屏蔽重复序列，都是为了下游分析服务的，没必要死磕用什么软件才是最优解……能做出符合自己预期的结果就行O(∩_∩)O</p><p>顺便一提，UCSC Genome Browser Group提供的生物分析套件和工具的源码，其中也有用TRF获得softmasking结果以及后续分析等一系列的流程，感兴趣可以看github仓库上的perl源码：</p><p><a href="https://github.com/ucscGenomeBrowser/kent/blob/307976d1f4c1ecbc73a55dea1f6348c19c1336b8/src/hg/utils/automation/doSimpleRepeat.pl">kent&#x2F;src&#x2F;hg&#x2F;utils&#x2F;automation&#x2F;doSimpleRepeat.pl at 307976d1f4c1ecbc73a55dea1f6348c19c1336b8 · ucscGenomeBrowser&#x2F;kent (github.com)</a></p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;在&lt;a href=&quot;https://www.shelven.com/2023/03/12/a.html&quot;&gt;串联重复序列注释&lt;/a&gt;这篇笔记里记录了如何用TRF软件进行TR预测，这款软件可以使用-m参数得到屏蔽后的序列，当时没写如何把Hard masking结果转换成Soft masking，这里就补个档。这两种屏蔽方式的结果文件是可以相互转换的。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="基因组三代测序分析" scheme="http://www.shelven.com/categories/%E5%9F%BA%E5%9B%A0%E7%BB%84%E4%B8%89%E4%BB%A3%E6%B5%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="格式转换" scheme="http://www.shelven.com/tags/%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2/"/>
    
  </entry>
  
  <entry>
    <title>HTML、CSS和JavaScript入门（3）——JavaScript基础</title>
    <link href="http://www.shelven.com/2023/10/08/a.html"/>
    <id>http://www.shelven.com/2023/10/08/a.html</id>
    <published>2023-10-08T07:31:18.000Z</published>
    <updated>2023-10-08T07:40:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>这一篇笔记主要记录下ES6版本的Javascript的入门学习笔记，只记录了自己了解的基础知识，实际用这门语言的时候还是要多查阅文档。</p><span id="more"></span><p>顺便推荐几个github上收藏量比较高的JavaScript学习仓库：</p><p><a href="https://github.com/getify/You-Dont-Know-JS">getify&#x2F;You-Dont-Know-JS: A book series on JavaScript. @YDKJS on twitter. (github.com)</a></p><p><a href="https://github.com/trekhleb/javascript-algorithms">trekhleb&#x2F;javascript-algorithms: 📝 Algorithms and data structures implemented in JavaScript with explanations and links to further readings (github.com)</a></p><p><a href="https://github.com/airbnb/javascript">airbnb&#x2F;javascript: JavaScript Style Guide (github.com)</a></p><h2 id="1-JavaScript基础"><a href="#1-JavaScript基础" class="headerlink" title="1. JavaScript基础"></a>1. JavaScript基础</h2><div class="story post-story"><p>HTML中的JavaScript脚本代码必须位于 <code>&lt;script&gt;</code> 和<code>&lt;/script&gt;</code>标签之间，可以在<code>&lt;head&gt;</code>中，也可以在<code>&lt;body&gt;</code>中。</p><p>放在<code>&lt;head&gt;</code>中的脚本一般是定义一个JavaScript函数，后续在<code>&lt;body&gt;</code>中引用；或者也可以像前面的CSS一样从外部引入，需要在<code>&lt;script&gt;</code>标签的<code>src</code>属性中设置JS文件的吧位置。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 一种引入JS的方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">myFoo</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;test&quot;</span>).<span class="property">innerHTML</span>=<span class="string">&quot;修改HTML当前标签的内容&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span>&gt;</span>这是一个id为test的段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 创建按钮并绑定单击事件，调用函数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;myFoo()&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 外部引入JS的方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以上是个简单的例子，点击按钮后可以改变<code>id</code>属性为”test”的标签的内容，可以看到JavaScript是如何控制网页行为的。</p><p>JavaScript可以用<code>console.log()</code>的方式将输出数据写入控制台；或者用<code>window.alert()</code>的方式将输出结果弹窗显示，方便起见后面的例子都用<code>console.log()</code>将结果写入控制台（浏览器中按F12，点击控制台）。</p><p>我是python入门的，新学的编程语言也都会和python进行对比，JavaScript对缩进的要求不像python那么严格，因为python以缩进（4个空格）区分代码块，而JS以左右花括号区分代码块，换行的缩进建议为<strong>两个空格</strong>。</p><p>在ES6版本之后，官方建议使用<code>const（声明常量）</code>和<code>let（声明变量）</code>代替<code>var</code>进行变量声明和赋值，<strong>var作用域是函数（指函数内）</strong>，而<strong>const和let是块级作用域（左右两个花括号之内）</strong>，以下是作用域的区别：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 使用 let 声明块级作用域变量</span></span><br><span class="line">  <span class="keyword">let</span> x = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="comment">// 在块级作用域内部声明新的变量，不会影响外部的 x</span></span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">20</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x); <span class="comment">// 输出 20</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x); <span class="comment">// 输出 10，外部的 x 不受内部影响</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 const 声明常量</span></span><br><span class="line">  <span class="keyword">const</span> y = <span class="number">30</span>;</span><br><span class="line">  <span class="comment">// y = 40; // 错误，常量不能重新赋值</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 var 声明变量</span></span><br><span class="line">  <span class="keyword">var</span> z = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="comment">// 在同一作用域内重复声明变量，不会引发错误</span></span><br><span class="line">    <span class="keyword">var</span> z = <span class="number">60</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(z); <span class="comment">// 输出 60</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(z); <span class="comment">// 输出 60，外部的 z 受内部影响</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">example</span>();</span><br></pre></td></tr></table></figure><p>再说明下这里的<code>var</code>作用域是函数内，所以和python一样，一个函数内定义的变量名不会影响到其他函数（除非你在函数外定义，那作用域就是全局）。</p><p>不仅仅是作用域的区别，在JavaScript中有个很有意思的概念**Hoisting(声明提升)**。我们知道python是一种顺序执行的语言，从上到下一行一行执行代码，JavaScript某种程度上也是顺序执行，但是可以被打破。</p><p>举个例子，<strong>var以及函数</strong>的<strong>声明</strong>会被提前到最近的作用域的最前面（const和let不会），<strong>但是赋值语句没有被提前</strong>，这就意味着我们可以在声明变量&#x2F;函数之前使用变量&#x2F;函数，但是变量的值就会成为<code>undefined</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x); <span class="comment">// 输出：undefined，也就是说这个变量此时还未赋值，注意这不是报错</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// 输出：5</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用 const，let就不一样了。</span></span><br><span class="line"><span class="title function_">example</span>()</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(y); <span class="comment">// 输出：ReferenceError，这才是报错，引用在初始化（赋值）前</span></span><br><span class="line">  <span class="keyword">const</span> y = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上面的示例中，变量 <code>x</code> 和函数 <code>foo</code> 的声明被提升到作用域的顶部。因此，即使在它们的声明之前使用，代码也不会引发错误。但是，变量 <code>x</code> 的值在声明之前是 <code>undefined</code>，而后才被赋值为5。还有一点，<strong>函数声明提升的优先级高于变量声明提升</strong>，这意味着函数声明会覆盖<strong>同名</strong>的变量声明。</p><p>为了不引起混淆，在使用变量和函数前都要先进行声明，对于变量的声明就用不会被提升的const和let。</p></div><h2 id="2-数据类型"><a href="#2-数据类型" class="headerlink" title="2. 数据类型"></a>2. 数据类型</h2><div class="story post-story"><p>上面列了些javascript和python带给我的直观区别，要入门一门语言还是要从最基础的数据类型开始。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String, Number, Boolean, null, undefined, Symbol</span></span><br><span class="line"><span class="keyword">const</span> username = <span class="string">&quot;Phantom&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> age = <span class="number">26</span>;</span><br><span class="line"><span class="keyword">const</span> iscol = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">const</span> x = <span class="literal">null</span>; <span class="comment">// 值被定义，但是空，typeof显示类型为object（历史遗留问题）</span></span><br><span class="line"><span class="keyword">const</span> y = <span class="literal">undefined</span>; <span class="comment">// 不存在定义</span></span><br><span class="line"><span class="keyword">const</span> n = <span class="title class_">Symbol</span>();<span class="comment">// 表示独一无二的值，最大的用法是用来定义对象的唯一属性名</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> x); <span class="comment">// typeof查看类型（有风险，比如上面的null，以及声明提升的问题）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// null类型数据不是Object</span></span><br><span class="line"><span class="keyword">const</span> z = <span class="literal">null</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(z <span class="keyword">instanceof</span> <span class="title class_">Object</span>);  <span class="comment">// 注意大写的O，输出：false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(z === <span class="literal">null</span>);  <span class="comment">// 输出：true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Symbol确定对象属性名的唯一性，避免与其他属性冲突</span></span><br><span class="line"><span class="keyword">const</span> symbol1 = <span class="title class_">Symbol</span>(<span class="string">&#x27;description&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> symbol2 = <span class="title class_">Symbol</span>(<span class="string">&#x27;description&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(symbol1 === symbol2);  <span class="comment">// 输出：false</span></span><br></pre></td></tr></table></figure></div><h2 id="3-对象和解构赋值"><a href="#3-对象和解构赋值" class="headerlink" title="3. 对象和解构赋值"></a>3. 对象和解构赋值</h2><div class="story post-story"><p>要明确一点，JavaScript和python一样都是<strong>面向对象</strong>的编程语言。JavaScript的对象由花括号分隔，在括号内部，对象属性以名称和值对的方式来定义，属性之间逗号分隔。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个对象</span></span><br><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Phantom&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">26</span>,</span><br><span class="line">  <span class="attr">hobbies</span>: [<span class="string">&quot;music&quot;</span>, <span class="string">&quot;sing&quot;</span>, <span class="string">&quot;dance&quot;</span>, <span class="string">&quot;basketball&quot;</span>],</span><br><span class="line">  <span class="attr">address</span>: &#123;</span><br><span class="line">  <span class="attr">street</span>: <span class="string">&quot;tarim street&quot;</span>,</span><br><span class="line">  <span class="attr">city</span>: <span class="string">&quot;tarim&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello, my name is <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用对象的方法和属性</span></span><br><span class="line">person.<span class="title function_">sayHello</span>();  <span class="comment">// 输出：Hello, my name is Phantom.</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>, person.<span class="property">age</span>); <span class="comment">// 输出：Phantom 26</span></span><br></pre></td></tr></table></figure><p>JavaScript中对赋值运算有个比较有意思的拓展，叫做<strong>解构赋值</strong>，可以对数组或者对象进行模式匹配，变量一个萝卜一个坑对应进行赋值：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组解构赋值</span></span><br><span class="line"><span class="keyword">let</span> [a, b, c] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c)  <span class="comment">// 输出 1 2 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象解构赋值</span></span><br><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">  <span class="attr">firstname</span>: <span class="string">&quot;Alex&quot;</span>,</span><br><span class="line">  <span class="attr">lastname</span>: <span class="string">&quot;Xie&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">  <span class="attr">hobbies</span>: [<span class="string">&quot;music&quot;</span>, <span class="string">&quot;sing&quot;</span>, <span class="string">&quot;dance&quot;</span>, <span class="string">&quot;basketball&quot;</span>],</span><br><span class="line">  <span class="attr">address</span>: &#123;</span><br><span class="line">    <span class="attr">street</span>: <span class="string">&quot;tarim street&quot;</span>,</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&quot;tarim&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  firstname,</span><br><span class="line">  lastname,</span><br><span class="line">  <span class="attr">address</span>: &#123; city &#125;,</span><br><span class="line">&#125; = person;  <span class="comment">// 相当于用同名变量将值从person变量中抽取出来</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(city);  <span class="comment">// 输出tarim</span></span><br></pre></td></tr></table></figure><p>在这里，我们通过解构赋值从 <code>person</code> 对象中提取了 <code>firstname</code>、<code>lastname</code> 和 <code>address</code> 属性，并将 <code>address</code> 属性解构为 <code>city</code> 变量。由于 <code>person</code> 对象的 <code>address</code> 属性是一个对象，而我们只关心其中的 <code>city</code> 属性，所以通过解构赋值的方式将 <code>city</code> 属性提取出来。</p><p>整个过程相当于用一个同名变量将值从<code>person</code>对象中提取出来。</p></div><h2 id="4-常用的内置方法"><a href="#4-常用的内置方法" class="headerlink" title="4. 常用的内置方法"></a>4. 常用的内置方法</h2><div class="story post-story"><p>方法部分就比较多了，这里就列举常见的，真正需要的时候得查手册。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串内置方法</span></span><br><span class="line"><span class="keyword">const</span> username = <span class="string">&quot;Phantom&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(username.<span class="property">length</span>); <span class="comment">//.length 长度，没括号是属性 输出：7</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(username.<span class="title function_">toUpperCase</span>()); <span class="comment">// 有括号的是方法 输出：PHANTOM</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(username.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">3</span>).<span class="title function_">toUpperCase</span>()); <span class="comment">// 输出：PHA</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(username.<span class="title function_">includes</span>(<span class="string">&quot;P&quot;</span>)) <span class="comment">// 判断是否含有参数字符串 输出：true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(username.<span class="title function_">startsWith</span>(<span class="string">&quot;n&quot;</span>)); <span class="comment">// 判断是否参数字符串开头，注意函数名是驼峰写法 输出：false</span></span><br><span class="line"><span class="keyword">const</span> test_txt = <span class="string">&quot;p h a n t o m&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(test_txt.<span class="title function_">split</span>(<span class="string">&quot; &quot;</span>)); <span class="comment">// 切分数组，其实和python的.split()方法是一样的 输出：[&#x27;p&#x27;, &#x27;h&#x27;, &#x27;a&#x27;, &#x27;n&#x27;, &#x27;t&#x27;, &#x27;o&#x27;, &#x27;m&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组内置方法</span></span><br><span class="line"><span class="keyword">const</span> numbers = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>); <span class="comment">// 构造函数创建数组</span></span><br><span class="line"><span class="keyword">const</span> fruits = [<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>]; <span class="comment">//直接用中括号申明数组</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numbers); <span class="comment">// 输出：[1, 2, 3, 4, 5]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruits[<span class="number">1</span>]); <span class="comment">// 中括号索引，和python一模一样 输出：banana</span></span><br><span class="line"></span><br><span class="line">fruits.<span class="title function_">push</span>(<span class="string">&quot;watermalon&quot;</span>); <span class="comment">// .push() 数组中添加元素，等同于python列表的.append()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruits); <span class="comment">// 输出：[&#x27;apple&#x27;, &#x27;banana&#x27;, &#x27;watermalon&#x27;]</span></span><br><span class="line">fruits.<span class="title function_">pop</span>(); <span class="comment">// 删除末尾元素</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Array</span>.<span class="title function_">isArray</span>(fruits)); <span class="comment">// 判断是否为数组 输出：true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruits.<span class="title function_">indexOf</span>(<span class="string">&quot;apple&quot;</span>)); <span class="comment">// 计算索引 输出：0</span></span><br></pre></td></tr></table></figure></div><h2 id="5-条件语句"><a href="#5-条件语句" class="headerlink" title="5. 条件语句"></a>5. 条件语句</h2><div class="story post-story"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if条件语句</span></span><br><span class="line"><span class="keyword">const</span> n = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">const</span> m = <span class="number">10</span>;</span><br><span class="line"><span class="comment">// ===才会连数据类型一起判断，==不会判断数据类型</span></span><br><span class="line"><span class="keyword">if</span> (n === <span class="number">10</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;n is 10&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (n &gt; <span class="number">10</span> || m &gt; <span class="number">10</span>) &#123;</span><br><span class="line">  <span class="comment">// 条件判断中”或“用||双竖线表示，”且“用&amp;&amp;表示</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;n is greater than 10 or m is greater than 10&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;n is less than 10 and m is less than 10&quot;</span>);</span><br><span class="line">&#125; <span class="comment">// 输出：n is greater than 10 or m is greater than 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 三目运算符(简化if else代码用)</span></span><br><span class="line"><span class="keyword">const</span> z = <span class="number">11</span>;</span><br><span class="line"><span class="keyword">const</span> color = z &gt; <span class="number">10</span> ? <span class="string">&quot;red&quot;</span> : <span class="string">&quot;blue&quot;</span>; <span class="comment">// ？表示判断为真，冒号后是判断为假</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(color); <span class="comment">// 输出：red</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一种条件语句switch</span></span><br><span class="line"><span class="keyword">switch</span> (color) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;red&quot;</span>: <span class="comment">// 需要注意case判断的条件是===</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;color is red&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>; <span class="comment">// case break相当于shell里的if fi</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;blue&quot;</span>:</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;color is blue&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="attr">default</span>: <span class="comment">// 表示没有匹配到任意一个条件，执行下面得代码块</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;color is not red or blue&quot;</span>);</span><br><span class="line">&#125; <span class="comment">// 输出：color is red</span></span><br></pre></td></tr></table></figure></div><h2 id="6-循环语句"><a href="#6-循环语句" class="headerlink" title="6. 循环语句"></a>6. 循环语句</h2><div class="story post-story"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for 循环</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`for loop number: <span class="subst">$&#123;i&#125;</span>`</span>); <span class="comment">// 像shell里的for循环，注意符号``</span></span><br><span class="line">&#125; <span class="comment">// 输出：for loop number: 0 一直到9，10行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// while 循环,与for不同，条件判断在while里面,否则死循环</span></span><br><span class="line"><span class="keyword">let</span> l = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (l &lt; <span class="number">10</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`while loop number: <span class="subst">$&#123;l&#125;</span>`</span>);</span><br><span class="line">  l++;</span><br><span class="line">&#125; <span class="comment">// 输出：while loop number: 0 一直到9，10行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.<span class="property">length</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 结合数组的for循环</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(array[i]);</span><br><span class="line">&#125; <span class="comment">// 输出 1 到 3 共三行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> array) &#123;</span><br><span class="line">  <span class="comment">// 类似于python的for i in [list]</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">&#125; <span class="comment">// 输出 1 到 3 共三行</span></span><br></pre></td></tr></table></figure><p>同样有<code>continue</code> 和 <code>break</code> 是用于控制循环流程：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// continue 跳过当前循环剩余代码，进入下一个循环</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i === <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">&#125; <span class="comment">// 输出：0 1 3 4（4行）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// break用于完全终止循环，跳出循环体</span></span><br><span class="line"><span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  i++;</span><br><span class="line">&#125; <span class="comment">// 输出：0 1 2（3行）</span></span><br></pre></td></tr></table></figure></div><h2 id="7-类和构造函数"><a href="#7-类和构造函数" class="headerlink" title="7. 类和构造函数"></a>7. 类和构造函数</h2><div class="story post-story"><p>JavaScript也使用 <code>class</code> 关键字来声明类，类名通常使用大写字母开头。类的方法定义和python类的方法定义是一样的，都是使用普通函数的语法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">  <span class="title function_">myMethod</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 方法的定义</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和python的构造函数使用方法名<code>__init__()</code>定义类似，JavaScript的构造函数是类的一个普通方法，使用 <code>constructor</code> 关键字定义。<strong>Python</strong>的构造函数可以接受任意数量的参数，<strong>包括 self（指向类的实例）作为第一个参数</strong>。在构造函数内部，可以使用这些参数来初始化实例的属性。而<strong>JavaScript</strong>的构造函数使用普通的函数参数来接收传递的值，<strong>没有特殊的self参数</strong>。</p><p>演示一下两者构造函数的差异：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python的构造函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, arg1, arg2</span>):</span><br><span class="line">        self.arg1 = arg1</span><br><span class="line">        self.arg2 = arg2</span><br><span class="line"></span><br><span class="line">my_instance = MyClass(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(my_instance.arg1)  <span class="comment"># 输出：Hello</span></span><br><span class="line"><span class="built_in">print</span>(my_instance.arg2)  <span class="comment"># 输出：World</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javascript的构造函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">arg1, arg2</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">arg1</span> = arg1;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">arg2</span> = arg2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myInstance = <span class="keyword">new</span> <span class="title class_">MyClass</span>(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="property">arg1</span>);  <span class="comment">// 输出：Hello</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="property">arg2</span>);  <span class="comment">// 输出：World</span></span><br></pre></td></tr></table></figure><p><code>new</code>关键字用于创建一个类的实例对象，比如上面的例子，通过<code>new</code>关键字，调用了<code>MyClass</code>类的构造函数，并且传递了参数<code>&quot;Hello&quot; </code>, <code>&quot;World&quot;</code>，将构造函数的<code>this</code>绑定到新创建的对象，最后，<code>new</code>关键字返回了新创建的<code>MyClass</code>实例对象<code>myInstance</code>。</p><p><code>constructor</code> 关键字也不是一定要显示声明的，需要理解构造函数是用来创建和初始化对象的特殊函数，<strong>在 JavaScript 中，如果一个函数被用于创建对象，它就被认为是构造函数。</strong></p><p><strong>python的构造函数不允许显示返回值</strong>，只负责初始化实例状态。而 <strong>JavaScript 的构造函数可以显式返回一个对象</strong>，如果返回的是一个对象，则该对象将作为实例创建的结果，否则将返回新创建的实例（上面的例子就是）。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造函数返回对象的情况</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">property</span> = <span class="string">&quot;Value&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">customProperty</span>: <span class="string">&quot;Custom Value&quot;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myInstance = <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="property">property</span>); <span class="comment">// 输出：undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="property">customProperty</span>); <span class="comment">// 输出：&quot;Custom Value&quot;</span></span><br></pre></td></tr></table></figure><p>上面的例子中，构造函数使用了<code>return</code>语句返回了一个对象<code>&#123; customProperty: &quot;Custom Value&quot; &#125;</code>。当我们使用<code>new</code>关键字创建<code>MyClass</code>的实例时，返回的结果不是新创建的实例对象，而是显式返回的对象，因此这个对象并没有 <code>property</code> 属性，而是具有 <code>customProperty</code> 属性。</p></div><h2 id="8-封装、继承和多态"><a href="#8-封装、继承和多态" class="headerlink" title="8. 封装、继承和多态"></a>8. 封装、继承和多态</h2><div class="story post-story"><p>既然JavaScript是面向对象的编程语言，就一定有面向对象的三大特征：封装、继承和多态。</p><h3 id="8-1-封装（Encapsulation）"><a href="#8-1-封装（Encapsulation）" class="headerlink" title="8.1 封装（Encapsulation）"></a>8.1 封装（Encapsulation）</h3><ul><li>对象和函数：很明显JavaScript中的对象和函数可以用来封装数据和行为。对象可以包含属性和方法，函数可以封装一段可执行的代码，并且可以接收参数和返回值。</li><li>访问控制：通过使用<strong>闭包</strong>或者<strong>WeakMap</strong>，可以模拟私有属性和方法，从而实现对数据的隐藏和封装。</li></ul><p>我们不能像python中一样用<code>_</code>或者<code>__</code>在属性或者方法上实现私有化，JavaScript提供了一些特殊的机制：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用闭包，简单来说，闭包是指一个函数能够访问并操作其作用域外部的变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyFunction</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> privateProperty = <span class="string">&quot;Private Value&quot;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">getPrivateProperty</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> privateProperty;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">setPrivateProperty</span> = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    privateProperty = value;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myInstance = <span class="keyword">new</span> <span class="title class_">MyFunction</span>(); <span class="comment">// 创建实例对象，执行构造函数代码，返回一个新的对象</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="property">privateProperty</span>); <span class="comment">// 构造函数内部的局部变量，外部不可访问，输出：undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="title function_">getPrivateProperty</span>()); <span class="comment">// 输出：&quot;Private Value&quot;</span></span><br><span class="line">myInstance.<span class="title function_">setPrivateProperty</span>(<span class="string">&quot;New Value&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="title function_">getPrivateProperty</span>()); <span class="comment">// 输出：&quot;New Value&quot;</span></span><br></pre></td></tr></table></figure><p>在上述示例中，我们使用闭包创建了一个私有变量<code>privateProperty</code>。通过在构造函数内部定义公有方法<code>getPrivateProperty</code>和<code>setPrivateProperty</code>，我们可以访问和修改私有属性(内部的两个方法访问修改了外部函数的变量)。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用WeakMap</span></span><br><span class="line"><span class="keyword">const</span> privateProperties = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    privateProperties.<span class="title function_">set</span>(<span class="variable language_">this</span>, &#123; <span class="attr">privateProperty</span>: <span class="string">&quot;Private Value&quot;</span> &#125;);</span><br><span class="line">  &#125;<span class="comment">// WeakMap用法set(key,value)</span></span><br><span class="line">  </span><br><span class="line">  <span class="title function_">getPrivateProperty</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> privateProperties.<span class="title function_">get</span>(<span class="variable language_">this</span>).<span class="property">privateProperty</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">setPrivateProperty</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    privateProperties.<span class="title function_">get</span>(<span class="variable language_">this</span>).<span class="property">privateProperty</span> = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myInstance = <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="property">privateProperty</span>); <span class="comment">// 输出：undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="title function_">getPrivateProperty</span>()); <span class="comment">// 输出：&quot;Private Value&quot;</span></span><br><span class="line">myInstance.<span class="title function_">setPrivateProperty</span>(<span class="string">&quot;New Value&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myInstance.<span class="title function_">getPrivateProperty</span>()); <span class="comment">// 输出：&quot;New Value&quot;</span></span><br></pre></td></tr></table></figure><p><code>Map</code>和<code>WeakMap</code>都是ES6中新的数据结构集，一个对象由多个key-value键值对构成，在Map中，任何类型都可以做对象的key；而在WeakMap中，key必需是对象，所有的key都是弱引用，不用考虑垃圾回收。</p><p>在构造函数中，使用<code>privateProperties</code>定义了一个<code>WeakMap</code>实例。通过 <code>privateProperties.set(this, &#123; privateProperty: &quot;Private Value&quot; &#125;)</code> 将当前实例对象作为键，将一个包含私有属性 <code>privateProperty</code> 的对象作为值存储在 <code>WeakMap</code> 中。</p><p>然后，通过在类的原型上定义 <code>getPrivateProperty</code> 和 <code>setPrivateProperty</code> 方法，访问和修改存储在 <code>WeakMap</code> 中的私有属性。</p><h3 id="8-2-继承（Inheritance）"><a href="#8-2-继承（Inheritance）" class="headerlink" title="8.2 继承（Inheritance）"></a>8.2 继承（Inheritance）</h3><p>使用 <code>extends</code> 关键字来创建子类，并使用 <code>super</code> 关键字来调用父类的构造函数和方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> makes a sound.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Animal</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name, breed</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name); <span class="comment">// 调用父类的构造函数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">breed</span> = breed;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> barks.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">fetch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> fetches the ball.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myDog = <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;Buddy&quot;</span>, <span class="string">&quot;Golden Retriever&quot;</span>);</span><br><span class="line">myDog.<span class="title function_">speak</span>(); <span class="comment">// 输出：&quot;Buddy barks.&quot;</span></span><br><span class="line">myDog.<span class="title function_">fetch</span>(); <span class="comment">// 输出：&quot;Buddy fetches the ball.&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myDog.<span class="property">name</span>); <span class="comment">// 输出：&quot;Buddy&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myDog.<span class="property">breed</span>); <span class="comment">// 输出：&quot;Golden Retriever&quot;</span></span><br></pre></td></tr></table></figure><p>在上面的例子中，我们有一个父类<code>Animal</code>和一个子类<code>Dog</code>。子类<code>Dog</code>使用<code>extends</code>关键字继承了父类<code>Animal</code>（python就不需要）。子类<code>Dog</code>在构造函数中使用<code>super(name)</code>调用了父类的构造函数，并传递了<code>name</code>参数。</p><p>子类可以覆盖父类的方法，上面的例子就覆盖了父类的<code>speak()</code>方法。在子类中，我们可以使用<code>this</code>关键字引用当前实例的属性和方法，包括从父类继承的属性和方法。</p><h3 id="8-3-多态（Polymorphism）"><a href="#8-3-多态（Polymorphism）" class="headerlink" title="8.3 多态（Polymorphism）"></a>8.3 多态（Polymorphism）</h3><p>JavaScript 是一种动态类型语言，变量的类型可以在运行时改变。这种动态性使得 JavaScript 具有一定的多态性。例如，多个对象可以对同一个方法做出不同的响应，根据对象的实际类型来确定要调用的方法（<strong>相同接口，不同实现</strong>）。</p><p>举个例子，假设我们有一个 <code>Animal</code> 类，它有一个 <code>makeSound</code> 方法用于发出动物的声音。然后我们派生出两个子类 <code>Dog</code> 和 <code>Cat</code>，它们分别重写了 <code>makeSound</code> 方法来发出不同的声音。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">  <span class="title function_">makeSound</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;The animal makes a sound&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Animal</span> &#123;</span><br><span class="line">  <span class="title function_">makeSound</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;The dog barks&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Animal</span> &#123;</span><br><span class="line">  <span class="title function_">makeSound</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;The cat meows&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在，我们可以创建不同的对象并调用它们的 <code>makeSound</code> 方法，它们会根据自己的实现发出不同的声音。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> animal = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line"><span class="keyword">const</span> dog = <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line"><span class="keyword">const</span> cat = <span class="keyword">new</span> <span class="title class_">Cat</span>();</span><br><span class="line"></span><br><span class="line">animal.<span class="title function_">makeSound</span>(); <span class="comment">// 输出：&quot;The animal makes a sound&quot;</span></span><br><span class="line">dog.<span class="title function_">makeSound</span>(); <span class="comment">// 输出：&quot;The dog barks&quot;</span></span><br><span class="line">cat.<span class="title function_">makeSound</span>(); <span class="comment">// 输出：&quot;The cat meows&quot;</span></span><br></pre></td></tr></table></figure><p>本质上就是子类对父类的继承方法的重写，实现调用一个接口具有不同的实现。</p><p>对于第8部分可能有些难以理解，可以结合前面python的面向对象编程笔记：</p><p><a href="https://www.shelven.com/2022/11/25/a.html">python自学笔记（3）——面向对象编程（上） - 我的小破站 (shelven.com)</a></p><p><a href="https://www.shelven.com/2022/11/26/a.html">python自学笔记（4）——面向对象编程（下） - 我的小破站 (shelven.com)</a></p><p>JavaScript还有很多高级用法，这里只记录了入门的一些基础，以后要用到再深入了解。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;这一篇笔记主要记录下ES6版本的Javascript的入门学习笔记，只记录了自己了解的基础知识，实际用这门语言的时候还是要多查阅文档。&lt;/p&gt;</summary>
    
    
    
    <category term="个人主页" scheme="http://www.shelven.com/categories/%E4%B8%AA%E4%BA%BA%E4%B8%BB%E9%A1%B5/"/>
    
    <category term="编程自学" scheme="http://www.shelven.com/categories/%E7%BC%96%E7%A8%8B%E8%87%AA%E5%AD%A6/"/>
    
    
    <category term="JavaScript" scheme="http://www.shelven.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>HTML、CSS和JavaScript入门（2）——CSS基础</title>
    <link href="http://www.shelven.com/2023/09/30/a.html"/>
    <id>http://www.shelven.com/2023/09/30/a.html</id>
    <published>2023-09-30T10:15:00.000Z</published>
    <updated>2023-09-30T10:24:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>前一篇笔记介绍了HTML的基础，这一篇主要记录下CSS的基础知识。</p><span id="more"></span><h2 id="1-CSS的引入方式"><a href="#1-CSS的引入方式" class="headerlink" title="1. CSS的引入方式"></a>1. CSS的引入方式</h2><div class="story post-story"><h3 id="1-1-内联样式"><a href="#1-1-内联样式" class="headerlink" title="1.1 内联样式"></a>1.1 内联样式</h3><p>直接用<code>style</code>写进HTML元素，仅对当前的HTML元素有效：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>未引入CSS的h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;color:brown&quot;</span>&gt;</span>内联样式引入CSS的h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230930/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>可以看到在用内联样式引入的css只在当前html元素生效，并不会影响其他的元素。</p><h3 id="1-2-内部样式表"><a href="#1-2-内部样式表" class="headerlink" title="1.2 内部样式表"></a>1.2 内部样式表</h3><p>在<code>&lt;head&gt;</code>区域中用<code>&lt;style&gt;</code>标签写入css规则，对所有标签都生效：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h1</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: darkslateblue;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是第一个h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是第二个h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230930/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="1-3-外部样式表"><a href="#1-3-外部样式表" class="headerlink" title="1.3 外部样式表"></a>1.3 外部样式表</h3><p>顾名思义时从外部css文件引入，需要在<code>&lt;head&gt;</code>区域中引入<code>link:css</code>。首先我们创建一个<code>style.css</code>文件，并写入以下内容：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">h1</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: darkkhaki;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回到html文件，在<code>&lt;head&gt;</code>区域内输入link，在提示的第三行出现<code>link:css</code>，选中回车就自动引入了我们创建的css文件：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是第一个h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是第二个h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230930/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>还有种外部样式表引用方式，是在<code>&lt;head&gt;</code>标签的<code>&lt;style&gt;</code>区域内用<code>@import</code>的方式引入：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 注意有分号，css提供的方式 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        @import url(&quot;style.css&quot;);</span></span><br><span class="line"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是第一个h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是第二个h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最终的效果和上面是一样的，就不放图片了。需要注意，使用<code>@import</code>方式引入有一些限制，它<strong>会在HTML解析完毕以后再加载CSS文件，就可能导致页面渲染的延迟</strong>，并且引入的CSS文件不能并行加载，可能会影响网页的性能。</p><p>所以一般都是用<code>&lt;link&gt;</code>标签的方式引入CSS文件，提高性能的同时也有更好的兼容性。</p></div><h2 id="2-CSS引入的优先级"><a href="#2-CSS引入的优先级" class="headerlink" title="2. CSS引入的优先级"></a>2. CSS引入的优先级</h2><div class="story post-story"><p>上面说了三种引入CSS的方式，如果一个标签被不同方法&#x2F;顺序引入的CSS文件修饰，最终会表现出哪种样式呢？这就要说到样式的优先级。</p><p>浏览器会为HTML元素提供默认的样式，如果没有其他的样式覆盖，默认样式将会应用于这些元素（可以在网页按F12，元素，body中看到<em>用户代理样式表</em>，也就是浏览器自身定义的样式）。</p><p>样式的优先级有如下基本规则：</p><ul><li><ol><li><code>!important</code>优先级最高，会覆盖CSS中任何其他声明，不推荐使用，因为它改变了你样式表的级联规则，难以调试。</li></ol></li><li><ol start="2"><li><strong>内联样式</strong>优先级高于内部样式表和外部样式表中的样式定义。</li></ol></li><li><ol start="3"><li>相同的规则按照加载顺序，写在后面的声明会覆盖前面的。</li></ol></li><li><ol start="4"><li>继承的样式优先级低于直接指定的样式。</li></ol></li></ul><p>什么是继承的样式？继承样式是指某个元素会继承其父元素的某些样式属性，即<strong>子元素会继承父元素的样式</strong>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: Arial;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: burlywood;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h1</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">24px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: blue;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是标题<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面的例子中，我们定义了<code>&lt;body&gt;</code>标签的<code>font-family</code>和<code>color</code>属性，子元素<code>&lt;h1&gt;</code>和<code>&lt;p&gt;</code>都继承了父元素的这两个属性，但同时我们又指定了<code>&lt;h1&gt;</code>标签的<code>font-size</code>和<code>color</code>属性。所以直接指定的<code>&lt;h1&gt;</code>除了继承了父标签的属性外，<code>color</code>属性的优先级高于继承的，为蓝色。</p><p><img src="https://www.shelven.com/tuchuang/20230930/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>继承样式并不是所有样式属性都会继承的，只有一部分样式属性具有继承性。常见的继承样式属性包括 <code>font-family</code>、<code>color</code>、<code>font-size</code>、<code>font-weight</code>、<code>text-align</code> 等。但是像 <code>width</code>、<code>height</code>、<code>margin</code>、<code>padding</code>、<code>background-color</code> 等属性就不具有继承性。</p></div><h2 id="3-类和选择器"><a href="#3-类和选择器" class="headerlink" title="3. 类和选择器"></a>3. 类和选择器</h2><div class="story post-story"><p>为了保持代码的可维护性和可读性，尽量避免用<code>!important</code>声明样式，也尽量避免滥用内联样式，一般情况下是将样式定义在外部样式表中，使用类和选择器来管理样式。这样可以更好地组织和维护样式，并提高代码的重用性。</p><p>为了方便演示，以下都用内部样式表的方式引入CSS样式。</p><h3 id="3-1-类（class）"><a href="#3-1-类（class）" class="headerlink" title="3.1 类（class）"></a>3.1 类（class）</h3><p>类是一种CSS的标记，用于标识一组具有相同样式的元素。通过为HTML元素添加<code>class属性</code>，并在CSS中定义对应的样式规则，可以将样式应用于多个元素。类名以<code>.</code>开头。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.highlight</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-color</span>: yellow;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;highlight&quot;</span>&gt;</span>这是一个带有highlight类的段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个普通的段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230930/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="3-2-选择器（Selector）"><a href="#3-2-选择器（Selector）" class="headerlink" title="3.2 选择器（Selector）"></a>3.2 选择器（Selector）</h3><p>选择器用于选择HTML中要应用样式的元素。可以根据元素的标签名、类、ID、属性等进行选择。</p><ul><li><strong>元素选择器（Element Selector）</strong>：根据元素的标签名选择元素。例如，<code>p</code>选择器选择所有的<code>&lt;p&gt;</code>段落元素。</li><li><strong>类选择器（Class Selector）</strong>：根据类名选择元素。例如，<code>.highlight</code>选择器选择所有具有highlight类的元素。</li><li><strong>ID选择器（ID Selector）</strong>：根据元素的唯一ID选择元素。例如，<code>#header</code>选择器选择具有header ID的元素。</li><li><strong>属性选择器（Attribute Selector）</strong>：根据元素的属性选择元素。例如，<code>[type=&quot;text&quot;]</code>选择器选择所有<code>type</code>属性为”text”的元素。</li><li><strong>通用选择器（Universal Selector）</strong>：所有元素都会被选中。</li></ul><p>不同选择器之间也是有优先级的，<strong>ID选择器 &gt; 类选择器 &gt; 元素选择器</strong>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 元素选择器 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">p</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: blue;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">      <span class="comment">/* 类选择器 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.highlight</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: yellow;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">      <span class="comment">/* ID选择器 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#header</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">      <span class="comment">/* 属性选择器 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;text&quot;</span>]</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid gray;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 通用选择器 */</span></span></span><br><span class="line"><span class="language-css">        * &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&#x27;Times New Roman&#x27;</span>, Times, serif;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">      </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个普通的段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;highlight&quot;</span>&gt;</span>这是一个带有highlight类的段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;header&quot;</span>&gt;</span>这是一个带有header ID的段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;文本输入框&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230930/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>还有些比较特殊的选择器，简单介绍两个：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 两个元素之间是空格，表示前面的父类，后面的是所有该标签的子类 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">div</span> <span class="selector-tag">p</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: brown;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 两个元素之间是逗号，表示同时选中 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h1</span>,<span class="selector-tag">h2</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: aqua;</span></span><br><span class="line"><span class="language-css">        &#125;   </span></span><br><span class="line"><span class="language-css">      </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个普通的段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是在div父元素下的段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是h1标签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>这是h2标签<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230930/8.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>空格是取所有的后代元素，如果只想要一级的子元素，可以用符号<code>&gt;</code>。</p></div><h2 id="4-伪类和伪元素"><a href="#4-伪类和伪元素" class="headerlink" title="4. 伪类和伪元素"></a>4. 伪类和伪元素</h2><div class="story post-story"><h3 id="4-1-伪类（Pseudo-class）"><a href="#4-1-伪类（Pseudo-class）" class="headerlink" title="4.1 伪类（Pseudo-class）"></a>4.1 伪类（Pseudo-class）</h3><p><strong>伪类用于选择处于特定状态的元素</strong>，例如鼠标悬停、被点击、是第一个子元素等。伪类以冒号<code>:</code>开头，紧跟在选择器后面。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 选择所有的链接元素 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">a</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: blue;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 选择鼠标悬停在链接上的元素 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: red;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 选择div的第一个p子元素 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">div</span> &gt; <span class="selector-tag">p</span><span class="selector-pseudo">:first</span>-child &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"> </span></span><br><span class="line"><span class="language-css">      </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.shelven.com&quot;</span>&gt;</span>这是一个普通的链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是在div父元素下的第一个段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是在div父元素下的第二个段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在上面的例子中，<code>:hover</code>是一个伪类选择器，用于选择鼠标悬停在链接上的元素，并应用红色字体颜色。<code>:first-child</code>也是一个伪类选择器，用于选择第一个子元素，并应用粗体字体样式（不指定的话就是任意一个元素的子元素）。</p><p>上边是正常显示的页面，下边是鼠标悬停在链接上的效果：</p><p><img src="https://www.shelven.com/tuchuang/20230930/9.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/9.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="> <img src="https://www.shelven.com/tuchuang/20230930/10.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/10.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="4-2-伪元素（Pseudo-element）"><a href="#4-2-伪元素（Pseudo-element）" class="headerlink" title="4.2 伪元素（Pseudo-element）"></a>4.2 伪元素（Pseudo-element）</h3><p><strong>伪元素用于在元素的特定位置插入内容或样式</strong>，例如在元素的前后插入额外的内容、选择元素的第一个字母等。伪元素以双冒号<code>::</code>开头，紧跟在选择器后面。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 在段落前插入内容 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">p</span><span class="selector-pseudo">::before</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">content</span>: <span class="string">&quot;前置内容&quot;</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 选择第一个字母 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">p</span><span class="selector-pseudo">::first-letter</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">2em</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: red;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 在段落后插入内容 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">p</span><span class="selector-pseudo">::after</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">content</span>: <span class="string">&quot;后置内容&quot;</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        这是一段普通的段落内容</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230930/11.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/11.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>在上面例子里，<code>::before</code>是一个伪元素选择器，用于在每个段落前插入额外的内容，并应用粗体字体样式。<code>::first-letter</code>也是一个伪元素选择器，用于选择每个段落的第一个字母，并应用2倍字体大小和红色字体颜色。</p></div><h2 id="5-盒子模型"><a href="#5-盒子模型" class="headerlink" title="5. 盒子模型"></a>5. 盒子模型</h2><div class="story post-story"><p>CSS中的盒子模型（Box Model）是用于描述元素在页面中占用空间的一种模型。它将每个元素看作是一个矩形的盒子，由四个部分组成：内容区域（Content）、内边距（Padding）、边框（Border）和外边距（Margin）。</p><ul><li><p>1.内容区域（Content）：<br>内容区域指的是元素内部实际显示内容的区域，包括文本、图片或其他子元素。它的大小由元素的宽度（width）和高度（height）属性决定。</p></li><li><p>2.内边距（Padding）：<br>内边距是元素内容区域与边框之间的空白区域，用于控制内容与边框之间的距离。可以使用<code>padding</code>属性设置内边距的大小。</p></li><li><p>3.边框（Border）：<br>边框是围绕元素内容和内边距的线条或样式，用于分隔元素与其他元素的区域。可以使用<code>border</code>属性设置边框的样式、宽度和颜色。</p></li><li><p>4.外边距（Margin）：<br>外边距是元素与相邻元素之间的空白区域，用于控制元素与其他元素之间的距离。可以使用<code>margin</code>属性设置外边距的大小。</p></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: blue;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">3px</span> solid black;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">9px</span> <span class="number">8px</span> <span class="number">7px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">5px</span> <span class="number">5px</span> <span class="number">5px</span> <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        这是一个普通的box模型</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当我们打开网页，按下F12，选择元素，div.box，就可以看到浏览器中展示的盒子模型：</p><p><img src="https://www.shelven.com/tuchuang/20230930/13.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230930/13.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>总的来说，盒子模型是帮助我们理解元素在页面中的布局和占用空间的，通过调整内容区域、内边距、边框和外边距的大小和样式，可以实现各种页面布局效果。</p><p>以上都是些基本的CSS常识，实例部分可以参考菜鸟教程，里面给的例子挺多的，自己试一下才能更好理解：<a href="https://www.runoob.com/css/css-examples.html">CSS 实例 | 菜鸟教程 (runoob.com)</a></p><p>关于CSS的书写格式，github上也有一个中文版指南：<a href="https://github.com/Zhangjd/css-style-guide">Zhangjd&#x2F;css-style-guide: A mostly reasonable approach to CSS and Sass. (github.com)</a></p><p>关于缩进的问题，我用的vscode回车就是hard tabs而不是soft tabs（两个空格），不过似乎也没影响，就先这样吧…..</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;前一篇笔记介绍了HTML的基础，这一篇主要记录下CSS的基础知识。&lt;/p&gt;</summary>
    
    
    
    <category term="个人主页" scheme="http://www.shelven.com/categories/%E4%B8%AA%E4%BA%BA%E4%B8%BB%E9%A1%B5/"/>
    
    <category term="编程自学" scheme="http://www.shelven.com/categories/%E7%BC%96%E7%A8%8B%E8%87%AA%E5%AD%A6/"/>
    
    
    <category term="CSS" scheme="http://www.shelven.com/tags/CSS/"/>
    
  </entry>
  
  <entry>
    <title>HTML、CSS和JavaScript入门（1）——HTML基础</title>
    <link href="http://www.shelven.com/2023/09/28/a.html"/>
    <id>http://www.shelven.com/2023/09/28/a.html</id>
    <published>2023-09-28T15:35:43.000Z</published>
    <updated>2023-10-06T07:16:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>不知不觉用Hexo建站也快一年半了，以前下载安装Node.js、搭建Hexo博客和使用volantis主题，以及到最后部署到服务器上，这一系列流程都是跟着教程和volantis的中文社区操作，因为自己是纯小白，属于两眼一抹黑干就完事了的那种。遇到bug也是各种百度谷歌，别人咋改文件自己跟着改，也完全不懂其中原理。</p><span id="more"></span><p>后来因为课题需要接触到编程，才慢慢有了美化网站的想法（虽然现在也不好看，主要是因为没时间整hhhh）。作为一个小白，看到网上动辄十几个小时的编程教程真的头疼，自己只是需要了解基本概念，会用就行，不需要学太深，所以有了这篇纯入门笔记。</p><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><div class="story post-story"><p>要学习前端web开发，首先需要了解和学习下面这些技术：</p><ol><li><strong>HTML（HyperText Markup Language）</strong>：HTML是用于定义网页结构和内容的<strong>标记语言</strong>。它用于创建网页的各种元素，如标题、段落、链接、图像等。</li><li><strong>CSS（Cascading Style Sheets）</strong>：CSS用于控制网页的样式和布局。通过CSS，用来设置设置网页的字体、颜色、大小、布局等各种外观属性。</li><li><strong>JavaScript</strong>：JavaScript是一种用于网页交互和动态效果的脚本语言。它可以通过操作网页元素、处理用户输入和响应事件等来实现交互性和动态性。</li></ol><p><strong>简单来说，把web前端开发比喻成我的世界这款游戏的话，HTML就是游戏实际中的地形、各种方块等实体，CSS就像游戏中的纹理包和材质，而JavaScript就是游戏中的逻辑和行为，控制方块和实体的移动、交互碰撞等行为。</strong></p><p>以上是基础中的基础，真正要学web开发，还要学习前端框架和库如React、Vue.js，会用前端构建工具像是Webpack、Vite来构建打包前端项目，需要学习网络和HTTP协议以便更好和后端交互，还要考虑移动端优化、跨浏览器兼容性等等……万丈高楼平地起，没有基础其他的都是空中楼阁。</p><p>我这里用vscode做为集成开发环境，安装了以下插件：</p><ul><li><ol><li>Live Server：可以在浏览器中<strong>实时预览网页</strong>，安装后只需要在对应的html文件右键，选择Open With Live Server即可在本地浏览器快速打开，编辑文件后会自动刷新浏览器。</li></ol></li></ul><p><img src="https://www.shelven.com/tuchuang/20230928/live.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/live.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li><ol start="2"><li>HTML CSS Support：根据输入内容和上下文，当你输入HTML标签或者CSS属性的时候，自动显示可能的选项（省去html文件和css文件之间反复切换）。</li></ol></li></ul><p><img src="https://www.shelven.com/tuchuang/20230928/HTML.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/HTML.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li><ol start="3"><li>Auto Rename Tag：自动重命名标签，修改一侧标签后同步修改另一侧标签。</li></ol></li></ul><p><img src="https://www.shelven.com/tuchuang/20230928/Auto.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/Auto.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li><ol start="4"><li>JavaScript（ES6） code snippets：支持JavaScript和TypeScript快速生成代码和语法提示。</li></ol></li></ul><p><img src="https://www.shelven.com/tuchuang/20230928/JS.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/JS.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div><h2 id="2-HTML5"><a href="#2-HTML5" class="headerlink" title="2. HTML5"></a>2. HTML5</h2><div class="story post-story"><h3 id="2-1-HTML基础"><a href="#2-1-HTML基础" class="headerlink" title="2.1 HTML基础"></a>2.1 HTML基础</h3><p>HTML5是HTML出的第五个版本，HTML5方便书写、精简，也便于阅读和理解，以下均以HTML5为例。</p><p>在vscode中新建一个<code>index.html</code>文件，输入英文的<code>!</code>并按下tab键补全，就会出现最基础的HTML5代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><code>&lt;!DOCTYPE html&gt;</code>声明为HTML5文档</p><p><code>&lt;html&gt;</code>元素是HTML页面的根元素，所有元素都在根元素内</p><p><code>&lt;head&gt;</code>元素包含了文档的元数据（meta），链接工程内的css文件，为搜索引擎提供网站描述、关键词等数据。这部分内容<strong>是不可见的</strong>，比如：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;字符集&quot;</span>&gt;</span> 指定字符编码集，如UTF-8 </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;描述内容&quot;</span>&gt;</span> 定义文档描述，通常用于搜索引擎的摘要显示</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">content</span>=<span class="string">&quot;关键词列表&quot;</span>&gt;</span> 定义文档关键词，指定文档关键词或者标签，有助于搜索引擎的索引和分类</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span> <span class="attr">content</span>=<span class="string">&quot;作者名称&quot;</span>&gt;</span> 定义文档作者</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span> 定义视口(viewpoint)位置，用于控制网页在移动设备的显示和缩放行为</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attr">content</span>=<span class="string">&quot;秒数; URL=重定向URL&quot;</span>&gt;</span> 定义文档刷新或者重定向</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>描述文档标题（标题页显示的内容）<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;样式表路径&quot;</span>&gt;</span>引入外部样式表，这个在css引入里再说</span><br></pre></td></tr></table></figure><p><code>&lt;body&gt;</code>元素包括了所有<strong>可见的</strong>页面内容</p></blockquote><p>从上面的例子可以看到，HTML不是一种编程语言，而是一种<strong>标记语言</strong>，标记语言有自己的一套标记标签(tag)，标签由一对尖括号包围，且通常是<strong>成对</strong>出现的，比如<code>&lt;p&gt;这里是内容&lt;/p&gt;</code>，开始标签和结束标签也称为开放标签和闭合标签。</p><p>也有一些标签是自闭和的，比如上面的<code>&lt;meta&gt;、&lt;title&gt;、&lt;link&gt;</code>，还有<code>&lt;br&gt;（换行）</code>、<code>&lt;hr&gt;（水平分隔线）</code>、<code>&lt;input&gt;（输入控件）</code>、<code>&lt;image&gt;（插入图片）</code>、<code>&lt;area&gt;（定义可点击的区域）</code>，他们不需要闭合因为他们本身就不需要内容。</p><p>顺便说一句，在vscode中，<code>ctrl+/</code>可以快速注释当前行内容；块注释可以选中代码后<code>alt+shift+A</code>；<code>alt+shift+↓</code>可以快速复制当前行内容到下一行（选中多行代码同理）；在html文件中，输入小写字母再按tab键，<strong>会自动补齐开始和结束标签</strong>，算是提高编程效率的小技巧……</p><p>现在就可以右键<code>index.html</code>文件，选择<code>Open With Live Server</code>，<code>win+→</code>把网页放在屏幕右边，就可以同屏查看代码和网页了。</p><p><img src="https://www.shelven.com/tuchuang/20230928/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="2-2-常用标签和属性"><a href="#2-2-常用标签和属性" class="headerlink" title="2.2 常用标签和属性"></a>2.2 常用标签和属性</h3><p>标题标签，通过<code>&lt;h1&gt;</code>到<code>&lt;h6&gt;</code>来定义：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是标题 1<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>这是标题 2<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>这是标题 3<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>这是标题 4<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h5</span>&gt;</span>这是标题 5<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h6</span>&gt;</span>这是标题 6<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230928/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>段落标签，通过<code>&lt;P&gt;</code>标签定义：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        Lorem ipsum dolor sit amet consectetur adipisicing elit. Repudiandae quia alias tempore natus perspiciatis commodi sapiente fugit ducimus id, in ut deleniti sint sequi explicabo, totam pariatur quidem. Non, quis?</span><br><span class="line">        Lorem 会输出占位用的无意义内容</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>标签可以是<strong>行内元素</strong>或者<strong>块级元素</strong>，行级元素之间不会新起一段，其所占空间与内容本身大小有关，块级元素会新起一段。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!-- 这是一个注释，不会显示 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        行级元素不会新起一段，比如</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>span（创建行内的容器）<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">decoding</span>=<span class="string">&quot;async&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://www.shelven.com/tuchuang/avatar.jpg&quot;</span> <span class="attr">width</span>=<span class="string">&quot;50&quot;</span>&gt;</span>img</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.shelven.com&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>a(链接标签)<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">strong</span>&gt;</span>strong加粗<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">em</span>&gt;</span>em斜体<span class="tag">&lt;/<span class="name">em</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        块级元素会新起一段，占据当前给定行的百分百宽度，包括</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>div标签<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h6</span>&gt;</span>h标签<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>p标签<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span>&gt;</span>form标签<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230928/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><code>&lt;span&gt;</code>和<code>&lt;div&gt;</code>这两个标签在HTML页面结构布局中比较重要，两者都没有特定的含义，<code>&lt;span&gt;</code>通常用来包裹文本和其他行内元素，<code>&lt;div&gt;</code>通常用来容纳其他块级元素或者行内元素。</p><p>在上面的例子中，标签内的比如decoding、href这样的信息称为HTML元素的<strong>属性</strong>，属性是以名称键值对的形式出现的，且都是放在开始标签中，而属性值不管是数字还是字符串，都要<strong>包括在引号内（首选双引号）</strong>。</p><blockquote><p>适用于大多数HTML标签的属性：</p><ul><li>class 为html元素定义类名（这个类名由css文件引入），方便器选择，<strong>可以写多个</strong></li><li>id 为html元素定义<strong>唯一</strong>的id值，也是方便选择器选择</li><li>hidden 隐藏html元素</li><li>style 规定元素的行内样式（内联样式），css导入中会详细说</li><li>title 为元素提供额外信息，比如用在a标签，鼠标悬停会显示的信息</li></ul><p>顺便提下，上面例子超链接的两种导入方式，<strong>hre</strong>f是超文本引用，建立文档与资源之间的关系，常用在link、a标签中；<strong>src</strong>是将指向的资源直接下载并用到当前页面，常用在script、img标签中。</p></blockquote><p>要让行级元素换行或者同一个段落内的内容换行，可以插入块级元素，或者是加入<code>&lt;br&gt;（换行）</code>或者<code>&lt;hr&gt;（插入水平线）</code>标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        这是一个段落<span class="tag">&lt;<span class="name">br</span>&gt;</span>这是另一个段落<span class="tag">&lt;<span class="name">hr</span>&gt;</span>接着再来一段</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230928/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="2-3-列表样式和表格"><a href="#2-3-列表样式和表格" class="headerlink" title="2.3 列表样式和表格"></a>2.3 列表样式和表格</h3><p>html的列表样式主要有两种：前面有个点的<strong>无序列表</strong>和带有数字排序的有序列表：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 无序列表ul标签 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>无序列表项1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>无序列表项2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>无序列表项3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>无序列表项4<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 有序列表ol标签 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>有序列表项1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>有序列表项2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>有序列表项3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>有序列表项4<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230928/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>表格标签为<code>&lt;table&gt;</code>，对应的分为<code>表头&lt;thead&gt;</code>和<code>表体&lt;tbody&gt;</code>。表头和表体都有行与列的概念，行在两者中都是<code>&lt;tr&gt;</code>标签，列在表头中标签为<code>&lt;th&gt;</code>，在表体中标签为<code>&lt;td&gt;</code>:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>年龄<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>qq<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>phantom<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>28<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>1021618642<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>aria<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>26<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>1269035311<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230928/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>可以看到浏览器会把表头显示为粗体居中的文本，其他和表体没啥区别。</p><h3 id="2-4-表单"><a href="#2-4-表单" class="headerlink" title="2.4 表单"></a>2.4 表单</h3><p>表单是收集用户输入信息的工具，可以通过<code>&lt;form&gt;</code>标签创建，需要注意，html表单<strong>只能给外观不能给功能</strong>，功能实现需要javascript，或者写一个php服务器端脚本来接收参数。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- label定义input内容的标签 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>账号:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- input ype=&quot;text&quot;输入框可以输入文本 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>密码:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- input type=&quot;password&quot;输入框不会明文显示 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>文本域<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- textarea是确定一个文本域 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;输入框&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;50&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>性别<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- select是给出一个下拉框 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;选项&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;male&quot;</span>&gt;</span>男<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;female&quot;</span>&gt;</span>女<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;unknow&quot;</span>&gt;</span>未知<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- input type=&quot;radio&quot;提供一个单选框 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;female&quot;</span>&gt;</span>女</span><br><span class="line">        <span class="comment">&lt;!-- input type=&quot;checkbox&quot;提供一个复选框 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;male&quot;</span>&gt;</span>男</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span> <span class="attr">value</span>=<span class="string">&quot;female&quot;</span>&gt;</span>女</span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230928/8.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="2-5-iframe"><a href="#2-5-iframe" class="headerlink" title="2.5 iframe"></a>2.5 iframe</h3><p>也就是HTML的框架，一个网页中可以嵌套别的网页，不过大部分的浏览器对嵌套层数是有限制的，一般都用不到：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;https://www.shelven.com&quot;</span> <span class="attr">width</span>=<span class="string">&quot;800&quot;</span> <span class="attr">height</span>=<span class="string">&quot;600&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230928/9.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/9.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>每个iframe都要加载和渲染独立的文档，过多的嵌套会增加加载时间和资源消耗，页面太复杂用户体验也会不好&#x3D; &#x3D;</p><p>简单地把iframe和div结合一下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;container&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 800px;height: 600px;text-align: center;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;header&quot;</span> <span class="attr">style</span>=<span class="string">&quot;background-color:#0099ff;height: 50px;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span> &gt;</span>我的小破站<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;menu&quot;</span> <span class="attr">style</span>=<span class="string">&quot;background-color:#ff00b3;height:400px;width:100px;float:left;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.shelven.com/&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>菜单<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.shelven.com/categories/&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>分类<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.shelven.com/tags/&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>标签<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.shelven.com/archives/&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>归档<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content&quot;</span> <span class="attr">style</span>=<span class="string">&quot;background-color:#EEEEEE;height: 400px;width: 700px;float:left;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;https://www.shelven.com&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;700&quot;</span> <span class="attr">height</span>=<span class="string">&quot;400&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;footer&quot;</span> <span class="attr">style</span>=<span class="string">&quot;background-color:#00ff0d;height: 50px;clear:both;text-align:center;font-size: large;&quot;</span>&gt;</span></span><br><span class="line">        萌ICP备20220246号 浙ICP备2022010847号</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>大概就是这样的布局：</p><p><img src="https://www.shelven.com/tuchuang/20230928/10.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/10.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>有了以上HTML的基础概念，后面CSS的引入就比较容易理解了。</p></div><h2 id="2023-x2F-10-x2F-5更新"><a href="#2023-x2F-10-x2F-5更新" class="headerlink" title="2023&#x2F;10&#x2F;5更新"></a>2023&#x2F;10&#x2F;5更新</h2><div class="story post-story"><p>发现一个很好用的vscode插件：</p><p><img src="https://www.shelven.com/tuchuang/20230928/111.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230928/111.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>该插件可以用来格式化css和js文件，可能你从别的项目中拷贝的js&#x2F;css文件是一行显示的，打开一大坨不方便阅读。下载这个插件以后，在对应的文件中按<strong>shift + alt + F</strong>，选择格式化方法为Prettier，可以快速格式化文件。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;不知不觉用Hexo建站也快一年半了，以前下载安装Node.js、搭建Hexo博客和使用volantis主题，以及到最后部署到服务器上，这一系列流程都是跟着教程和volantis的中文社区操作，因为自己是纯小白，属于两眼一抹黑干就完事了的那种。遇到bug也是各种百度谷歌，别人咋改文件自己跟着改，也完全不懂其中原理。&lt;/p&gt;</summary>
    
    
    
    <category term="个人主页" scheme="http://www.shelven.com/categories/%E4%B8%AA%E4%BA%BA%E4%B8%BB%E9%A1%B5/"/>
    
    <category term="编程自学" scheme="http://www.shelven.com/categories/%E7%BC%96%E7%A8%8B%E8%87%AA%E5%AD%A6/"/>
    
    
    <category term="HTML" scheme="http://www.shelven.com/tags/HTML/"/>
    
  </entry>
  
  <entry>
    <title>R基础入门——基本语法和作图</title>
    <link href="http://www.shelven.com/2023/09/26/a.html"/>
    <id>http://www.shelven.com/2023/09/26/a.html</id>
    <published>2023-09-26T11:34:48.000Z</published>
    <updated>2023-09-26T11:38:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>整理笔记的时候翻到两年前做的R入门笔记，还记得21年冬天那个时候是第一次接触R，华中农业大学的孔秋生教授来塔里木大学做的R语言讲座。两年了有些东西过时了，整理下做个备份吧~顺便回头复习复习，温故而知新 ^_^</p><span id="more"></span><h2 id="1-R是什么"><a href="#1-R是什么" class="headerlink" title="1. R是什么"></a>1. R是什么</h2><div class="story post-story"><p><strong>R</strong>是一种用于统计计算和数据分析的编程语言。它提供了广泛的统计和图形功能，以及丰富的数据处理和建模工具。R具有强大的数据处理能力和丰富的统计函数库，被广泛应用于学术研究、数据科学、金融分析、生物医学等领域。</p><p><strong>RStudio</strong>是一个集成开发环境（Integrated Development Environment，IDE），用于编写、运行和调试R语言代码。它提供了许多功能和工具，旨在提高R语言开发的效率和便利性。说白了，我们是在Rstudio中编写和运行R语言代码。</p><p>当然，这个集成开发环境不是唯一的，我们也可以在比如vscode中调试运行。Rstudio只是提供一个为新手入门提供一个友好的界面，熟练后甚至可以不用集成开发环境，比如在linux中也可以运行，这就是后话了。</p></div><h2 id="2-前期准备和一些基础认识"><a href="#2-前期准备和一些基础认识" class="headerlink" title="2. 前期准备和一些基础认识"></a>2. 前期准备和一些基础认识</h2><div class="story post-story"><p>先安装R，再安装Rstudio，顺序不能反，否则可能会提示找不到R在什么地方…</p><p>R官网：<a href="https://www.r-project.org/">R: The R Project for Statistical Computing (r-project.org)</a></p><p>Rstudio官网（现在已经改名为Posit，还真不习惯）：<a href="https://posit.co/">Posit | The Open-Source Data Science Company</a></p><p>全部安装好，进入Rstudio后，点击菜单栏<strong>Tools</strong>，下拉框的<strong>Global Options</strong>，这里可以修改全局设置。主要修改的是自己的工作目录（也可以在代码中修改），我顺便改了四个窗口的布局（在<strong>Pane Layout</strong>中修改）：</p><p><img src="https://www.shelven.com/tuchuang/20230926/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><blockquote><ul><li><ol><li>Source窗口：写R代码的窗口，也可以在3窗口（console）写，个人习惯</li></ol></li><li><ol start="2"><li>Environment、History等窗口：可以看到代码运行过程中生成的变量、自己的历史命令等等</li></ol></li><li><ol start="3"><li>Console窗口：R语言的交互式控制台，可以逐行输入和执行R代码，并立即看到结果，ctrl+L可以清屏</li></ol></li><li><ol start="4"><li>Files、Plot等窗口，前者可以看当前工作环境的文件，后者看到绘制的图</li></ol></li></ul></blockquote><p>2和4窗口有多个选项供选择，我用的比较多的是这些，仅供参考。</p><p>对于1和3码代码的窗口部分，对于<strong>有较大代码块或者需要保存和重复的代码，建议用Source窗口，运行每一行需要Ctrl+回车</strong>；而<strong>对于简单的代码测试、快速计算或者做交互式探索的话，可以选择在Console窗口，回车就可以运行</strong>。</p><p>R语言要调用的软件包在CRAN仓库中，我们可以在以下R包官网中找到你需要的R包，<strong>以及各R包的参数、用法</strong>。</p><p><a href="https://cran.r-project.org/web/packages/">CRAN - Contributed Packages (r-project.org)</a></p><p>在Rstudio中，你可以通过菜单栏<strong>Tools</strong>，下拉框的第一个<strong>Install Packages</strong>窗口，输入你想要安装的R包，点击install安装：</p><p><img src="https://www.shelven.com/tuchuang/20230926/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>以上是认识R和Rstudio的最基础的知识，下面主要讲讲R代码的语法和作图的一些示例。</p></div><h2 id="3-R代码基础语法"><a href="#3-R代码基础语法" class="headerlink" title="3. R代码基础语法"></a>3. R代码基础语法</h2><div class="story post-story"><p><strong>再次申明这是入门写的笔记，不会介绍很详细</strong>，完整的可以看官方手册<a href="https://cran.r-project.org/doc/manuals/r-release/R-intro.html#Preface">An Introduction to R (r-project.org)</a></p><p>为了方便展示运行结果，以下运行结果前均以两个井号##开头。</p><h3 id="3-1-数据类型"><a href="#3-1-数据类型" class="headerlink" title="3.1 数据类型"></a>3.1 数据类型</h3><p>常用的数据类型有<strong>数值型(numeric)<strong>，</strong>字符型(character)<strong>，</strong>逻辑型（logical）</strong>。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a <span class="operator">=</span> <span class="number">123</span>    <span class="comment"># =赋值，&lt;-也可以赋值，R官方社区用&lt;-较多，自己取舍。#表示注释，不会运行</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span>    <span class="comment"># class()确定括号内数据类型</span></span><br><span class="line"><span class="comment">## [1] &quot;numeric&quot;</span></span><br><span class="line"></span><br><span class="line">a <span class="operator">=</span> <span class="string">&quot;123&quot;</span>    <span class="comment"># 赋值为字符型加双引号，与代码相关的都是英文字符</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;character&quot;</span></span><br><span class="line"></span><br><span class="line">a <span class="operator">=</span> <span class="literal">TRUE</span>    <span class="comment"># 逻辑型包括TRUE/FALSE/T/F</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;logical&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-数据结构"><a href="#3-2-数据结构" class="headerlink" title="3.2 数据结构"></a>3.2 数据结构</h3><p>在R中，向量是一种基本的数据结构，用于存储一系列<strong>相同类型的元素</strong>。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向量vector c()这个函数用来创建向量</span></span><br><span class="line"><span class="comment"># 数值型向量</span></span><br><span class="line">a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">)</span>      <span class="comment"># 数值之间逗号间隔</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;numeric&quot;</span></span><br><span class="line"></span><br><span class="line">seq<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span>    <span class="comment"># seq()序列函数</span></span><br><span class="line"><span class="comment">## [1] 1 2 3 4 5</span></span><br><span class="line">seq<span class="punctuation">(</span>from <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> to <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> by <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span>    <span class="comment"># by表示步长</span></span><br><span class="line"><span class="comment">## [1] 1.0 1.5 2.0 2.5 3.0</span></span><br><span class="line"><span class="number">1</span><span class="operator">:</span><span class="number">10</span>    <span class="comment"># x:x也可以表示序列</span></span><br><span class="line"><span class="comment">## [1]  1  2  3  4  5  6  7  8  9 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符型向量</span></span><br><span class="line">a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;character&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">letters</span>    <span class="comment"># 26个小写英文字母顺序排列</span></span><br><span class="line"><span class="comment">## [1] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot; &quot;g&quot; &quot;h&quot; &quot;i&quot; &quot;j&quot; &quot;k&quot; &quot;l&quot; &quot;m&quot; &quot;n&quot; &quot;o&quot; &quot;p&quot; &quot;q&quot; &quot;r&quot; &quot;s&quot; &quot;t&quot; &quot;u&quot; &quot;v&quot; &quot;w&quot; &quot;x&quot; &quot;y&quot; &quot;z&quot;</span></span><br><span class="line"><span class="built_in">LETTERS</span>    <span class="comment"># 26个大写英文字母顺序排列</span></span><br><span class="line"><span class="comment">## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot; &quot;D&quot; &quot;E&quot; &quot;F&quot; &quot;G&quot; &quot;H&quot; &quot;I&quot; &quot;J&quot; &quot;K&quot; &quot;L&quot; &quot;M&quot; &quot;N&quot; &quot;O&quot; &quot;P&quot; &quot;Q&quot; &quot;R&quot; &quot;S&quot; &quot;T&quot; &quot;U&quot; &quot;V&quot; &quot;W&quot; &quot;X&quot; &quot;Y&quot; &quot;Z&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逻辑型向量</span></span><br><span class="line">a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">T</span><span class="punctuation">,</span><span class="literal">TRUE</span><span class="punctuation">,</span><span class="built_in">F</span><span class="punctuation">,</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;logical&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-3-向量数据操作"><a href="#3-3-向量数据操作" class="headerlink" title="3.3 向量数据操作"></a>3.3 向量数据操作</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rep()重复</span></span><br><span class="line"><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> times <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span>    <span class="comment"># 1到3重复3次</span></span><br><span class="line"><span class="comment">## [1] 1 2 3 1 2 3 1 2 3 1 2 3</span></span><br><span class="line"><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> each <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span>    <span class="comment"># 1到3每个数字重复三次</span></span><br><span class="line"><span class="comment">## [1] 1 1 1 1 2 2 2 2 3 3 3 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># paste()组合</span></span><br><span class="line">paste<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span>    <span class="comment"># 默认组合中间有空格</span></span><br><span class="line"><span class="comment">## [1] &quot;1 A&quot; &quot;2 B&quot; &quot;3 C&quot;</span></span><br><span class="line">paste0<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">       <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span>    <span class="comment"># 去掉组合中间空格</span></span><br><span class="line"><span class="comment">## [1] &quot;1A&quot; &quot;2B&quot; &quot;3C&quot;</span></span><br><span class="line">paste<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>    <span class="comment"># 换行注意逗号不要漏</span></span><br><span class="line">      sep <span class="operator">=</span> <span class="string">&quot;/&quot;</span><span class="punctuation">)</span>    <span class="comment"># 自定义连接组合的符号</span></span><br><span class="line"><span class="comment">## [1] &quot;1/A&quot; &quot;2/B&quot; &quot;3/C&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##练习：3个处理ABC，3个重复</span></span><br><span class="line">paste0<span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> each <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> times <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;A1&quot; &quot;A2&quot; &quot;A3&quot; &quot;B1&quot; &quot;B2&quot; &quot;B3&quot; &quot;C1&quot; &quot;C2&quot; &quot;C3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># []索引，注意索引第一位是1而不是0</span></span><br><span class="line">a <span class="operator">=</span> <span class="number">2</span><span class="operator">:</span><span class="number">10</span></span><br><span class="line">a<span class="punctuation">[</span><span class="number">5</span><span class="punctuation">]</span>    <span class="comment"># a向量中第5个数</span></span><br><span class="line"><span class="comment">## [1] 6</span></span><br><span class="line">a<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span>    <span class="comment"># a向量第1-3个数</span></span><br><span class="line"><span class="comment">## [1] 2 3 4</span></span><br><span class="line">a<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">]</span>    <span class="comment"># a向量第1，4，5个数</span></span><br><span class="line"><span class="comment">## [1] 2 5 6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逻辑操作符</span></span><br><span class="line"><span class="comment"># &amp;与；|或；!非</span></span><br><span class="line">a<span class="punctuation">[</span>a<span class="operator">&gt;</span><span class="number">5</span><span class="punctuation">]</span>    <span class="comment"># a向量中比5大的数</span></span><br><span class="line"><span class="comment">## [1]  6  7  8  9 10</span></span><br><span class="line">a<span class="punctuation">[</span>a<span class="operator">&gt;</span><span class="number">5</span> <span class="operator">&amp;</span> a<span class="operator">&lt;</span><span class="number">8</span><span class="punctuation">]</span>    <span class="comment"># a向量中大于5且小于8的数</span></span><br><span class="line"><span class="comment">## [1] 6 7</span></span><br><span class="line">a<span class="punctuation">[</span>a<span class="operator">&gt;</span><span class="number">5</span> <span class="operator">|</span> a<span class="operator">&lt;</span><span class="number">3</span><span class="punctuation">]</span>    <span class="comment"># a向量中大于5或小于3的数</span></span><br><span class="line"><span class="comment">## [1]  2  6  7  8  9 10</span></span><br><span class="line">a<span class="punctuation">[</span>a<span class="operator">!=</span><span class="number">8</span><span class="punctuation">]</span>    <span class="comment"># a向量中不包括8的值</span></span><br><span class="line"><span class="comment">## [1]  2  3  4  5  6  7  9 10</span></span><br></pre></td></tr></table></figure><h3 id="3-4-向量计算"><a href="#3-4-向量计算" class="headerlink" title="3.4 向量计算"></a>3.4 向量计算</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># +, -, *, /  加减乘除正常计算</span></span><br><span class="line"><span class="number">2</span> <span class="operator">*</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span></span><br><span class="line"><span class="comment">## [1] 2 4 6</span></span><br><span class="line"><span class="number">1</span><span class="operator">:</span><span class="number">3</span> <span class="operator">*</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span>    <span class="comment"># 两个向量分别相乘</span></span><br><span class="line"><span class="comment">## [1] 1 4 9</span></span><br><span class="line"><span class="number">2</span><span class="operator">:</span><span class="number">5</span> <span class="operator">+</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span>    <span class="comment"># 注意两个向量长度不同，计算方式不同，最后一个是5+1得到的</span></span><br><span class="line"><span class="comment">## [1] 3 5 7 6</span></span><br><span class="line"><span class="comment">## Warning message:</span></span><br><span class="line"><span class="comment">## In 2:5 + 1:3 :</span></span><br><span class="line"><span class="comment">##   longer object length is not a multiple of shorter object length</span></span><br></pre></td></tr></table></figure><h3 id="3-5-向量类型转换"><a href="#3-5-向量类型转换" class="headerlink" title="3.5 向量类型转换"></a>3.5 向量类型转换</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># as.+数据类型()</span></span><br><span class="line">a <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;integer&quot;</span></span><br><span class="line"><span class="comment"># as.character() 转换字符型数据</span></span><br><span class="line">b <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line">b</span><br><span class="line"><span class="comment">## [1] &quot;1&quot; &quot;2&quot; &quot;3&quot;</span></span><br><span class="line"><span class="comment"># as.numeric() 转换数值型数据</span></span><br><span class="line"><span class="built_in">c</span> <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>b<span class="punctuation">)</span>  </span><br><span class="line"><span class="built_in">c</span></span><br><span class="line"><span class="comment">## [1] 1 2 3</span></span><br><span class="line"><span class="comment"># as.logical() 转换逻辑型数据</span></span><br><span class="line">d <span class="operator">=</span> <span class="built_in">as.logical</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">)</span></span><br><span class="line">d</span><br><span class="line"><span class="comment">## [1] TRUE TRUE TRUE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习：产生5个大写字母</span></span><br><span class="line">a <span class="operator">=</span> <span class="built_in">LETTERS</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">5</span><span class="punctuation">]</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;character&quot;</span></span><br><span class="line">a</span><br><span class="line"><span class="comment">## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot; &quot;D&quot; &quot;E&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习：产生4对T,F</span></span><br><span class="line">a <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">T</span><span class="punctuation">,</span><span class="built_in">F</span><span class="punctuation">)</span><span class="punctuation">,</span> times <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;logical&quot;</span></span><br><span class="line"><span class="built_in">as.numeric</span><span class="punctuation">(</span>a<span class="punctuation">)</span>    <span class="comment"># TRUE数值为1，FALSE数值为0</span></span><br><span class="line"><span class="comment">## [1] 1 0 1 0 1 0 1 0</span></span><br><span class="line"><span class="built_in">as.character</span><span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] &quot;TRUE&quot;  &quot;FALSE&quot; &quot;TRUE&quot;  &quot;FALSE&quot; &quot;TRUE&quot;  &quot;FALSE&quot; &quot;TRUE&quot;  &quot;FALSE&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-6-常用计算函数"><a href="#3-6-常用计算函数" class="headerlink" title="3.6 常用计算函数"></a>3.6 常用计算函数</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mean<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span>    <span class="comment"># 平均数</span></span><br><span class="line"><span class="comment">## [1] 5.5</span></span><br><span class="line">sd<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span>    <span class="comment"># 标准差</span></span><br><span class="line"><span class="comment">## [1] 3.02765</span></span><br><span class="line"><span class="built_in">max</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span>    <span class="comment"># 最大值</span></span><br><span class="line"><span class="comment">## [1] 10</span></span><br><span class="line"><span class="built_in">range</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span>    <span class="comment"># 最小值和最大值</span></span><br><span class="line"><span class="comment">## [1]  1 10</span></span><br><span class="line"><span class="built_in">length</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span>    <span class="comment"># 长度</span></span><br><span class="line"><span class="comment">## [1] 10</span></span><br><span class="line"><span class="built_in">length</span><span class="punctuation">(</span><span class="built_in">letters</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## [1] 26</span></span><br></pre></td></tr></table></figure><h3 id="3-7-矩阵（matrix）"><a href="#3-7-矩阵（matrix）" class="headerlink" title="3.7 矩阵（matrix）"></a>3.7 矩阵（matrix）</h3><p>矩阵是一种二维数据结构，由行和列组成，其中每个元素有<strong>相同的数据类型</strong>。矩阵可以看成是向量的拓展。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># matrix(data = NA, nrow = 1, ncol = 1, byrow = FALSE, dimnames = NULL)</span></span><br><span class="line"><span class="comment"># data：矩阵的元素，默认为NA，即未给出元素值的话，各项为NA</span></span><br><span class="line"><span class="comment"># nrow：矩阵的行数，默认为1，可简写nr</span></span><br><span class="line"><span class="comment"># ncol：矩阵的列数，默认为1，可简写nc</span></span><br><span class="line"><span class="comment"># byrow：元素是否按行填充，默认按列</span></span><br><span class="line"><span class="comment"># dimnames：以字符型向量表示的行名及列名</span></span><br><span class="line">a <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">12</span></span><br><span class="line">matrix<span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line"><span class="comment">##       [,1]</span></span><br><span class="line"><span class="comment">## [1,]    1</span></span><br><span class="line"><span class="comment">## [2,]    2</span></span><br><span class="line"><span class="comment">## [3,]    3</span></span><br><span class="line"><span class="comment">## [4,]    4</span></span><br><span class="line"><span class="comment">## [5,]    5</span></span><br><span class="line"><span class="comment">## [6,]    6</span></span><br><span class="line"><span class="comment">## [7,]    7</span></span><br><span class="line"><span class="comment">## [8,]    8</span></span><br><span class="line"><span class="comment">## [9,]    9</span></span><br><span class="line"><span class="comment">##[10,]   10</span></span><br><span class="line"><span class="comment">##[11,]   11</span></span><br><span class="line"><span class="comment">##[12,]   12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数值型矩阵</span></span><br><span class="line">a <span class="operator">=</span> matrix<span class="punctuation">(</span>a<span class="punctuation">,</span></span><br><span class="line">           nr <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span>    <span class="comment"># nrow可以不写</span></span><br><span class="line">           byrow <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span>    <span class="comment"># 先行后列形式填充</span></span><br><span class="line">a</span><br><span class="line"><span class="comment">##      [,1] [,2] [,3] [,4]</span></span><br><span class="line"><span class="comment">## [1,]    1    2    3    4</span></span><br><span class="line"><span class="comment">## [2,]    5    6    7    8</span></span><br><span class="line"><span class="comment">## [3,]    9   10   11   12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符型矩阵</span></span><br><span class="line">matrix<span class="punctuation">(</span><span class="built_in">LETTERS</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">12</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">       ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##      [,1] [,2] [,3]</span></span><br><span class="line"><span class="comment">## [1,] &quot;A&quot;  &quot;E&quot;  &quot;I&quot; </span></span><br><span class="line"><span class="comment">## [2,] &quot;B&quot;  &quot;F&quot;  &quot;J&quot; </span></span><br><span class="line"><span class="comment">## [3,] &quot;C&quot;  &quot;G&quot;  &quot;K&quot; </span></span><br><span class="line"><span class="comment">## [4,] &quot;D&quot;  &quot;H&quot;  &quot;L&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 行/列名  使用行数和列数相等的向量命名</span></span><br><span class="line">colnames<span class="punctuation">(</span>a<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;第一列&quot;</span><span class="punctuation">,</span><span class="string">&quot;第二列&quot;</span><span class="punctuation">,</span><span class="string">&quot;第三列&quot;</span><span class="punctuation">,</span><span class="string">&quot;第四列&quot;</span><span class="punctuation">)</span></span><br><span class="line">a</span><br><span class="line"><span class="comment">##      第一列 第二列 第三列 第四列</span></span><br><span class="line"><span class="comment">## [1,]      1      2      3      4</span></span><br><span class="line"><span class="comment">## [2,]      5      6      7      8</span></span><br><span class="line"><span class="comment">## [3,]      9     10     11     12</span></span><br><span class="line">row.names<span class="punctuation">(</span>a<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">LETTERS</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line">a</span><br><span class="line"><span class="comment">##   第一列 第二列 第三列 第四列</span></span><br><span class="line"><span class="comment">## A      1      2      3      4</span></span><br><span class="line"><span class="comment">## B      5      6      7      8</span></span><br><span class="line"><span class="comment">## C      9     10     11     12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据过滤（提取）</span></span><br><span class="line">a<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="comment"># 提取矩阵第一行</span></span><br><span class="line"><span class="comment">## 第一列 第二列 第三列 第四列 </span></span><br><span class="line"><span class="comment">##     1      2      3      4 </span></span><br><span class="line">a<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">,</span><span class="punctuation">]</span>    </span><br><span class="line"><span class="comment">##   第一列 第二列 第三列 第四列</span></span><br><span class="line"><span class="comment">## A      1      2      3      4</span></span><br><span class="line"><span class="comment">## B      5      6      7      8</span></span><br><span class="line">a<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="comment"># 删除矩阵第一行</span></span><br><span class="line"><span class="comment">##   第一列 第二列 第三列 第四列</span></span><br><span class="line"><span class="comment">## B      5      6      7      8</span></span><br><span class="line"><span class="comment">## C      9     10     11     12</span></span><br></pre></td></tr></table></figure><h3 id="3-8-数据框（Data-Frame）"><a href="#3-8-数据框（Data-Frame）" class="headerlink" title="3.8 数据框（Data Frame）"></a>3.8 数据框（Data Frame）</h3><p>数据框是R语言中另一种常见的二维数据结构，它<strong>可以存储不同类型的数据</strong>，比如数值、字符、因子（factor）等等，并且每一列可以有不同的长度。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">data.frame<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">12</span><span class="punctuation">,</span><span class="number">5</span><span class="operator">:</span><span class="number">8</span><span class="punctuation">)</span>    <span class="comment"># 注意行数不同，填充方式不同</span></span><br><span class="line"><span class="comment">##    X1.12 X5.8</span></span><br><span class="line"><span class="comment">## 1      1    5</span></span><br><span class="line"><span class="comment">## 2      2    6</span></span><br><span class="line"><span class="comment">## 3      3    7</span></span><br><span class="line"><span class="comment">## 4      4    8</span></span><br><span class="line"><span class="comment">## 5      5    5</span></span><br><span class="line"><span class="comment">## 6      6    6</span></span><br><span class="line"><span class="comment">## 7      7    7</span></span><br><span class="line"><span class="comment">## 8      8    8</span></span><br><span class="line"><span class="comment">## 9      9    5</span></span><br><span class="line"><span class="comment">## 10    10    6</span></span><br><span class="line"><span class="comment">## 11    11    7</span></span><br><span class="line"><span class="comment">## 12    12    8</span></span><br><span class="line"></span><br><span class="line">a <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">4</span></span><br><span class="line">b <span class="operator">=</span> <span class="number">5</span><span class="operator">:</span><span class="number">8</span></span><br><span class="line"><span class="built_in">c</span> <span class="operator">=</span> <span class="built_in">letters</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">]</span></span><br><span class="line">d <span class="operator">=</span> <span class="built_in">letters</span><span class="punctuation">[</span><span class="number">5</span><span class="operator">:</span><span class="number">8</span><span class="punctuation">]</span></span><br><span class="line">e <span class="operator">=</span> data.frame<span class="punctuation">(</span>a<span class="punctuation">,</span>b<span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">,</span>d<span class="punctuation">)</span></span><br><span class="line">e</span><br><span class="line"><span class="comment">##   a b c d</span></span><br><span class="line"><span class="comment">## 1 1 5 a e</span></span><br><span class="line"><span class="comment">## 2 2 6 b f</span></span><br><span class="line"><span class="comment">## 3 3 7 c g</span></span><br><span class="line"><span class="comment">## 4 4 8 d h</span></span><br><span class="line"></span><br><span class="line">str<span class="punctuation">(</span>e<span class="punctuation">)</span>    <span class="comment"># 检查数据框中数据类型</span></span><br><span class="line"><span class="comment">## &#x27;data.frame&#x27;:4 obs. of  4 variables:</span></span><br><span class="line"><span class="comment">##  $ a: int  1 2 3 4</span></span><br><span class="line"><span class="comment">##  $ b: int  5 6 7 8</span></span><br><span class="line"><span class="comment">##  $ c: chr  &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot;</span></span><br><span class="line"><span class="comment">##  $ d: chr  &quot;e&quot; &quot;f&quot; &quot;g&quot; &quot;h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本数据操作</span></span><br><span class="line"><span class="comment"># 行/列提取</span></span><br><span class="line">e<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment">##   a b c d</span></span><br><span class="line"><span class="comment">## 1 1 5 a e</span></span><br><span class="line">e<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment">## [1] 1 2 3 4</span></span><br><span class="line">e<span class="operator">$</span>a    <span class="comment"># $对列提取,abcd为列数</span></span><br><span class="line"><span class="comment">## [1] 1 2 3 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加列</span></span><br><span class="line">e<span class="operator">$</span>e <span class="operator">=</span> <span class="number">9</span><span class="operator">:</span><span class="number">12</span>    <span class="comment"># 增加不存在的e列为向量9:12</span></span><br><span class="line">e</span><br><span class="line"><span class="comment">##   a b c d  e</span></span><br><span class="line"><span class="comment">## 1 1 5 a e  9</span></span><br><span class="line"><span class="comment">## 2 2 6 b f 10</span></span><br><span class="line"><span class="comment">## 3 3 7 c g 11</span></span><br><span class="line"><span class="comment">## 4 4 8 d h 12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 行/列命名</span></span><br><span class="line">row.names<span class="punctuation">(</span>e<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;P&quot;</span></span><br><span class="line">row.names<span class="punctuation">(</span>e<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;l&quot;</span>    <span class="comment"># 更改行名</span></span><br><span class="line">colnames<span class="punctuation">(</span>e<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;第一列&quot;</span>    <span class="comment"># 更改列名</span></span><br><span class="line">e</span><br><span class="line"><span class="comment">##   第一列 b c d  e</span></span><br><span class="line"><span class="comment">## 1      1 5 a e  9</span></span><br><span class="line"><span class="comment">## 2      2 6 b f 10</span></span><br><span class="line"><span class="comment">## P      3 7 c g 11</span></span><br><span class="line"><span class="comment">## l      4 8 d h 12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并矩阵两种方式rbind,cbind(矩阵，名称 = 赋值)</span></span><br><span class="line">f <span class="operator">=</span> cbind<span class="punctuation">(</span>e<span class="punctuation">,</span>f <span class="operator">=</span> <span class="number">13</span><span class="operator">:</span><span class="number">16</span><span class="punctuation">)</span>    <span class="comment"># 合并以后相当于增加了1列</span></span><br><span class="line">f</span><br><span class="line"><span class="comment">##   第一列 b c d  e  f</span></span><br><span class="line"><span class="comment">## 1      1 5 a e  9 13</span></span><br><span class="line"><span class="comment">## 2      2 6 b f 10 14</span></span><br><span class="line"><span class="comment">## P      3 7 c g 11 15</span></span><br><span class="line"><span class="comment">## l      4 8 d h 12 16</span></span><br><span class="line">colnames<span class="punctuation">(</span>f<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">6</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span></span><br><span class="line">f</span><br><span class="line">g <span class="operator">=</span> rbind<span class="punctuation">(</span>f<span class="punctuation">,</span> <span class="number">6</span> <span class="punctuation">)</span>    <span class="comment"># 合并以后相当于增加了1行</span></span><br><span class="line">g</span><br><span class="line"><span class="comment">##   第一列 b c d  e  Y</span></span><br><span class="line"><span class="comment">## 1      1 5 a e  9 13</span></span><br><span class="line"><span class="comment">## 2      2 6 b f 10 14</span></span><br><span class="line"><span class="comment">## P      3 7 c g 11 15</span></span><br><span class="line"><span class="comment">## l      4 8 d h 12 16</span></span><br><span class="line"><span class="comment">## 5      6 6 6 6  6  6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 行/列平均数</span></span><br><span class="line"><span class="comment"># rowMeans 行平均数 colMeans 列平均数</span></span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 练习：生成一个矩阵，包含21-40的值，给行和列取名</span></span><br><span class="line"><span class="comment">## 加上最后一列平均数；加上最后一列，计算第二列和第一列的差</span></span><br><span class="line">a <span class="operator">=</span> matrix<span class="punctuation">(</span><span class="number">21</span><span class="operator">:</span><span class="number">40</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>a<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">LETTERS</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">5</span><span class="punctuation">]</span></span><br><span class="line">row.names<span class="punctuation">(</span>a<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">letters</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">]</span></span><br><span class="line">cbind<span class="punctuation">(</span>a<span class="punctuation">,</span>Mean <span class="operator">=</span> rowMeans<span class="punctuation">(</span>a<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##    A  B  C  D  E Mean</span></span><br><span class="line"><span class="comment">## a 21 25 29 33 37   29</span></span><br><span class="line"><span class="comment">## b 22 26 30 34 38   30</span></span><br><span class="line"><span class="comment">## c 23 27 31 35 39   31</span></span><br><span class="line"><span class="comment">## d 24 28 32 36 40   32</span></span><br><span class="line">b <span class="operator">=</span> a<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line"><span class="built_in">c</span> <span class="operator">=</span> a<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span></span><br><span class="line">d <span class="operator">=</span> <span class="built_in">c</span><span class="operator">-</span>b</span><br><span class="line">cbind<span class="punctuation">(</span>a<span class="punctuation">,</span> H <span class="operator">=</span> d<span class="punctuation">)</span></span><br><span class="line"><span class="comment">##    A  B  C  D  E H</span></span><br><span class="line"><span class="comment">## a 21 25 29 33 37 4</span></span><br><span class="line"><span class="comment">## b 22 26 30 34 38 4</span></span><br><span class="line"><span class="comment">## c 23 27 31 35 39 4</span></span><br><span class="line"><span class="comment">## d 24 28 32 36 40 4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习：建一个数据框统计一天消费，第一列开支，第二列单价，第三列数量</span></span><br><span class="line">b <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">648</span><span class="punctuation">,</span><span class="number">328</span><span class="punctuation">,</span><span class="number">128</span><span class="punctuation">,</span><span class="number">60</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">c</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">c</span><span class="operator">*</span>b<span class="punctuation">)</span></span><br><span class="line">d <span class="operator">=</span> data.frame<span class="punctuation">(</span>a<span class="punctuation">,</span>b<span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;消费金额&quot;</span></span><br><span class="line">colnames<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;单价&quot;</span></span><br><span class="line">colnames<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;数量&quot;</span></span><br><span class="line">row.names<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;648氪金消费&quot;</span></span><br><span class="line">row.names<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;328氪金消费&quot;</span></span><br><span class="line">row.names<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;128氪金消费&quot;</span></span><br><span class="line">row.names<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;60氪金消费&quot;</span></span><br><span class="line">row.names<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">5</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;30氪金消费&quot;</span></span><br><span class="line">row.names<span class="punctuation">(</span>d<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">6</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;6氪金消费&quot;</span></span><br><span class="line">rbind<span class="punctuation">(</span>d<span class="punctuation">,</span>总氪金量 <span class="operator">=</span> <span class="built_in">sum</span><span class="punctuation">(</span>a<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##             消费金额 单价 数量</span></span><br><span class="line"><span class="comment">## 648氪金消费      648  648    1</span></span><br><span class="line"><span class="comment">## 328氪金消费      984  328    3</span></span><br><span class="line"><span class="comment">## 128氪金消费      512  128    4</span></span><br><span class="line"><span class="comment">## 60氪金消费        60   60    1</span></span><br><span class="line"><span class="comment">## 30氪金消费       120   30    4</span></span><br><span class="line"><span class="comment">## 6氪金消费         36    6    6</span></span><br><span class="line"><span class="comment">## 总氪金量        2360 2360 2360</span></span><br></pre></td></tr></table></figure></div><h2 id="4-R做图"><a href="#4-R做图" class="headerlink" title="4. R做图"></a>4. R做图</h2><div class="story post-story"><p>咱们学生物最关心的就是怎么作图了，上面的编程基础没懂也没事，下面怎么画图可以套模板。</p><p>R可以导入不同的包作图，这里用最最基础的ggplot为例，以下是安装和导入方式，后面所有例子均需导入ggplot：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ggplot2包</span></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;ggplot2&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入ggplot2</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h3 id="4-1-线性回归图"><a href="#4-1-线性回归图" class="headerlink" title="4.1 线性回归图"></a>4.1 线性回归图</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 以R内置的cars数据为例</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> cars<span class="punctuation">,</span></span><br><span class="line">       mapping <span class="operator">=</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> speed<span class="punctuation">,</span>    <span class="comment"># aes描述数据中的变量映射到geom的可视属性（美学？）</span></span><br><span class="line">                     y <span class="operator">=</span> dist<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span>     </span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> geom_line<span class="punctuation">(</span>col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span> <span class="operator">+</span>     <span class="comment"># geom表示图层</span></span><br><span class="line">  geom_smooth<span class="punctuation">(</span>method <span class="operator">=</span> <span class="string">&quot;lm&quot;</span><span class="punctuation">)</span> <span class="operator">+</span>   <span class="comment"># lm表示线性回归方法</span></span><br><span class="line">  annotate<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span>    <span class="comment"># annotate注释</span></span><br><span class="line">           x <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span>    <span class="comment"># 注释坐标</span></span><br><span class="line">           y <span class="operator">=</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">           label <span class="operator">=</span> <span class="string">&quot;y = -17.6x + 3.9 \n p = 1.49e-12&quot;</span><span class="punctuation">,</span>    <span class="comment"># \n为换行符</span></span><br><span class="line">           size <span class="operator">=</span> <span class="number">5</span><span class="punctuation">)</span>    <span class="comment"># 注释大小</span></span><br><span class="line"></span><br><span class="line">lm.cars <span class="operator">=</span> lm<span class="punctuation">(</span>formula <span class="operator">=</span> dist <span class="operator">~</span> speed<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> cars<span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>lm.cars<span class="punctuation">)</span>    <span class="comment"># 回归方程详细参数总结，显示结果如下，代码中不要加下面的东西</span></span><br><span class="line"><span class="comment">#-------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#Call:</span></span><br><span class="line"><span class="comment">#lm(formula = dist ~ speed, data = cars)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Residuals:</span></span><br><span class="line"><span class="comment">#    Min      1Q  Median      3Q     Max </span></span><br><span class="line"><span class="comment">#-29.069  -9.525  -2.272   9.215  43.201 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Coefficients:</span></span><br><span class="line"><span class="comment">#            Estimate Std. Error t value Pr(&gt;|t|)    </span></span><br><span class="line"><span class="comment">#(Intercept) -17.5791     6.7584  -2.601   0.0123 *  </span></span><br><span class="line"><span class="comment">#speed         3.9324     0.4155   9.464 1.49e-12 ***</span></span><br><span class="line"><span class="comment">#---</span></span><br><span class="line"><span class="comment">#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Residual standard error: 15.38 on 48 degrees of freedom</span></span><br><span class="line"><span class="comment">#Multiple R-squared:  0.6511,Adjusted R-squared:  0.6438 </span></span><br><span class="line"><span class="comment">#F-statistic: 89.57 on 1 and 48 DF,  p-value: 1.49e-12</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/3.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="4-2-直方图"><a href="#4-2-直方图" class="headerlink" title="4.2 直方图"></a>4.2 直方图</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 以R内置的iris数据为例</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> iris<span class="punctuation">,</span></span><br><span class="line">       mapping <span class="operator">=</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_histogram<span class="punctuation">(</span>col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span>     <span class="comment"># 边缘颜色</span></span><br><span class="line">                 fill <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span>    <span class="comment"># 填充色</span></span><br><span class="line">                 alpha <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>    <span class="comment"># 透明度</span></span><br><span class="line">                 bins <span class="operator">=</span> <span class="number">30</span><span class="punctuation">)</span> <span class="operator">+</span>    <span class="comment">#分组数   </span></span><br><span class="line">  labs<span class="punctuation">(</span>x <span class="operator">=</span> <span class="string">&quot;Sepal Length(cm)&quot;</span><span class="punctuation">,</span>    <span class="comment"># labs横纵坐标名</span></span><br><span class="line">       y <span class="operator">=</span> <span class="string">&quot;Count&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span>    <span class="comment"># 主题——经典背景（白色的）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习：对iris数据集中的Sepal.Width形状做直方图（图略）</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> iris<span class="punctuation">,</span></span><br><span class="line">       mapping <span class="operator">=</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_histogram<span class="punctuation">(</span>col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 fill <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                 alpha <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">                 bins <span class="operator">=</span> <span class="number">30</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span>x <span class="operator">=</span> <span class="string">&quot;Sepal Width(cm)&quot;</span><span class="punctuation">,</span></span><br><span class="line">       y <span class="operator">=</span> <span class="string">&quot;Count&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/4.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="4-3-密度图"><a href="#4-3-密度图" class="headerlink" title="4.3 密度图"></a>4.3 密度图</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_density<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/5.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 密度图 + 直方图</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> iris<span class="punctuation">,</span></span><br><span class="line">       mapping <span class="operator">=</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_histogram<span class="punctuation">(</span>aes<span class="punctuation">(</span>y <span class="operator">=</span> ..density..<span class="punctuation">)</span><span class="punctuation">,</span>    <span class="comment"># 直方图纵坐标改成密度</span></span><br><span class="line">                 col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 fill <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                 alpha <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">                 bins <span class="operator">=</span> <span class="number">30</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_density<span class="punctuation">(</span>col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_dark<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习：做Petal.Length直方图和密度图（图略）</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> iris<span class="punctuation">,</span></span><br><span class="line">       mapping <span class="operator">=</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Petal.Length<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_histogram<span class="punctuation">(</span>aes<span class="punctuation">(</span>y <span class="operator">=</span> ..density..<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                 bins <span class="operator">=</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">                 col <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 fill <span class="operator">=</span> <span class="string">&quot;green&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_density<span class="punctuation">(</span>col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/6.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="4-4-折线图"><a href="#4-4-折线图" class="headerlink" title="4.4 折线图"></a>4.4 折线图</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_freqpoly<span class="punctuation">(</span><span class="punctuation">)</span>    <span class="comment"># 折线图</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/7.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="4-5-柱形图"><a href="#4-5-柱形图" class="headerlink" title="4.5 柱形图"></a>4.5 柱形图</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> iris<span class="punctuation">,</span></span><br><span class="line">       mapping <span class="operator">=</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Species<span class="punctuation">,</span></span><br><span class="line">                     fill <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span>   <span class="comment"># 总体颜色设置</span></span><br><span class="line">  geom_bar<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>    <span class="comment"># 设置宽度</span></span><br><span class="line">           alpha <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span>     <span class="comment"># 注意设置颜色后总体颜色设置失效</span></span><br><span class="line">           show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span>   <span class="comment"># 设置F为图例不显示</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习：以mtcars数据集为例,对cyl作图（图略）</span></span><br><span class="line">mtcars</span><br><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> factor<span class="punctuation">(</span>cyl<span class="punctuation">)</span><span class="punctuation">,</span>    <span class="comment"># factor连续型变量数值转换成因子</span></span><br><span class="line">           fill <span class="operator">=</span> factor<span class="punctuation">(</span>cyl<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_bar<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">           col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">           alpha <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>x <span class="operator">=</span> <span class="string">&quot;Number of cylinder&quot;</span><span class="punctuation">,</span></span><br><span class="line">       y <span class="operator">=</span> <span class="string">&quot;Count&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2个变量作图（图略）</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span></span><br><span class="line">           col <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span>     <span class="comment"># 以种作为分类依据</span></span><br><span class="line">  geom_density<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习：对iris的Sepal.Length,根据不同种做直方图（图略）</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x<span class="operator">=</span> Sepal.Length<span class="punctuation">,</span></span><br><span class="line">           fill <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_histogram<span class="punctuation">(</span>bins <span class="operator">=</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">                 alpha <span class="operator">=</span> <span class="number">0.4</span><span class="punctuation">,</span></span><br><span class="line">                 col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/8.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 柱形图叠加误差棒</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">Mean <span class="operator">=</span> tapply<span class="punctuation">(</span>iris<span class="operator">$</span>Sepal.Length<span class="punctuation">,</span>    <span class="comment"># tapply分组，提取 </span></span><br><span class="line">              iris<span class="operator">$</span>Species<span class="punctuation">,</span></span><br><span class="line">              mean<span class="punctuation">)</span></span><br><span class="line">Mean <span class="operator">=</span> as.data.frame<span class="punctuation">(</span>Mean<span class="punctuation">)</span>    <span class="comment"># 转换array类型为数据框</span></span><br><span class="line">Mean</span><br><span class="line"><span class="comment">##            Mean</span></span><br><span class="line"><span class="comment">## setosa     5.006</span></span><br><span class="line"><span class="comment">## versicolor 5.936</span></span><br><span class="line"><span class="comment">## virginica  6.588</span></span><br><span class="line">Mean<span class="operator">$</span>Species <span class="operator">=</span> row.names<span class="punctuation">(</span>Mean<span class="punctuation">)</span></span><br><span class="line">Mean</span><br><span class="line"><span class="comment">##             Mean    Species</span></span><br><span class="line"><span class="comment">## setosa     5.006     setosa</span></span><br><span class="line"><span class="comment">## versicolor 5.936 versicolor</span></span><br><span class="line"><span class="comment">## virginica  6.588  virginica</span></span><br><span class="line">sd <span class="operator">=</span> tapply<span class="punctuation">(</span>iris<span class="operator">$</span>Sepal.Length<span class="punctuation">,</span>    <span class="comment"># tapply分组，提取 </span></span><br><span class="line">            iris<span class="operator">$</span>Species<span class="punctuation">,</span></span><br><span class="line">            sd<span class="punctuation">)</span></span><br><span class="line">sd <span class="operator">=</span> as.data.frame<span class="punctuation">(</span>sd<span class="punctuation">)</span></span><br><span class="line">sd</span><br><span class="line"><span class="comment">##                   sd</span></span><br><span class="line"><span class="comment">## setosa     0.3524897</span></span><br><span class="line"><span class="comment">## versicolor 0.5161711</span></span><br><span class="line"><span class="comment">## virginica  0.6358796</span></span><br><span class="line">Newiris <span class="operator">=</span> cbind<span class="punctuation">(</span>Mean<span class="punctuation">,</span> Sd <span class="operator">=</span> sd<span class="operator">$</span>sd<span class="punctuation">)</span></span><br><span class="line">Newiris</span><br><span class="line"><span class="comment">##             Mean    Species        Sd</span></span><br><span class="line"><span class="comment">## setosa     5.006     setosa 0.3524897</span></span><br><span class="line"><span class="comment">## versicolor 5.936 versicolor 0.5161711</span></span><br><span class="line"><span class="comment">## virginica  6.588  virginica 0.6358796</span></span><br><span class="line">ggplot<span class="punctuation">(</span>Newiris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Species<span class="punctuation">,</span>y <span class="operator">=</span> Mean<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">           aes<span class="punctuation">(</span>fill <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_errorbar<span class="punctuation">(</span>aes<span class="punctuation">(</span>ymin <span class="operator">=</span> Mean <span class="operator">-</span> Sd<span class="punctuation">,</span></span><br><span class="line">                    ymax <span class="operator">=</span> Mean <span class="operator">+</span> Sd<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                width <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/9.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="4-6-箱式图"><a href="#4-6-箱式图" class="headerlink" title="4.6 箱式图"></a>4.6 箱式图</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 三条线是75%，50%，25%。长度是箱高1.5倍，超过为离群值</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Species<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span></span><br><span class="line">           fill <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_violin<span class="punctuation">(</span>show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">              width <span class="operator">=</span> <span class="number">0.8</span><span class="punctuation">)</span> <span class="operator">+</span>     <span class="comment"># 叠加小提琴图</span></span><br><span class="line">  geom_boxplot<span class="punctuation">(</span>show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">               width <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span></span><br><span class="line">               fill <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_jitter<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">              size <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">              show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span>    <span class="comment"># 显示每个点,size为点大小</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/10.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="4-7-一些简单的练习"><a href="#4-7-一些简单的练习" class="headerlink" title="4.7 一些简单的练习"></a>4.7 一些简单的练习</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 练习：以iris为例，做Sepal.Length和Petal.Length回归分析，并可视化</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> Petal.Length<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_point<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_smooth<span class="punctuation">(</span>method <span class="operator">=</span> lm<span class="punctuation">,</span></span><br><span class="line">              col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  annotate<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">           x <span class="operator">=</span> <span class="number">5.5</span><span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">           size <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">           label <span class="operator">=</span> <span class="string">&quot;y = -7.10x + 1.86 \n p &lt; 2e-16 \n Adjusted r-squared = 0.75&quot;</span> <span class="punctuation">)</span></span><br><span class="line">lm.iris <span class="operator">=</span> lm<span class="punctuation">(</span>Petal.Length <span class="operator">~</span> Sepal.Length<span class="punctuation">,</span></span><br><span class="line">             iris<span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>lm.iris<span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/14.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/14.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 练习：做个糖葫芦？</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">x <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">y <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">5</span></span><br><span class="line">a <span class="operator">=</span> data.frame<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> a<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> x<span class="punctuation">,</span> y <span class="operator">=</span> y<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_vline<span class="punctuation">(</span>xintercept <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span>    <span class="comment"># 生成一条直线，交于x = 1,2,3</span></span><br><span class="line">             size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">             col <span class="operator">=</span> <span class="string">&quot;yellow&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">             col <span class="operator">=</span> <span class="string">&quot;#FF5000&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylim<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span> <span class="operator">+</span>    <span class="comment"># 调整y轴上下限</span></span><br><span class="line">  xlim<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_void<span class="punctuation">(</span><span class="punctuation">)</span>    <span class="comment"># 主题设置为空</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/13.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/13.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 练习:做个字母表？</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">x <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">y <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">5</span><span class="operator">:</span><span class="number">1</span><span class="punctuation">,</span>each <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">m <span class="operator">=</span> <span class="built_in">letters</span></span><br><span class="line">n <span class="operator">=</span> <span class="built_in">LETTERS</span></span><br><span class="line">l <span class="operator">=</span> paste0<span class="punctuation">(</span>n<span class="punctuation">,</span>m<span class="punctuation">)</span></span><br><span class="line">l</span><br><span class="line">al <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>l<span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span>    <span class="comment"># 设置4个NA值补齐</span></span><br><span class="line">a <span class="operator">=</span> data.frame<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">,</span>al<span class="punctuation">)</span></span><br><span class="line">a</span><br><span class="line">ggplot<span class="punctuation">(</span>a<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> al<span class="punctuation">)</span><span class="punctuation">,</span>    <span class="comment"># 加文本图层，点的坐标映射字母</span></span><br><span class="line">            size <span class="operator">=</span> <span class="number">5</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_void<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylim<span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlim<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/11.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 优化一下，做个炫彩字母表？大写字母在上，小写字母在下</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">x <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">y <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">5</span><span class="operator">:</span><span class="number">1</span><span class="punctuation">,</span>each <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">al <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">LETTERS</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">al1 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">letters</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">=</span> data.frame<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">,</span>al<span class="punctuation">)</span></span><br><span class="line">mydata</span><br><span class="line">ggplot<span class="punctuation">(</span>mydata<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> al<span class="punctuation">,</span></span><br><span class="line">                col <span class="operator">=</span> al<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            size <span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>y <span class="operator">=</span> y <span class="operator">-</span> <span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">                label <span class="operator">=</span> al1<span class="punctuation">,</span></span><br><span class="line">                col <span class="operator">=</span> al1<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_void<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylim<span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlim<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230926/12.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230926/12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 算了 自由发挥吧，图就不放了</span></span><br><span class="line"><span class="comment"># 练习 3个变量</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> Petal.Length<span class="punctuation">,</span></span><br><span class="line">           col <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span>    <span class="comment"># 增加种属变量</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_smooth<span class="punctuation">(</span>method <span class="operator">=</span> lm<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 练习</span></span><br><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> factor<span class="punctuation">(</span>cyl<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           fill <span class="operator">=</span> factor<span class="punctuation">(</span>carb<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_bar<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 练习</span></span><br><span class="line">ToothGrowth<span class="comment"># 另一个奇奇怪怪的R内置数据</span></span><br><span class="line">str<span class="punctuation">(</span>ToothGrowth<span class="punctuation">)</span>    <span class="comment"># str()查看括号内数据类型信息</span></span><br><span class="line">ToothGrowth<span class="operator">$</span>dose <span class="operator">=</span> factor<span class="punctuation">(</span>ToothGrowth<span class="operator">$</span>dose<span class="punctuation">)</span></span><br><span class="line">a <span class="operator">=</span> tapply<span class="punctuation">(</span>ToothGrowth<span class="operator">$</span>len<span class="punctuation">,</span></span><br><span class="line">           ToothGrowth<span class="operator">$</span>supp<span class="operator">:</span>ToothGrowth<span class="operator">$</span>dose<span class="punctuation">,</span></span><br><span class="line">           mean<span class="punctuation">)</span></span><br><span class="line">a <span class="operator">=</span> data.frame<span class="punctuation">(</span>a<span class="punctuation">)</span></span><br><span class="line">supp <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;OJ&quot;</span><span class="punctuation">,</span><span class="string">&quot;VC&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>each <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">dose <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">=</span> cbind<span class="punctuation">(</span>len <span class="operator">=</span> a<span class="operator">$</span>a<span class="punctuation">,</span>supp<span class="punctuation">,</span>dose<span class="punctuation">)</span></span><br><span class="line">b <span class="operator">=</span> as.data.frame<span class="punctuation">(</span>b<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>b<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> supp<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> len<span class="punctuation">,</span></span><br><span class="line">           fill <span class="operator">=</span> dose<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_col<span class="punctuation">(</span>position <span class="operator">=</span> position_dodge<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 练习</span></span><br><span class="line">ggplot<span class="punctuation">(</span>ToothGrowth<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> supp<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> len<span class="punctuation">,</span></span><br><span class="line">           fill <span class="operator">=</span> dose<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_jitter<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 练习</span></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> Sepal.Width<span class="punctuation">,</span></span><br><span class="line">           size <span class="operator">=</span> Petal.Length<span class="punctuation">,</span></span><br><span class="line">           col <span class="operator">=</span> Petal.Length<span class="punctuation">,</span></span><br><span class="line">           alpha <span class="operator">=</span> Petal.Length<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span>    <span class="comment"># 根据需要选第三个变量</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 练习</span></span><br><span class="line">x <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">y <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">5</span><span class="operator">:</span><span class="number">1</span><span class="punctuation">,</span>each <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">al <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">LETTERS</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">al1 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">letters</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">=</span> data.frame<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">,</span>al<span class="punctuation">)</span></span><br><span class="line">mydata</span><br><span class="line">ggplot<span class="punctuation">(</span>mydata<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> al<span class="punctuation">,</span></span><br><span class="line">                col <span class="operator">=</span> al<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            size <span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>y <span class="operator">=</span> y <span class="operator">-</span> <span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">                label <span class="operator">=</span> al1<span class="punctuation">,</span></span><br><span class="line">                col <span class="operator">=</span> al1<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_void<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylim<span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlim<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;整理笔记的时候翻到两年前做的R入门笔记，还记得21年冬天那个时候是第一次接触R，华中农业大学的孔秋生教授来塔里木大学做的R语言讲座。两年了有些东西过时了，整理下做个备份吧~顺便回头复习复习，温故而知新 ^_^&lt;/p&gt;</summary>
    
    
    
    <category term="编程自学" scheme="http://www.shelven.com/categories/%E7%BC%96%E7%A8%8B%E8%87%AA%E5%AD%A6/"/>
    
    
    <category term="R语言" scheme="http://www.shelven.com/tags/R%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>基因组注释（7）——功能基因注释评估</title>
    <link href="http://www.shelven.com/2023/09/25/a.html"/>
    <id>http://www.shelven.com/2023/09/25/a.html</id>
    <published>2023-09-25T13:46:23.000Z</published>
    <updated>2023-09-25T13:52:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>前面说了如何用eggNOG-mapper快速注释功能基因，我们最后得到了很多结果文件，其中最重要的是两个<code>annotations</code>文件。这里主要讲一下怎么整理结果文件，并且对注释的结果做质量评估。</p><span id="more"></span><h2 id="1-基因功能注释评估"><a href="#1-基因功能注释评估" class="headerlink" title="1. 基因功能注释评估"></a>1. 基因功能注释评估</h2><div class="story post-story"><p>其实就是整理结果文件中有多少基因注释到了哪些数据库中，以一种直观的方式展现结果。</p><p>这里分两种情况，如果自己喜欢以编程的方式处理文件，可以直接处理<code>out.emapper.annotations</code>这个文件。如果前一种方式不是很得心应手的话，那就直接处理<code>out.emapper.annotations.xlsx</code>这个文件，毕竟可以用excel直接打开。</p><p>在<a href="https://www.shelven.com/2023/09/19/a.html">上一篇博客</a>中详细介绍了结果文件中20列代表什么含义，删掉前两行运行的参数和命令，剩下的就是我们熟悉的excel表格。</p><p>将第一行表头的内容选中，筛选。A列（query）就是eggNOG注释到的基因名，选中并且粘贴到新的表格；J列（GOs）筛选除了“-”以外的内容，复制第一列作为注释到GO的序列；L列（KEGG_ko）筛选除了“-”以外的内容，复制第一列作为注释到KEGG的序列；U列（PFAMs）筛选除“-”以外的内容，复制第一列作为注释到PFAM的序列。可以得到如下形式的表格（另存为<code>annotation.xlsx</code>）：</p><p><img src="https://www.shelven.com/tuchuang/20230921/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230921/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这种类型的输入数据可以在本地导入R包做韦恩（Venn）图，也可以选择用在线工具直接生成韦恩图，比如这个网站：<a href="https://bioinfogp.cnb.csic.es/tools/venny/index.html">Venny 2.1.0 (csic.es)</a></p><p><img src="https://www.shelven.com/tuchuang/20230921/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230921/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>最多支持四组样本，把数据贴进左边4个框内即可。上方的<strong>Style</strong>可以选择不同的着色方式，点击图中的数字可以在左下方<strong>Results</strong>框内看到各个数据集的重叠关系，右键图片也可以直接保存。<del>这个功能不难实现，有空可以更新到我的本地小工具集合中。</del></p><blockquote><p>类似的在线做韦恩图的网站还有很多：</p><p><a href="https://jvenn.toulouse.inrae.fr/app/example.html">jvenn (inrae.fr)</a></p><p><a href="http://www.biovenn.nl/index.php">BioVenn - a web application for the comparison and visualization of biological lists using area-proportional Venn diagrams</a></p><p><a href="http://www.pangloss.com/seidel/Protocols/venn.cgi">Venn Diagram generator (pangloss.com)</a></p></blockquote><p>或者选择自己折腾R，用经典的VennDiagram包做韦恩图，或者用UpSetR包做Upset图：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># R包readxl导入xlsx文件，VennDiagram做Veen图</span></span><br><span class="line">library<span class="punctuation">(</span>VennDiagram<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>readxl<span class="punctuation">)</span></span><br><span class="line">data <span class="operator">=</span> read_excel<span class="punctuation">(</span><span class="string">&quot;annotation.xlsx&quot;</span><span class="punctuation">,</span> sheet <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">data<span class="punctuation">[</span><span class="built_in">is.na</span><span class="punctuation">(</span>data<span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>  <span class="comment"># 替换读入的NA为空</span></span><br><span class="line"></span><br><span class="line">plot <span class="operator">=</span> venn.diagram<span class="punctuation">(</span></span><br><span class="line">  x <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">    eggNOG <span class="operator">=</span> data<span class="operator">$</span>eggNOG<span class="punctuation">,</span></span><br><span class="line">    GO <span class="operator">=</span> data<span class="operator">$</span>GO<span class="punctuation">,</span></span><br><span class="line">    KEGG <span class="operator">=</span> data<span class="operator">$</span>KEGG<span class="punctuation">,</span></span><br><span class="line">    PFAM <span class="operator">=</span> data<span class="operator">$</span>PFAM</span><br><span class="line">  <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  disable.logging <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">  filename <span class="operator">=</span> <span class="string">&#x27;Veen_annotation.png&#x27;</span><span class="punctuation">,</span></span><br><span class="line">  col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span></span><br><span class="line">  lwd <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  lty <span class="operator">=</span> <span class="string">&quot;solid&quot;</span><span class="punctuation">,</span></span><br><span class="line">  fill <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;cornflowerblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="string">&quot;yellow&quot;</span><span class="punctuation">,</span> <span class="string">&quot;darkorchid1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  alpha <span class="operator">=</span> <span class="number">0.50</span><span class="punctuation">,</span></span><br><span class="line">  label.col <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orange&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;darkorchid4&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;darkgreen&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  cex <span class="operator">=</span> <span class="number">2.0</span><span class="punctuation">,</span></span><br><span class="line">  fontfamily <span class="operator">=</span> <span class="string">&quot;serif&quot;</span><span class="punctuation">,</span></span><br><span class="line">  fontface <span class="operator">=</span> <span class="string">&quot;bold&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cat.col <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;darkgreen&quot;</span><span class="punctuation">,</span> <span class="string">&quot;orange&quot;</span><span class="punctuation">,</span> <span class="string">&quot;darkorchid4&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  cat.cex <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">#cat.pos = 0,</span></span><br><span class="line">  <span class="comment">#cat.dist = 0.07,</span></span><br><span class="line">  rotation.degree <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  cat.fontfamily <span class="operator">=</span> <span class="string">&quot;serif&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cat.fontface <span class="operator">=</span> <span class="string">&quot;bold&quot;</span><span class="punctuation">,</span></span><br><span class="line">  margin <span class="operator">=</span> <span class="number">0.1</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><img src="https://www.shelven.com/tuchuang/20230921/Veen_annotation.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230921/Veen_annotation.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><p>VennDiagram包参数参考<a href="https://cran.r-project.org/web/packages/VennDiagram/VennDiagram.pdf">VennDiagram: Generate High-Resolution Venn and Euler Plots (r-project.org)</a></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># UpSetR包做upset图</span></span><br><span class="line">library<span class="punctuation">(</span>UpSetR<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>readxl<span class="punctuation">)</span></span><br><span class="line">data <span class="operator">=</span> read_excel<span class="punctuation">(</span><span class="string">&quot;annotation.xlsx&quot;</span><span class="punctuation">,</span> sheet <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">data<span class="punctuation">[</span><span class="built_in">is.na</span><span class="punctuation">(</span>data<span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>  <span class="comment"># 替换NA为空</span></span><br><span class="line">data <span class="operator">=</span> fromList<span class="punctuation">(</span>data<span class="punctuation">)</span>  <span class="comment"># 转换成0和1的矩阵（UpSetR包对导入数据有要求，建议看github官网）</span></span><br><span class="line"></span><br><span class="line">upset<span class="punctuation">(</span></span><br><span class="line">  data<span class="punctuation">,</span></span><br><span class="line">  nsets <span class="operator">=</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  matrix.color <span class="operator">=</span> <span class="string">&quot;gray23&quot;</span><span class="punctuation">,</span></span><br><span class="line">  main.bar.color <span class="operator">=</span> <span class="string">&quot;gray23&quot;</span><span class="punctuation">,</span></span><br><span class="line">  mainbar.y.label <span class="operator">=</span> <span class="string">&quot;交集基因数&quot;</span><span class="punctuation">,</span></span><br><span class="line">  mainbar.y.max <span class="operator">=</span> <span class="number">7000</span><span class="punctuation">,</span></span><br><span class="line">  sets.bar.color <span class="operator">=</span> <span class="string">&quot;gray23&quot;</span><span class="punctuation">,</span></span><br><span class="line">  sets.x.label <span class="operator">=</span> <span class="string">&quot;注释的基因数&quot;</span><span class="punctuation">,</span></span><br><span class="line">  point.size <span class="operator">=</span> <span class="number">2.2</span><span class="punctuation">,</span> </span><br><span class="line">  line.size <span class="operator">=</span> <span class="number">0.7</span><span class="punctuation">,</span></span><br><span class="line">  mb.ratio <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.7</span><span class="punctuation">,</span> <span class="number">0.3</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  show.numbers <span class="operator">=</span> <span class="string">&quot;yes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  set_size.show <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230921/3.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230921/3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>UpSetR参数参考<a href="https://cran.r-project.org/web/packages/UpSetR/UpSetR.pdf">UpSetR: A More Scalable Alternative to Venn and Euler Diagrams for Visualizing Intersecting Sets (r-project.org)</a></p><p>有点扯远了，两个图能获得的信息是一样的（upset图看不懂的话可以对照韦恩图，看柱状图数字以及底下的点和线就明白了），作图不是为了炫技而是让人一目了然，个人感觉upset图更直观一点，当然也可以直接整理一个表格（很多测序公司的报告都喜欢这么做，感觉也没啥意义）。</p><p>基于不同数据库得到的基因功能注释结果进行统计，结果显示能注释到功能数据库的基因数目为20411个，占预测基因总数的92.04%，具体如下：</p><table><thead><tr><th align="left">Type</th><th align="left">Number</th><th align="left">Percent(%)</th></tr></thead><tbody><tr><td align="left">eggNOG</td><td align="left">20411</td><td align="left">92.04</td></tr><tr><td align="left">GO</td><td align="left">10766</td><td align="left">48.55</td></tr><tr><td align="left">KEGG</td><td align="left">10245</td><td align="left">46.20</td></tr><tr><td align="left">Pfam</td><td align="left">18167</td><td align="left">81.92</td></tr><tr><td align="left">Overall</td><td align="left">22176</td><td align="left">100.00</td></tr></tbody></table><blockquote><p>Type: 各数据库类型</p><p>Number: 注释的基因数目</p><p>Percent: 个数据库注释到的基因所占的预测基因的比例</p><p>Overall: 总的预测基因数</p></blockquote></div><h2 id="2-BUSCO评估"><a href="#2-BUSCO评估" class="headerlink" title="2. BUSCO评估"></a>2. BUSCO评估</h2><div class="story post-story"><p>前面的博客写过一篇如何做BUSCO评估——<a href="https://www.shelven.com/2023/03/01/a.html">0基础学习基因组三代测序组装（7）——基因组组装质量评估（BUSCO、LAI指数）</a>，当时是评估组装的基因组完整性。这里注释完成后也需要对预测的基因集进行评估，和前面不一样的地方是，这里我们用BUSCO的<strong>Protein mode</strong>。</p><p>以前已经下载过真双子叶库的BUSCO保守基因序列了，这里就直接用：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">SBATCH -n 8</span></span><br><span class="line"></span><br><span class="line">database_path=/public/home/wlxie/biosoft/busco_soft/busco/test_data/eukaryota/busco_downloads/lineages/eudicots_odb10</span><br><span class="line">sequence_path=/public/home/wlxie/biosoft/braker3/Ap_mydb/Ap_rmTE.aa</span><br><span class="line"></span><br><span class="line">busco -i $&#123;sequence_path&#125; -l $&#123;database_path&#125; -o Ap -m proteins --cpu 8 --offline</span><br></pre></td></tr></table></figure><p>用busco自带的作图脚本处理一下结果文件<code>short_summary.specific.eudicots_odb10.Ap.txt</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir result</span><br><span class="line">cp Ap/short_summary.specific.eudicots_odb10.Ap.txt result</span><br><span class="line">python /public/home/wlxie/biosoft/busco/scripts/generate_plot.py -wd result</span><br></pre></td></tr></table></figure><p>20秒不到就可以出图片结果：</p><img src="https://www.shelven.com/tuchuang/20230921/busco_figure.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230921/busco_figure.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>也可以根据结果文件整理一个表格：</p><table><thead><tr><th>Gene ID</th><th>Number</th><th>Percent(%)</th></tr></thead><tbody><tr><td>Complete BUSCOs(C)</td><td>2232</td><td>95.96</td></tr><tr><td>Fragmented BUSCOs(D)</td><td>6</td><td>0.26</td></tr><tr><td>Missing BUSCOs(M)</td><td>88</td><td>3.78%</td></tr><tr><td>eudicots</td><td>2326</td><td>100.00</td></tr></tbody></table><p>eudicots_odb10真双子叶库有2326个BUSCO groups，2232个（95.96%）BUSCO groups能够完整比对上（包括1837个单拷贝和395个多拷贝），说明这个基因组注释的完整性还是不错的。</p></div><h2 id="3-基因转录组表达"><a href="#3-基因转录组表达" class="headerlink" title="3. 基因转录组表达"></a>3. 基因转录组表达</h2><div class="story post-story"><p>用二代转录组数据比对前面组装的参考基因组，统计样本中表达量大于0的基因数。表达量可以用FPKM或者TPM来衡量，最好是用TPM，给定一个标准，比如我这里统计TPM&gt;0.001的基因，就是转录组的一系列标准操作。</p><p>简单写个从转录组下机数据比对到定量的脚本，需要新建一个文件夹提交作业：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">SBATCH -n 20</span></span><br><span class="line"></span><br><span class="line">genome_path=/public/home/wlxie/Genome/Ap.fasta</span><br><span class="line">gff3_path=/public/home/wlxie/biosoft/braker3/Ap_rmTE.gff3</span><br><span class="line">fq_path=/public/home/wlxie/Sequencing_data/BYT2022020901/Apocynum_pictum/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hisat2 构建索引，比对参考基因组</span></span><br><span class="line">hisat2-build $&#123;genome_path&#125; genome</span><br><span class="line">hisat2 -p 20 -x genome -S out.sam  -1 $&#123;fq_path&#125;1.fq -2 $&#123;fq_path&#125;2.fq</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">samtools转sam为bam并排序</span></span><br><span class="line">samtools sort -@ 20 -o out.bam out.sam</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">stringtie统计定量</span></span><br><span class="line">stringtie -p 20 -e -G $&#123;gff3_path&#125; -o result.gtf out.bam</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除中间文件</span></span><br><span class="line">rm -rf genome.*</span><br><span class="line">rm -rf out.*</span><br></pre></td></tr></table></figure><p>最终得到<code>result.gtf</code>，这个文件详细记录了每个转录本表达量：</p><p><img src="https://www.shelven.com/tuchuang/20230921/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230921/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>一行显示不下……后面还有个TPM值，简单写个python处理下数据，统计TPM值大于0.001的基因个数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">count = <span class="number">0</span></span><br><span class="line">gen_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;result.gtf&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> gtf:</span><br><span class="line">    lines = gtf.readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;TPM&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">            gen_count += <span class="number">1</span></span><br><span class="line">            TPM = line.split(<span class="string">&#x27;\t&#x27;</span>)[<span class="number">8</span>].split(<span class="string">&#x27;;&#x27;</span>)[<span class="number">4</span>].split(<span class="string">&#x27; &#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">            TPM = <span class="built_in">float</span>(TPM.strip(<span class="string">&#x27;&quot;&#x27;</span>))</span><br><span class="line">            <span class="keyword">if</span> TPM &gt; <span class="number">0.001</span>:</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;基因总数：<span class="subst">&#123;gen_count&#125;</span> \n表达量大于0的基因数：<span class="subst">&#123;count&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;占比：<span class="subst">&#123;count/gen_count*<span class="number">100</span>:<span class="number">.2</span>f&#125;</span> %&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">基因总数：22176 </span></span><br><span class="line"><span class="string">表达量大于0的基因数：19760</span></span><br><span class="line"><span class="string">占比：89.11 %</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>也就是说有19760个表达的基因是受转录组数据支持的，占总基因数的89.11%。严格来说这边用的数据是注释功能基因之前的，用到的gff文件是移除TE序列后修改的gff文件，用来评价功能注释的结果似乎没有说服力还不够。这里没有对基因去冗余，计算的表达量和转录组分析的表达量还是有差异的。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;前面说了如何用eggNOG-mapper快速注释功能基因，我们最后得到了很多结果文件，其中最重要的是两个&lt;code&gt;annotations&lt;/code&gt;文件。这里主要讲一下怎么整理结果文件，并且对注释的结果做质量评估。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="基因组三代测序分析" scheme="http://www.shelven.com/categories/%E5%9F%BA%E5%9B%A0%E7%BB%84%E4%B8%89%E4%BB%A3%E6%B5%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="BUSCO" scheme="http://www.shelven.com/tags/BUSCO/"/>
    
    <category term="韦恩图" scheme="http://www.shelven.com/tags/%E9%9F%A6%E6%81%A9%E5%9B%BE/"/>
    
    <category term="UpSet图" scheme="http://www.shelven.com/tags/UpSet%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>基因组注释（6）——在线版eggNOG-mapper注释功能基因</title>
    <link href="http://www.shelven.com/2023/09/19/a.html"/>
    <id>http://www.shelven.com/2023/09/19/a.html</id>
    <published>2023-09-19T14:04:47.000Z</published>
    <updated>2023-09-20T07:55:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>继续更新一下基因组注释，在基因组注释的<a href="https://www.shelven.com/2023/04/11/a.html">第5篇博客</a>中，我们已经拿到了Braker3预测的功能基因，并且删除了其中可能被TE插入而失去功能的基因。仅仅拿到这些基因CDS序列和蛋白序列肯定是不够的，我们还需要知道这些蛋白具体行使什么生物学功能。 </p><span id="more"></span><h2 id="1-功能注释常用数据库"><a href="#1-功能注释常用数据库" class="headerlink" title="1. 功能注释常用数据库"></a>1. 功能注释常用数据库</h2><div class="story post-story"><p>基因功能注释的原理都是相似的，我们拿到了蛋白序列之后，与现有的蛋白数据库进行比对，统计比对结果。稍微介绍几个常用的比对数据库，其他没介绍到的可以参考本站<a href="https://www.shelven.com/Bioinformatics/">网址导航—生信网站快速导航</a>，里面有本人年初总结的一些常用生信数据库和工具（有好的工具也可以联系我补充）。</p><h3 id="1-1-NR数据库"><a href="#1-1-NR数据库" class="headerlink" title="1.1 NR数据库"></a>1.1 NR数据库</h3><p>NR数据库全称Non-Redundant Protein Sequence Database（非冗余蛋白数据库），由NCBI建立和维护，可以在NCBI主页的<strong>Data&amp;Software</strong>入口找到<a href="https://ftp.ncbi.nlm.nih.gov/blast/db/">FTP：BLAST Databases</a>。用过本地blast的人都知道，blast比对NR&#x2F;NT库的结果中包含了物种注释信息和相应的氨基酸序列，可以用于物种分类、数据污染评估等等（没用过的话可以参考我的这篇博客——<a href="https://www.shelven.com/2022/06/20/a.html?keyword=blast">数据污染评估</a>）。</p><p>一般的注释方法和数据污染评估一样，使用<code>blastp</code>的比对方法，设置<code>-evalue 1e-5</code>, <code>-max_target_seqs 1</code>，只保留匹配得分最高的蛋白序列。</p><h3 id="1-2-KEGG数据库"><a href="#1-2-KEGG数据库" class="headerlink" title="1.2 KEGG数据库"></a>1.2 KEGG数据库</h3><p><a href="https://www.kegg.jp/">KEGG</a>数据库全称Kyoto Encyclopedia of Genes and Genomes，是日本京都大学生物信息学中心1995年建立的数据库，该数据库描述生物体中复杂的生物学通路，其丰富的通路信息帮助我们系统了解蛋白的生物学功能，如代谢通路、遗传信息传递以及细胞过程等一些复杂的生物功能。</p><p>一般的注释方法同上，比对的数据库为KEGG数据库，并统计蛋白序列注释到的KEGG通路信息。</p><h3 id="1-3-KOG数据库"><a href="#1-3-KOG数据库" class="headerlink" title="1.3 KOG数据库"></a>1.3 KOG数据库</h3><p><a href="https://www.hsls.pitt.edu/obrc/index.php?page=URL1144075392">KOG</a>数据库全称Eukaryotic Orthologous Groups of protein（真核同源群数据库），和这个数据库齐名的还有COG（Clusters of Orthologous Groups of proteins），这两个数据库都是NCBI中基于直系同源关系的数据库，COG针对原核生物，KOG针对真核生物。其比对原理是将蛋白序列比对并注释到某个同源蛋白簇中，这个同源蛋白簇是NCBI通过生物的完整基因组的编码蛋白系统进化关系分类构建而成的，比对到的同源蛋白簇揭示该蛋白的功能。</p><p>一般的注释方法同上，比对的是KOG数据库，并统计蛋白序列注释的KOG信息。</p><h3 id="1-4-GO数据库"><a href="#1-4-GO数据库" class="headerlink" title="1.4 GO数据库"></a>1.4 GO数据库</h3><p><a href="https://geneontology.org/">GO</a>数据库全称Gene Ontology，数据库由基因本体联合会建立，是将所有与基因有关的研究结果进行分类汇总的综合数据库。可能听起来比较抽象，基因本体论的本质是用特定的一套词汇描述生物学功能，对不同物种的基因功能进行注释的统一化（去掉物种特异性），我们可以将基因按照其参与的<strong>生物过程</strong>（BiologicalProcess， BP） 、 <strong>细胞组分</strong>（Cellular Component， CC） ， <strong>分子功能</strong>（Molecular Function， MF） 三个方面进行分类注释。很多蛋白数据库都带有GO号注释信息。</p><p>GO注释目前有两种主要的注释方法：</p><ol><li>序列相似性比对，也就是上面blast方法，比对的数据库可以是Swissport，提取GO列的注释信息。</li><li>结构域相似性比对，常用的软件有<code>InterproScan</code> ，比对的数据库可以是Pfam数据库（一个蛋白质域家族的数据库），也是提取GO注释信息。</li></ol><h3 id="1-5-Swissprot数据库"><a href="#1-5-Swissprot数据库" class="headerlink" title="1.5 Swissprot数据库"></a>1.5 Swissprot数据库</h3><p>Swissprot<del>（不要打成Swissport，瑞士机场）</del>隶属于<a href="https://www.uniprot.org/">Uniprot</a>数据库，  包含<strong>经过注释和验证的严格非冗余的</strong>蛋白序列数据库， 提供了蛋白序列详尽的注释信息。也是一个非常常用的蛋白注释数据库，现在<strong>UniprotKB</strong>（Universal Protein Knowledge Base）主要由两个子库构成，一个是<code>TrEMB</code>（该部分是计算机进行分析注释的，未人工校验的蛋白），另一个就是<code>Swissprot</code>。</p><p>一般的注释方法同上，比对Swissprot数据库，统计基因组蛋白序列注释到的Swissprot数据库蛋白信息。</p><p>上面介绍的是一般情况下我们做基因功能注释要用的数据库，全都是可以用blast比对相应的数据库，最后做个汇总比如韦恩图查看各个数据库注释的情况。</p><img src="https://www.shelven.com/tuchuang/20230919/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>之所以说一般情况，是因为随着算法和技术的发展，不断有新的比对工具（比如<code>DIAMOND</code>，<a href="https://github.com/bbuchfink/diamond">速度是blast的100到10000倍</a>；还有基于隐马尔科夫模型的<code>HMMER 3</code>等）和注释流程的出现，这些经典的方法固然可用，缺点也很明显：比对速度慢，需要下载大量的比对数据库，占用资源等等。</p></div><h2 id="2-eggNOG"><a href="#2-eggNOG" class="headerlink" title="2. eggNOG"></a>2. eggNOG</h2><div class="story post-story"><p><a href="http://eggnog6.embl.de/">eggNOG</a>（evolutionary gene genealogy Non-supervised Orthologous Groups）数据库是从NCBI的COG&#x2F;KOG延伸出来的，前面介绍过这两个数据库是直系同源数据库，在2008年提出的eggNOG的时候只有这两个直系同源数据库，这两个数据库在当时一方面是数据不多（当时只有 312 个细菌、26 个古细菌和 35 个真核生物基因组），另一方面是更新缓慢，主要对当时比较基因组学研究影响较大。</p><p>看到<strong>Non-supervised</strong>无监督这几个字，相信有的小伙伴就明白了，他们用了Smith–Waterman算法（与blast齐名的寻找序列最优相似比较的算法，比blast更精准）构建了直系同源群（Orthologous Group），并且<strong>通过基因的描述文件、注释的功能类别和预测的蛋白质结构域</strong>等，自动注释这些直系同源群。这种非监督的方法，不受物种限制，不限于已有基因的功能和关系，这种灵活性、可扩展性和跨物种比较的优势，可以帮助人们发现新的功能和关系，并提供基于进化关系的功能注释。</p><p>感兴趣的可以看看下面这篇2008年的原文：</p><p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2238944/">eggNOG: automated construction and annotation of orthologous groups of genes - PMC (nih.gov)</a></p><p>经过十几年的迭代，eggNOG现在已经发布了6.0版本（2023年1月6日），总的来说，eggNOG 6.0提供了超过1700万个直系同源群 (OG) ，涵盖10756个细菌、457个古细菌和1322个真核生物，这些直系同源群可注释的信息包括 KEGG、GO、UniProtKB、BiGG、CAZy、CARD、PFAM 和 SMART。此外，eggNOG 6.0网站还推出了挖掘直系同源基因和基因功能数据分析的新功能，包括为跨物种的多个直系同源群生成系统发育图谱等。</p><p><img src="https://www.shelven.com/tuchuang/20230919/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div><h2 id="3-eggNOG-mapper"><a href="#3-eggNOG-mapper" class="headerlink" title="3. eggNOG-mapper"></a>3. eggNOG-mapper</h2><div class="story post-story"><p>eggNOG-mapper是eggNOG推出的一款进行批量基因功能注释的工具，在2021年的时候已经更新到了v2版本，主要更新了从raw contigs开始的从头基因预测、内置成对的同源预测（built-in pairwise orthology prediction）、快速检测蛋白结构域和自动生成gff文件四项功能。</p><h3 id="3-1-eggNOG-mapper原理"><a href="#3-1-eggNOG-mapper原理" class="headerlink" title="3.1 eggNOG-mapper原理"></a>3.1 eggNOG-mapper原理</h3><p>整个流程和原理可以用作者原文的一张图概括：</p><p><img src="https://www.shelven.com/tuchuang/20230919/8.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><blockquote><p>A: 编码基因预测阶段，用Prodigal从组装的contigs中进行蛋白预测（或者blastx模式预测）。</p><p>B: 搜索阶段，选择HMMER或者DIAMOND或者MMESQS2将输入的蛋白序列和EggNOG数据库进行比对，生成seed orthologs。</p><p>C: 直系同源推断阶段，根据所需要的分类范围，生成直系同源报告。</p><p>D: 注释阶段，根据蛋白注释信息和蛋白结构域注释信息，生成表格和gff格式的报告。</p></blockquote><h3 id="3-2-运行网页版eggNOG-mapper"><a href="#3-2-运行网页版eggNOG-mapper" class="headerlink" title="3.2 运行网页版eggNOG-mapper"></a>3.2 运行网页版eggNOG-mapper</h3><p>eggNOG-mapper这个工具可以下载到本地运行（主要是方便宏基因组这种大批量的注释），也可以在线运行，官方提供了在线服务地址<a href="http://eggnog-mapper.embl.de/">http://eggnog-mapper.embl.de</a></p><p>因为我自己不是做宏基因组的，所以也没必要下载工具和数据库（需要的时候再更），直接使用在线服务就可以。</p><img src="https://www.shelven.com/tuchuang/20230919/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>可以看到eggNOG-mapper在线版支持5种类型数据输入：</p><blockquote><p>Proteins：蛋白序列，上限是10万条序列</p><p>CDS：CDS序列，上限也是10万条，会在搜索前倍翻译成蛋白序列</p><p>Genomic：基因组序列，支持最多1000条DNA序列，1000万个核苷酸。直接上传基因组序列会多一步编码蛋白预测，可以选择使用<code>Prodigal</code>或者<code>Blastx-like</code>这两者之一。</p><p>Metagenomic：Contig级别的基因组序列，本质上和上面是一样的，所以限制条件也相同。同样会进行编码蛋白预测。</p><p>Seeds：eggNOG-mapper跑的seed orthologs，支持最多上传10万条，这个主要用于重新注释。</p></blockquote><p>我们前面拿到了蛋白序列，所以直接上传蛋白序列即可，注意一下上传的要求是<code>.gz</code>的压缩文件。所以稍微处理下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保留原文件，以gz格式压缩为另一个文件</span></span><br><span class="line">gzip -c Ap_rmTE.aa &gt; Ap_pep.gz</span><br></pre></td></tr></table></figure><p>上传gz文件，留下邮箱，底下还可以设置比对的参数和注释的参数，都以默认参数运行即可。稍微说下注释的一些参数：</p><img src="https://www.shelven.com/tuchuang/20230919/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><blockquote><p>Taxonomic Scope：可以手动选择的分类范围，官方建议是默认的方式，但也可以手动选择，比如我注释植物，就可以选择Viridiplantae绿色植物。这里的参数会影响流程里的直系同源推断阶段的范围，默认情况下每个序列都会自动调整。</p><p>Orthology restrictions：直系同源限制，可以选择from any ortholog或者from one to one ortholog，也是影响直系同源推断阶段的结果，后者只会在直系同源中匹配。</p><p>Gene Ontology evidence：基因本体论证据，这里是两种：1. experimental，也就是有实验支撑的（比如做过亚细胞定位啊，免疫荧光啊这些）。2. non-electronic，通俗说就是“非电子”证据，电子证据是与实验证据相距最远的，这里的指的是除实验和电子以外的证据。</p><p>PFAM refinement：这里的选项是对蛋白结构域注释的调整，可以直接出报告，也可以再将序列进行realign等。</p><p>SMART annotation：顾名思义，就是这步可以用SMART再进行蛋白质结构域预测，默认是跳过的。</p></blockquote><p>关于基因本体论的证据，GO官网有解释，我这里解释可能不是很清楚，可以查看官网对基因本体论的证据说明以及分类：</p><p><a href="https://geneontology.org/docs/guide-go-evidence-codes/">Guide to GO evidence codes (geneontology.org)</a></p><p>所有参数确定之后，点击<strong>submit</strong>，网页会提醒你查看邮件。进入邮箱，点击第一个第一个选项<strong>Click to manage your job</strong>，再点击<strong>Start job</strong>即可开始运行。</p><p><img src="https://www.shelven.com/tuchuang/20230919/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="3-3-eggNOG-mapper结果文件解读"><a href="#3-3-eggNOG-mapper结果文件解读" class="headerlink" title="3.3 eggNOG-mapper结果文件解读"></a>3.3 eggNOG-mapper结果文件解读</h3><p>在线运行还是非常快的~我这20000个左右的蛋白序列，吃个饭的功夫回来就跑完了，不用下数据库不用配置环境就可以做分析，一个字，香！</p><p><img src="https://www.shelven.com/tuchuang/20230919/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>当我们看到右上角状态为<strong>Done</strong>后，就证明已经跑完了。我们返回前一个页面，点击<strong>Access your job files here</strong>，这个链接就是我们结果文件的存储位置，注意存储是暂时的，需要我们尽快下载到本地保存。</p><p><img src="https://www.shelven.com/tuchuang/20230919/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>检查日志无报错即可。我们主要用的是其中的两个annotations文件，一个是方便你自己提取内容做富集分析（内容制表符分割，怎么提取和做GO、KEGG富集分析下次再说吧，写个脚本的事），第二个带<code>.xlsx</code>后缀方便你用excel编辑和打开。</p><p>这里主要讲一下结果文件的各项参数代表什么意思：</p><p><img src="https://www.shelven.com/tuchuang/20230919/9.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230919/9.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li><ol><li>query：蛋白序列名称</li></ol></li><li><ol start="2"><li>seed_ortholog：搜索阶段比对上的seed ortholog编号</li></ol></li><li><ol start="3"><li>evalue：evalue值，越小结果越可靠</li></ol></li><li><ol start="4"><li>score：比对的得分，越大越可靠</li></ol></li><li><ol start="5"><li>eggNOG_OGs：为序列确定的以逗号分隔、按照进化分支深度排序的直系同源组（orthologs groups，OGs）列表。每个直系同源组以OG@tax_id|tax_name方式展现。</li></ol></li><li><ol start="6"><li>max_annot_lvl：用于检索注释的最宽的直系同源组，以tax_id|tax_name方式展现。</li></ol></li><li><ol start="7"><li>COG_category：从最佳OG中推测的COG功能分类（一个字母），具体有哪些可以看这里NCBI的介绍<a href="https://www.ncbi.nlm.nih.gov/research/cog#">COG - NCBI (nih.gov)</a>。</li></ol></li><li><ol start="8"><li>Description：注释的基因功能描述（eggNOG-mapper注释的描述真的很简短……）</li></ol></li><li><ol start="9"><li>Preferred_name：普遍使用的基因名缩写</li></ol></li><li><ol start="10"><li>GOs：注释的GO编号，一个基因可能对映非常多的GO号</li></ol></li><li><ol start="11"><li>EC：KEGG的EC通路编号，代表相关的酶</li></ol></li><li><ol start="12"><li>KEGG_ko：KEGG的KO编号，表示直系同源基因，代表一个具体的功能</li></ol></li><li><ol start="13"><li>KEGG_Pathway：通常有ko编号和map编号，map编号代表reference pathway，是一种代谢通路类型，比较具体有一般参考意义</li></ol></li><li><ol start="14"><li>KEGG_Module：KEGG Module数据库编号，以M开头，实际上就是多个KO划分在一个共同发挥功能的单元里</li></ol></li><li><ol start="15"><li>KEGG_Reaction：KEGG Reaction数据库编号，以R开头，包含代谢通路上酶促反应相关信息</li></ol></li><li><ol start="16"><li>KEGG_rclass：KEGG RCLASS数据库编号，以RC编号开头，手动整理的反应数据集合</li></ol></li><li><ol start="17"><li>BRITE：KEGG的Brite数据库编号，用的不是很多，是一个储存分类信息的数据库</li></ol></li><li><ol start="18"><li>CAZy：碳水化合物酶相关的专业数据库，可以看官网<a href="http://www.cazy.org/">CAZy - Home</a></li></ol></li><li><ol start="19"><li>BiGG_Reaction：BiGG是一个整合基因组尺度代谢网络模型的数据库，官网<a href="http://bigg.ucsd.edu/">BiGG Models (ucsd.edu)</a></li></ol></li><li><ol start="20"><li>PFAMs：PFAM数据库，根据多序列比对结果和隐马尔可夫模型，将蛋白分为不同家族的一个数据库，官网<a href="https://www.ebi.ac.uk/interpro/">InterPro (ebi.ac.uk)</a>。没错官网是InterPro，pfam数据库已经被InterPro合并，并且2023年1月之后原网页就失效了。</li></ol></li></ul><p>这么多数据咋一看很头疼，可以整理一下写个脚本，做GO和KEGG富集分析，这个下次再说。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;继续更新一下基因组注释，在基因组注释的&lt;a href=&quot;https://www.shelven.com/2023/04/11/a.html&quot;&gt;第5篇博客&lt;/a&gt;中，我们已经拿到了Braker3预测的功能基因，并且删除了其中可能被TE插入而失去功能的基因。仅仅拿到这些基因CDS序列和蛋白序列肯定是不够的，我们还需要知道这些蛋白具体行使什么生物学功能。 &lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="基因组三代测序分析" scheme="http://www.shelven.com/categories/%E5%9F%BA%E5%9B%A0%E7%BB%84%E4%B8%89%E4%BB%A3%E6%B5%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="eggNOG mapper" scheme="http://www.shelven.com/tags/eggNOG-mapper/"/>
    
  </entry>
  
  <entry>
    <title>从无到有制作密码子统计工具——tkinter等工具的使用</title>
    <link href="http://www.shelven.com/2023/09/01/a.html"/>
    <id>http://www.shelven.com/2023/09/01/a.html</id>
    <published>2023-09-01T14:58:31.000Z</published>
    <updated>2023-09-04T10:39:00.615Z</updated>
    
    <content type="html"><![CDATA[<p>前阵子课题组的师弟问我怎么统计CDS序列的密码子频率，其实百度一下有很多在线分析网站可以把序列丢进去，直接出结果……</p><span id="more"></span><p><img src="https://www.shelven.com/tuchuang/20230901/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230901/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>在做密码子偏好性分析的领域，有一个老牌的经典软件<a href="https://codonw.sourceforge.net/">codonw</a>，不仅可以分析每条序列的密码子使用频率，还可以计算近10种密码子偏好性分析常用的指标，以及做关联分析（对应性分析）图。</p><p><img src="https://www.shelven.com/tuchuang/20230901/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230901/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这个工具在windows系统中要在命令行下运行，linux系统中可以通过conda安装。以及我在github上看到有人重构了原代码，用c语言写了底层方法并且绑定了python，我在用这个项目编译的时候失败了，感兴趣的话可以访问这个codonw-slim项目<a href="https://github.com/smsaladi/codonw-slim">smsaladi&#x2F;codonw-slim</a>。</p><p>当然，这篇博客的重点不是codonw软件，前面说的需求是统计CDS序列的密码子频率，使用在线工具或者现有的工具当然快——前人栽树后人乘凉，这无可厚非。我比较感兴趣的是做这些工具的逻辑，以及<strong>如何自己手搓一个工具</strong>，让一个没有任何编程经验的人可以快速用上。</p><p>python强大之处在于有着丰富和强大的第三方库，编程语言很容易懂，很适合我这种编程小白练手。想要做工具，首先就要设计图形用户界面（Graphical User Interface，GUI），<strong>tkinter</strong>是python自带的最经典的GUI编程库，官方后续又对tkinter库做了优化也就是Ttk库（基于tkinter库开发的），也有很多人写了一系列针对tkinter的美观拓展插件。万变不离其宗，掌握一个工具的用法，其他的工具思路也都是类似的。</p><p>这里不讲tkinter如何使用，网上的教程太多了，CSDN上可以翻到各种组件的详细用法，还有经典的<strong>pack</strong>、<strong>grid</strong>和<strong>place</strong>三种布局，基本概念知道了依葫芦画瓢就行。</p><p>这里我先把自己写的密码子频率统计工具的代码放出来：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> filedialog, messagebox</span><br><span class="line"><span class="keyword">from</span> tkinter.scrolledtext <span class="keyword">import</span> ScrolledText</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="comment">#from Bio import SeqIO</span></span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">codon_table = &#123;</span><br><span class="line">    <span class="string">&#x27;Ala&#x27;</span>:[<span class="string">&#x27;GCG&#x27;</span>,<span class="string">&#x27;GCA&#x27;</span>,<span class="string">&#x27;GCT&#x27;</span>,<span class="string">&#x27;GCC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Cys&#x27;</span>:[<span class="string">&#x27;TGT&#x27;</span>,<span class="string">&#x27;TGC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Asp&#x27;</span>:[<span class="string">&#x27;GAT&#x27;</span>,<span class="string">&#x27;GAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Glu&#x27;</span>:[<span class="string">&#x27;GAG&#x27;</span> ,<span class="string">&#x27;GAA&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Phe&#x27;</span>:[<span class="string">&#x27;TTT&#x27;</span> ,<span class="string">&#x27;TTC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Gly&#x27;</span>:[<span class="string">&#x27;GGG&#x27;</span>,<span class="string">&#x27;GGA&#x27;</span>,<span class="string">&#x27;GGT&#x27;</span>,<span class="string">&#x27;GGC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;His&#x27;</span>:[<span class="string">&#x27;CAT&#x27;</span>,<span class="string">&#x27;CAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Ile&#x27;</span>:[<span class="string">&#x27;ATA&#x27;</span>,<span class="string">&#x27;ATT&#x27;</span>,<span class="string">&#x27;ATC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Lys&#x27;</span>:[<span class="string">&#x27;AAG&#x27;</span>,<span class="string">&#x27;AAA&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Leu&#x27;</span>:[<span class="string">&#x27;TTG&#x27;</span>,<span class="string">&#x27;TTA&#x27;</span>,<span class="string">&#x27;CTG&#x27;</span>,<span class="string">&#x27;CTA&#x27;</span>,<span class="string">&#x27;CTT&#x27;</span>,<span class="string">&#x27;CTC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Met&#x27;</span>:[<span class="string">&#x27;ATG&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Asn&#x27;</span>:[<span class="string">&#x27;AAT&#x27;</span>,<span class="string">&#x27;AAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Pro&#x27;</span>:[<span class="string">&#x27;CCG&#x27;</span>,<span class="string">&#x27;CCA&#x27;</span>,<span class="string">&#x27;CCT&#x27;</span>,<span class="string">&#x27;CCC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Gln&#x27;</span>:[<span class="string">&#x27;CAG&#x27;</span>,<span class="string">&#x27;CAA&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Arg&#x27;</span>:[<span class="string">&#x27;AGG&#x27;</span>,<span class="string">&#x27;AGA&#x27;</span>,<span class="string">&#x27;CGG&#x27;</span>,<span class="string">&#x27;CGA&#x27;</span>,<span class="string">&#x27;CGA&#x27;</span>,<span class="string">&#x27;CGT&#x27;</span>,<span class="string">&#x27;CGC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Ser&#x27;</span>:[<span class="string">&#x27;AGT&#x27;</span>,<span class="string">&#x27;AGC&#x27;</span>,<span class="string">&#x27;TCG&#x27;</span>,<span class="string">&#x27;TCA&#x27;</span>,<span class="string">&#x27;TCT&#x27;</span>,<span class="string">&#x27;TCC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Thr&#x27;</span>:[<span class="string">&#x27;ACG&#x27;</span>,<span class="string">&#x27;ACA&#x27;</span>,<span class="string">&#x27;ACT&#x27;</span>,<span class="string">&#x27;ACC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Val&#x27;</span>:[<span class="string">&#x27;GTG&#x27;</span>,<span class="string">&#x27;GTA&#x27;</span>,<span class="string">&#x27;GTT&#x27;</span>,<span class="string">&#x27;GTC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Trp&#x27;</span>:[<span class="string">&#x27;TGG&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Tyr&#x27;</span>:[<span class="string">&#x27;TAT&#x27;</span>,<span class="string">&#x27;TAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;*&#x27;</span>:[<span class="string">&#x27;TGA&#x27;</span>,<span class="string">&#x27;TAG&#x27;</span>,<span class="string">&#x27;TAA&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读入fasta序列（代替SeqIO.parse）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fasta_generator</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        first_line = file.readline().strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> first_line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):  <span class="comment"># 给一个fasta格式判断</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid file format&#x27;</span>)</span><br><span class="line">        sequence_id = first_line[<span class="number">1</span>:]  <span class="comment"># 储存当前序列名称</span></span><br><span class="line">        sequence = <span class="string">&#x27;&#x27;</span>   <span class="comment"># 储存当前序列内容</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):    <span class="comment"># &gt;开头为序列名称行</span></span><br><span class="line">                <span class="keyword">if</span> sequence_id:     <span class="comment"># 如果已存在序列名称，返回上一个序列名称和内容</span></span><br><span class="line">                    <span class="keyword">yield</span> &#123;<span class="string">&#x27;id&#x27;</span>: sequence_id, <span class="string">&#x27;seq&#x27;</span>: sequence&#125;</span><br><span class="line">                sequence_id = line[<span class="number">1</span>:]</span><br><span class="line">                sequence = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:       <span class="comment"># 否则，行为序列内容</span></span><br><span class="line">                sequence += line</span><br><span class="line">        <span class="keyword">if</span> sequence_id:     <span class="comment"># 处理完最后一个序列，返回最后一个序列名称和内容</span></span><br><span class="line">            <span class="keyword">yield</span> &#123;<span class="string">&#x27;id&#x27;</span>: sequence_id, <span class="string">&#x27;seq&#x27;</span>: sequence&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MY_GUI</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化函数，定义实例的属性</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,init_window_name</span>):</span><br><span class="line">        self.init_window_name = init_window_name</span><br><span class="line">        self.image_file = <span class="literal">None</span>  <span class="comment"># PhotoImage没有引用会自动销毁，这里需要显示引用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义一个类方法，设置窗口</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_init_window</span>(<span class="params">self</span>):</span><br><span class="line">        self.init_window_name.title(<span class="string">&quot;密码子统计工具_v1.0&quot;</span>)                    </span><br><span class="line">        self.init_window_name.geometry(<span class="string">&#x27;1048x680+400+150&#x27;</span>)    <span class="comment"># 1068x681窗口大小，+横坐标 +纵坐标 定义窗口弹出时的默认展示位置</span></span><br><span class="line">        self.init_window_name.attributes(<span class="string">&quot;-alpha&quot;</span>,<span class="number">1</span>)  <span class="comment"># 虚化，值越小虚化程度越高</span></span><br><span class="line">        self.init_window_name.iconbitmap(<span class="string">&#x27;pic/bitbug_favicon.ico&#x27;</span>)<span class="comment"># 可以换自己的ico图标</span></span><br><span class="line">        self.init_window_name.resizable(<span class="number">0</span>,<span class="number">0</span>)    <span class="comment"># 禁止改变窗口大小</span></span><br><span class="line">        <span class="comment"># 画布（可以不要，或者换自己的gif图片）</span></span><br><span class="line">        canvas = Canvas(self.init_window_name, width=<span class="number">1024</span>, height=<span class="number">680</span>, bg=<span class="literal">None</span>)</span><br><span class="line">        self.image_file = PhotoImage(file=<span class="string">&quot;pic/bg.gif&quot;</span>)</span><br><span class="line">        self.resized_image = self.image_file.zoom(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        canvas.create_image(<span class="number">520</span>, <span class="number">35</span>, anchor=<span class="string">&#x27;n&#x27;</span>, image=self.resized_image)</span><br><span class="line">        canvas.grid(row=<span class="number">0</span>,rowspan = <span class="number">20</span>,column=<span class="number">0</span>,columnspan=<span class="number">23</span>)</span><br><span class="line">        <span class="comment"># frame(暂时不用了)</span></span><br><span class="line">        <span class="comment">#self.frame = Frame(self.init_window_name, borderwidth=1, height=2, relief=&#x27;groove&#x27;,bd=1)</span></span><br><span class="line">        <span class="comment">#self.frame.grid(row=21,column=0, columnspan=24)</span></span><br><span class="line">        <span class="comment"># 标签</span></span><br><span class="line">        self.init_data_label = Label(self.init_window_name, text=<span class="string">&quot;导入序列&quot;</span>)</span><br><span class="line">        self.init_data_label.grid(row=<span class="number">0</span>, column=<span class="number">0</span>)</span><br><span class="line">        self.result_data_label = Label(self.init_window_name, text=<span class="string">&quot;Number(Frequency)&quot;</span>)</span><br><span class="line">        self.result_data_label.grid(row=<span class="number">0</span>, column=<span class="number">12</span>)</span><br><span class="line">        self.result_out_label = Label(self.init_window_name, text=<span class="string">&quot;Codon Usage results&quot;</span>)</span><br><span class="line">        self.result_out_label.grid(row=<span class="number">6</span>,column=<span class="number">13</span>)</span><br><span class="line">        self.log_label = Label(self.init_window_name, text=<span class="string">&quot;运行日志&quot;</span>)</span><br><span class="line">        self.log_label.grid(row=<span class="number">11</span>, column=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># 文本框</span></span><br><span class="line">        self.init_data_Text = ScrolledText(self.init_window_name, width=<span class="number">60</span>, height=<span class="number">35</span>)  <span class="comment"># 原始数据录入框</span></span><br><span class="line">        self.init_data_Text.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, rowspan=<span class="number">10</span>, columnspan=<span class="number">10</span>, padx=<span class="number">20</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.init_data_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)   <span class="comment"># 绑定事件禁止键入</span></span><br><span class="line">        self.log_data_Text = ScrolledText(self.init_window_name, width=<span class="number">60</span>, height=<span class="number">9</span>,)  <span class="comment"># 日志框</span></span><br><span class="line">        self.log_data_Text.grid(row=<span class="number">12</span>, column=<span class="number">0</span>, rowspan=<span class="number">5</span>, columnspan=<span class="number">10</span>,padx=<span class="number">20</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.log_data_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)</span><br><span class="line">        self.result_data_Text = ScrolledText(self.init_window_name, width=<span class="number">60</span>, height=<span class="number">20</span>, wrap=<span class="string">&#x27;none&#x27;</span>)  <span class="comment"># 频数频率展示</span></span><br><span class="line">        self.result_data_Text.grid(row=<span class="number">1</span>, column=<span class="number">12</span>, rowspan=<span class="number">5</span>, columnspan=<span class="number">10</span>, padx=<span class="number">10</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.result_data_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)</span><br><span class="line">        self.result_fre_Text = ScrolledText(self.init_window_name, width=<span class="number">40</span>, height=<span class="number">20</span>)     <span class="comment"># 结果展示</span></span><br><span class="line">        self.result_fre_Text.grid(row=<span class="number">7</span>, column=<span class="number">12</span>, rowspan=<span class="number">10</span>, columnspan=<span class="number">10</span>,padx=<span class="number">10</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.result_fre_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)</span><br><span class="line">        <span class="comment"># 按钮</span></span><br><span class="line">        self.load_file_button = Button(self.init_window_name, text = <span class="string">&quot;导入fasta文件&quot;</span>,borderwidth=<span class="number">2</span>,relief=RAISED, command=self.select_file) <span class="comment"># 绑定内部命令</span></span><br><span class="line">        self.load_file_button.grid(row=<span class="number">2</span>, column=<span class="number">11</span>)</span><br><span class="line">        self.codon_count_button = Button(self.init_window_name, text=<span class="string">&quot;开始统计&quot;</span>,borderwidth=<span class="number">2</span>,relief=RAISED,command=self.codon_count)</span><br><span class="line">        self.codon_count_button.grid(row=<span class="number">3</span>, column=<span class="number">11</span>)</span><br><span class="line">        self.export_count_button = Button(self.init_window_name, text=<span class="string">&quot;导出表格&quot;</span>,borderwidth=<span class="number">2</span>,relief=RAISED,command=self.export_count)</span><br><span class="line">        self.export_count_button.grid(row=<span class="number">4</span>, column=<span class="number">11</span>)</span><br><span class="line">        self.export_fre_button = Button(self.init_window_name, text=<span class="string">&quot;导出结果&quot;</span>, borderwidth=<span class="number">2</span>,relief=RAISED,command=self.export_fre)</span><br><span class="line">        self.export_fre_button.grid(row=<span class="number">5</span>,column=<span class="number">11</span>)</span><br><span class="line">        self.clean_button = Button(self.init_window_name, text=<span class="string">&#x27;清空窗口&#x27;</span>, borderwidth=<span class="number">2</span>,relief=RAISED,command=self.window_clean)</span><br><span class="line">        self.clean_button.grid(row=<span class="number">6</span>,column=<span class="number">11</span>)</span><br><span class="line">        <span class="comment"># 滚轮与绑定（ScrolledText只带有垂直滚动条）</span></span><br><span class="line">        self.scrollbar_x = Scrollbar(self.init_window_name, orient=HORIZONTAL)  <span class="comment"># 创建滚动条部件</span></span><br><span class="line">        self.result_data_Text.config(xscrollcommand=self.scrollbar_x.<span class="built_in">set</span>)   <span class="comment"># 文本框-控制-滚动条</span></span><br><span class="line">        self.scrollbar_x.config(command=self.result_data_Text.xview)    <span class="comment"># 滚动条-控制-文本框</span></span><br><span class="line">        self.scrollbar_x.grid(row=<span class="number">5</span>, column=<span class="number">12</span>, rowspan=<span class="number">1</span>,columnspan=<span class="number">10</span>, sticky=<span class="string">&quot;ESW&quot;</span>,padx=<span class="number">10</span>)   <span class="comment"># 设置滚动条位置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导入序列功能函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_file</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">global</span> file_name</span><br><span class="line">        file_name = filedialog.askopenfilename(title=<span class="string">&quot;选择文件&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> file_name != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:  </span><br><span class="line">                records = fasta_generator(file_name)</span><br><span class="line">                number = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> records:</span><br><span class="line">                    name = i[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                    seq = i[<span class="string">&#x27;seq&#x27;</span>]</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(seq)&gt;<span class="number">48</span>:</span><br><span class="line">                        seq = seq[:<span class="number">45</span>] + <span class="string">&#x27;...&#x27;</span> + seq[-<span class="number">3</span>:]</span><br><span class="line">                    self.init_data_Text.insert(END,<span class="string">f&quot;Name:<span class="subst">&#123;name&#125;</span>\nSeq:&#x27;<span class="subst">&#123;seq&#125;</span>&#x27;\n&quot;</span>)</span><br><span class="line">                    number += <span class="number">1</span></span><br><span class="line">                self.write_log_to_Text(<span class="string">f&quot;INFO:fasta文件导入成功！共加载<span class="subst">&#123;number&#125;</span>条序列。&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                messagebox.showerror(<span class="string">&quot;ERROR&quot;</span>, <span class="string">&quot;载入失败，请检查文件是否为fasta格式！&quot;</span>)</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;ERROR:载入失败，请检查文件格式。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 分析统计功能函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">codon_count</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> file_name != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            records = fasta_generator(file_name)</span><br><span class="line">            CodonsDict = OrderedDict([(<span class="string">&#x27;GCG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GCA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GCT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GCC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TGT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TGC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GAT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GAC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GAG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GAA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TTT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TTC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GGG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GGA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GGT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GGC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CAT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CAC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ATA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ATT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ATC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AAG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AAA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TTG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TTA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CTG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CTA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CTT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CTC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ATG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AAT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AAC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CCG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CCA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CCT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CCC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CAG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CAA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AGG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AGA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CGG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CGA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CGT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;CGC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AGT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;AGC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TCG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TCA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TCT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TCC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ACG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ACA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ACT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;ACC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GTG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GTA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GTT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;GTC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TGG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TAT&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TAC&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TGA&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TAG&#x27;</span>, <span class="number">0</span>), (<span class="string">&#x27;TAA&#x27;</span>, <span class="number">0</span>)])</span><br><span class="line">            <span class="comment"># 输出表头</span></span><br><span class="line">            self.result_data_Text.insert(END, <span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27;Name&#x27;</span>:&lt;<span class="number">15</span>&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> CodonsDict:</span><br><span class="line">                <span class="keyword">if</span> key != <span class="string">&#x27;TAA&#x27;</span>:</span><br><span class="line">                    self.result_data_Text.insert(END, <span class="string">f&#x27;<span class="subst">&#123;key:&lt;<span class="number">12</span>&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.result_data_Text.insert(END,<span class="string">f&#x27;<span class="subst">&#123;key:&lt;<span class="number">12</span>&#125;</span>\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> records:</span><br><span class="line">                <span class="comment"># 每条序列判断ATG开头，是否有屏蔽序列,长度是否为3的倍数</span></span><br><span class="line">                <span class="keyword">if</span> i[<span class="string">&#x27;seq&#x27;</span>].startswith(<span class="string">&#x27;ATG&#x27;</span>) <span class="keyword">and</span> <span class="string">&#x27;N&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> i[<span class="string">&#x27;seq&#x27;</span>] <span class="keyword">and</span> <span class="built_in">len</span>(i[<span class="string">&#x27;seq&#x27;</span>]) % <span class="number">3</span> ==<span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(<span class="built_in">str</span>(i[<span class="string">&#x27;seq&#x27;</span>])), <span class="number">3</span>):</span><br><span class="line">                        codon = <span class="built_in">str</span>(i[<span class="string">&#x27;seq&#x27;</span>])[j:j+<span class="number">3</span>]</span><br><span class="line">                        <span class="keyword">if</span> codon <span class="keyword">in</span> CodonsDict.keys():</span><br><span class="line">                            CodonsDict[codon] +=<span class="number">1</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            self.write_log_to_Text(<span class="string">&quot;WARNING:序列%s存在未识别的密码子，跳过。&quot;</span> % (i[<span class="string">&#x27;id&#x27;</span>]))</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    total = <span class="built_in">sum</span>([CodonsDict[key] <span class="keyword">for</span> key <span class="keyword">in</span> CodonsDict.keys()])</span><br><span class="line">                    name = i[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                    self.result_data_Text.insert(END, <span class="string">f&#x27;<span class="subst">&#123;name:&lt;<span class="number">15</span>&#125;</span>&#x27;</span>)    <span class="comment"># 这里的f-string格式化输出f&#x27;&#123;i[&#x27;id&#x27;]:&lt;15&#125;&#x27;会报错，所以用了个变量name代替</span></span><br><span class="line">                    self.result_fre_Text.insert(END,<span class="string">&#x27;Results for %d residue sequence &quot;%s&quot;:\n\nAA\tCodon\tNumber\tFrequency\n\n&#x27;</span> % (total, i[<span class="string">&#x27;id&#x27;</span>]))</span><br><span class="line">                    <span class="keyword">for</span> key <span class="keyword">in</span> CodonsDict.keys():</span><br><span class="line">                        <span class="comment"># 计算每个密码子使用频率（标准密码子表）</span></span><br><span class="line">                        frequency = <span class="string">&quot;%.2f&quot;</span> % (CodonsDict[key]*<span class="number">3000</span>/total)</span><br><span class="line">                        content = <span class="built_in">str</span>(CodonsDict[key]) + <span class="string">&#x27;(%s)&#x27;</span> % (frequency)</span><br><span class="line">                        self.result_data_Text.insert(END,<span class="string">f&#x27;<span class="subst">&#123;content:&lt;<span class="number">12</span>&#125;</span>&#x27;</span>)</span><br><span class="line">                        <span class="keyword">if</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Ala&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Ala\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Cys&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Cys\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Asp&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Asp\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Glu&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Glu\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Phe&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Phe\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Gly&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Gly\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;His&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;His\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Ile&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Ile\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Lys&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Lys\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Leu&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Leu\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Met&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Met\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Asn&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Asn\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Pro&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Pro\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Gln&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Gln\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Arg&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Arg\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Ser&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Ser\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Thr&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Thr\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Val&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Val\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Trp&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Trp\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;Tyr&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;Tyr\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                        <span class="keyword">elif</span> key <span class="keyword">in</span> codon_table[<span class="string">&#x27;*&#x27;</span>]:</span><br><span class="line">                            self.result_fre_Text.insert(END,<span class="string">&#x27;*\t%s\t%d\t%s\n&#x27;</span> % (key, CodonsDict[key], frequency))</span><br><span class="line">                    self.result_fre_Text.insert(END,<span class="string">&#x27;\n----------------------------------------\n&#x27;</span> )</span><br><span class="line">                    self.result_data_Text.insert(END,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.write_log_to_Text(<span class="string">&quot;WARNING:序列%s非ATG开头/存在屏蔽序列/非3的倍数，该序列将不会出现在统计结果中。&quot;</span> % (i[<span class="string">&#x27;id&#x27;</span>]))</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;INFO:统计结束!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;ERROR:请先载入fasta文件！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导出频数频率统计表</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_count</span>(<span class="params">self</span>):</span><br><span class="line">        content = self.result_data_Text.get(<span class="string">&#x27;1.0&#x27;</span>, END)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> content:</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;ERROR:请先点击“载入fasta文件”并点击“开始统计”按钮！&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                count_file = filedialog.asksaveasfilename()</span><br><span class="line">                count_file = count_file + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(count_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> count:</span><br><span class="line">                    content = re.sub(<span class="string">r&quot;[^\S\r\n]+&quot;</span>,<span class="string">&#x27;,&#x27;</span>,content) <span class="comment"># 正则匹配换行符之外的所有空格</span></span><br><span class="line">                    count.write(content)</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;INFO:密码子频数频率统计表保存成功!文件路径：%s&quot;</span> % (count_file))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;ERROR:ERROR:导出失败，请检查是否有同名文件未关闭！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导出结果文件</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_fre</span>(<span class="params">self</span>):</span><br><span class="line">        content = self.result_fre_Text.get(<span class="string">&#x27;1.0&#x27;</span>, END)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Results&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> content:</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;ERROR:请先点击“载入fasta文件”并点击“开始统计”按钮！&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result_file = filedialog.asksaveasfilename()</span><br><span class="line">                result_file = result_file + <span class="string">&#x27;.txt&#x27;</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(result_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> out:</span><br><span class="line">                    out.write(content)</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;INFO:结果文件保存成功!保存路径：%s&quot;</span> % (result_file))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;ERROR:导出失败，请检查是否有同名文件未关闭！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 清空所有文本框</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">window_clean</span>(<span class="params">self</span>):</span><br><span class="line">        self.init_data_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        self.log_data_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        self.result_data_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        self.result_fre_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志打印</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_log_to_Text</span>(<span class="params">self,logmsg</span>):</span><br><span class="line">        current_time = time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,time.localtime(time.time()))</span><br><span class="line">        logmsg_in = <span class="built_in">str</span>(current_time) +<span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(logmsg) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">        self.log_data_Text.insert(END, logmsg_in)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gui_start</span>():</span><br><span class="line">    init_window = Tk()</span><br><span class="line">    GUI = MY_GUI(init_window)</span><br><span class="line">    GUI.set_init_window()</span><br><span class="line">    init_window.mainloop()</span><br><span class="line"></span><br><span class="line">gui_start()</span><br></pre></td></tr></table></figure><p>第一次用tkinter这个工具，代码看起来也有点乱……就当作自己的尝试 &#x3D; &#x3D;，各个部件写了注释方便以后自己参考。</p><p>运行时可以生成如下gui界面：</p><p><img src="https://www.shelven.com/tuchuang/20230901/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230901/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>界面比较简单，点击“导入fasta文件”，左边的文本框可以看到序列大致信息，点击“开始统计”后右边两个文本框可以输出两种格式的结果，后面两个按钮分别自定义导出两种结果，“清空窗口”就是清除文本框的所有数据。</p><p>整体逻辑是<strong>识别导入的序列是否是ATG开头，是否含有屏蔽序列，长度是否能被3整除</strong>，以上条件都满足才会计入右边的统计结果，否则跳过该序列，跳过的信息会在运行日志框中显示。如果用的不是标准密码子表，可以自行更改<strong>codon_table</strong>变量。</p><p>除开代码中间一大堆判断密码子编码哪个氨基酸（我是真的没想到还能用什么方法判断21种不同的编码氨基酸），其他地方都尽量写地简洁了一些。原先打算直接用<strong>Bio</strong>库<code>SeqIO.parse</code>的方法载入序列，确实很方便，但是不利于程序的最后打包……Bio库的一个依赖库是<strong>numpy</strong>，用过python的小伙伴都知道numpy也是一个重量级科学计算库，但是用<code>pyinstaller</code>将程序打包成可执行文件的时候，numpy有一个重量级的openblas依赖，可以看看有多“重量级”：</p><p><img src="https://www.shelven.com/tuchuang/20230901/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230901/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>一个依赖占了37Mb的空间……况且我用Bio库只是为了导入和识别fasta序列，所以这里搓了个<code>fasta_generator()</code>方法函数来代替<code>SeqIO.parse</code>，调用方法函数后都是生成一个生成器对象，逐行读取fasta文件，<code>id</code>储存序列名称，<code>seq</code>储存序列内容。这样就不用调用Bio库，可以看到这里调用的都是python的内置库，可以有效减少打包后的体量。</p><p>说到打包，为什么要打包？因为写的python程序要运行起来还有个前提，就是别人的电脑里也装了python，并且要在命令行中运行python解释器，这不是我的最终目的，因此接下来是把py文件“转“成能在windows系统中运行的可执行文件，这里用典型的python打包库<code>pyinstaller</code>。因为pyinstaller不是自带的python库，所以需要单独安装。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 在windows命令行的对应文件路径下（我是windows环境下开发的）</span><br><span class="line">pip install pyinstaller</span><br><span class="line"></span><br><span class="line">pyinstaller -w -D -n Codon -i bitbug_favicon.ico codon.py</span><br></pre></td></tr></table></figure><blockquote><p>pyinstaller参数：</p><ul><li>-w 指定程序运行时不显示命令行窗口（美观起见，发给别人用就加这个参数）</li><li>-D 产生一个目录作为可执行程序（如果想都打包进一个可执行文件的话，用参数-F，运行起来会很慢！）</li><li>-n 指定项目名称</li><li>-i 指定可执行文件图标，ico格式</li><li>–hidden-impor 如果有隐藏导入项（非标准库）的时候需要手动加入</li></ul></blockquote><p><code>pyinstaller</code>安装后可以直接使用，如果提示该命令不是系统命令的话，需要把对应的exe文件路径写到环境变量中。</p><p>打包后会在当前目录生成<strong>spec后缀</strong>的打包配置文件，名为<strong>build</strong>的中间文件，还有<strong>dist</strong>——最终生成的可执行文件所在目录。我们打包的可执行程序就在dist中。</p><p>这里<strong>打包以后还要注意</strong>，py脚本中<strong>导入的图片不会被打包</strong>，找到<strong>exe</strong>文件，根据脚本中写的导入图片的相对路径，创建文件夹<strong>pic</strong>并且把图片一起丢进去。还可以顺便把自己的测试文件也创个<strong>test</strong>文件夹丢进去。</p><p>最终整个文件夹打包后的大小为25.6Mb……怎么说呢，python写的代码转成exe文件体量就是会很大，相比之下原来的一个依赖就要37Mb，已经好很多了……</p><img src="https://www.shelven.com/tuchuang/20230901/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230901/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>既然都做到这一步了，顺便就把整个文件夹再打包打包做个windows安装包<del>（虽然也可以直接打包成压缩包，但是少了点仪式感）</del>，麻雀虽小五脏俱全，体验下流程~</p><p>制作windows安装包要用到两个软件：</p><ul><li>NSIS——开源的Windows系统安装程序制作工具，相当于一门脚本语言，描述安装程序的行为和逻辑</li><li>HM NIS Edit——NSIS编辑器，以向导的方式自动生成NSIS脚本，再通过NSIS编译成windows安装包</li></ul><p>这两个软件就像咱学生信用到的R和Rstudio，没啥好说的，在后者创建一个脚本向导，只要点点选择按钮就可以定制自己程序的安装和卸载过程以及逻辑了，不需要专门去学这个脚本语言，非常方便。</p><p>下载和使用过程CSDN上有详细的每一步流程，放个链接，不重复造轮子。<a href="https://blog.csdn.net/qq_43647590/article/details/130057285">Windows下使用Pyinstaller做成客户端安装包_</a></p><p>瞧这安装界面，是不是有那味儿了~</p><p><img src="https://www.shelven.com/tuchuang/20230901/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230901/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>软件安装包顺便在这里也备份一个，可以直接在windows系统中安装使用，以后有空再做界面的美化和其他新功能。<a href="https://www.shelven.com/tuchuang/Setup.exe">点击这里获取安装包</a></p><h2 id="2023-x2F-09-x2F-04-更新"><a href="#2023-x2F-09-x2F-04-更新" class="headerlink" title="2023&#x2F;09&#x2F;04 更新"></a>2023&#x2F;09&#x2F;04 更新</h2><div class="story post-story"><p>我真的是脑子抽了用了二十几个判断……既然写了标准密码子表，只要判断是不是在condon_table中并且输出key值就可以了，后面输出格式都是一样的……顺便优化了一下代码，有序字典也不用了。</p><p>果然代码还是要多练，越看越不对劲，以后尽量避免“面向结果编程”的错误 &#x3D; &#x3D;</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> filedialog, messagebox</span><br><span class="line"><span class="keyword">from</span> tkinter.scrolledtext <span class="keyword">import</span> ScrolledText</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">codon_table = &#123;</span><br><span class="line">    <span class="string">&#x27;Ala&#x27;</span>:[<span class="string">&#x27;GCG&#x27;</span>,<span class="string">&#x27;GCA&#x27;</span>,<span class="string">&#x27;GCT&#x27;</span>,<span class="string">&#x27;GCC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Cys&#x27;</span>:[<span class="string">&#x27;TGT&#x27;</span>,<span class="string">&#x27;TGC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Asp&#x27;</span>:[<span class="string">&#x27;GAT&#x27;</span>,<span class="string">&#x27;GAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Glu&#x27;</span>:[<span class="string">&#x27;GAG&#x27;</span> ,<span class="string">&#x27;GAA&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Phe&#x27;</span>:[<span class="string">&#x27;TTT&#x27;</span> ,<span class="string">&#x27;TTC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Gly&#x27;</span>:[<span class="string">&#x27;GGG&#x27;</span>,<span class="string">&#x27;GGA&#x27;</span>,<span class="string">&#x27;GGT&#x27;</span>,<span class="string">&#x27;GGC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;His&#x27;</span>:[<span class="string">&#x27;CAT&#x27;</span>,<span class="string">&#x27;CAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Ile&#x27;</span>:[<span class="string">&#x27;ATA&#x27;</span>,<span class="string">&#x27;ATT&#x27;</span>,<span class="string">&#x27;ATC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Lys&#x27;</span>:[<span class="string">&#x27;AAG&#x27;</span>,<span class="string">&#x27;AAA&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Leu&#x27;</span>:[<span class="string">&#x27;TTG&#x27;</span>,<span class="string">&#x27;TTA&#x27;</span>,<span class="string">&#x27;CTG&#x27;</span>,<span class="string">&#x27;CTA&#x27;</span>,<span class="string">&#x27;CTT&#x27;</span>,<span class="string">&#x27;CTC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Met&#x27;</span>:[<span class="string">&#x27;ATG&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Asn&#x27;</span>:[<span class="string">&#x27;AAT&#x27;</span>,<span class="string">&#x27;AAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Pro&#x27;</span>:[<span class="string">&#x27;CCG&#x27;</span>,<span class="string">&#x27;CCA&#x27;</span>,<span class="string">&#x27;CCT&#x27;</span>,<span class="string">&#x27;CCC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Gln&#x27;</span>:[<span class="string">&#x27;CAG&#x27;</span>,<span class="string">&#x27;CAA&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Arg&#x27;</span>:[<span class="string">&#x27;AGG&#x27;</span>,<span class="string">&#x27;AGA&#x27;</span>,<span class="string">&#x27;CGG&#x27;</span>,<span class="string">&#x27;CGA&#x27;</span>,<span class="string">&#x27;CGA&#x27;</span>,<span class="string">&#x27;CGT&#x27;</span>,<span class="string">&#x27;CGC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Ser&#x27;</span>:[<span class="string">&#x27;AGT&#x27;</span>,<span class="string">&#x27;AGC&#x27;</span>,<span class="string">&#x27;TCG&#x27;</span>,<span class="string">&#x27;TCA&#x27;</span>,<span class="string">&#x27;TCT&#x27;</span>,<span class="string">&#x27;TCC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Thr&#x27;</span>:[<span class="string">&#x27;ACG&#x27;</span>,<span class="string">&#x27;ACA&#x27;</span>,<span class="string">&#x27;ACT&#x27;</span>,<span class="string">&#x27;ACC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Val&#x27;</span>:[<span class="string">&#x27;GTG&#x27;</span>,<span class="string">&#x27;GTA&#x27;</span>,<span class="string">&#x27;GTT&#x27;</span>,<span class="string">&#x27;GTC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Trp&#x27;</span>:[<span class="string">&#x27;TGG&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Tyr&#x27;</span>:[<span class="string">&#x27;TAT&#x27;</span>,<span class="string">&#x27;TAC&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;*&#x27;</span>:[<span class="string">&#x27;TGA&#x27;</span>,<span class="string">&#x27;TAG&#x27;</span>,<span class="string">&#x27;TAA&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读入fasta序列（代替SeqIO.parse）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fasta_generator</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        first_line = file.readline().strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> first_line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):  <span class="comment"># 给一个fasta格式判断</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid file format&#x27;</span>)</span><br><span class="line">        sequence_id = first_line[<span class="number">1</span>:]  <span class="comment"># 储存当前序列名称</span></span><br><span class="line">        sequence = <span class="string">&#x27;&#x27;</span>   <span class="comment"># 储存当前序列内容</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;&gt;&#x27;</span>):    <span class="comment"># &gt;开头为序列名称行</span></span><br><span class="line">                <span class="keyword">if</span> sequence_id:     <span class="comment"># 如果已存在序列名称，返回上一个序列名称和内容</span></span><br><span class="line">                    <span class="keyword">yield</span> &#123;<span class="string">&#x27;id&#x27;</span>: sequence_id, <span class="string">&#x27;seq&#x27;</span>: sequence&#125;</span><br><span class="line">                sequence_id = line[<span class="number">1</span>:]</span><br><span class="line">                sequence = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:       <span class="comment"># 否则，行为序列内容</span></span><br><span class="line">                sequence += line</span><br><span class="line">        <span class="keyword">if</span> sequence_id:     <span class="comment"># 处理完最后一个序列，返回最后一个序列名称和内容</span></span><br><span class="line">            <span class="keyword">yield</span> &#123;<span class="string">&#x27;id&#x27;</span>: sequence_id, <span class="string">&#x27;seq&#x27;</span>: sequence&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MY_GUI</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化函数，定义实例的属性</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,init_window_name</span>):</span><br><span class="line">        self.init_window_name = init_window_name</span><br><span class="line">        self.image_file = <span class="literal">None</span>  <span class="comment"># PhotoImage没有引用会自动销毁，这里需要显示引用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义一个类方法，设置窗口</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_init_window</span>(<span class="params">self</span>):</span><br><span class="line">        self.init_window_name.title(<span class="string">&quot;密码子统计工具_v1.0&quot;</span>)                    </span><br><span class="line">        self.init_window_name.geometry(<span class="string">&#x27;1048x680+400+150&#x27;</span>)    <span class="comment"># 1068x681窗口大小，+横坐标 +纵坐标 定义窗口弹出时的默认展示位置</span></span><br><span class="line">        self.init_window_name.attributes(<span class="string">&quot;-alpha&quot;</span>,<span class="number">1</span>)  <span class="comment"># 虚化，值越小虚化程度越高</span></span><br><span class="line">        self.init_window_name.iconbitmap(<span class="string">&#x27;d:/zhuomian/python/myscript/codon/codon源码/bitbug_favicon.ico&#x27;</span>)</span><br><span class="line">        self.init_window_name.resizable(<span class="number">0</span>,<span class="number">0</span>)    <span class="comment"># 禁止改变窗口大小</span></span><br><span class="line">        canvas = Canvas(self.init_window_name, width=<span class="number">1024</span>, height=<span class="number">680</span>, bg=<span class="literal">None</span>)</span><br><span class="line">        self.image_file = PhotoImage(file=<span class="string">&quot;d:/zhuomian/python/myscript/codon/codon源码/bg.gif&quot;</span>)</span><br><span class="line">        self.resized_image = self.image_file.zoom(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        canvas.create_image(<span class="number">520</span>, <span class="number">35</span>, anchor=<span class="string">&#x27;n&#x27;</span>, image=self.resized_image)</span><br><span class="line">        canvas.grid(row=<span class="number">0</span>,rowspan = <span class="number">20</span>,column=<span class="number">0</span>,columnspan=<span class="number">23</span>)</span><br><span class="line">        <span class="comment"># 标签</span></span><br><span class="line">        self.init_data_label = Label(self.init_window_name, text=<span class="string">&quot;导入序列&quot;</span>)</span><br><span class="line">        self.init_data_label.grid(row=<span class="number">0</span>, column=<span class="number">0</span>)</span><br><span class="line">        self.result_data_label = Label(self.init_window_name, text=<span class="string">&quot;Number(Frequency)&quot;</span>)</span><br><span class="line">        self.result_data_label.grid(row=<span class="number">0</span>, column=<span class="number">12</span>)</span><br><span class="line">        self.result_out_label = Label(self.init_window_name, text=<span class="string">&quot;Codon Usage results&quot;</span>)</span><br><span class="line">        self.result_out_label.grid(row=<span class="number">6</span>,column=<span class="number">13</span>)</span><br><span class="line">        self.log_label = Label(self.init_window_name, text=<span class="string">&quot;运行日志&quot;</span>)</span><br><span class="line">        self.log_label.grid(row=<span class="number">11</span>, column=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># 文本框</span></span><br><span class="line">        self.init_data_Text = ScrolledText(self.init_window_name, width=<span class="number">60</span>, height=<span class="number">35</span>)  <span class="comment"># 原始数据录入框</span></span><br><span class="line">        self.init_data_Text.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, rowspan=<span class="number">10</span>, columnspan=<span class="number">10</span>, padx=<span class="number">20</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.init_data_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)   <span class="comment"># 绑定事件禁止键入</span></span><br><span class="line">        self.log_data_Text = ScrolledText(self.init_window_name, width=<span class="number">60</span>, height=<span class="number">9</span>,)  <span class="comment"># 日志框</span></span><br><span class="line">        self.log_data_Text.grid(row=<span class="number">12</span>, column=<span class="number">0</span>, rowspan=<span class="number">5</span>, columnspan=<span class="number">10</span>,padx=<span class="number">20</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.log_data_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)</span><br><span class="line">        self.result_data_Text = ScrolledText(self.init_window_name, width=<span class="number">60</span>, height=<span class="number">20</span>, wrap=<span class="string">&#x27;none&#x27;</span>)  <span class="comment"># 频数频率展示</span></span><br><span class="line">        self.result_data_Text.grid(row=<span class="number">1</span>, column=<span class="number">12</span>, rowspan=<span class="number">5</span>, columnspan=<span class="number">10</span>, padx=<span class="number">10</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.result_data_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)</span><br><span class="line">        self.result_fre_Text = ScrolledText(self.init_window_name, width=<span class="number">40</span>, height=<span class="number">20</span>)     <span class="comment"># 结果展示</span></span><br><span class="line">        self.result_fre_Text.grid(row=<span class="number">7</span>, column=<span class="number">12</span>, rowspan=<span class="number">10</span>, columnspan=<span class="number">10</span>,padx=<span class="number">10</span>,pady=<span class="number">5</span>)</span><br><span class="line">        self.result_fre_Text.bind(<span class="string">&#x27;&lt;KeyPress&gt;&#x27;</span>, <span class="keyword">lambda</span> f: <span class="string">&#x27;break&#x27;</span>)</span><br><span class="line">        <span class="comment"># 按钮</span></span><br><span class="line">        self.load_file_button = Button(self.init_window_name, text = <span class="string">&quot;导入fasta文件&quot;</span>,borderwidth=<span class="number">2</span>,relief=RAISED, command=self.select_file) <span class="comment"># 绑定内部命令</span></span><br><span class="line">        self.load_file_button.grid(row=<span class="number">2</span>, column=<span class="number">11</span>)</span><br><span class="line">        self.codon_count_button = Button(self.init_window_name, text=<span class="string">&quot;开始统计&quot;</span>,borderwidth=<span class="number">2</span>,relief=RAISED,command=self.codon_count)</span><br><span class="line">        self.codon_count_button.grid(row=<span class="number">3</span>, column=<span class="number">11</span>)</span><br><span class="line">        self.export_count_button = Button(self.init_window_name, text=<span class="string">&quot;导出表格&quot;</span>,borderwidth=<span class="number">2</span>,relief=RAISED,command=self.export_count)</span><br><span class="line">        self.export_count_button.grid(row=<span class="number">4</span>, column=<span class="number">11</span>)</span><br><span class="line">        self.export_fre_button = Button(self.init_window_name, text=<span class="string">&quot;导出结果&quot;</span>, borderwidth=<span class="number">2</span>,relief=RAISED,command=self.export_fre)</span><br><span class="line">        self.export_fre_button.grid(row=<span class="number">5</span>,column=<span class="number">11</span>)</span><br><span class="line">        self.clean_button = Button(self.init_window_name, text=<span class="string">&#x27;清空窗口&#x27;</span>, borderwidth=<span class="number">2</span>,relief=RAISED,command=self.window_clean)</span><br><span class="line">        self.clean_button.grid(row=<span class="number">6</span>,column=<span class="number">11</span>)</span><br><span class="line">        <span class="comment"># 滚轮与绑定（ScrolledText只带有垂直滚动条）</span></span><br><span class="line">        self.scrollbar_x = Scrollbar(self.init_window_name, orient=HORIZONTAL)  <span class="comment"># 创建滚动条部件</span></span><br><span class="line">        self.result_data_Text.config(xscrollcommand=self.scrollbar_x.<span class="built_in">set</span>)   <span class="comment"># 文本框-控制-滚动条</span></span><br><span class="line">        self.scrollbar_x.config(command=self.result_data_Text.xview)    <span class="comment"># 滚动条-控制-文本框</span></span><br><span class="line">        self.scrollbar_x.grid(row=<span class="number">5</span>, column=<span class="number">12</span>, rowspan=<span class="number">1</span>,columnspan=<span class="number">10</span>, sticky=<span class="string">&quot;ESW&quot;</span>,padx=<span class="number">10</span>)   <span class="comment"># 设置滚动条位置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导入序列功能函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_file</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">global</span> file_name</span><br><span class="line">        file_name = filedialog.askopenfilename(title=<span class="string">&quot;选择文件&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> file_name != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:  </span><br><span class="line">                records = fasta_generator(file_name)</span><br><span class="line">                number = <span class="number">0</span>  <span class="comment"># 计数，导入多少序列</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> records:</span><br><span class="line">                    name = i[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                    seq = i[<span class="string">&#x27;seq&#x27;</span>]</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(seq)&gt;<span class="number">48</span>:</span><br><span class="line">                        seq = seq[:<span class="number">45</span>] + <span class="string">&#x27;...&#x27;</span> + seq[-<span class="number">3</span>:]</span><br><span class="line">                    self.init_data_Text.insert(END,<span class="string">f&quot;Name:<span class="subst">&#123;name&#125;</span>\nSeq:&#x27;<span class="subst">&#123;seq&#125;</span>&#x27;\n&quot;</span>)</span><br><span class="line">                    number += <span class="number">1</span></span><br><span class="line">                self.write_log_to_Text(<span class="string">f&quot;INFO:fasta文件导入成功！共加载<span class="subst">&#123;number&#125;</span>条序列。&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                messagebox.showerror(<span class="string">&quot;ERROR&quot;</span>, <span class="string">&quot;载入失败，请检查文件是否为fasta格式！&quot;</span>)</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;ERROR:载入失败，请检查文件格式。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 分析统计功能函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">codon_count</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> file_name != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            records = fasta_generator(file_name)</span><br><span class="line">            CodonsDict = &#123;codon: <span class="number">0</span> <span class="keyword">for</span> codon_list <span class="keyword">in</span> codon_table.values() <span class="keyword">for</span> codon <span class="keyword">in</span> codon_list&#125;  <span class="comment"># 新的字典，统计密码子数量用</span></span><br><span class="line">            <span class="comment"># 输出表头</span></span><br><span class="line">            self.result_data_Text.insert(END, <span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27;Name&#x27;</span>:&lt;<span class="number">15</span>&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> CodonsDict:</span><br><span class="line">                    self.result_data_Text.insert(END, <span class="string">f&#x27;<span class="subst">&#123;key:&lt;<span class="number">12</span>&#125;</span>&#x27;</span>)</span><br><span class="line">            self.result_data_Text.insert(END,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> records:</span><br><span class="line">                <span class="comment"># 每条序列判断ATG开头，是否有屏蔽序列,长度是否为3的倍数</span></span><br><span class="line">                <span class="keyword">if</span> i[<span class="string">&#x27;seq&#x27;</span>].startswith(<span class="string">&#x27;ATG&#x27;</span>) <span class="keyword">and</span> <span class="string">&#x27;N&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> i[<span class="string">&#x27;seq&#x27;</span>] <span class="keyword">and</span> <span class="built_in">len</span>(i[<span class="string">&#x27;seq&#x27;</span>]) % <span class="number">3</span> ==<span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(<span class="built_in">str</span>(i[<span class="string">&#x27;seq&#x27;</span>])), <span class="number">3</span>):</span><br><span class="line">                        codon = <span class="built_in">str</span>(i[<span class="string">&#x27;seq&#x27;</span>])[j:j+<span class="number">3</span>]</span><br><span class="line">                        <span class="keyword">if</span> codon <span class="keyword">in</span> CodonsDict.keys():</span><br><span class="line">                            CodonsDict[codon] +=<span class="number">1</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            self.write_log_to_Text(<span class="string">&quot;WARNING:序列%s存在未识别的密码子，跳过。&quot;</span> % (i[<span class="string">&#x27;id&#x27;</span>]))</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    total = <span class="built_in">sum</span>([CodonsDict[key] <span class="keyword">for</span> key <span class="keyword">in</span> CodonsDict.keys()])</span><br><span class="line">                    name = i[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                    self.result_data_Text.insert(END, <span class="string">f&#x27;<span class="subst">&#123;name:&lt;<span class="number">15</span>&#125;</span>&#x27;</span>)    <span class="comment"># 这里的f-string格式化输出f&#x27;&#123;i[&#x27;id&#x27;]:&lt;15&#125;&#x27;会报错，所以用了个变量name代替</span></span><br><span class="line">                    self.result_fre_Text.insert(END,<span class="string">&#x27;Results for %d residue sequence &quot;%s&quot;:\n\nAA\tCodon\tNumber\tFrequency\n\n&#x27;</span> % (total, name))</span><br><span class="line">                    <span class="comment"># 计算频率</span></span><br><span class="line">                    <span class="keyword">for</span> key, value <span class="keyword">in</span> CodonsDict.items():</span><br><span class="line">                        frequency = <span class="string">&#x27;%.2f&#x27;</span> % (value * <span class="number">3000</span> / total)</span><br><span class="line">                        content = <span class="string">&#x27;%d(%s)&#x27;</span> % (value, frequency)</span><br><span class="line">                        self.result_data_Text.insert(END,<span class="string">f&#x27;<span class="subst">&#123;content:&lt;<span class="number">12</span>&#125;</span>&#x27;</span>)</span><br><span class="line">                        <span class="comment"># 结果文本框内的输出</span></span><br><span class="line">                        <span class="keyword">for</span> key_, value_ <span class="keyword">in</span> codon_table.items():</span><br><span class="line">                            <span class="keyword">if</span> key <span class="keyword">in</span> value_:</span><br><span class="line">                                AA = key_</span><br><span class="line">                                self.result_fre_Text.insert(END, <span class="string">&#x27;%s\t%s\t%d\t%s\n&#x27;</span> % (AA, key, value, frequency))</span><br><span class="line">                    self.result_fre_Text.insert(END,<span class="string">&#x27;\n----------------------------------------\n&#x27;</span> )</span><br><span class="line">                    self.result_data_Text.insert(END,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.write_log_to_Text(<span class="string">&quot;WARNING:序列%s非ATG开头/存在屏蔽序列/非3的倍数，该序列将不会出现在统计结果中。&quot;</span> % (i[<span class="string">&#x27;id&#x27;</span>]))</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;INFO:统计结束!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;ERROR:请先载入fasta文件！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导出频数频率统计表</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_count</span>(<span class="params">self</span>):</span><br><span class="line">        content = self.result_data_Text.get(<span class="string">&#x27;1.0&#x27;</span>, END)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> content:</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;ERROR:请先点击“载入fasta文件”并点击“开始统计”按钮！&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                count_file = filedialog.asksaveasfilename()</span><br><span class="line">                count_file = count_file + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(count_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> count:</span><br><span class="line">                    content = re.sub(<span class="string">r&quot;[^\S\r\n]+&quot;</span>,<span class="string">&#x27;,&#x27;</span>,content) <span class="comment"># 正则匹配换行符之外的所有空格，处理成csv格式的输出</span></span><br><span class="line">                    count.write(content)</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;INFO:密码子频数频率统计表保存成功!文件路径：%s&quot;</span> % (count_file))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;ERROR:ERROR:导出失败，请检查是否有同名文件未关闭！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导出结果文件</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_fre</span>(<span class="params">self</span>):</span><br><span class="line">        content = self.result_fre_Text.get(<span class="string">&#x27;1.0&#x27;</span>, END)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Results&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> content:</span><br><span class="line">            self.write_log_to_Text(<span class="string">&quot;ERROR:请先点击“载入fasta文件”并点击“开始统计”按钮！&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result_file = filedialog.asksaveasfilename()</span><br><span class="line">                result_file = result_file + <span class="string">&#x27;.txt&#x27;</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(result_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> out:</span><br><span class="line">                    out.write(content)</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;INFO:结果文件保存成功!保存路径：%s&quot;</span> % (result_file))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.write_log_to_Text(<span class="string">&quot;ERROR:导出失败，请检查是否有同名文件未关闭！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 清空所有文本框</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">window_clean</span>(<span class="params">self</span>):</span><br><span class="line">        self.init_data_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        self.log_data_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        self.result_data_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        self.result_fre_Text.delete(<span class="number">1.0</span>, END)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志打印</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_log_to_Text</span>(<span class="params">self,logmsg</span>):</span><br><span class="line">        current_time = time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,time.localtime(time.time()))</span><br><span class="line">        logmsg_in = <span class="built_in">str</span>(current_time) +<span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(logmsg) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">        self.log_data_Text.insert(END, logmsg_in)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gui_start</span>():</span><br><span class="line">    init_window = Tk()</span><br><span class="line">    GUI = MY_GUI(init_window)</span><br><span class="line">    GUI.set_init_window()</span><br><span class="line">    init_window.mainloop()</span><br><span class="line"></span><br><span class="line">gui_start()</span><br></pre></td></tr></table></figure></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;前阵子课题组的师弟问我怎么统计CDS序列的密码子频率，其实百度一下有很多在线分析网站可以把序列丢进去，直接出结果……&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="tkinter" scheme="http://www.shelven.com/tags/tkinter/"/>
    
    <category term="pyinstaller" scheme="http://www.shelven.com/tags/pyinstaller/"/>
    
    <category term="密码子统计工具" scheme="http://www.shelven.com/tags/%E5%AF%86%E7%A0%81%E5%AD%90%E7%BB%9F%E8%AE%A1%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>ATAC-seq和CUT&amp;Tag技术原理和实验流程</title>
    <link href="http://www.shelven.com/2023/08/18/a.html"/>
    <id>http://www.shelven.com/2023/08/18/a.html</id>
    <published>2023-08-17T16:21:11.000Z</published>
    <updated>2023-08-17T16:24:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>前阵子去兰州开全国植物生物学大会，做实验的师弟问了我一个问题：什么是ATAC-seq？因为王茂军老师课题组有同学在做CUT&amp;Tag，我脑海里第一个出现的也是CUT&amp;Tag，两者的研究内容虽然不同，但是使用的分析方式是非常相似的。正好看到菲沙基因做过这两个技术的讲座，这篇博客就整理一下介绍这两个技术以及衍生技术的分析原理，加深下自己的理解，详细的分析流程留到以后需要做的时候再记录。</p><span id="more"></span><h2 id="1-ATAC-Seq"><a href="#1-ATAC-Seq" class="headerlink" title="1. ATAC-Seq"></a>1. ATAC-Seq</h2><div class="story post-story"><p>ATAC-seq全称<strong>Assay for Transposase Accessible Chromatin with high-throughput sequencing</strong>，翻译为<strong>转座酶可及染色质的高通量测序分析</strong>，简单来说这个技术是运用转座酶获取开放染色质区，然后通过高通量测序技术和生物信息学挖掘相关的基因信息，解决生物学相关问题。</p><h3 id="1-1-背景介绍"><a href="#1-1-背景介绍" class="headerlink" title="1.1 背景介绍"></a>1.1 背景介绍</h3><h4 id="什么是开放染色质？"><a href="#什么是开放染色质？" class="headerlink" title="什么是开放染色质？"></a>什么是开放染色质？</h4><p>在前面介绍<a href="https://www.shelven.com/2023/06/15/a.html">三维基因组的博客</a>中，介绍了真核生物的染色质结构由低级到高级可以分为4种，染色体的基本结构单位是核小体，核小体串珠结构螺旋化（也就是不断地压缩折叠）形成了直径为30nm的染色质纤维，细胞核内大多数染色质都是以这种染色质纤维的形式存在的。</p><p><img src="https://www.shelven.com/tuchuang/20230817/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们知道DNA的复制和转录过程需要将染色质紧密的结构打开（打开的过程与<strong>组蛋白乙酰化</strong>有密切联系，组蛋白乙酰化使组蛋白携带的正电荷减少，削弱了组蛋白与DNA结合的能力，从而使染色质区域的结构从紧密变得松散），这部分打开后结构疏松的染色质就是开放染色质<strong>（open chromatin）</strong>，当染色质打开后，暴露的DNA序列就有足够的空间和转录因子（Transcription factors，TF）结合，进而调控基因的表达。</p><p>这种允许顺式调控元件和反式作用因子结合，也就是允许与染色质进行物理接触的程度就是染色质的可接近性<strong>（chromatin accessibility）</strong>，也称为<strong>染色质可及性</strong>。</p><h4 id="如何检测染色质开放区？"><a href="#如何检测染色质开放区？" class="headerlink" title="如何检测染色质开放区？"></a>如何检测染色质开放区？</h4><p>简单说一下几个常用的检测染色质开放区的方法。</p><p>一种是传统的使用DNA酶的实验方法<strong>MNase-seq</strong>和<strong>Dnase-seq</strong>。两者的思路都是将开放染色质区的DNA用DNA酶酶切后进行高通量测序。前者用的是限制性外切酶，将不受核小体保护的区域切除，只留下核小体上缠绕的DNA序列；后者用的限制性内切酶，将受核小体保护的区域切除，留下核小体之间的序列。</p><p>另一种是基于酚氯仿抽提的技术<strong>FAIRE-seq</strong>技术，超声波破碎甲醛固定的染色质，酚氯仿抽提得到的上层水相认为是潜在的开放染色质区，针对抽提得到的片段化开放性染色质区进行建库测序。</p><p>还有一种就是经典的研究蛋白与DNA互作的<strong>ChIP-seq</strong>技术，因为需要制作对应的转录因子的抗体去拉DNA，所以该技术<strong>只能根据明确的转录因子来检测该转录因子与DNA的互作</strong>，局限性比较大，这里就提一下不放在一起比较了。</p><p>最后就是<strong>ATAC-seq</strong>技术，依赖改造的Tn5转座酶（转座DNA设计为测序接头）将测序接头引入染色质开放区，对酶切后的DNA片段进行富集，最后通过PCR扩增后进行高通量测序。另一方面，转座酶还可以切割开放区染色质附近的核小体间连接区DNA，简单来说可以得到MNase-seq和Dnase-seq两种技术的结果。</p><p>如下图所示，我们可以比较一下这几种检测染色质开放区技术的检测范围和灵敏度：</p><img src="https://www.shelven.com/tuchuang/20230817/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><table><thead><tr><th>研究方法</th><th>细胞数量</th><th>获取方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>DNase-seq</td><td>1*10^7</td><td>DNase Ⅰ切割不受保护的DNA序列</td><td>单碱基对的酶切位点分辨率</td><td>酶用量要准确控制，切割有偏好性</td></tr><tr><td>MNase-seq</td><td>1*10^7</td><td>MNase优先切割受保护的DNA序列</td><td>酶切特性有较高分辨率</td><td>酶用量要准确控制，切割有偏好性</td></tr><tr><td>FAIRE-seq</td><td>1*10^5~1*10^7</td><td>超声波打断染色质</td><td>无偏性分析，重复性好</td><td>信噪比低，数据解读困难</td></tr><tr><td>ATAC-seq</td><td>5*10^2~5*10^4</td><td>改造的Tn5转座酶切割开放区并插入测序接头</td><td>细胞需求量少，实验时间短，灵敏度高，重复性好</td><td>容易引入线粒体污染</td></tr></tbody></table><h3 id="1-2-实验流程"><a href="#1-2-实验流程" class="headerlink" title="1.2 实验流程"></a>1.2 实验流程</h3><p>整个实验流程可以分为6个步骤：</p><blockquote><ol><li>细胞悬液制备（500~50000个细胞，最难的一步）</li><li>细胞裂解，制备细胞核（完整性十分重要）</li><li>Tn5酶切，37℃酶切孵育</li><li>DNA片段纯化，磁珠法回收</li><li>PCR扩增12-15个循环</li><li>上机测序</li></ol></blockquote><img src="https://www.shelven.com/tuchuang/20230817/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>上面PCR扩增这一步的流程，可以看到Tn5酶切过程中会在<strong>上下游分别产生一个缺口</strong>，因此需要72℃延伸的过程来补平缺口。引入barcoded primer是为了区分不同的样品（单细胞测序的话是区分不同类型细胞）。</p><p>从上面的实验流程也可以看出，ATAC-seq中比较重要的步骤是细<strong>胞悬液制备和提取完整的细胞核</strong>，在细胞裂解和提取细胞核过程中，线粒体DNA可能会与染色体DNA一起被提取和处理，从而引入线粒体污染。线粒体是没有组蛋白保护的，容易被Tn5转座酶切割，同时线粒体的拷贝数也比染色体高很多，如果线粒体在实验过程中没有去除，很容易导致线粒体DNA被富集，影响染色体DNA测序深度和覆盖度。</p><h3 id="1-3-生信分析"><a href="#1-3-生信分析" class="headerlink" title="1.3 生信分析"></a>1.3 生信分析</h3><p>获得下机数据后，就可以开始做上下游的生信分析。因为我自己没跑过这个流程，所以这里以菲沙基因提供的流程为例，着重介绍ATAC-seq流程中产生的图如何解读，以及我们可以做哪些下游分析。</p><p><img src="https://www.shelven.com/tuchuang/20230817/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h4 id="下机数据预处理"><a href="#下机数据预处理" class="headerlink" title="下机数据预处理"></a>下机数据预处理</h4><p>拿到下机数据后首先去接头（adapter trimming），然后比对到参考基因组（alignment），对比对后得到的bam文件进行过滤，具体而言是提取可靠比对、去除PCR重复（推荐用picard软件）、去除细胞器污染（主要是线粒体和叶绿体）这三步。这些处理方式都是老朋友了。</p><h4 id="数据质量评估"><a href="#数据质量评估" class="headerlink" title="数据质量评估"></a>数据质量评估</h4><p>ATAC-seq数据质量评估主要是看两个图，一个是<strong>插入片段分布图（Fragment Insertion Size Distribution）</strong>，一个是<strong>TSS富集峰图</strong>。</p><p><strong>插入片段分布图</strong></p><p><img src="https://www.shelven.com/tuchuang/20230817/8.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>ATAC-seq的插入片段分布有着非常鲜明的特点，一般把&lt;100 bp的片段区域称NFR（Nucleosome-Free Region）也就是无核小体区，这部分区域也是转座酶最容易切割的区域，每隔10.5 bp就有一个小齿，对应DNA螺旋一周的间距。200 bp有一个峰对应的是核小体单体的插入片段长度，再远点的400 bp和600 bp有两个小峰，对应核小体二聚体和核小体三聚体的插入片段长度。</p><p><strong>TSS富集峰图</strong></p><img src="https://www.shelven.com/tuchuang/20230817/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="  /><p>转录起始位点(Transcription Start Site,TSS)是没有核小体的，所以在ATAC-seq质控分析中，可以明显看到<strong>NFR在转录起始位点富集</strong>。以上图为例，我们选择TSS上下游3Kb的区域，NFR reads在TSS位点两侧有明显富集趋势。底下的热图也是同样的意思，每一行表示一个基因或者转录本，图中的红色区域也不一定要延伸到底，因为部分TSS可能没有在这个时期开放，这是很正常的现象。</p><p>这两个质控步骤可以先做第一个，第二个TSS富集峰图需要在peak calling和转换文件格式为<code>.bw</code>之后，使用Deeptools工具作图。</p><h4 id="Reads-Shifting"><a href="#Reads-Shifting" class="headerlink" title="Reads Shifting"></a>Reads Shifting</h4><p>质控后还有一个步骤是进行reads shifting，前面说过Tn5酶切过程中会在上下游产生一个缺口，因此需要将正链正向移动4bp，负链负向移动5bp。</p><p>这一步在ACAT-seq的原文中有做，不做的话对单碱基分辨率要求比较高的分析是有影响的（比如转录因子足迹分析，下面的Motif Analysis会说）。</p><h4 id="Peak-Calling"><a href="#Peak-Calling" class="headerlink" title="Peak Calling"></a>Peak Calling</h4><p>peak calling是后续所有分析的基础。简单来说，在将reads比对到参考基因组后，因为进行的是pair-end测序，一对reads之间的序列为一个fragment，统计每个碱基上fragment的数量作图，哪个地方fragment数量多，在统计图上就会显示出一个峰，也就是一个peak。peak calling的过程就是检测染色质开放区的fragment富集信号。</p><img src="https://www.shelven.com/tuchuang/20230817/9.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/9.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>这一步用的软件有比较经典的<code>MACS2</code>，这个软件可以处理ChIP-seq、ATAC-seq、CUT&amp;TAG等等的数据，<strong>需要调整不同的参数</strong>。与ChIP-seq不同，ATAC-seq的Tn5转座酶酶切的是染色质开放区域，在TF结合区域的DNA是拉不下来的（反映在峰图上是一个谷，ChIP-seq是一个峰），因此在调整峰值偏移（peak shift）的时候，一般用<strong>shift-extend</strong>的方法进行分析，ATAC-seq需要向外shift。如下图：</p><img src="https://www.shelven.com/tuchuang/20230817/10.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/10.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>比如我们测序reads长度是150bp，两条reads的5‘端代表Tn5的酶切位点，我们需要向外shift 75bp，让酶切位点处于reads的中间位置，再进行peak calling。</p><p>用上面的软件进行peak calling后会生成bedGraph文件，也就是<code>.bdg</code>后缀的文件，是bed文件的一种扩展，可以在IGV基因组浏览器中打开（可能会比较卡），也可以借助UCSC的工具<a href="http://hgdownload.soe.ucsc.edu/admin/exe/linux.x86_64/bedGraphToBigWig">bedGraphToBigWig</a>转成BigWig文件后（<code>.bw</code>后缀）再到IGV基因组浏览器中打开。还有一个重要的结果文件是<code>.narrowPeak</code>后缀的文件，也可以直接导入IGV。</p><p><img src="https://www.shelven.com/tuchuang/20230817/11.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/11.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>以上上游分析的步骤可以参考<a href="https://yiweiniu.github.io/blog/2019/03/ATAC-seq-data-analysis-from-FASTQ-to-peaks/">ATAC-seq data analysis: from FASTQ to peaks | Yiwei Niu’s Note</a>。</p><p>接下来是常见的一些下游分析的方法。</p><h4 id="IDR-Peak"><a href="#IDR-Peak" class="headerlink" title="IDR Peak"></a>IDR Peak</h4><p>对于一个样本如果做了多个重复，就需要对样本的可重复性进行评估。可以用ENCODE项目的一个软件包<a href="https://www.encodeproject.org/software/idr/">Irreproducible Discovery Rate (IDR) </a>，导入两个样本的<code>.narrowPeak</code>结果文件后作图分析，这个软件的作用是评估重复样本间peak的一致性，生成的图如下：</p><p><img src="https://www.shelven.com/tuchuang/20230817/12.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/12.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>IDR算法同时考虑了peaks间的overlap和富集倍数的一致性。上面的图所有的点都是两个样本间相互overlap的peak，也就是都是可重复的，红点代表富集倍数是有差别的，黑点代表富集倍数是一致的，因此黑点数量越多越好。</p><h4 id="Peak-Annotation"><a href="#Peak-Annotation" class="headerlink" title="Peak Annotation"></a>Peak Annotation</h4><p>拿到peak后，如果想要知道这些peak在基因组的哪些地方分布功能是什么，就需要对peak进行注释，常用的有R包<code>ChIPseeker</code>。</p><h4 id="Motif-Analysis"><a href="#Motif-Analysis" class="headerlink" title="Motif Analysis"></a>Motif Analysis</h4><p>这一部分能做的分析还是相当多的，列举几个：</p><blockquote><ul><li>从头预测：预测新的motif，注释已存在的motif。软件：MEME+Tomtom</li><li>Motif扫描：除了开放染色质区域，寻找其他序列所有motif的位置信息。软件：FIMO</li><li>转录因子富集：软件AME或者HOMER</li><li>转录因子足迹（TF FootPrint）：转录因子占位效应（转录因子结合在DNA上，阻止了Tn5酶切，在开放染色质区域留下一个缺失的位置），注意要进行前面说的reads shifting。软件R&#x2F;centipade</li></ul></blockquote><p>常用的motif数据库：</p><blockquote><ul><li>PlantTFDB：<a href="http://planttfdb.gao-lab.org/">PlantTFDB - Plant Transcription Factor Database @ CBI, PKU (gao-lab.org)</a></li><li>JASPAR：<a href="https://jaspar.genereg.net/">JASPAR - A database of transcription factor binding profiles (genereg.net)</a></li><li>MEME：<a href="https://meme-suite.org/meme/doc/download.html">Download Releases - MEME Suite (meme-suite.org)</a></li><li>TRANSFAC：<a href="http://gene-regulation.com/pub/databases.html">Gene Regulation (gene-regulation.com)</a></li><li>HOCOMOCO：<a href="https://hocomoco11.autosome.org/">HOmo sapiens COmprehensive MOdel COllection (autosome.org)</a></li></ul></blockquote><h4 id="Nucleosome-positioning"><a href="#Nucleosome-positioning" class="headerlink" title="Nucleosome positioning"></a>Nucleosome positioning</h4><p>核小体定位，从前面的插入片段分布图可以看出，在ATAT-seq文库中，核小体单体插入片段数量相比NFR明显少很多，但是也有一些软件比如<strong>NuleoATAC</strong>和<strong>HMMRATAC</strong>可以用于核小体的占位分析。</p><h4 id="联合分析"><a href="#联合分析" class="headerlink" title="联合分析"></a>联合分析</h4><ul><li>ChIP-seq：由于转录因子的结合区域在染色质开放区，因此ATAC-seq的peak和ChIP-seq的peak之间存在部分重叠，因此这两个组学联用可以相互验证，而转录因子在ChIP-seq中独有的Peak则暗示这个转录因子可能是结合在异染色质区域的驱动型转录因子（Pioneer TFs）。对于组蛋白修饰的ChIP-seq而言，前面也说过组蛋白乙酰化与染色质开放区形成有重要联系，同样可以与ATAC-seq进行联合分析。</li><li>RNA-seq：比如将ATAC-seq的信号在gene body上的分布做比较，或者按照基因不同的表达量做分类，再与ATAC-seq联用分别统计不同表达量基因的TSS上的富集信号，研究ATAC-seq的富集信号是否与基因表达量相关、差异表达的基因是否受染色质可及性的调控等等。</li></ul></div><h2 id="2-CUT-amp-Tag"><a href="#2-CUT-amp-Tag" class="headerlink" title="2. CUT&amp;Tag"></a>2. CUT&amp;Tag</h2><div class="story post-story"><p>CUT&amp;Tag全称<strong>Cleavage Under Target &amp; Tagmentation</strong>，翻译为靶向剪切及转座酶技术，是一种研究蛋白-DNA互作的技术，替代传统的ChIP-seq方法。开头介绍ATAC-seq和CUT&amp;Tag非常相似，原因就在于CUT&amp;Tag也用Tn5转座酶，只不过这个酶是Protein A&#x2F;G融合的Tn5转座酶。当然，两者研究内容还是不一样的，下面详细说一下。</p><h3 id="2-1-背景介绍"><a href="#2-1-背景介绍" class="headerlink" title="2.1 背景介绍"></a>2.1 背景介绍</h3><h4 id="ChIP"><a href="#ChIP" class="headerlink" title="ChIP"></a>ChIP</h4><p>前面介绍ATAC-seq的时候已经拿ChIP-seq做过对比，这里为了引出CUT&amp;Tag还是对ChIP技术做个简单介绍。ChIP全称<strong>Chromatin Immunoprecipitation</strong>，翻译为染色质免疫共沉淀，顾名思义，这个技术有个鲜明的特征就是抗原抗体免疫反应。</p><p>下面是ChIP-seq的经典流程：</p><img src="https://www.shelven.com/tuchuang/20230817/13.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/13.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><p>我们知道，抗原抗体反应具有专一性，所以我们制备特定的转录因子的抗体（一般是多克隆抗体），将细胞核内的染色质用甲醛交联固定后进行超声破碎，这个时候与转录因子结合的DNA序列不会被打断。加入抗体做免疫共沉淀，解交联后获得与转录因子结合的DNA序列，建库测序就可以做后面的分析。</p><h4 id="ChIP技术分类"><a href="#ChIP技术分类" class="headerlink" title="ChIP技术分类"></a>ChIP技术分类</h4><ul><li><strong>N-ChIP</strong>：用的是Native Chromatin，原生态染色质，DNA片段化的方法为酶切，用上面提到的<strong>MNase</strong>。只能处理结合能力比较强的蛋白（一般用于组蛋白修饰），蛋白复合体存在解离的风险，实验难度相对较大。</li><li><strong>X-ChIP</strong>：用的是Cross-linked Chromatin，甲醛交联的染色质，DNA片段化方式为超声波。甲醛交联的背景一般比较高，抗体识别位点可能会被屏蔽。</li></ul><p>ChIP-seq技术非常依赖于抗体质量，如果研究低表达的蛋白，制备抗体的也是很大的挑战。近年在鉴定转录因子结合位点上又出了个新技术<strong>DAP-Seq</strong>，通过<strong>体外蛋白表达技术</strong>，表达出带有Halo标签的转录因子蛋白。通过Halo标签的抗体富集对应的蛋白DNA复合物，从而使所有蛋白都可以被一种抗体（Halo标签抗体）富集，绕过了抗体制备的难题（和后面要说的没啥关系，写到技术分类这里提一嘴）。</p><h4 id="CUT系列技术"><a href="#CUT系列技术" class="headerlink" title="CUT系列技术"></a>CUT系列技术</h4><ul><li><strong>CUT&amp;RUN</strong>：Cleavage Under Targets and Release Using Nuclease，靶向剪切和核酸酶释放，这里用的核酸酶是与Protein A&#x2F;G融合的MNase。</li><li><strong>CUT&amp;Tag</strong>：Cleavage Under Targets and Tagmentation，靶向剪切和转座酶，这里用的酶是Protein A&#x2F;G融合的Tn5转座酶，是CUT&amp;RUN技术的改进版。</li></ul><p>两种技术用的酶不一样，Tn5转座酶可以插入测序标签，因此CUT&amp;Tag比CUT&amp;RUN节省了更多建库时间，1天就可以完成建库。</p><h3 id="2-2-实验流程"><a href="#2-2-实验流程" class="headerlink" title="2.2 实验流程"></a>2.2 实验流程</h3><p>整个实验流程可以分为6步：</p><blockquote><ol><li>收集细胞，刀豆蛋白的磁珠吸附细胞膜</li><li>细胞电穿孔后分别孵一抗和二抗，一抗结合目标蛋白，二抗放大信号</li><li>Hyperactive pA&#x2F;pG-Tn5 Transposon结合，这种改造的Tn5转座酶会特异性识别抗体并结合</li><li>加入镁离子或者钙离子激活Tn5转座酶，片段化DNA</li><li>提取DNA</li><li>PCR扩增文库</li></ol></blockquote><img src="https://www.shelven.com/tuchuang/20230817/14.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230817/14.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>上面的流程图可以看出，CUT&amp;Tag与ATAC-seq的区别就在于，CUT&amp;Tag用了抗体，Tn5转座酶进一步改造可以识别抗体。</p><p>因此CUT&amp;Tag实验需要做阴性对照（IgG），CUT&amp;Tag文库和ATCA文库差别就在于抗体识别的蛋白，如果抗体的特异性很差，比如在所有组蛋白上都有结合，那这个时候建库得到的就是ATCA文库而不是CUT&amp;Tag文库。这个时候阴性对照就很重要了，如果在IgG上也能出正常的PCR结果，就说明抗体有问题或者实验设计有问题了。</p><p>因为CUT&amp;Tag用的是Tn5转座酶，所以也有一个缺陷，比如要研究异染色质的蛋白与DNA互作就做不了，因为<strong>Tn5转座酶无法在异染色质区剪切DNA</strong>。或者你要研究的蛋白空间结构比较大，导致Tn5转座酶无法剪切到DNA，这个时候也不能用CUT&amp;Tag。</p><h3 id="2-3-生信分析"><a href="#2-3-生信分析" class="headerlink" title="2.3 生信分析"></a>2.3 生信分析</h3><p>CUT&amp;Tag生信分析和ATAC-seq几乎一模一样，下游分析也可以做IDR Peak、Peak Annotation和Motif Analysis，这里就不赘述了。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;前阵子去兰州开全国植物生物学大会，做实验的师弟问了我一个问题：什么是ATAC-seq？因为王茂军老师课题组有同学在做CUT&amp;amp;Tag，我脑海里第一个出现的也是CUT&amp;amp;Tag，两者的研究内容虽然不同，但是使用的分析方式是非常相似的。正好看到菲沙基因做过这两个技术的讲座，这篇博客就整理一下介绍这两个技术以及衍生技术的分析原理，加深下自己的理解，详细的分析流程留到以后需要做的时候再记录。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="表观遗传学" scheme="http://www.shelven.com/categories/%E8%A1%A8%E8%A7%82%E9%81%97%E4%BC%A0%E5%AD%A6/"/>
    
    
    <category term="ATAC-seq" scheme="http://www.shelven.com/tags/ATAC-seq/"/>
    
    <category term="CUT&amp;Tag" scheme="http://www.shelven.com/tags/CUT-Tag/"/>
    
  </entry>
  
  <entry>
    <title>go-cqhttp登录异常（错误码45）的解决办法</title>
    <link href="http://www.shelven.com/2023/08/04/a.html"/>
    <id>http://www.shelven.com/2023/08/04/a.html</id>
    <published>2023-08-04T14:57:57.000Z</published>
    <updated>2023-08-04T15:01:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>曾经写了一篇go-cqhttp扫码登录异常的解决方法<a href="https://www.shelven.com/2022/09/09/b.html">点击此处</a>，当时go-cqhttp版本为<code>v1.0.0</code>，如今（2023年8月4日）已不再适用。在<code>v1.1.0</code>版本之后需要自建或者使用别人搭建的签名服务器，否则会返回错误代码45，这里记录下自己的操作和踩的坑。</p><span id="more"></span><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><div class="story post-story"><p>go-cqhttp更新版本<code>v1.1.0</code>之后，无法通过替换<strong>device.json</strong>文件登录，返回错误码45，需要配置签名服务器。</p><p><img src="https://www.shelven.com/tuchuang/20230804/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230804/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><div class="story post-story"><h3 id="1-linux操作系统解决方法"><a href="#1-linux操作系统解决方法" class="headerlink" title="1. linux操作系统解决方法"></a>1. linux操作系统解决方法</h3><h4 id="1-1-安装和启动docker"><a href="#1-1-安装和启动docker" class="headerlink" title="1.1 安装和启动docker"></a>1.1 安装和启动docker</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 下载docker安装脚本，一键安装</span><br><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line">bash get-docker.sh</span><br><span class="line"></span><br><span class="line"># 启动docker服务</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"># 查看docker状态，是否正常启动</span><br><span class="line">service docker status</span><br></pre></td></tr></table></figure><h4 id="1-2-查看ANDROID-ID"><a href="#1-2-查看ANDROID-ID" class="headerlink" title="1.2 查看ANDROID_ID"></a>1.2 查看<strong>ANDROID_ID</strong></h4><p>如果你的<code>device.json</code>文件还没有删除，打开它，找到<code>android_id</code>值，比如我这里是<code>d9b3a88f3cd1f951</code>（瞎打的，总之是这样子的格式）。</p><p>如果你已经删除上面的文件，再次运行go-cqhttp，会自动生成<code>device.json</code>文件，同上操作。</p><p>这个参数非常重要，每次重启go-cqhttp会随机生成新的android_id值，如果使用别人的签名服务器，需要将你的device.json文件中android_id值改成别人签名服务器提供的，两者的值要对应。</p><h4 id="1-3-自建签名服务器"><a href="#1-3-自建签名服务器" class="headerlink" title="1.3 自建签名服务器"></a>1.3 自建签名服务器</h4><p>实例化qsign的docker镜像：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 开放防火墙端口（用docker默认的8080）</span><br><span class="line">firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line"># 重载防火墙</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"># 运行docker</span><br><span class="line">docker run -d --restart=always --name qsign -p 8080:8080 -e ANDROID_ID=d9b3a88f3cd1f951 xzhouqd/qsign:8.9.63</span><br><span class="line"></span><br><span class="line"># 检查运行是否成功，访问主机端口没有报错就行</span><br><span class="line">curl localhost:8080</span><br></pre></td></tr></table></figure><p>映射的主机端口不要改，就用默认的8080，否则docker运行后会无法访问映射的主机端口，curl l映射的端口会出现报错<code>curl: (56) Recv failure: Connection reset by peer</code>，运行go-cqhttp也会出现获取协议T544报错和获取sso sign报错reset by peer！</p><h4 id="1-4-修改config-yml"><a href="#1-4-修改config-yml" class="headerlink" title="1.4 修改config.yml"></a>1.4 修改config.yml</h4><p>回到go-cqhttp目录，修改<code>config.yml</code>文件的sign-server字段，如下：</p><p><img src="https://www.shelven.com/tuchuang/20230804/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230804/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>如果没有该字段，说明你的go-cqhttp版本不对，去github下载新的。</p><h4 id="1-5-运行go-cqhttp"><a href="#1-5-运行go-cqhttp" class="headerlink" title="1.5 运行go-cqhttp"></a>1.5 运行go-cqhttp</h4><p>如果你之前用过go-cqhttp，把主目录下的<code>data/versions/6.json</code>文件删除，<strong>否则会因为协议版本和签名服务器的协议版本不一致导致仍然报错45</strong>，仍然提示你配置sign service！</p><p><img src="https://www.shelven.com/tuchuang/20230804/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230804/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>删除<code>6.json</code>后，同样会让你进行滑块验证，到上面提示的网址手动滑块验证后，可能和我一样会提示账号开启了设备锁，不要慌，同样是到提示的网站，用手机QQ扫一下（不需要服务器和手机QQ在同一个网络环境），然后再次运行go-cqhttp，再次进行滑块验证即可。</p><p>成功运行~</p><p><img src="https://www.shelven.com/tuchuang/20230804/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230804/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="2-windows操作系统解决方法"><a href="#2-windows操作系统解决方法" class="headerlink" title="2.windows操作系统解决方法"></a>2.windows操作系统解决方法</h3><h4 id="2-1-查看ANDROID-ID"><a href="#2-1-查看ANDROID-ID" class="headerlink" title="2.1 查看ANDROID_ID"></a>2.1 查看ANDROID_ID</h4><p>这步和1.2一样，先从<code>device.json</code>获取<code>android_id</code>值，不再赘述。</p><h4 id="2-2-自建签名服务器"><a href="#2-2-自建签名服务器" class="headerlink" title="2.2 自建签名服务器"></a>2.2 自建签名服务器</h4><p>下载这个仓库<a href="https://github.com/fuqiuluo/unidbg-fetch-qsign/releases?page=2">Releases · fuqiuluo&#x2F;unidbg-fetch-qsign (github.com)</a>，release版本<a href="https://github.com/fuqiuluo/unidbg-fetch-qsign/releases/tag/1.0.3">V1.0.3 JAR</a>，注意版本。</p><p>解压后可以看到两个目录<code>bin</code>和<code>lib</code>，在主目录下创建<code>txlib/8.9.86</code>这样结构的两个文件夹，将<a href="https://github.com/fuqiuluo/unidbg-fetch-qsign/tree/master/txlib/8.9.63">unidbg-fetch-qsign&#x2F;txlib&#x2F;8.9.63 at master · fuqiuluo&#x2F;unidbg-fetch-qsign (github.com)</a>这个仓库下的两个<code>.so</code>结尾的文件下载到<code>8.9.86</code>文件夹中。</p><p><img src="https://www.shelven.com/tuchuang/20230804/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230804/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>回到主目录，创建一个批处理文件<code>run.bat</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.\bin\unidbg-fetch-qsign.bat --host=127.0.0.1 --port=8080  --count=1 --library=txlib\8.9.63  --android_id=d890fd5ae11be94d</span><br><span class="line"></span><br><span class="line"># 这里--port可以自定义端口，--count表示最大连接数，--library就是两个.so文件的路径，--android_id是第一步你获取的值</span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230804/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230804/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>双击<code>run.bat</code>，一会儿后看到<code>[FEKit_]info: task_handle.h:74 TaskSystem not allow</code>是正常的。</p><h4 id="2-3-修改config-yml，运行go-cqhttp"><a href="#2-3-修改config-yml，运行go-cqhttp" class="headerlink" title="2.3 修改config.yml，运行go-cqhttp"></a>2.3 修改config.yml，运行go-cqhttp</h4><p>同1.4，1.5，不再赘述。</p><p>以上实现方式均参考自<a href="https://github.com/Mrs4s/go-cqhttp/discussions/2245">签名服务器相关问题 · Mrs4s&#x2F;go-cqhttp · Discussion #2245 (github.com)</a></p><p>我自己在linux和windows上均试过没有问题，感谢提出解决方案的大佬。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;曾经写了一篇go-cqhttp扫码登录异常的解决方法&lt;a href=&quot;https://www.shelven.com/2022/09/09/b.html&quot;&gt;点击此处&lt;/a&gt;，当时go-cqhttp版本为&lt;code&gt;v1.0.0&lt;/code&gt;，如今（2023年8月4日）已不再适用。在&lt;code&gt;v1.1.0&lt;/code&gt;版本之后需要自建或者使用别人搭建的签名服务器，否则会返回错误代码45，这里记录下自己的操作和踩的坑。&lt;/p&gt;</summary>
    
    
    
    <category term="QQ机器人" scheme="http://www.shelven.com/categories/QQ%E6%9C%BA%E5%99%A8%E4%BA%BA/"/>
    
    
    <category term="qq bot" scheme="http://www.shelven.com/tags/qq-bot/"/>
    
    <category term="go-cqhttp" scheme="http://www.shelven.com/tags/go-cqhttp/"/>
    
  </entry>
  
  <entry>
    <title>Hi-C染色体挂载（2）——3D-DNA配置运行和手动调整Hi-C互作图</title>
    <link href="http://www.shelven.com/2023/07/13/a.html"/>
    <id>http://www.shelven.com/2023/07/13/a.html</id>
    <published>2023-07-13T13:47:54.000Z</published>
    <updated>2023-09-11T12:56:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>前一篇博客主要讲了如何使用juicer进行Hi-C测序的下机数据处理，这篇博客我们按照Aiden团队的基因组组装“CookBook”继续接下来的操作，主要记录下3D-DNA软件的配置运行，以及如何手动调整结果。</p><span id="more"></span><h2 id="1-下载和配置3D-DNA"><a href="#1-下载和配置3D-DNA" class="headerlink" title="1. 下载和配置3D-DNA"></a>1. 下载和配置3D-DNA</h2><div class="story post-story"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 拉取3D-DNA仓库</span><br><span class="line">git clone https://ghproxy.com/https://github.com/aidenlab/3d-dna.git</span><br><span class="line">## 将run-asm-pipeline-post-review.sh和run-asm-pipeline.sh属性分别改成可执行，对应chmod的0755权限</span><br><span class="line">chmod 755 run-asm-pipeline-post-review.sh</span><br><span class="line">chmod 755 run-asm-pipeline.sh</span><br><span class="line"></span><br><span class="line"># 安装LastZ（跑二倍体模式需要用，一个DNA序列比对工具）</span><br><span class="line">conda install LastZ</span><br><span class="line"></span><br><span class="line"># 安装GNU Parallel</span><br><span class="line">## 官方推荐用该shell下实现并行运算的工具，加快程序运行速度。集群用户如果没有预装可以在~/bin中以如下方式编译安装</span><br><span class="line">wget http://ftp.gnu.org/gnu/parallel/parallel-latest.tar.bz2</span><br><span class="line">tar -xvjf parallel-latest.tar.bz2</span><br><span class="line">cd parallel-20230622</span><br><span class="line">./configure --prefix=$HOME &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><code>3D-DNA</code>有两个pipeline脚本，12个独立的功能模块（每个模块一个文件夹），官方给出的pipeline如下：</p><p><img src="https://www.shelven.com/tuchuang/20230712/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>三个橘色框是需要手动调整的地方，稍微了解下这几个独立模块分别在做什么（具体参考<a href="https://aidenlab.org/assembly/manual_180322.pdf">manual_180319 (aidenlab.org)</a>）：</p><blockquote><p>主要的8个独立模块（对应上面的流程）：</p><ul><li><p>scaffold：对给定的scaffolds进行排序和定向，转换基于3D proximity的一系列单个片段序列成为单个的megascaffold，这个megascaffold用于检测错误的连接或者保留用于后续处理（split模块还会用到）</p></li><li><p>visualize：与后续的Juicebox Assembly Tools处理对接，也就是可视化组装结果。在3D-DNA中用于连接各个处理阶段，便于审查和调整参数。</p></li><li><p>edit：包含检测3D-DNA错误连接的脚本和一些校正算法，这个模块在做特殊处理的时候最可能需要调整参数</p></li><li><p>polish：校正3D-DNA scaffolding算法可能引起的错误，类型基因组的polish过程</p></li><li><p>split：分割megascaffold成为染色体</p></li><li><p>seal：消除上一步结果的假阳性（通过引入碎片的方式，详细看手册说明）</p></li><li><p>merge：融合代表替代单倍型的组装片段（仅在二倍体模式下）起作用</p></li><li><p>finalize：生成最终的fasta格式输出，在最终fasta生成过程中，考虑到可能的顺序和方向，将被识别为同一染色体内部的scaffold连接起来，同时在每个scaffold之间添加固定大小（500bp）的间隙</p></li></ul><p>附加的4个独立模块：</p><ul><li>utils：一些其他模块用到的核心脚本，包括从.fasta文件生成.assembly文件</li><li>lift：一些从基因组草图到最后组装结果的核心脚本</li><li>supp：几个附加脚本，包括生成色谱图的脚本</li><li>data：一些数据表</li></ul></blockquote><p>如果要研究各个步骤的算法就可以在各个模块中找源码，现在的我只是个调包侠，程序不出问题就不深入研究了（以后有时间一定&#x3D; &#x3D;）</p><p>两个pipeline脚本也是对应不同阶段使用的：</p><blockquote><p><code>run-asm-pipeline.sh</code>将几个独立模块串联，组装基因组（也就是上面流程图用的脚本）</p><p><code>run-asm-pipeline-post-review.sh</code>用于<strong>Juicebox Assembly Tools (JBAT)手动调整之后执行</strong>，只会执行上个脚本的后几个阶段（finalize或者seal和finalize），生成最终的hic文件（用于质控）和fasta序列</p></blockquote></div><h2 id="2-运行3D-DNA"><a href="#2-运行3D-DNA" class="headerlink" title="2. 运行3D-DNA"></a>2. 运行3D-DNA</h2><div class="story post-story"><p>了解不同脚本和模块作用后，接下来就是很简单的设置脚本参数运行了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 创建run.slurm脚本</span><br><span class="line">vim run.slurm</span><br><span class="line"></span><br><span class="line"># 脚本内容如下</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">#!/bin/bash</span><br><span class="line">#SBATCH -n 30</span><br><span class="line">#SBATCH -N 1</span><br><span class="line">#SBATCH -t 7200</span><br><span class="line"></span><br><span class="line">/public/home/wlxie/biosoft/3d-dna/run-asm-pipeline.sh \</span><br><span class="line">/public/home/wlxie/biosoft/juicer/reference/genome.fa \</span><br><span class="line">-r 0 \</span><br><span class="line">/public/home/wlxie/biosoft/juicer/aligned/merged_nodups.txt</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># 运行脚本</span><br><span class="line">sbatch run.slurm</span><br></pre></td></tr></table></figure><p>220Mb参考基因组，50G的<code>merged_nodups.txt</code>文件，实际运行结束时长为10小时。</p><p><code>run-asm-pipeline.sh</code>脚本用法和参数如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">USAGE: ./run-asm-pipeline.sh [options] &lt;path_to_input_fasta&gt; &lt;path_to_input_mnd&gt;</span><br><span class="line"></span><br><span class="line">path_to_input_fasta：组装的基因组fasta文件位置</span><br><span class="line">path_to_input_mnd：juicer处理后得到的去重复的Hi-C reads比对基因组文件位置，也就是merged_nodups.txt</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-m|--mode haploid/diploid单倍体/二倍体模式（默认单倍体）</span><br><span class="line">-i|--input input_size指定输入的 contig/scaffold size阈值，默认15000，小于15000的将被忽略</span><br><span class="line">-r|--rounds number_of_edit_rounds 指定纠错轮数（默认为2轮）</span><br><span class="line">-s|--stage stage指定运行的阶段，可以是polish, split, seal, merge和finalize</span><br></pre></td></tr></table></figure><p>对于运行模式，作者团队建议是先运行默认的<code>haploid</code>模式，检查拼接后的图谱中是否存在与杂合度不足相关的信号，<code>diploid</code>模式会尝试合并一些单倍型。</p><blockquote><p>The diploid mode is to be used when one suspects large amounts of under collapsed heterozygosity to be present in the draft genome assembly (this was indeed the case for AaegL2). Running in the diploid mode will attempt to analyze the final assembly to remove the interspersed haplotigs and merge overlaps not recognized by the contigger because of variant differences. In most cases the default haploid mode should be used.</p></blockquote><p>可以看官方的这篇文章帮助理解下两种模式的区别，以及软件<code>LastZ</code>在<code>diploid</code>模式中起的作用：<a href="https://www.dropbox.com/s/le9cs0l6hdsqbkd/Extended_Hi-C_methods.docx?dl=0">Extended_Hi-C_methods.docx (dropbox.com)</a></p><p>至于纠错轮数，最好是按照默认的参数跑2轮，然后选择效果最好的一次结果导入juicerbox进行调整。</p><p>那么问题来了，怎么确认用哪个结果呢？首先要确认下结果文件有些啥。</p></div><h2 id="3-3D-DNA结果文件"><a href="#3-3D-DNA结果文件" class="headerlink" title="3. 3D-DNA结果文件"></a>3. 3D-DNA结果文件</h2><div class="story post-story"><p>这个软件产生的结果文件非常多，中间步骤产生的文件是不会自动删除的，看一下主要的几个文件：</p><ul><li><code>.fasta</code>基因组序列文件，最终组装的基因组序列名称为<code>.FINAL.fasta</code></li></ul><p><img src="https://www.shelven.com/tuchuang/20230712/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li><code>.hic</code>高度压缩的二进制文件，与下面的<code>.assembly</code>文件都可以载入Juicebox Assembly Tools，不同阶段产生不同的hic文件，0表示未校正</li></ul><p><img src="https://www.shelven.com/tuchuang/20230712/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li><code>.assembly</code>空格分隔的文本，记录对基因组草图执行的指令，包括拆分、更改顺序、方向和锚定到染色体中（不同阶段都会产生，同时产生同名的<code>.cprops</code>和<code>.asm</code>，这两种文件已弃用）</li></ul><p><img src="https://www.shelven.com/tuchuang/20230712/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li><code>.scaffold_track.txt &amp; .superscaf_track.txt</code>scaffold和super scaffold的染色体边界文件，Juicebox 2D 注释格式，使用juicerbox的时候可以用到，但是使用Juicebox Assembly Tools不需要用（因为边界注释会根据. assembly 文件自动生成）</li><li><code>.bed &amp; .wig</code>对pipeline进行故障审查的时候用到，可以与<code>.hic</code>文件导入juicebox，暂时与Juicebox Assembly Tools不兼容</li></ul><p>可以看出很多中间文件还是为了导入juicebox做分析产生的，而我们仅仅是为了辅助基因组组装，确认染色体的挂载情况，用到的是Aiden团队开发的juicebox的桌面应用拓展模块，也就是<code>Juicebox Assembly Tools(JBAT)</code>，很多中间文件已经用不到了，这里我们需要用到的是<code>.hic</code>和<code>.assembly</code>两种类型文件，且这两种文件名称是一一对应的。</p><p>如果是默认参数跑的话还会有<code>genome.1.hic</code>和<code>genome.2.hic</code>两个文件，分别代表校正了一次和两次的结果，都可以导入JBAT看结果。</p><p>看很多教程其实陷入了误区，需要校正多少轮，用哪一组数据其实没有固定说法，有的人用<code>genome.0.hic</code>，有的人用<code>genome.1.hic</code>，都是可以的，这几个只是polish前和polish后产生的hic文件，<strong>别忘了我们还有其他阶段产生的hic文件，都是可以用的</strong>。这里我用<code>genome.rawchrom.hic</code>和对应的<code>genome.rawchrom.assembly</code>这组文件，因为这组文件实际上区分染色体的情况最好。</p><p>下一步就是导入<code>JBAT</code>手动调整染色体边界和修改组装过程中产生的错误。</p></div><h2 id="4-导入JBAT"><a href="#4-导入JBAT" class="headerlink" title="4. 导入JBAT"></a>4. 导入JBAT</h2><div class="story post-story"><p>这一步在个人电脑上完成，最好保证电脑有4G以上的运存（2023年了个人电脑都有这个配置了吧），<strong>否则会巨卡无比</strong>。</p><p>我用的官方1.11.08版本的windows工具：</p><p><a href="https://s3.amazonaws.com/hicfiles.tc4ga.com/public/Juicebox/Juicebox_1.11.08.exe">https://s3.amazonaws.com/hicfiles.tc4ga.com/public/Juicebox/Juicebox_1.11.08.exe</a></p><p>不要安装直接可以运行，首先导入<code>.hic</code>文件：</p><p><img src="https://www.shelven.com/tuchuang/20230712/1.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>导入hic文件之后<code>Assembly</code>菜单就可以点了，导入对应名字的<code>.assembly</code>文件：</p><p><img src="https://www.shelven.com/tuchuang/20230712/2.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>完整导入后界面如图所示，主要是用到以下几个菜单栏：</p><p><img src="https://www.shelven.com/tuchuang/20230712/3.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li>①：标准化方式，选择balance看起来舒服点&#x3D; &#x3D;</li><li>②：分辨率，调整显示的分表率大小</li><li>③：色彩范围，调整表示互作强度的色彩范围</li><li>④右下角几个颜色块代表图上线条框的区域处于什么状态。默认黄色线框的是待编辑区（这里没有，对区块进行操作的时候才有），紫色线框是染色体区块，绿色线框是scaffold区域</li></ul></div><h2 id="5-调整Hi-C互作图"><a href="#5-调整Hi-C互作图" class="headerlink" title="5. 调整Hi-C互作图"></a>5. 调整Hi-C互作图</h2><div class="story post-story"><p>我这个互作图没有明显的需要染色体易位、倒位的调整，只需要确定染色体边界（也就是蓝色的线）就行。</p><p>染色体易位和倒位的调整在官方视频里就有，b站有人做了翻译，看一个视频足够了<a href="https://www.bilibili.com/video/BV1LK411M7nZ/?from=search&seid=15631142475797820614&vd_source=7779d154860677839e3a88514c21d826">翻译 | Juicebox Assembly Tools教程_哔哩哔哩_bilibili</a></p><p>调高分辨率，比如下面我要做的就是将紫色框分成两个：</p><p><img src="https://www.shelven.com/tuchuang/20230712/4.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>放大到一定分辨率后，scaffold的交界处鼠标会变成<code>L</code>型，点一下就可以加上染色体边界，这里截图没截出来……</p><p>还有一种方法，长按<code>shift</code>键，单击拖动鼠标框选住你要操作的scaffold（不需要完全覆盖scaffold，只要框的面积里有你要的scaffold就行），松开<code>shift</code>键，这个时候选中的scaffold会处于待编辑状态（黄色的框线）。右键，选择<code>Add chr boundaries</code>即可为选中的scaffold区域添加染色体边界。</p><p>如果想要撤销操作，右键后点击<code>Undo</code>即可。</p><p><img src="https://www.shelven.com/tuchuang/20230712/5.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>整体调整完以后是这样：</p><p><img src="https://www.shelven.com/tuchuang/20230712/9.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>染色体条数不是无缘无故添加的，既要以图为准，又要由实验确定，或者通过已经发表的文献（该物种或者近缘物种）佐证，纠正算法产生染色体边界的误差。我是通过查阅文献得到这个物种染色体条数为11，调整后的Hi-C互作图也能明显分为11个互作区块，证实组装是没有问题的。</p><p>官方的操作手册上也有详尽的手动调整Hi-C互作图教程，可以参考<a href="https://www.dropbox.com/s/yq5oeuh0c9dlzhw/manual_180322.pdf?dl=0">manual_180322.pdf (dropbox.com)</a>。</p><p>手动调整完后，导出调整后的<code>.assembly</code>文件，我们需要用这个文件重新回到3D-DNA生成最终的染色体水平基因组fasta文件。</p><p><img src="https://www.shelven.com/tuchuang/20230712/10.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div><h2 id="6-3D-DNA处理"><a href="#6-3D-DNA处理" class="headerlink" title="6. 3D-DNA处理"></a>6. 3D-DNA处理</h2><div class="story post-story"><p>简单来说，我们在<code>JBAT</code>导出的最终<code>.assembly</code>文件记录了各个scaffold的坐标位置和互作信息，只需要在<code>3D-DNA</code>中跑最后finalize流程就可以了，软件提供了脚本<code>run-asm-pipeline-post-review.sh</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">USAGE: ./run-asm-pipeline-post-review.sh [options] -r &lt;review.assembly&gt; &lt;path_to_input_fasta&gt; &lt;path_to_input_mnd&gt; </span><br><span class="line"></span><br><span class="line">path_to_input_fasta：指定组装的草图基因组fasta文件</span><br><span class="line">path_to_input_mnd：指定juicer产生的merged_nodups.txt</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-r|--review path_to_review_assembly指定上一步JBAT导出的.assembly文件</span><br><span class="line">-i|--input input_size指定输入的 contig/scaffold size阈值，默认15000，小于15000的将被忽略</span><br><span class="line">-s|--stage stage指定运行开始的阶段，可以是seal或者finalize，默认finalize</span><br><span class="line">-q|--mapq mapq指定最终map的可视化MAPQ阈值，默认1</span><br><span class="line">-g|--gap_size gap_size指定最终scaffold之间的间隔，默认500</span><br><span class="line">--sort-output对最终输出的染色体级别的scaffold长度排序，降序</span><br><span class="line">--build-gapped-mapOption to output an additional contact map corresponding to the assembly after the gaps have been added between scaffolded sequences.（我也不知道干啥的）</span><br></pre></td></tr></table></figure><p>比较重要的就三个文件位置参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 创建run_postview.slurm脚本</span><br><span class="line">vim run_postview.slurm</span><br><span class="line"></span><br><span class="line"># 脚本内容如下</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">#!/bin/bash</span><br><span class="line">#SBATCH -n 30</span><br><span class="line">#SBATCH -N 1</span><br><span class="line">#SBATCH -t 7200</span><br><span class="line"></span><br><span class="line">/public/home/wlxie/biosoft/3d-dna/run-asm-pipeline-post-review.sh \</span><br><span class="line">         -r /public/home/wlxie/biosoft/3d-dna/baima_diploid/genome_rawchrom.review.assembly \</span><br><span class="line">         /public/home/wlxie/biosoft/juicer/reference/genome.fa \</span><br><span class="line">         /public/home/wlxie/biosoft/juicer/aligned/merged_nodups.txt</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># 运行脚本</span><br><span class="line">sbatch run_postview.slurm</span><br></pre></td></tr></table></figure><p>静静等待生成最终的fasta序列就可以啦，如果前面做过contig基因组草图注释的话，还需要将注释的基因信息转坐标到最终的染色体水平基因组上；如果没做过注释的话，跑一遍注释流程吧！</p></div><h2 id="2023-7-17补充"><a href="#2023-7-17补充" class="headerlink" title="2023.7.17补充"></a>2023.7.17补充</h2><div class="story post-story"><p>最终生成的基因组序列要看<code>genome.FINAL.fasta</code>，发现染色体数目和前面手动标定染色体边界的数目不一致，这很正常。可以用seqkit工具统计下各个染色体的长度，如下：</p><p><img src="https://www.shelven.com/tuchuang/20230712/11.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>可以看到前11条是染色体级别的contig，这和手动标记的染色体数目一致，后面的contig长度占比非常小，可以标记区分一下，这些都要放在组装的基因组文件里。</p><p>顺便放一下自己写的python代码，同样的处理效果，顺手就当python练习了（运行前提：fasta文件中没有空行）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fasta_file = <span class="string">&#x27;genome.FINAL.fasta&#x27;</span><span class="comment"># 换成自己的fasta文件路径</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fasta_length</span>(<span class="params">file_path</span>):</span><br><span class="line">    sequences = &#123;&#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        content = file.read()   <span class="comment"># 读整个文件</span></span><br><span class="line"></span><br><span class="line">    blocks = content.split(<span class="string">&#x27;&gt;&#x27;</span>)     <span class="comment"># 根据关键字“&gt;”分块</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> blocks[<span class="number">1</span>:]:    <span class="comment"># 第一个块为空，跳过</span></span><br><span class="line">        index = block.find(<span class="string">&#x27;\n&#x27;</span>)    <span class="comment"># 查找第一个换行符索引</span></span><br><span class="line">        newline_number = block.count(<span class="string">&#x27;\n&#x27;</span>)    <span class="comment"># 统计换行符数量</span></span><br><span class="line">        header = block[:index]  <span class="comment"># 序列名称</span></span><br><span class="line">        sequence_length = <span class="built_in">len</span>(block) - index - newline_number    <span class="comment"># 序列长度</span></span><br><span class="line">        sequences[header] = sequence_length <span class="comment"># 序列名称和长度存入字典</span></span><br><span class="line">    <span class="keyword">return</span> sequences</span><br><span class="line"></span><br><span class="line">sequence_lengths = fasta_length(fasta_file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> header, length <span class="keyword">in</span> sequence_lengths.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>:<span class="subst">&#123;length&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure></div><h2 id="2023-9-11补充"><a href="#2023-9-11补充" class="headerlink" title="2023.9.11补充"></a>2023.9.11补充</h2><div class="story post-story"><p>考虑到juicebox调整的这个图不能直接用在论文里（看起来有点不直观），这里再推荐两个项目：</p><p><a href="https://github.com/Atvar2/plotHicGenome">Atvar2&#x2F;plotHicGenome: The tools are used for displaying hic signal of genome (github.com)</a></p><p><a href="https://github.com/yukaiquan/biotools/tree/main/Hic/juicerbox2matrix">biotools&#x2F;Hic&#x2F;juicerbox2matrix at main · yukaiquan&#x2F;biotools (github.com)</a></p><p>第一个工具可以将Juicebox调整的结果（<code>.review.assembly</code>文件）和juicer2的结果（<code>merged_nodups.txt</code>）结合，做全基因组层面的Hi-C互作图。第二个工具是另一个作者优化了生成bin matrix矩阵的过程，测试了下吃个饭的功夫就跑完了。其实也可以用<code>.hic</code>以及<code>.review.assembly</code>文件做matrix，然后用<strong>HiCPlotter</strong>作图（怎么用HiCPlotter可以看之前的这篇博客 <a href="https://www.shelven.com/2023/06/15/a.html">三维基因组学——如何用Hi-C数据分析拓扑关联结构域</a>），效果基本上是差不多的。</p><p>这里记录下使用上面项目的过程和最后跑出来的效果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#SBATCH -n 8</span><br><span class="line">#SBATCH -t 7200</span><br><span class="line"></span><br><span class="line">assembly=/public/home/wlxie/biosoft/3d-dna/baima_diploid/genome_rawchrom.review.assembly</span><br><span class="line">merged_nodups=/public/home/wlxie/biosoft/juicer/aligned/merged_nodups.txt</span><br><span class="line"></span><br><span class="line">./juicerbox2matrix -a $&#123;assembly&#125; -c 11 -i $&#123;merged_nodups&#125; -o run</span><br><span class="line"></span><br><span class="line">plotHicGenome juicer $&#123;merged_nodups&#125; $&#123;assembly&#125; -H run/Hicmatrix.txt -W whole -n 11 -s False -l t -F 4 -r 500000 -X 2 -w 0.5 -d 3 -S &#x27;dashed&#x27; -i 300 -z 6,6 -C &#x27;black&#x27; -L 0.8 -A 0.8 -B &#x27;1%&#x27; -D 0.2 -o Juicerbox.pdf -R ./run</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230712/12.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230712/12.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;前一篇博客主要讲了如何使用juicer进行Hi-C测序的下机数据处理，这篇博客我们按照Aiden团队的基因组组装“CookBook”继续接下来的操作，主要记录下3D-DNA软件的配置运行，以及如何手动调整结果。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="基因组三代测序分析" scheme="http://www.shelven.com/categories/%E5%9F%BA%E5%9B%A0%E7%BB%84%E4%B8%89%E4%BB%A3%E6%B5%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Hi-C染色体挂载" scheme="http://www.shelven.com/tags/Hi-C%E6%9F%93%E8%89%B2%E4%BD%93%E6%8C%82%E8%BD%BD/"/>
    
    <category term="3D-DNA" scheme="http://www.shelven.com/tags/3D-DNA/"/>
    
    <category term="JBAT" scheme="http://www.shelven.com/tags/JBAT/"/>
    
  </entry>
  
  <entry>
    <title>Hi-C染色体挂载（1）——juicer2处理Hi-C数据</title>
    <link href="http://www.shelven.com/2023/07/11/a.html"/>
    <id>http://www.shelven.com/2023/07/11/a.html</id>
    <published>2023-07-11T10:04:56.000Z</published>
    <updated>2023-07-11T13:03:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>前面经过三代数据结合二代数据的组装和polish，已经把基因组组装成了contigs的水平，下一步就是进一步提升到染色体水平。从实现的方式上来说有Bionano的光学图谱技术（作用是减少Scaffold数量，基因组纠错），Hi-C技术，遗传图谱以及依靠算法实现的基于近缘物种参考基因组的染色体水平组装（比如RagTag）。</p><span id="more"></span><p>对于一个没有遗传图谱，也没有近缘物种参考基因组的物种，考虑到光学图谱费用昂贵，一般最划算用的最多的是测一个Hi-C来进行基因组染色体级别组装。一些经典的Hi-C辅助组装的软件应运而生，比如<code>LACHESIS</code>、<code>3D-DNA</code>、<code>YaHS</code>等等。这篇笔记主要记录下软件<code>3D-DNA的</code>染色体挂载流程。</p><p>然而<code>3D-DNA</code>不能直接处理Hi-C下机数据，因此总的流程是用<code>juicer2</code>先处理Hi-C数据，再用<code>3D-DNA</code>进行染色体挂载，最后用<code>Juicebox Assembly Tools (JBAT)</code>进行手工纠错。流程参考自Baylor College of Medicine &amp; Rice University Aiden团队<a href="https://aidenlab.org/assembly/manual_180322.pdf">Genome Assembly Cookbook</a>，这几个软件也是出自他们团队。</p><h2 id="juicer2"><a href="#juicer2" class="headerlink" title="juicer2"></a>juicer2</h2><div class="story post-story"><p>Juicer是一款非常经典的Hi-C数据处理软件，但是配置运行起来稍微有点麻烦，花了小半天时间踩坑记录一下。<strong>需要非常注意的一点</strong>，直接从github官网拉取的juicer仓库是<strong>juicer2</strong>，在release版本中有一个稳定版<strong>juicer1.6</strong>，两者的配置和产生的结果文件是不一样的！！！</p><p>秉着软件用新不用旧的原则，本篇笔记全程用的是<code>juicer2</code>，如果有软件运行问题可以在<a href="https://groups.google.com/g/3d-genomics">3D Genomics - Google 网上论坛</a>交流，或者在github官方提Issues（不建议）。</p><p>顺便提一下我使用<code>Juicer2</code>过程中碰到的版本问题：</p><ul><li><p><code>juicer2</code>配置的<code>juicer_tools</code>版本要在<strong>2.0</strong>以上，否则会报错<code>Exception in thread &quot;main&quot; java.lang.RuntimeException: Unknown command: statistics</code>，该报错会直接导致无法生成<code>inter.txt</code>、<code>inter_hists.m</code> 、<code>inter_30.txt</code>和<code>inter_30_hists.m</code>文件，也就是Hi-C互作的统计数据和矩阵。</p></li><li><p><code>juicer2</code>结果文件中<strong>不会自动产生merged_nodups.txt文件</strong>，该文件原本作为<code>3D-DNA</code>的输入文件，在<code>juicer2</code>中被同名的<code>merged_nodups.bam</code>文件和<code>merged*.txt</code>代替。如果想要<code>merged_nodups.txt</code>文件，<strong>需要加上参数--assembly</strong>。</p></li></ul><h3 id="1-下载和配置juice2"><a href="#1-下载和配置juice2" class="headerlink" title="1. 下载和配置juice2"></a>1. 下载和配置juice2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 拉取最新版本的juicer2仓库（这里用的github镜像，集群可能有dns污染无法直接访问github）</span><br><span class="line">git clone https://ghproxy.com/https://github.com/aidenlab/juicer.git</span><br><span class="line">cd juicer</span><br><span class="line"></span><br><span class="line"># juicer主目录下配置scripts（必需）</span><br><span class="line">## 个人电脑的是建立软链接到CPU文件夹下，其他如slurm、LSF、AWS和Univa等集群或者云端跑juicer是建立软链接或者复制到对应文件夹的scripts文件夹下</span><br><span class="line">ln -s CPU scripts</span><br><span class="line"></span><br><span class="line"># scripts/common文件夹中下载juicer_tools（必需）</span><br><span class="line">cd scripts/common</span><br><span class="line">wget -c https://ghproxy.com/https://github.com/aidenlab/Juicebox/releases/download/v2.20.00/juicer_tools.2.20.00.jar</span><br><span class="line"># 修改文件属性为可执行文件后，建立软链接</span><br><span class="line">ln -s juicer_tools.2.20.00.jar juicer_tools.jar</span><br></pre></td></tr></table></figure><p>本来想配置slurm跑的，因为塔大集群使用的是slurm作业调度系统。花了好大功夫配置环境发现运行<code>SLURM/scripts</code>底下的<code>juicer.sh</code>还需要配置CUDA，晕，学校的集群没有GPU（怨念 &#x3D; &#x3D;）……所以如果集群没有GPU的话就老老实实用<code>CPU</code>文件夹下的<code>juicer.sh</code>，按照CPU流程跑后面的程序，缺点是不能用集群提交多线程作业非常难受。</p><blockquote><p>官方也是推荐小的Hi-C实验可以用CPU版本，如果数据量比较大，还是推荐带有GPU加速的集群（最好是SLURM）或者云端跑。如下是官方推荐的两种方式：</p><p><a href="https://github.com/aidenlab/juicer/wiki/Running-Juicer-on-a-cluster">Running Juicer on a cluster · aidenlab&#x2F;juicer Wiki (github.com)</a></p><p><a href="https://github.com/ENCODE-DCC/hic-pipeline">ENCODE-DCC&#x2F;hic-pipeline: HiC uniform processing pipeline (github.com)</a></p></blockquote><p>juicer主目录下需要配置两个必需的文件夹<code>reference</code>和<code>restriction_sites</code>（第二个在juicer流程中非必须，但是做染色体挂载一定要）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># juicer目录下创建参考基因组文件夹，放入参考基因组（复制或者软链接）和构建参考基因组索引文件（必需用bwa）</span><br><span class="line">mkdir reference &amp;&amp; cd reference</span><br><span class="line">cp /path/to/your/reference/genome.fa ./</span><br><span class="line">bwa index genome.fa</span><br><span class="line"></span><br><span class="line"># juicer目录下创建限制性酶切位点文件夹，MboI酶酶切参考基因组（根据自己测hic用的限制酶）</span><br><span class="line">mkdir restriction_sites &amp;&amp; cd restriction_sites</span><br><span class="line">python ~/biosoft/juicer/misc/generate_site_positions.py MboI genome ~/biosoft/juicer/reference/genome.fa</span><br><span class="line">## 生成的酶切图谱文件名为genome_MboI.txt，同个文件夹下生成contig长度文件</span><br><span class="line">awk &#x27;BEGIN&#123;OFS=&quot;\t&quot;&#125;&#123;print $1, $NF&#125;&#x27; genome_MboI.txt &gt; genome.chrom.sizes</span><br></pre></td></tr></table></figure><p>官方的酶切参考基因组的脚本<code>generate_site_positions.py</code>支持<code>HindIII、DpnII、MboI、Sau3AI和Arima</code>4种限制性核酸内切酶，如果你Hi-C测序用的是其他酶，可以根据实际修改这个脚本中的字典类型数据patterns，根据实际情况加入键值对信息：</p><p><img src="https://www.shelven.com/tuchuang/20230710/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230710/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>稍微解释一下官网给的<code>awk &#39;BEGIN&#123;OFS=&quot;\t&quot;&#125;&#123;print $1, $NF&#125;&#39;</code>这个命令，这里awk的程序部分由两部分组成：</p><blockquote><ul><li><code>BEGIN&#123;OFS=&quot;\t&quot;&#125;</code>：BEGIN块是在处理文件之前执行的代码块。在这里，它设置输出字段分隔符（OFS）为制表符（<code>\t</code>）。这意味着输出的字段将使用制表符进行分隔。</li><li><code>&#123;print $1, $NF&#125;</code>：这是awk的主要部分，它定义了要执行的操作。在这里，它打印每行的第一个字段$1和最后一个字段（NF）。通过使用逗号分隔它们，它们将以制表符分隔的形式打印出来。</li></ul></blockquote><p><code>genome.chrom.sizes</code>文件如下所示：</p><p><img src="https://www.shelven.com/tuchuang/20230710/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230710/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>工作目录下必需配置一个文件夹<code>fastq</code>，其中存放Hi-C的双端测序数据，命名格式参考<code>juicer.sh</code>文件中的正则表达式<code>*_R*.fastq*</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 工作目录下创建存放hic测序数据的文件夹，我这里为了方便查看，工作目录就是juicer主目录，测序数据可以用软链接的形式存放</span><br><span class="line">mkdir fastq &amp;&amp; cd fastq</span><br><span class="line">ln -s ~/hi-c/BM_R1.fq.gz Av_R1.fastq.gz</span><br><span class="line">ln -s ~/hi-c/BM_R2.fq.gz Av_R2.fastq.gz</span><br></pre></td></tr></table></figure><h3 id="2-运行juicer2"><a href="#2-运行juicer2" class="headerlink" title="2. 运行juicer2"></a>2. 运行juicer2</h3><p>官网的<code>juicer.sh</code>参数非常之多，我这里只展示一些关键的，其他用默认参数即可。<code>1.x</code>版本可以参考<a href="https://github.com/aidenlab/juicer/wiki/Usage">Usage · aidenlab&#x2F;juicer Wiki (github.com)</a>，<code>2.0</code>版本具体可以用<code>bash juicer.sh -h</code>查看，两个版本指令稍有不同。CPU版本和其他集群版本也稍有不同，以CPU中的2.0版本为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Usage: juicer.sh [-g genomeID] [-d topDir] [-s site]</span><br><span class="line">                 [-a about] [-S stage] [-p chrom.sizes path]</span><br><span class="line">                 [-y restriction site file] [-z reference genome file]</span><br><span class="line">                 [-D Juicer scripts parent dir] [-b ligation] [-t threads]</span><br><span class="line">                 [-T threadsHic] [-i sample] [-k library] [-w wobble]</span><br><span class="line">                 [-e] [-h] [-f] [-j] [-u] [-m] [--assembly] [--cleanup] [--qc]</span><br><span class="line">-g genomeID必需项，指定基因组和版本，比如人类的&quot;hg19&quot; 或者小鼠的&quot;mm10&quot;，如果没有，可以用-z命令替代，指定参考基因组文件</span><br><span class="line">-z reference genome file指定参考基因组文件，此文件中必需有BWA索引文件</span><br><span class="line">-d topDir指定输出目录，默认是当前目录。[topDir]/fastq必需包含fastq文件</span><br><span class="line">-s site必需项，指定限制性核酸内切酶。如果不做片段级别的分析可以写none</span><br><span class="line">-S stage指定运行pipeline的阶段，固定是&quot;chimeric&quot;, &quot;merge&quot;, &quot;dedup&quot;, &quot;final&quot;, &quot;postproc&quot;, &quot;early&quot;其中之一，报错调试用</span><br><span class="line">chimeric：alignment结束或者从aligned文件开始</span><br><span class="line">merge:alignment结束但是没有生成merged_sort文件</span><br><span class="line">dedup：文件已经merge结束，但是没有生成merged_nodups文件</span><br><span class="line">final：reads在merged_nodups文件中已经删除重复，但是尚未生成最终的state和hic文件</span><br><span class="line">postproc：hic文件已经生成，只有特征注释尚未完成</span><br><span class="line">early：在hic文件生成前提前结束程序</span><br><span class="line">-p chrom.sizes path指定染色体长度文件</span><br><span class="line">-y restriction site file指定参考基因组酶切文件</span><br><span class="line">-D Juicer scripts parent dir指定Juicer/scripts所在目录</span><br><span class="line">-t threads指定跑BWA的线程数</span><br><span class="line">-T threadsHic指定生成hic文件用的核数（2.0版本新增）</span><br><span class="line">--assembly接下游3D-DNA分析，会提前结束并生成老版本的merged_nodups文件（2.0新增）</span><br><span class="line">--cleanup如果pipeline成功运行，自动清除中间文件（2.0新增）</span><br><span class="line"></span><br><span class="line">如果是在集群中跑juicer，以下两个参数也是必需要改的，否则用默认分区名会直接报错：</span><br><span class="line">-q queue指定跑alignments的队列分区（默认commons），slurm中的分区也就是partition，可以理解为LSF、PBS等作业调度系统中的队列</span><br><span class="line">-l long queue指定跑需要时间更长的job，比如生成hic文件的队列分区（默认long）</span><br></pre></td></tr></table></figure><p>因为我不是做三维基因组，Hi-C只测了一个样（主要用于辅助基因组组装，染色体挂载），比如做三维基因组就会有大量的Hi-C数据，juicer也支持多个结果的合并（使用<code>mega.sh</code>），详细也可以参考上面的juicer Wiki。</p><p>上面的限速步骤主要是跑BWA，因为第一次跑juicer不知道要多久，就稍微申请多一点的核数<del>（虽然集群没有GPU，但是CPU资源很充足平常没人用）。</del></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个slurm作业</span><br><span class="line">vim juicer.slurm</span><br><span class="line"></span><br><span class="line"># 提交slurm作业</span><br><span class="line">sbatch juicer.slurm</span><br></pre></td></tr></table></figure><p><code>juicer.slurm</code>文件内容如下<strong>（再次提醒--assembly 参数非常重要）</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#SBATCH -N 1</span><br><span class="line">#SBATCH -n 30</span><br><span class="line">#SBATCH -t 7200</span><br><span class="line"></span><br><span class="line">/public/home/wlxie/biosoft/juicer/scripts/juicer.sh \</span><br><span class="line">-z /public/home/wlxie/biosoft/juicer/reference/genome.fa \</span><br><span class="line">-p /public/home/wlxie/biosoft/juicer/restriction_sites/genome.chrom.sizes \</span><br><span class="line">-y /public/home/wlxie/biosoft/juicer/restriction_sites/genome_MboI.txt \</span><br><span class="line">-s MboI \</span><br><span class="line">-D /public/home/wlxie/biosoft/juicer \</span><br><span class="line">-t 30 \</span><br><span class="line">--assembly</span><br></pre></td></tr></table></figure><p>运行时间可以参考一下我这里220 Mb的参考基因组，Hi-C测序数据39G（双端测序，gz文件），实际上运行了13小时才出结果。</p><p>运行pipeline成功后会在日志中提示<code>(-: Pipeline successfully completed (-:</code></p><h3 id="3-结果文件"><a href="#3-结果文件" class="headerlink" title="3. 结果文件"></a>3. 结果文件</h3><p>CPU模式下会在工作目录创建<code>aligned</code>和<code>splits</code>文件夹：</p><blockquote><ul><li>splits 文件夹存放整个pipeline的临时文件，跑完流程并且确认结果没问题后可以运行cleanup.sh或者直接删除（按照帮助文档的说法，–cleanup参数应该可以自动删除，我没有试过）</li><li>aligned 文件夹存放运行结果</li><li>如果你是用集群模式跑的，比如SLURM，还会生成一个<code>debug</code>文件夹（CPU模式下用SLURM跑的没有该文件夹），可以查看各个步骤的error报告和output报告</li></ul></blockquote><p>aligned文件夹有以下结果文件：</p><p><img src="https://www.shelven.com/tuchuang/20230710/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230710/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我这里实际上是多了一些文件（实际上跑了两遍），因为一开始没有加上<code>--assembly</code>参数，所以一直运行到出hic结果文件，而且没有<code>merged_nodups.txt</code>。</p><p>我做染色体挂载<strong>只需要最后一个文件</strong>，第二次运行加了上面的参数，并且加上<code>-S final</code>参数，这样就省去了前面比对和去重复的时间（90%以上的时间花在这里），一个小时可以重新跑完出结果。</p><p>顺便了解一下其他结果文件的用途：</p><blockquote><ul><li><strong>inter.hic &#x2F; inter_30.hic</strong>: The .hic files for Hi-C contacts at MAPQ &gt; 0 and at MAPQ &gt;&#x3D; 30, respectively</li><li><strong>merged_nodups.txt</strong>: The Hi-C contacts with duplicates removed. This file is also input to the assembly and diploid pipelines （后面跑3D-DNA的输入文件）</li><li><strong>inter.txt, inter_hists.m &#x2F; inter_30.txt, inter_30_hists.m</strong>: The statistics and graphs files for Hi-C contacts at MAPQ &gt; 0 and at MAPQ &gt;&#x3D; 30, respectively. These are also stored within the respective .hic files in the header. The .m files can be loaded into Matlab. The statistics and graphs are displayed under Dataset Metrics when loaded into Juicebox （可以后续导入juicer box）</li></ul></blockquote></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;前面经过三代数据结合二代数据的组装和polish，已经把基因组组装成了contigs的水平，下一步就是进一步提升到染色体水平。从实现的方式上来说有Bionano的光学图谱技术（作用是减少Scaffold数量，基因组纠错），Hi-C技术，遗传图谱以及依靠算法实现的基于近缘物种参考基因组的染色体水平组装（比如RagTag）。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="基因组三代测序分析" scheme="http://www.shelven.com/categories/%E5%9F%BA%E5%9B%A0%E7%BB%84%E4%B8%89%E4%BB%A3%E6%B5%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="juicer2" scheme="http://www.shelven.com/tags/juicer2/"/>
    
    <category term="Hi-C染色体挂载" scheme="http://www.shelven.com/tags/Hi-C%E6%9F%93%E8%89%B2%E4%BD%93%E6%8C%82%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>python自学笔记（8）——10种排序方式的python实现</title>
    <link href="http://www.shelven.com/2023/07/04/a.html"/>
    <id>http://www.shelven.com/2023/07/04/a.html</id>
    <published>2023-07-04T15:14:44.000Z</published>
    <updated>2023-07-04T15:37:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近中期答辩结束，稍微有点空闲的时间捋一捋数据结构和算法方面的知识。虽然现在用python实现排序就一个sort()函数的事，但是还是想锻炼下自己的思维，从底层代码学习一下10种经典排序的实现方式。</p><span id="more"></span><p>对于时间复杂度和空间复杂度的计算，自己还是一知半解，每种排序方式后面放了自己的理解，有错误会继续修改，最后有一张菜鸟教程总结的图可以参考。</p><p>本篇笔记的内容主要是跟着b站up主做的，代码整理来自<a href="https://space.bilibili.com/319521269">英雄哪里出来的个人空间</a></p><p>我这里先定义一个生成随机整数序列的函数，后面都会调用，就不重复写了：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成指定范围、长度的序列</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_sequence</span>(<span class="params"><span class="built_in">len</span>, <span class="built_in">min</span>, <span class="built_in">max</span></span>):</span><br><span class="line">    seq = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>):</span><br><span class="line">        seq.append(random.randint(<span class="built_in">min</span>, <span class="built_in">max</span>))</span><br><span class="line">    <span class="keyword">return</span> seq</span><br></pre></td></tr></table></figure><h2 id="1-选择排序"><a href="#1-选择排序" class="headerlink" title="1. 选择排序"></a>1. 选择排序</h2><div class="story post-story"><p>从第一个元素到最后一个元素中选择最小的元素，和第一个元素进行交换；然后从第二个元素到最后一个元素选择最小的元素，和第二个元素交换，依此类推。通过对未排序的元素比较和交换，选择出最小的，直到最后成为一个升序序列。</p><img src="https://www.shelven.com/tuchuang/20230704/SelectionSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/SelectionSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">SelectionSort</span>(<span class="params">a</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(a)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>): <span class="comment"># 排完倒数第二个数之后就不用再排了，所以这里用n-1而不是n</span></span><br><span class="line">        <span class="built_in">min</span> = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, n):</span><br><span class="line">            <span class="keyword">if</span> a[j] &lt; a[<span class="built_in">min</span>]:</span><br><span class="line">                <span class="built_in">min</span> = j</span><br><span class="line">        a[i], a[<span class="built_in">min</span>] = a[<span class="built_in">min</span>], a[i]</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">SelectionSort(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[77, 76, 21, 51, 29, 23, 19, 68, 53, 37]</span></span><br><span class="line"><span class="string">[19, 76, 21, 51, 29, 23, 77, 68, 53, 37]</span></span><br><span class="line"><span class="string">[19, 21, 76, 51, 29, 23, 77, 68, 53, 37]</span></span><br><span class="line"><span class="string">[19, 21, 23, 51, 29, 76, 77, 68, 53, 37]</span></span><br><span class="line"><span class="string">[19, 21, 23, 29, 51, 76, 77, 68, 53, 37]</span></span><br><span class="line"><span class="string">[19, 21, 23, 29, 37, 76, 77, 68, 53, 51]</span></span><br><span class="line"><span class="string">[19, 21, 23, 29, 37, 51, 77, 68, 53, 76]</span></span><br><span class="line"><span class="string">[19, 21, 23, 29, 37, 51, 53, 68, 77, 76]</span></span><br><span class="line"><span class="string">[19, 21, 23, 29, 37, 51, 53, 68, 77, 76]</span></span><br><span class="line"><span class="string">[19, 21, 23, 29, 37, 51, 53, 68, 76, 77]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>这个算法时间复杂度（算法中循环执行的次数，量级估算）为O(n^2)，其中n是输入序列的长度。空间复杂度（算法运行过程中临时占用存储大小，量级估算）为O(1)，因为它只需要使用常数级别的额外空间。</p></div><h2 id="2-冒泡排序"><a href="#2-冒泡排序" class="headerlink" title="2. 冒泡排序"></a>2. 冒泡排序</h2><div class="story post-story"><p>通过不断比较相邻元素，将数值大的元素往后排。第一个元素和第二个元素比较，如果第一个元素大，则进行交换，再比较第二个元素和第三个元素大小，以此类推，直到最大的元素移动到最后一个位置，然后进行第二轮比较。每一轮中数值较大的元素，不断到达数组的尾部。</p><img src="https://www.shelven.com/tuchuang/20230704/BubbleSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/BubbleSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">BubbleSort</span>(<span class="params">a</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(a)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):<span class="comment"># range()左闭右开，n-1可以取到右边界，逆序枚举</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, i):</span><br><span class="line">            <span class="keyword">if</span> a[j] &gt; a[j + <span class="number">1</span>]:</span><br><span class="line">                a[j], a[j + <span class="number">1</span>] = a[j + <span class="number">1</span>], a[j]</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">BubbleSort(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[57, 86, 40, 11, 38, 46, 21, 38, 18, 6]</span></span><br><span class="line"><span class="string">[57, 40, 11, 38, 46, 21, 38, 18, 6, 86]</span></span><br><span class="line"><span class="string">[40, 11, 38, 46, 21, 38, 18, 6, 57, 86]</span></span><br><span class="line"><span class="string">[11, 38, 40, 21, 38, 18, 6, 46, 57, 86]</span></span><br><span class="line"><span class="string">[11, 38, 21, 38, 18, 6, 40, 46, 57, 86]</span></span><br><span class="line"><span class="string">[11, 21, 38, 18, 6, 38, 40, 46, 57, 86]</span></span><br><span class="line"><span class="string">[11, 21, 18, 6, 38, 38, 40, 46, 57, 86]</span></span><br><span class="line"><span class="string">[11, 18, 6, 21, 38, 38, 40, 46, 57, 86]</span></span><br><span class="line"><span class="string">[11, 6, 18, 21, 38, 38, 40, 46, 57, 86]</span></span><br><span class="line"><span class="string">[6, 11, 18, 21, 38, 38, 40, 46, 57, 86]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>这个算法的时间复杂度为O(n^2)（最好的情况下数据本来有序，复杂度O(n)），其中n是待排序数组的长度。空间复杂度为O(1)，因为只使用了常数级别的额外空间。和选择排序算法是一样。</p></div><h2 id="3-插入排序"><a href="#3-插入排序" class="headerlink" title="3. 插入排序"></a>3. 插入排序</h2><div class="story post-story"><p>对前i-1个数已经有序的情况下，将第i个数插入到合适的位置。</p><p>将第二个元素和第一个元素比较，如果第二个元素小于等于第一个元素，则将第一个元素向后移动，并将第一个元素执行插入，这样前两个元素就是有序的。接着进行第二轮比较，也就是将第三个元素依次和第二元素和第一个元素比较，并插入到合适的位置，使前三个元素有序。以此类推，迭代执行n-1次插入，<strong>每次插入都是将元素插入到有序序列中。</strong></p><img src="https://www.shelven.com/tuchuang/20230704/InsertionSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/InsertionSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">InsertionSort</span>(<span class="params">a</span>):</span><br><span class="line">    n =<span class="built_in">len</span>(a)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n):</span><br><span class="line">        x = a[i]</span><br><span class="line">        j = i - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> j &gt;= <span class="number">0</span> <span class="keyword">and</span> x &lt;= a[j]:<span class="comment"># 若x&lt;=a[j]，则将a[j]往后移动，继续判断前一个数</span></span><br><span class="line">            a[j + <span class="number">1</span>] = a[j]</span><br><span class="line">            j -= <span class="number">1</span></span><br><span class="line">        a[j + <span class="number">1</span>] = x</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">InsertionSort(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[95, 69, 37, 81, 21, 11, 53, 12, 22, 16]</span></span><br><span class="line"><span class="string">[69, 95, 37, 81, 21, 11, 53, 12, 22, 16]</span></span><br><span class="line"><span class="string">[37, 69, 95, 81, 21, 11, 53, 12, 22, 16]</span></span><br><span class="line"><span class="string">[37, 69, 81, 95, 21, 11, 53, 12, 22, 16]</span></span><br><span class="line"><span class="string">[21, 37, 69, 81, 95, 11, 53, 12, 22, 16]</span></span><br><span class="line"><span class="string">[11, 21, 37, 69, 81, 95, 53, 12, 22, 16]</span></span><br><span class="line"><span class="string">[11, 21, 37, 53, 69, 81, 95, 12, 22, 16]</span></span><br><span class="line"><span class="string">[11, 12, 21, 37, 53, 69, 81, 95, 22, 16]</span></span><br><span class="line"><span class="string">[11, 12, 21, 22, 37, 53, 69, 81, 95, 16]</span></span><br><span class="line"><span class="string">[11, 12, 16, 21, 22, 37, 53, 69, 81, 95]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>这个算法的时间复杂度为O(n^2)，其中n是待排序数组的长度。空间复杂度为O(1)，因为只使用了常数级别的额外空间。</p><p>要改善选择排序的时间复杂度，可以考虑使用其他更高效的排序算法，例如快速排序（Quick Sort）或归并排序（Merge Sort）。这些算法的时间复杂度通常为O(nlogn)，比上面三个排序算法的O(n^2)更快。此外，还可以考虑使用内置的排序函数，如Python中的<code>sorted()</code>函数，它使用了优化的排序算法。如果待排序数组已经基本有序，可以通过引入一些优化措施来提高插入排序的性能，例如使用二分查找来确定插入位置，减少比较和交换的次数。</p></div><h2 id="4-归并排序"><a href="#4-归并排序" class="headerlink" title="4. 归并排序"></a>4. 归并排序</h2><div class="story post-story"><p>利用分治的思想，采用递归的形式，对元素进行排序。当有两个长度为n的有序数组时，可以通过两个指针的移动，在O(n)的时间复杂度内，快速合并成一个有序数组。而这两个长度为n的有序数组，也可以通过两个n&#x2F;2的有序数组合并而来。因此，只要不断对数组进行分治，就可以把一个无序数组变成有序。</p><p>对数组拆分的过程用到递归，对数组组合的过程用到了合并，故命名归并排序。</p><img src="https://www.shelven.com/tuchuang/20230704/MergeSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/MergeSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实现一个合并函数(a列表start到mid的元素，以及mid+1到end的元素，需要分别按照递增顺序排列)，执行后a列表start到end的元素也按照递增顺序排序</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Merge</span>(<span class="params">a, start, mid, end</span>):</span><br><span class="line">    tmp = []</span><br><span class="line">    l = start   <span class="comment"># l和r是两个区间的起点</span></span><br><span class="line">    r = mid + <span class="number">1</span></span><br><span class="line">    <span class="comment"># 当两个区间都未到达右端点，判断a[l]和a[r]，小的值放入临时列表，下标自增</span></span><br><span class="line">    <span class="keyword">while</span> l &lt;= mid <span class="keyword">and</span> r &lt;= end:    </span><br><span class="line">        <span class="keyword">if</span> a[l] &lt;= a[r]:</span><br><span class="line">            tmp.append(a[l])</span><br><span class="line">            l += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tmp.append(a[r])</span><br><span class="line">            r += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 跳出循环时，剩余部分全部放入临时列表（因为跳出循环表示一个列表已经排完了，另一个列表剩下的也是有序的）</span></span><br><span class="line">    tmp.extend(a[l : mid + <span class="number">1</span>])  </span><br><span class="line">    tmp.extend(a[r : end + <span class="number">1</span>])</span><br><span class="line">    <span class="comment"># 临时列表值拷贝回原列表a，完成一次合并</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end + <span class="number">1</span>):</span><br><span class="line">        a[i] = tmp[i - start]</span><br><span class="line">    <span class="built_in">print</span>(start, end, tmp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实现一个递归函数（作用是拆分子数组）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">MergeSort</span>(<span class="params">a, start, end</span>):</span><br><span class="line">    <span class="comment"># 待排序元素只有一个则返回</span></span><br><span class="line">    <span class="keyword">if</span> start == end:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment"># 计算中点mid，整数除法，向下取整</span></span><br><span class="line">    mid = (start + end) // <span class="number">2</span></span><br><span class="line">    MergeSort(a, start, mid)</span><br><span class="line">    MergeSort(a, mid + <span class="number">1</span>, end)</span><br><span class="line">    <span class="comment"># 两次调用MergeSort()产生两个有序数组，之后对两个有序数组进行Merge()合并</span></span><br><span class="line">    Merge(a, start, mid, end)</span><br><span class="line"></span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">MergeSort(a, <span class="number">0</span>, <span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[92, 87, 91, 24, 5, 36, 76, 62, 66, 89]</span></span><br><span class="line"><span class="string">0 1 [87, 92]</span></span><br><span class="line"><span class="string">0 2 [87, 91, 92]</span></span><br><span class="line"><span class="string">3 4 [5, 24]</span></span><br><span class="line"><span class="string">0 4 [5, 24, 87, 91, 92]</span></span><br><span class="line"><span class="string">5 6 [36, 76]</span></span><br><span class="line"><span class="string">5 7 [36, 62, 76]</span></span><br><span class="line"><span class="string">8 9 [66, 89]</span></span><br><span class="line"><span class="string">5 9 [36, 62, 66, 76, 89]</span></span><br><span class="line"><span class="string">0 9 [5, 24, 36, 62, 66, 76, 87, 89, 91, 92]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>其实也可以不用递归的方法，用迭代的方式来实现归并排序：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实现一个合并函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">arr, start, mid, end, temp</span>):</span><br><span class="line">    i = start</span><br><span class="line">    j = mid</span><br><span class="line">    k = start</span><br><span class="line">    <span class="keyword">while</span> i &lt; mid <span class="keyword">and</span> j &lt; end:</span><br><span class="line">        <span class="keyword">if</span> arr[i] &lt; arr[j]:</span><br><span class="line">            temp[k] = arr[i]</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            temp[k] = arr[j]</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; mid:</span><br><span class="line">        temp[k] = arr[i]</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> j &lt; end:</span><br><span class="line">        temp[k] = arr[j]</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 实现一个拆分子数组和合并的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_sort</span>(<span class="params">arr</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(arr) &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> arr</span><br><span class="line">    <span class="comment"># 创建一个临时数组用于存储排序结果</span></span><br><span class="line">    temp = [<span class="number">0</span>] * <span class="built_in">len</span>(arr)</span><br><span class="line">    <span class="comment"># 设置初始步长为1</span></span><br><span class="line">    step = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> step &lt; <span class="built_in">len</span>(arr):</span><br><span class="line">        <span class="comment"># 按照步长将数组分为多个子数组进行合并</span></span><br><span class="line">        <span class="keyword">for</span> start <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(arr), <span class="number">2</span> * step):</span><br><span class="line">            <span class="comment"># 计算子数组的起始索引、中间索引和结束索引</span></span><br><span class="line">            mid = <span class="built_in">min</span>(start + step, <span class="built_in">len</span>(arr))</span><br><span class="line">            end = <span class="built_in">min</span>(start + <span class="number">2</span> * step, <span class="built_in">len</span>(arr))</span><br><span class="line">            <span class="comment"># 合并两个子数组</span></span><br><span class="line">            merge(arr, start, mid, end, temp)</span><br><span class="line">        <span class="comment"># 将临时数组的结果复制回原始数组</span></span><br><span class="line">        arr[:] = temp[:]</span><br><span class="line">        <span class="comment"># 增加步长</span></span><br><span class="line">        step *= <span class="number">2</span></span><br><span class="line">        <span class="built_in">print</span>(arr)</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line"></span><br><span class="line">arr = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(arr)</span><br><span class="line">sorted_arr = merge_sort(arr)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[65, 50, 64, 33, 58, 7, 97, 87, 92, 52]（原序列）</span></span><br><span class="line"><span class="string">[50, 65, 33, 64, 7, 58, 87, 97, 52, 92]（步长2）</span></span><br><span class="line"><span class="string">[33, 50, 64, 65, 7, 58, 87, 97, 52, 92]（步长4）</span></span><br><span class="line"><span class="string">[7, 33, 50, 58, 64, 65, 87, 97, 52, 92]（步长8）</span></span><br><span class="line"><span class="string">[7, 33, 50, 52, 58, 64, 65, 87, 92, 97]（最终序列）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>在这个实现中，使用了一个临时数组<code>temp</code>来存储排序的结果。首先，设置初始步长为1，然后在每一轮迭代中，按照步长将原始数组分为多个子数组，并调用<code>merge</code>函数将这些子数组进行合并。合并后的结果存储在临时数组<code>temp</code>中。最后，将临时数组的结果复制回原始数组。迭代的思想在于通过不断迭代地合并子数组，直到得到完整的有序数组。</p><p><strong>归并排序的时间复杂度是O(nlogn)，其中n是待排序数组的大小。空间复杂度是O(n)，因为在每次合并操作中需要创建一个临时列表来存储合并后的结果。</strong></p><p>时间复杂度的算法可以参考<a href="https://blog.csdn.net/qq_42511528/article/details/108081681">如何计算归并排序算法的时间复杂度？</a></p><p>空间复杂度的算法可以参考<a href="https://blog.csdn.net/u010711495/article/details/117378617">归并排序的空间复杂度</a></p></div><h2 id="5-桶排序"><a href="#5-桶排序" class="headerlink" title="5. 桶排序"></a>5. 桶排序</h2><div class="story post-story"><p>生成一些桶，让数字散列在不同桶中，对桶中元素分别执行排序，再将元素依次取出。</p><p>比如建立4个桶，遍历所有数字并依次分散到4个桶中，保证第2个桶所有数字都大于第1个桶，第3个桶所有数字都大于第2个桶。每个桶中分别进行选择排序，4个桶的元素都有序之后，再将元素依次取出。</p><p><img src="https://www.shelven.com/tuchuang/20230704/BucketSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/BucketSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确定桶内排序方法（这里用选择排序）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SelectionSort</span>(<span class="params">a</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(a)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>): </span><br><span class="line">        <span class="built_in">min</span> = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, n):</span><br><span class="line">            <span class="keyword">if</span> a[j] &lt; a[<span class="built_in">min</span>]:</span><br><span class="line">                <span class="built_in">min</span> = j</span><br><span class="line">        a[i], a[<span class="built_in">min</span>] = a[<span class="built_in">min</span>], a[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">BucketSort</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="comment"># 确定列表元素最小值和最大值，定义桶数量</span></span><br><span class="line">    minV = <span class="built_in">min</span>(a)</span><br><span class="line">    maxV = <span class="built_in">max</span>(a)</span><br><span class="line">    bucketCount = <span class="number">3</span><span class="comment"># 桶的数量</span></span><br><span class="line">    bucket = [[], [], []]</span><br><span class="line">    <span class="comment"># 计算每个桶的范围</span></span><br><span class="line">    perBucket = (maxV - minV + bucketCount) // bucketCount</span><br><span class="line"><span class="comment"># 遍历列表每个元素，计算该元素放入的桶的索引，并且放入相应桶中</span></span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> a:</span><br><span class="line">        bucketIndex = (num - minV) // perBucket</span><br><span class="line">        bucket[bucketIndex].append(num)</span><br><span class="line">    <span class="comment"># 遍历每个桶，对每个桶的元素进行选择排序</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bucketCount):</span><br><span class="line">        SelectionSort(bucket[i])</span><br><span class="line">    </span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 遍历每个桶，遍历桶中元素，将元素放回原列表</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bucketCount):</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> bucket[i]:</span><br><span class="line">            a[idx] = v</span><br><span class="line">            idx += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(bucket)</span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">    </span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">BucketSort(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[84, 66, 53, 83, 22, 15, 95, 6, 32, 70]</span></span><br><span class="line"><span class="string">[[6, 15, 22, 32], [53], [66, 70, 83, 84, 95]]</span></span><br><span class="line"><span class="string">[6, 15, 22, 32, 53, 66, 70, 83, 84, 95]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>桶的数量可以根据待排序元素的分布情况和排序的要求来决定，一般将待排序的元素均匀分配到桶中，桶内的排序算法可以是任意一种排序算法，取决于应用场景和性能要求。这个算法挺有意思的，可以看到每个桶的元素数量不一定一样，桶排序一般不会直接用，往往会做变形。</p><p>这个桶排序算法的时间复杂度为O(n + k^2)，其中n是待排序元素的数量，k是桶的数量。具体来说，遍历列表并将元素放入桶中的时间复杂度为O(n)，对每个桶进行选择排序的时间复杂度为O(k^2)，遍历每个桶并将元素放回原列表的时间复杂度为O(n)。因此，总的时间复杂度为O(n + k^2)，也就是O(n)。</p><p>空间复杂度方面，除了原始列表外，额外使用了一个大小为k的桶列表来存储元素。因此，空间复杂度为O(n + k)，也就是O(n)。</p></div><h2 id="6-计数排序"><a href="#6-计数排序" class="headerlink" title="6. 计数排序"></a>6. 计数排序</h2><div class="story post-story"><p>利用哈希表的思想，对数据类型和范围有要求。</p><p>首先生成一个计数器数组，并且一开始所有值的计数都为0，然后遍历枚举原数组的所有元素，在元素值对应的计数器上执行计数操作。最后遍历枚举计数器数组，按照数组中元素个数放回到原数组中，这样所有元素都是升序排列了。</p><img src="https://www.shelven.com/tuchuang/20230704/CountingSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/CountingSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">CountingSort</span>(<span class="params">a</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(a)</span><br><span class="line">    <span class="comment"># 获取原数组中最大值，加1，作为计数器列表的实际长度</span></span><br><span class="line">    cntlen = <span class="built_in">max</span>(a) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># 生成一个值都为0的计数器列表</span></span><br><span class="line">    cnt = [<span class="number">0</span>] * cntlen</span><br><span class="line">    <span class="comment"># 遍历枚举原数组所有元素，在对应的计数器上加1</span></span><br><span class="line">    <span class="keyword">for</span> val <span class="keyword">in</span> a:</span><br><span class="line">        cnt[val] += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(cnt)</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 遍历枚举计数器列表，cnt[val]代表val这个数有多少个，大于0，则将它的计数器减一，并放到原来的列表中。如果还有则继续迭代至计数为0</span></span><br><span class="line">    <span class="keyword">for</span> val <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, cntlen):</span><br><span class="line">        <span class="keyword">while</span> cnt[val] &gt; <span class="number">0</span>:</span><br><span class="line">            cnt[val] -= <span class="number">1</span></span><br><span class="line">            a[n] = val</span><br><span class="line">            n += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">CountingSort(a)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果</span></span><br><span class="line"><span class="string">[8, 14, 18, 13, 16, 17, 7, 10, 8, 15]（原列表）</span></span><br><span class="line"><span class="string">[0, 0, 0, 0, 0, 0, 0, 1, 2, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1]（计数器列表）</span></span><br><span class="line"><span class="string">[7, 8, 8, 10, 13, 14, 15, 16, 17, 18]（计数排序后的列表）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>很明显，这种排序方式对数据有较大的限制，适用于<strong>数据范围较小的非负整数，且数据分布较均匀</strong>的情况（并不是说负数就完全不能用）。这很好理解，数据范围太广，会导致计数数组很大，占用大量内存空间，如果数据分布不均匀，计数的效率也会降低。</p><p>本质上来说这种计数排序算法是一种简单的桶排序算法，一个计数器就是一个桶。计数排序算法**时间复杂度是O(n)，空间复杂度是O(n)**。</p></div><h2 id="7-基数排序"><a href="#7-基数排序" class="headerlink" title="7. 基数排序"></a>7. 基数排序</h2><div class="story post-story"><p>和上面的计数排序很像，本质上也是桶排序，只不过用<strong>数位</strong>来划分桶。</p><p>首先建立0-9的10个桶，对待排序的每个元素，按照<strong>个位数的值</strong>放入对应的桶中，按顺序遍历桶中元素，取出来放回原数组。对于待排序的每个数字，按照<strong>十位数的值</strong>放入对应桶中，按顺序遍历桶中元素，取出来放回原数组。以此类推，按照百位数、千位数的值放入桶中，遍历，取出，直到排序完成。</p><img src="https://www.shelven.com/tuchuang/20230704/RadixSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/RadixSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">RadixSort</span>(<span class="params">a</span>):</span><br><span class="line">    base = <span class="number">1</span><span class="comment"># base为取的数位</span></span><br><span class="line">    maxv = <span class="built_in">max</span>(a)</span><br><span class="line">    <span class="comment"># 从低到高遍历每个数位</span></span><br><span class="line">    <span class="keyword">while</span> base &lt; maxv:</span><br><span class="line">        bucket = []</span><br><span class="line">        <span class="comment"># 每次遍历定义10个桶</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            bucket.append([])</span><br><span class="line">        <span class="comment"># 每个原列表元素根据当前数位放入对应的桶中</span></span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> a:</span><br><span class="line">            idx = num // base % <span class="number">10</span><span class="comment"># //向下取整，%除法取余</span></span><br><span class="line">            bucket[idx].append(num)</span><br><span class="line">        l = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 遍历每个桶，按顺序放回原列表</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> bucket[idx]:</span><br><span class="line">                a[l] = v</span><br><span class="line">                l += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">        base *= <span class="number">10</span></span><br><span class="line"></span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">RadixSort(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[119, 13, 832, 247, 117, 126, 996, 904, 112, 396]（原序列）</span></span><br><span class="line"><span class="string">[832, 112, 13, 904, 126, 996, 396, 247, 117, 119]（按照个位数放入桶中，遍历取出）</span></span><br><span class="line"><span class="string">[904, 112, 13, 117, 119, 126, 832, 247, 996, 396]（按照十位数放入桶中，遍历取出）</span></span><br><span class="line"><span class="string">[13, 112, 117, 119, 126, 247, 396, 832, 904, 996]（按照百位数放入桶中，遍历取出）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>上面的代码只适用于正整数，我们通过循环遍历每个数位，所以外层循环的次数是位数d。内层循环中，我们遍历了待排序数组并将每个元素放入对应的桶中，所以内层循环的时间复杂度是O(n)。最后，我们遍历每个桶，按顺序将元素放回原列表，这也需要O(n)的时间复杂度。</p><p>总的来说，基数排序的时间复杂度为O(d * (n + k))，其中d表示位数，n表示待排序数组的长度，k表示桶的数量。空间复杂度为O(dk+n)。</p><p>如果有负整数，可以把原数组元素分为正整数和负整数，分别进行基数排序后合并：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">RadixSort</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="comment"># 分离正数和负数</span></span><br><span class="line">    positive_nums = [num <span class="keyword">for</span> num <span class="keyword">in</span> a <span class="keyword">if</span> num &gt;= <span class="number">0</span>]</span><br><span class="line">    negative_nums = [-num <span class="keyword">for</span> num <span class="keyword">in</span> a <span class="keyword">if</span> num &lt; <span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 对正数部分进行基数排序</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(positive_nums) &gt; <span class="number">0</span>:</span><br><span class="line">        base = <span class="number">1</span></span><br><span class="line">        maxv = <span class="built_in">max</span>(positive_nums)</span><br><span class="line">        <span class="keyword">while</span> base &lt; maxv:</span><br><span class="line">            bucket = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">            <span class="keyword">for</span> num <span class="keyword">in</span> positive_nums:</span><br><span class="line">                idx = num // base % <span class="number">10</span></span><br><span class="line">                bucket[idx].append(num)</span><br><span class="line">            positive_nums = [v <span class="keyword">for</span> bucket_list <span class="keyword">in</span> bucket <span class="keyword">for</span> v <span class="keyword">in</span> bucket_list]</span><br><span class="line">            <span class="built_in">print</span>(positive_nums)</span><br><span class="line">            base *= <span class="number">10</span></span><br><span class="line">    <span class="comment"># 对负数部分进行基数排序</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(negative_nums) &gt; <span class="number">0</span>:</span><br><span class="line">        base = <span class="number">1</span></span><br><span class="line">        maxv = <span class="built_in">max</span>(negative_nums)</span><br><span class="line">        <span class="keyword">while</span> base &lt; maxv:</span><br><span class="line">            bucket = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">            <span class="keyword">for</span> num <span class="keyword">in</span> negative_nums:</span><br><span class="line">                idx = num // base % <span class="number">10</span></span><br><span class="line">                bucket[idx].append(num)</span><br><span class="line">            negative_nums = [v <span class="keyword">for</span> bucket_list <span class="keyword">in</span> bucket <span class="keyword">for</span> v <span class="keyword">in</span> bucket_list]</span><br><span class="line">            <span class="built_in">print</span>(negative_nums)</span><br><span class="line">            base *= <span class="number">10</span></span><br><span class="line">    <span class="comment"># 将负数部分反转</span></span><br><span class="line">    negative_nums = [-num <span class="keyword">for</span> num <span class="keyword">in</span> negative_nums[::-<span class="number">1</span>]]</span><br><span class="line">    <span class="built_in">print</span>(negative_nums)</span><br><span class="line">    <span class="comment"># 合并正数和负数部分</span></span><br><span class="line">    sorted_a = negative_nums + positive_nums</span><br><span class="line">    <span class="keyword">return</span> sorted_a</span><br><span class="line"></span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, -<span class="number">1000</span>, <span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">a = RadixSort(a)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[-918, -574, 385, -322, -164, 880, -158, -400, 607, -746](原序列)</span></span><br><span class="line"><span class="string">[880, 385, 607]</span></span><br><span class="line"><span class="string">[607, 880, 385]</span></span><br><span class="line"><span class="string">[385, 607, 880]（基数排序后的正数序列）</span></span><br><span class="line"><span class="string">[400, 322, 574, 164, 746, 918, 158]</span></span><br><span class="line"><span class="string">[400, 918, 322, 746, 158, 164, 574]</span></span><br><span class="line"><span class="string">[158, 164, 322, 400, 574, 746, 918]（基数排序后取反的负数序列）</span></span><br><span class="line"><span class="string">[-918, -746, -574, -400, -322, -164, -158]（反转的成原来的负数序列）</span></span><br><span class="line"><span class="string">[-918, -746, -574, -400, -322, -164, -158, 385, 607, 880]（整合排序后的结果）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></div><h2 id="8-快速排序"><a href="#8-快速排序" class="headerlink" title="8. 快速排序"></a>8. 快速排序</h2><div class="story post-story"><p>找到一个基准点，把小于它的和大于它的数分开，分别递归执行快速排序。也是用了分治的思想，属于冒泡排序的改进算法。</p><img src="https://www.shelven.com/tuchuang/20230704/QuickSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/QuickSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从a列表start到end之间寻找基准数下标，并且将所有小于等于它的数放在它左边，大于它的数放在右边</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">QuickSortPivot</span>(<span class="params">a, start, end</span>):</span><br><span class="line">    pivot = start   <span class="comment"># 最左边数为基准数</span></span><br><span class="line">    j = start + <span class="number">1</span>   <span class="comment"># j代表大于基准数的数的下标左边界</span></span><br><span class="line">    <span class="comment"># 遍历列表所有数，如果当前数小于等于基准数，则a[i]和a[j]交换，j自增；大于则不处理（保证j下标以前的数小于等于基准数）</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start + <span class="number">1</span>, end + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> a[i] &lt;= a[pivot]:</span><br><span class="line">            a[i], a[j] = a[j], a[i]</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 遍历之后，基准数与小于基准数的最后一个数交换（这样就可以让基准数左边和右边分开，且基准数位置就是正确的了）</span></span><br><span class="line">    a[pivot], a[j - <span class="number">1</span>] = a[j - <span class="number">1</span>], a[pivot]</span><br><span class="line">    <span class="comment"># 更新基准数下标</span></span><br><span class="line">    pivot = j - <span class="number">1</span> </span><br><span class="line">    <span class="built_in">print</span>(a[pivot], a[start : pivot], a[pivot + <span class="number">1</span> : end + <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> pivot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 快速排序函数，用来对区间[start, end]的数递归执行快速排序</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">QuickSort</span>(<span class="params">a, start, end</span>):</span><br><span class="line">    <span class="keyword">if</span> start &gt;= end:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment"># 获得基准数下标，分别递归计算左边和右边部分</span></span><br><span class="line">    pivot = QuickSortPivot(a, start, end)</span><br><span class="line">    QuickSort(a, start, pivot - <span class="number">1</span>)</span><br><span class="line">    QuickSort(a, pivot + <span class="number">1</span>, end)</span><br><span class="line"></span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">QuickSort(a, <span class="number">0</span>, <span class="number">9</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[55, 100, 41, 99, 52, 90, 50, 71, 92, 44]# 原序列</span></span><br><span class="line"><span class="string">55 [44, 41, 52, 50] [90, 99, 71, 92, 100]# 基准数，基准数左边序列，基准数右边序列</span></span><br><span class="line"><span class="string">44 [41] [52, 50]</span></span><br><span class="line"><span class="string">52 [50] []</span></span><br><span class="line"><span class="string">90 [71] [99, 92, 100]</span></span><br><span class="line"><span class="string">99 [92] [100]</span></span><br><span class="line"><span class="string">[41, 44, 50, 52, 55, 71, 90, 92, 99, 100]# 快速排序后的序列</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>这种排序算法也有一个缺点，如果很不巧每次选取的基准点都是序列的最大值或者最小值，那么时间复杂度将会是最大值O(n^2)。</p><p><strong>时间复杂度：</strong></p><ul><li>在每一次划分操作中，需要遍历待排序数组的所有元素，这需要O(n)的时间。</li><li>在每一次划分操作中，将数组划分为两个子数组，每个子数组的长度大约是原数组的一半（最好的情况）。因此，划分操作的时间复杂度为O(n)。</li><li>快速排序的递归深度为logn，因为每次划分操作都将数组的规模减半。</li><li>因此，最好的情况下时间复杂度为O(nlogn)，最坏情况下时间复杂度为O(n^2)。</li></ul><p><strong>空间复杂度：</strong></p><ul><li>快速排序使用递归调用来对子数组进行排序，每次递归调用都需要保存当前的函数调用信息（包括参数、局部变量等）。</li><li>快速排序的递归深度通常为logn，因此需要的栈空间也是logn。</li><li>因此，总的空间复杂度为O(logn)。最坏的情况下是O(n)，随机化基准值pivot可以防止最坏情况发生。</li></ul><p>可以用随机快速排序，每次找基准点采用了一次随机，规避快速排序最坏的情况发生。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">QuickSortPivot</span>(<span class="params">a, start, end</span>):</span><br><span class="line">    <span class="comment"># 引入区间中随机一个元素的索引值，和最左边的数交换（本来是最左边的数作为下一轮的基准数）</span></span><br><span class="line">    randIdx = random.randint(start, end)</span><br><span class="line">    a[start], a[randIdx] = a[randIdx], a[start]</span><br><span class="line">    </span><br><span class="line">    pivot = start  </span><br><span class="line">    j = start + <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start + <span class="number">1</span>, end + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> a[i] &lt;= a[pivot]:</span><br><span class="line">            a[i], a[j] = a[j], a[i]</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">    a[pivot], a[j - <span class="number">1</span>] = a[j - <span class="number">1</span>], a[pivot]</span><br><span class="line">    pivot = j - <span class="number">1</span> </span><br><span class="line">    <span class="built_in">print</span>(a[pivot], a[start : pivot], a[pivot + <span class="number">1</span> : end + <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> pivot</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">QuickSort</span>(<span class="params">a, start, end</span>):</span><br><span class="line">    <span class="keyword">if</span> start &gt;= end:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    pivot = QuickSortPivot(a, start, end)</span><br><span class="line">    QuickSort(a, start, pivot - <span class="number">1</span>)</span><br><span class="line">    QuickSort(a, pivot + <span class="number">1</span>, end)</span><br><span class="line">    </span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">QuickSort(a, <span class="number">0</span>, <span class="number">9</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[24, 2, 44, 75, 32, 32, 68, 36, 9, 79]</span></span><br><span class="line"><span class="string">68 [9, 2, 44, 32, 32, 24, 36] [75, 79]</span></span><br><span class="line"><span class="string">36 [9, 2, 32, 32, 24] [44]</span></span><br><span class="line"><span class="string">9 [2] [32, 32, 24]</span></span><br><span class="line"><span class="string">24 [] [32, 32]</span></span><br><span class="line"><span class="string">32 [32] []</span></span><br><span class="line"><span class="string">79 [75] []</span></span><br><span class="line"><span class="string">[2, 9, 24, 32, 32, 36, 44, 68, 75, 79]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></div><h2 id="9-希尔排序"><a href="#9-希尔排序" class="headerlink" title="9. 希尔排序"></a>9. 希尔排序</h2><div class="story post-story"><p>本质是一种改进后的插入排序，又称“缩小增量排序”，增量在这里是指<strong>按照一定规则选择的间隔值</strong>（这里也是分组数），通常设置为数组长度的一半，每次缩小增量直到增量为1，组内排序方法为插入排序。每轮希尔排序的分组数越来越小，也就是说组内元素越来越多，最后一组就是整个数组。</p><img src="https://www.shelven.com/tuchuang/20230704/ShellSort1.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/ShellSort1.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ShellSort</span>(<span class="params">a</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(a)</span><br><span class="line">    <span class="comment"># gap为增量，每隔gap值执行插入排序</span></span><br><span class="line">    gap = n // <span class="number">2</span>    </span><br><span class="line">    <span class="keyword">while</span> gap &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(gap, n):</span><br><span class="line">            x = a[i]</span><br><span class="line">            j =i</span><br><span class="line">            <span class="keyword">while</span> j &gt;= gap:</span><br><span class="line">                <span class="keyword">if</span> x &lt; a[j - gap]:</span><br><span class="line">                    a[j] = a[j - gap]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                j -= gap</span><br><span class="line">            a[j] = x</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">        <span class="comment"># 增量除2向下取整，继续迭代</span></span><br><span class="line">        gap = gap // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">ShellSort(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[20, 17, 75, 69, 34, 85, 38, 23, 57, 28]# 原序列</span></span><br><span class="line"><span class="string">[20, 17, 23, 57, 28, 85, 38, 75, 69, 34]# 第一次希尔排序，实际分了5组[20,85][17,38][75,23][69,57][34,28]并组内进行了插入排序</span></span><br><span class="line"><span class="string">[20, 17, 23, 34, 28, 57, 38, 75, 69, 85]# 第二次希尔排序，实际分了2组[20,23,28,38,69][17,57,85,75,34]并组内进行了插入排序</span></span><br><span class="line"><span class="string">[17, 20, 23, 28, 34, 38, 57, 69, 75, 85]# 第三次希尔排序，实际就是1组，所有组内元素插入排序</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>希尔排序的时间复杂度是根据增量序列的选择而变化的。在最坏情况下（原序列为逆序），时间复杂度是O(n^2)；最好的情况下（原序列本身有序），时间复杂度是O(n)。平均情况下，希尔排序的时间复杂度可以达到O(nlogn)。</p><p>希尔排序的空间复杂度是O(1)，即不需要额外的空间来存储数据。希尔排序是一种原地排序算法，它通过交换元素的位置来实现排序，不需要额外的辅助数组或链表。因此，希尔排序的空间复杂度是常数级别的。</p></div><h2 id="10-堆排序"><a href="#10-堆排序" class="headerlink" title="10. 堆排序"></a>10. 堆排序</h2><div class="story post-story"><p>堆是一颗完全二叉树，假设一个节点编号为<code>idx</code>，则左子树树根编号为<code>idx*2</code>，右子树树根编号为<code>idx*2+1</code>，把每个结点的编号和顺序表下标对应，就可以把这颗二叉树用顺序表形式存储起来。</p><p>对于一个给定的顺序表，首先构造成<strong>大顶堆</strong>（所有根结点大于左右子结点），方法是从顺序表的最后一个元素开始，自底向上构造堆。对于某个元素，取左右子树中的大者和该元素比较，如果比该元素大，则与之交换（该元素所在位置下沉）。由于每个堆左右子树都是满足堆的性质的，当枚举完根结点后大顶堆就构造完毕了。</p><p>这个时候堆顶的元素是最大的，把堆顶元素和顺序表最后一个元素进行交换（弹出），最大值就在最后一位了。继续利用堆的下沉操作，除了最后一位以外继续构造大顶堆，把次大元素交换到倒数第二位，依此类推，最终整个顺序表就是升序排列的有序顺序表了。</p><p><img src="https://www.shelven.com/tuchuang/20230704/HeapSort.gif" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/HeapSort.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实现大顶堆下沉操作，heap整个顺序表start到end之间组成合法的堆，start为根结点坐标</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">maxHeapify</span>(<span class="params">heap, start, end</span>):</span><br><span class="line">    son = start * <span class="number">2</span>     <span class="comment"># 左子树根</span></span><br><span class="line">    <span class="comment"># 左子树存在，则取左子树和右子树根中的大者的下标，存储到son中</span></span><br><span class="line">    <span class="keyword">while</span> son &lt;= end:</span><br><span class="line">        <span class="keyword">if</span> son + <span class="number">1</span> &lt;= end <span class="keyword">and</span> heap[son + <span class="number">1</span>] &gt; heap[son]:</span><br><span class="line">            son += <span class="number">1</span></span><br><span class="line">        <span class="comment"># 如果结点点的值大于根结点的值，则将根结点和子结点交换（下沉），子结点迭代执行</span></span><br><span class="line">        <span class="keyword">if</span> heap[son] &gt; heap[start]:</span><br><span class="line">            heap[start], heap[son] = heap[son], heap[start]</span><br><span class="line">            start, son = son, son * <span class="number">2</span></span><br><span class="line">        <span class="comment"># 如果子结点的值小于等于根结点的值，说明堆构造没问题，跳出循环</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实现堆排序操作</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HeapSort</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="comment"># 堆下标从1开始，列表下标从0开始，所以在0的位置加上占位符None</span></span><br><span class="line">    heap = [<span class="literal">None</span>] + a</span><br><span class="line">    <span class="comment"># 定义堆顶元素下标root为1</span></span><br><span class="line">    root = <span class="number">1</span></span><br><span class="line">    l = <span class="built_in">len</span>(heap)</span><br><span class="line">    <span class="comment"># 从顺序表l//2个元素开始(因为堆的最后一层是没有子结点的)逆序枚举，自底向上构造堆</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l // <span class="number">2</span>, root - <span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        maxHeapify(heap, i, l - <span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 堆顶和最后一个元素交换，除最后一个元素外，重构堆</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l - <span class="number">1</span>, root, -<span class="number">1</span>):</span><br><span class="line">        heap[i], heap[root] = heap[root], heap[i]</span><br><span class="line">        maxHeapify(heap, root, i - <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(heap[root:])</span><br><span class="line"></span><br><span class="line">a = generate_random_sequence(<span class="number">10</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">HeapSort(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出结果：</span></span><br><span class="line"><span class="string">[3, 52, 44, 78, 60, 100, 54, 61, 38, 1]# 原数列</span></span><br><span class="line"><span class="string">[78, 61, 54, 52, 60, 44, 3, 1, 38, 100]# 最大数为100，1-9位重新构造大顶堆</span></span><br><span class="line"><span class="string">[61, 60, 54, 52, 38, 44, 3, 1, 78, 100]# 次大数为78，1-8位重新构造大顶堆</span></span><br><span class="line"><span class="string">[60, 52, 54, 1, 38, 44, 3, 61, 78, 100]# 第三大数为61，1-7重新构造大顶堆</span></span><br><span class="line"><span class="string">[54, 52, 44, 1, 38, 3, 60, 61, 78, 100].</span></span><br><span class="line"><span class="string">[52, 38, 44, 1, 3, 54, 60, 61, 78, 100].</span></span><br><span class="line"><span class="string">[44, 38, 3, 1, 52, 54, 60, 61, 78, 100].</span></span><br><span class="line"><span class="string">[38, 1, 3, 44, 52, 54, 60, 61, 78, 100].</span></span><br><span class="line"><span class="string">[3, 1, 38, 44, 52, 54, 60, 61, 78, 100].</span></span><br><span class="line"><span class="string">[1, 3, 38, 44, 52, 54, 60, 61, 78, 100]# 最后一次构造大顶堆，只有一个最小元素1，此时数列已经升序排好</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>堆排序的时间复杂度为O(nlogn)，n是待排序元素的数量，空间复杂度为O(1)，因为它是原地排序算法，不需要额外的空间来存储元素。</p><p>最后是一张来自菜鸟教程的排序算法总结图：</p><p><img src="https://www.shelven.com/tuchuang/20230704/1.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230704/1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近中期答辩结束，稍微有点空闲的时间捋一捋数据结构和算法方面的知识。虽然现在用python实现排序就一个sort()函数的事，但是还是想锻炼下自己的思维，从底层代码学习一下10种经典排序的实现方式。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="编程自学" scheme="http://www.shelven.com/categories/%E7%BC%96%E7%A8%8B%E8%87%AA%E5%AD%A6/"/>
    
    
    <category term="python" scheme="http://www.shelven.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>群体基因组学——GWAS分析</title>
    <link href="http://www.shelven.com/2023/06/20/a.html"/>
    <id>http://www.shelven.com/2023/06/20/a.html</id>
    <published>2023-06-20T10:40:24.000Z</published>
    <updated>2023-06-24T07:28:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>本篇笔记主要记录如何在linux命令行中用<code>TASSEL5</code>和<code>PLINK2</code>软件做GWAS分析，以及如何可视化GWAS结果（在R中绘制曼哈顿图和QQ图）。关于GWAS是做什么的，以及基本概念介绍可以看上一篇笔记介绍：<a href="https://www.shelven.com/2023/06/16/a.html">群体基因组学——概述和图表详解 - 我的小破站 (shelven.com)</a></p><span id="more"></span><p>PLINK和TASSEL都是做GWAS分析用的经典软件，两个软件都有linux版本和windows版本，我这里是在linux集群环境中跑的分析流程，所有软件下载linux版本，两款软件可以在下方官网中安装：</p><p><a href="https://www.cog-genomics.org/plink/2.0/">PLINK 2.0 (cog-genomics.org)</a>、<a href="https://tassel.bitbucket.io/">Tassel</a></p><p>TASSEL官网有tassel pipeline命令行的帮助文档，一些常用的参数可以参考<a href="https://bytebucket.org/tasseladmin/tassel-5-source/wiki/docs/Tassel5PipelineCLI.pdf">Tassel5PipelineCLI.pdf (bytebucket.org)</a></p><p>TASSEL中文文档可以参考本站<a href="https://www.shelven.com/tuchuang/20230619/Tassel5.pdf">Tassel5中文操作手册.pdf</a></p><h2 id="1-数据格式"><a href="#1-数据格式" class="headerlink" title="1. 数据格式"></a>1. 数据格式</h2><div class="story post-story"><p>plink的数据格式有两套，每套各自的前缀名称相同，一套后缀为<code>.bed</code>、<code>.bin</code>和<code>.fam</code>，另一套后缀为<code>.map</code>和<code>.ped</code>，后面的分析以第一套为例，读取速度比较快。</p><p>那么这三个是怎么来的呢？我们做群体重测序后，通过GATK等软件做变异检测最终会生成一个VCF文件，通过软件<code>plink</code>可以将VCF文件转化成上面的三个文件，分别展示一下三个文件的内容和结构：</p><p><img src="https://www.shelven.com/tuchuang/20230619/1.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><blockquote><ul><li>fam文件（家族信息文件）有6列，分别为家系编号、个体编号、父系编号（0表示信息缺失）、母系编号（0表示信息缺失）、性别编号（1表示男，2表示女，0表示未知性别）、表型值（1表示对照，2表示病例，0&#x2F;-9或者其他非数字表示信息缺失）</li><li>bim文件（个体信息文件）有6列，分别为染色体编号、SNP标识、以摩根或厘摩为单位的位置（可以用0）、碱基对坐标、Allele1和Allele2（通常是主效等位基因）</li><li>bed文件为二进制文件</li></ul></blockquote><p>转化成这三个文件主要是为了下一步更快过滤数据，因为bed是二进制文件，计算机处理起来更快。</p><p>以上数据来源是贺师兄做的棉花重测序样本的部分变异信息文件。</p></div><h2 id="2-基因型数据清洗（使用PLINK）"><a href="#2-基因型数据清洗（使用PLINK）" class="headerlink" title="2. 基因型数据清洗（使用PLINK）"></a>2. 基因型数据清洗（使用PLINK）</h2><div class="story post-story"><p>使用plink软件过滤掉最小等位基因频率（Minor Allele Frequency，MAF）小于0.05的变异位点，在关联分析中MAF值太小会造成假阳性。比如说，一个基因座上有两个等位基因A和B，A在群体中的频率为0.6，B在群体中的频率为0.4，那么MAF值就是0.4，可以想到一个基因座上MAF值越小，基因座上的等位基因越单一，MAF太低的位点贡献的信息很少，不与表型做关联分析。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 过滤MAF小于0.05的SNP，重新生成.bed、.bin和.fam文件</span><br><span class="line">## --make-bed 创建PLINK1二进制文件集</span><br><span class="line">plink --bfile Course_GWAS --maf 0.05 --make-bed --out Course_GWAS_maf0.05</span><br><span class="line"></span><br><span class="line"># 重新将三个过滤后的文件转化成vcf文件</span><br><span class="line">## --recode 创建新文件集，可选格式&#x27;vcf&#x27;，&#x27;vcf-fid&#x27;，和&#x27;vcf-iid&#x27;</span><br><span class="line">plink --bfile Course_GWAS_maf0.05 --recode vcf-iid --out GWAS_vcf</span><br></pre></td></tr></table></figure><p>可以通过查看过滤前后的bim文件，统计过滤了多少位点（plink软件在屏幕上的标准输出也会显示）：</p><p><img src="https://www.shelven.com/tuchuang/20230619/2.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># plink输出结果</span><br><span class="line">PLINK v2.00a5LM 64-bit Intel (7 Jun 2023)      www.cog-genomics.org/plink/2.0/</span><br><span class="line">(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3</span><br><span class="line">Logging to Course_GWAS_maf0.05.log.</span><br><span class="line">Options in effect:</span><br><span class="line">  --bfile Course_GWAS</span><br><span class="line">  --maf 0.05</span><br><span class="line">  --make-bed</span><br><span class="line">  --out Course_GWAS_maf0.05</span><br><span class="line"></span><br><span class="line">Start time: Tue Jun 20 14:38:58 2023</span><br><span class="line">1837 MiB RAM detected, ~914 available; reserving 850 MiB for main workspace.</span><br><span class="line">Using up to 2 compute threads.</span><br><span class="line">216 samples (0 females, 0 males, 216 ambiguous; 216 founders) loaded from</span><br><span class="line">Course_GWAS.fam.</span><br><span class="line">10000 variants loaded from Course_GWAS.bim.</span><br><span class="line">Note: No phenotype data present.</span><br><span class="line">Calculating allele frequencies... done.</span><br><span class="line">3030 variants removed due to allele frequency threshold(s)</span><br><span class="line">(--maf/--max-maf/--mac/--max-mac).</span><br><span class="line">6970 variants remaining after main filters.</span><br><span class="line">Writing Course_GWAS_maf0.05.fam ... done.</span><br><span class="line">Writing Course_GWAS_maf0.05.bim ... done.</span><br><span class="line">Writing Course_GWAS_maf0.05.bed ... done.</span><br></pre></td></tr></table></figure><p>需要注意下我这里使用的表型数据都是处理好的，所以只对基因型数据做过滤就行，如果自己有表型数据还要做一下表型数据清洗，比如删除异常值等等。</p><p>生成的<code>GWAS_vcf.vcf</code>用于下一步关联分析。</p></div><h2 id="3-关联分析（使用TASSEL5）"><a href="#3-关联分析（使用TASSEL5）" class="headerlink" title="3. 关联分析（使用TASSEL5）"></a>3. 关联分析（使用TASSEL5）</h2><div class="story post-story"><p>PLINK软件也可以做关联分析，网上也能找到一把教程，但是PLINK只能做GLM模型的关联分析，现在文献中用的比较多的软件是TASSEL5，接下来演示用命令行的Tassel Pipeline做关联分析。</p><h3 id="3-1-计算亲缘关系矩阵"><a href="#3-1-计算亲缘关系矩阵" class="headerlink" title="3.1 计算亲缘关系矩阵"></a>3.1 计算亲缘关系矩阵</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># -Xmx10G 控制最大堆（heap size）的大小为10G</span><br><span class="line"># -importGuess 使用Tassel的importGuess函数载入文件</span><br><span class="line"># -KinshipPlugin 调用亲缘关系矩阵插件，与 -endPlugin 联用</span><br><span class="line"># -method 这里指定计算IBS亲缘关系矩阵</span><br><span class="line"># -export 指定输出文件，输出文件类型与input数据有关，比如基因型表默认Hapmap格式，距离矩阵默认SqrMatrix</span><br><span class="line"># -exportType 指定输出文件类型，有Hapmap, HDF5, VCF, Plink, SqrMatrix等等</span><br><span class="line"></span><br><span class="line">perl /opt/TASSEL5/run_pipeline.pl -Xmx10G -importGuess GWAS_vcf.vcf -KinshipPlugin -method Centered_IBS -endPlugin -export kinship.txt -exportType SqrMatrix</span><br></pre></td></tr></table></figure><p>生成的216个样本的亲缘关系矩阵kinship.txt如下：</p><p><img src="https://www.shelven.com/tuchuang/20230619/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="3-2-主成分分析"><a href="#3-2-主成分分析" class="headerlink" title="3.2 主成分分析"></a>3.2 主成分分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># -fork&lt;id&gt; 用于区分不同的pipeline，代表一个pipeline的起始，后面可以是数字或者字符（非空格）</span><br><span class="line"># -PrincipalComponentsPlugin 调用主成分分析插件，同样和 -endPlugin 联用</span><br><span class="line"># -covariance true 计算协方差矩阵（用来识别主成分），两种方法，相关系数(correlation)或者协方差(covariance)</span><br><span class="line"># -runfork&lt;id&gt; 这个参数已经可以不需要了，pipeline会自动执行需要的fork</span><br><span class="line"></span><br><span class="line">perl /opt/TASSEL5/run_pipeline.pl -fork1 -importGuess GWAS_vcf.vcf -PrincipalComponentsPlugin -covariance true -endPlugin -export pca -runfork1</span><br></pre></td></tr></table></figure><p>默认情况下会生成的PCA结果主要展示前5个主成分，且这一步会生成三个txt文件，PCA结果展示在第一个文件<code>pca1.txt</code>：</p><p><img src="https://www.shelven.com/tuchuang/20230619/4.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="3-3-可视化亲缘关系矩阵和PCA结果（群体结构分析）"><a href="#3-3-可视化亲缘关系矩阵和PCA结果（群体结构分析）" class="headerlink" title="3.3 可视化亲缘关系矩阵和PCA结果（群体结构分析）"></a>3.3 可视化亲缘关系矩阵和PCA结果（群体结构分析）</h3><p>在拿到这两个矩阵之后就可以通过R可视化结果，首先是亲缘关系矩阵热图：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>data.table<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">kinship <span class="operator">=</span> fread<span class="punctuation">(</span><span class="string">&quot;kinship.txt&quot;</span><span class="punctuation">,</span>skip <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span>     <span class="comment"># 前3行不用读入</span></span><br><span class="line">setDF<span class="punctuation">(</span>kinship<span class="punctuation">)</span>      <span class="comment"># 将data.table格式转化成data.frame格式</span></span><br><span class="line">row.names<span class="punctuation">(</span>kinship<span class="punctuation">)</span> <span class="operator">=</span> kinship<span class="operator">$</span>V1</span><br><span class="line">kinship<span class="operator">$</span>V1 <span class="operator">=</span> <span class="literal">NULL</span>       </span><br><span class="line">colnames<span class="punctuation">(</span>kinship<span class="punctuation">)</span> <span class="operator">=</span> row.names<span class="punctuation">(</span>kinship<span class="punctuation">)</span>      <span class="comment"># 第一列做行名，删除第一列，行名设置为列名  </span></span><br><span class="line">kinship <span class="operator">=</span> as.matrix<span class="punctuation">(</span>kinship<span class="punctuation">)</span>        <span class="comment"># 转成矩阵格式</span></span><br><span class="line">pdf<span class="punctuation">(</span><span class="string">&quot;kinship.pdf&quot;</span><span class="punctuation">)</span></span><br><span class="line">heatmap<span class="punctuation">(</span>kinship<span class="punctuation">,</span>labRow<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span>labCol<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span>      <span class="comment"># 绘制热图，不在行和列上显示标签</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230619/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>用颜色深浅不同表示每个样本之间的亲缘关系远近，颜色越深亲缘关系越近。</p><p>PCA结果作图：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>data.table<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pca_re <span class="operator">=</span> fread<span class="punctuation">(</span><span class="string">&quot;pca1.txt&quot;</span><span class="punctuation">,</span>skip <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">plot <span class="operator">=</span> ggplot<span class="punctuation">(</span>pca_re<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>PC1<span class="punctuation">,</span> y<span class="operator">=</span>PC2<span class="punctuation">)</span><span class="punctuation">)</span>  <span class="operator">+</span> geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_hline<span class="punctuation">(</span>yintercept <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span>  <span class="operator">+</span> <span class="comment"># 添加x坐标</span></span><br><span class="line">  geom_vline<span class="punctuation">(</span>xintercept <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment"># 添加y坐标</span></span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">ggsave<span class="punctuation">(</span>plot <span class="operator">=</span>plot<span class="punctuation">,</span> filename<span class="operator">=</span><span class="string">&quot;2D-PCA.pdf&quot;</span><span class="punctuation">)</span>   <span class="comment"># 以第一主成分为X轴，第二主成分为y轴作图即可</span></span><br></pre></td></tr></table></figure><p><img src="https://www.shelven.com/tuchuang/20230619/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这里的群体结构差异有但不能很好分类。如果做群体结构分析的时候可以分成明显的几个不同的部分，那就要考虑后续做GWAS分析过程中要考虑群体结构的分层问题了。这里我们只是拿部分数据跑个简单的流程，继续往下。</p><h3 id="3-4-基于GLM模型进行GWAS分析"><a href="#3-4-基于GLM模型进行GWAS分析" class="headerlink" title="3.4 基于GLM模型进行GWAS分析"></a>3.4 基于GLM模型进行GWAS分析</h3><p>现在分别有了如下的基因型数据（GWAS_vcf.vcf）、表型数据（phenotype.tassel.txt），就可以以PCA结果作为协变量，基于GLM模型进行GWAS分析：</p><p><img src="https://www.shelven.com/tuchuang/20230619/7.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># -excludeLastTrait 移除表型数据的最后一列（不太明白什么意思？官网说可用于删除的最后一列用于MLM或GLM的群体结构）</span><br><span class="line"># -combine&lt;id&gt; 用在新的pipneline开头，将多个来自不同pipeline的数据集组合到一起，后面使用 -input&lt;id&gt; 指定，以 -intersect 结尾</span><br><span class="line"># -FixedEffectLMPlugin 使用GLM模型</span><br><span class="line"></span><br><span class="line">perl /opt/TASSEL5/run_pipeline.pl -fork1 -importGuess GWAS_vcf.vcf -fork2 -importGuess phenotype.tassel.txt  -fork3 -importGuess pca1.txt -excludeLastTrait -combine5 -input1 -input2 -input3 -intersect -FixedEffectLMPlugin -endPlugin -export glm</span><br></pre></td></tr></table></figure><p>主要结果为<code>glm1.txt</code>，结果如下：</p><p><img src="https://www.shelven.com/tuchuang/20230619/8.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们主要用到的数据是：</p><ul><li>第一列：表型</li><li>第二列：SNP名称</li><li>第三列：染色体编号</li><li>第四列：处于染色体的位置</li><li>第六列：p值</li></ul><h3 id="3-5-基于MLM模型进行GWAS分析"><a href="#3-5-基于MLM模型进行GWAS分析" class="headerlink" title="3.5 基于MLM模型进行GWAS分析"></a>3.5 基于MLM模型进行GWAS分析</h3><p>在tassel中运行MLM模型和GLM模型相似，MLM模型需要亲缘关系矩阵来定义个体之间的关系，以PCA和kinship作为协变量，基于MLM模型进行GWAS分析：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># -mlm -mlmVarCompEst P3D -mlmCompressionLevel Optimum 使用P3D和最优水平压缩</span><br><span class="line"></span><br><span class="line">perl /opt/TASSEL5/run_pipeline.pl -fork1 -importGuess GWAS_vcf.vcf -fork2 -importGuess phenotype.tassel.txt -fork3 -importGuess pca1.txt -fork4 -importGuess kinship.txt -combine5 -input1 -input2 -input3 -intersect -combine6 -input5 -input4 -mlm -mlmVarCompEst P3D -mlmCompressionLevel Optimum -export mlm</span><br></pre></td></tr></table></figure><p>主要结果为<code>mlm6.txt</code>（前5个是5个表型的分析数据），结果如下：</p><p><img src="https://www.shelven.com/tuchuang/20230619/9.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们主要用到的数据是：</p><ul><li>第一列：表型</li><li>第二列：SNP名称</li><li>第三列：染色体编号</li><li>第四列：处于染色体的位置</li><li>第七列：p值</li></ul><h3 id="3-6-计算核酸多态性值"><a href="#3-6-计算核酸多态性值" class="headerlink" title="3.6 计算核酸多态性值"></a>3.6 计算核酸多态性值</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vcftools --vcf GWAS_vcf.vcf --site-pi --out pi</span><br></pre></td></tr></table></figure><p>用vcftools就可以根据vcf文件统计平均每个位点的π值。</p><p><img src="https://www.shelven.com/tuchuang/20230619/10.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div><h2 id="4-GWAS结果可视化"><a href="#4-GWAS结果可视化" class="headerlink" title="4. GWAS结果可视化"></a>4. GWAS结果可视化</h2><div class="story post-story"><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qqman包绘制曼哈顿图和qq图</span></span><br><span class="line">library<span class="punctuation">(</span>qqman<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>data.table<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">glm <span class="operator">&lt;-</span> fread<span class="punctuation">(</span><span class="string">&quot;glm1.txt&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Trait&quot;</span><span class="punctuation">,</span><span class="string">&quot;Marker&quot;</span><span class="punctuation">,</span><span class="string">&quot;Chr&quot;</span><span class="punctuation">,</span><span class="string">&quot;Pos&quot;</span><span class="punctuation">,</span><span class="string">&quot;p&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>glm<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Trait&quot;</span><span class="punctuation">,</span><span class="string">&quot;SNP&quot;</span><span class="punctuation">,</span><span class="string">&quot;CHR&quot;</span><span class="punctuation">,</span><span class="string">&quot;BP&quot;</span><span class="punctuation">,</span><span class="string">&quot;P&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">mlm <span class="operator">&lt;-</span> fread<span class="punctuation">(</span><span class="string">&quot;mlm6.txt&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Trait&quot;</span><span class="punctuation">,</span><span class="string">&quot;Marker&quot;</span><span class="punctuation">,</span><span class="string">&quot;Chr&quot;</span><span class="punctuation">,</span><span class="string">&quot;Pos&quot;</span><span class="punctuation">,</span><span class="string">&quot;p&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">mlm <span class="operator">&lt;-</span> na.omit<span class="punctuation">(</span>mlm<span class="punctuation">)</span>     <span class="comment"># 需要注意mlm结果文件有一行是NaN值，去除</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>mlm<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Trait&quot;</span><span class="punctuation">,</span><span class="string">&quot;SNP&quot;</span><span class="punctuation">,</span><span class="string">&quot;CHR&quot;</span><span class="punctuation">,</span><span class="string">&quot;BP&quot;</span><span class="punctuation">,</span><span class="string">&quot;P&quot;</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义作图函数</span></span><br><span class="line">plot_func <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span>trait<span class="punctuation">,</span>model<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  pdf<span class="punctuation">(</span>paste<span class="punctuation">(</span>model<span class="punctuation">,</span><span class="string">&quot;_&quot;</span><span class="punctuation">,</span>trait<span class="punctuation">,</span><span class="string">&quot;.manhttan.pdf&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      width <span class="operator">=</span> <span class="number">11</span><span class="punctuation">,</span>height <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">  manhattan<span class="punctuation">(</span>data<span class="punctuation">[</span>Trait<span class="operator">==</span>trait<span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">5</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment"># 曼哈顿图需要的是&quot;SNP&quot;,&quot;CHR&quot;,&quot;BP&quot;,&quot;P&quot;这几列信息</span></span><br><span class="line">            suggestiveline <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">            genomewideline <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="comment"># remove the suggestive(Default -log10(1e-5)) and genome-wide(Default -log10(5e-8)) significance lines，也就是去掉两条阈值线</span></span><br><span class="line">  dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">  pdf<span class="punctuation">(</span>paste<span class="punctuation">(</span>model<span class="punctuation">,</span><span class="string">&quot;_&quot;</span><span class="punctuation">,</span>trait<span class="punctuation">,</span><span class="string">&quot;.qq.pdf&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  qqman<span class="operator">::</span>qq<span class="punctuation">(</span>data<span class="punctuation">[</span>Trait<span class="operator">==</span>trait<span class="punctuation">,</span><span class="punctuation">]</span><span class="operator">$</span>P<span class="punctuation">)</span>  <span class="comment"># qq图只要获得每个SNP位点的p值就可以作图</span></span><br><span class="line">  dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 区分下不同表型</span></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>trait <span class="keyword">in</span> unique<span class="punctuation">(</span>glm<span class="operator">$</span>Trait<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  plot_func<span class="punctuation">(</span>glm<span class="punctuation">,</span>trait<span class="punctuation">,</span><span class="string">&quot;glm&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>trait <span class="keyword">in</span> unique<span class="punctuation">(</span>mlm<span class="operator">$</span>Trait<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  plot_func<span class="punctuation">(</span>mlm<span class="punctuation">,</span>trait<span class="punctuation">,</span><span class="string">&quot;mlm&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>生成各个表型GWAS分析的曼哈顿图和qq图：</p><p><img src="https://www.shelven.com/tuchuang/20230619/11.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>随便查看一个MLM模型的GWAS曼哈顿图和qq图结果：</p><p><img src="https://www.shelven.com/tuchuang/20230619/13.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/13.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://www.shelven.com/tuchuang/20230619/12.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230619/12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;本篇笔记主要记录如何在linux命令行中用&lt;code&gt;TASSEL5&lt;/code&gt;和&lt;code&gt;PLINK2&lt;/code&gt;软件做GWAS分析，以及如何可视化GWAS结果（在R中绘制曼哈顿图和QQ图）。关于GWAS是做什么的，以及基本概念介绍可以看上一篇笔记介绍：&lt;a href=&quot;https://www.shelven.com/2023/06/16/a.html&quot;&gt;群体基因组学——概述和图表详解 - 我的小破站 (shelven.com)&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="群体基因组学" scheme="http://www.shelven.com/categories/%E7%BE%A4%E4%BD%93%E5%9F%BA%E5%9B%A0%E7%BB%84%E5%AD%A6/"/>
    
    
    <category term="群体基因组学" scheme="http://www.shelven.com/tags/%E7%BE%A4%E4%BD%93%E5%9F%BA%E5%9B%A0%E7%BB%84%E5%AD%A6/"/>
    
    <category term="Tassel5" scheme="http://www.shelven.com/tags/Tassel5/"/>
    
    <category term="Plink" scheme="http://www.shelven.com/tags/Plink/"/>
    
  </entry>
  
  <entry>
    <title>群体基因组学——概述和图表详解</title>
    <link href="http://www.shelven.com/2023/06/16/a.html"/>
    <id>http://www.shelven.com/2023/06/16/a.html</id>
    <published>2023-06-16T08:47:16.000Z</published>
    <updated>2023-06-16T08:57:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近看群体遗传学的文章，苦于不能理解研究者做的另人眼花缭乱的图表……哎，该补补基础了。这篇笔记先从樊龙江主编的《植物基因组学》教材开始学习基础概念，有部分摘自知乎和一些文献，加上这个领域论文图表的解读和自己的理解做汇总整理。下一篇笔记自己实操跑一下GWAS流程。</p><span id="more"></span><h2 id="1-群体基因组学概述"><a href="#1-群体基因组学概述" class="headerlink" title="1. 群体基因组学概述"></a>1. 群体基因组学概述</h2><div class="story post-story"><p>群体基因组学，将基因组数据和技术与群体遗传学理论体系结合，<strong>通过覆盖全基因组范围的多态性推测全基因组效应和位点特异性效应</strong>。说人话，这门学科的作用就是通过检测SNP等的信息来回答关于物种起源、进化以及环境适应的分子机制。</p><p>群体基因组研究的基础是高质量的群体基因型数据，在获得群体原始测序数据后，<strong>如何高效准确的进行变异检测和群体基因分型是后续研究的关键</strong>（因为要用到大量的测序数据，所以也很烧钱）。</p><img src="https://www.shelven.com/tuchuang/20230615/1.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 50%;" /><p>变异检测的流程可分为<strong>数据质控——读序联配——变异检测——基因分型</strong></p><p>上图的bam文件通过软件GATK检测结构变异或者SNP就是变异检测，这部分内容我前面组装三代基因组测序数据中使用过，因为我只有一个二倍体基因组，所以当时也没用到基因分型，GATK用法可以看我的这篇笔记：</p><p><a href="https://www.shelven.com/2023/03/07/a.html">0基础学习三代基因组测序组装（9）——GATK检测植物基因组SNP和INDEL变异 - 我的小破站 (shelven.com)</a></p></div><h2 id="2-群体基因组进化分析方法"><a href="#2-群体基因组进化分析方法" class="headerlink" title="2. 群体基因组进化分析方法"></a>2. 群体基因组进化分析方法</h2><div class="story post-story"><h3 id="2-1-群体系统发生树和群体结构"><a href="#2-1-群体系统发生树和群体结构" class="headerlink" title="2.1 群体系统发生树和群体结构"></a>2.1 群体系统发生树和群体结构</h3><p><strong>群体发生树</strong>反映特定群体中个体间亲缘关系。一般我们做进化树都是用单拷贝基因，而做群体研究构建进化树用了整个基因组数据信息（比如全基因组SNP、Indel、SV等），能一定程度抵消横向基因转移和单个基因速率差异带来的分析误差，<strong>比单基因构建的结果更接近真实进化关系</strong>。全基因组SNP构建进化树（一般是把SNP merge到一起），个体间两两比较，根据SNP差异计算个体差异距离，构建群体差异矩阵。软件有<code>MEGA</code>、<code>PHYLIP</code>、<code>FastTree</code>等。</p><p>还有一个非常重要的概念：<strong>群体遗传结构，</strong>指基因型或者基因在空间和时间上的分布模式，包括<strong>种群内的遗传变异</strong>和<strong>种群间的遗传分化</strong>。<strong>种群遗传结构反映物种进化历史中的一些特殊进化事件</strong>，软件有Structure、Frappe等。总体流程确定亚群数（K），然后计算各个体归属第K亚群的概率Q值。以及主成分分析（PCA）也常用于群体结构划分。</p><img src="https://www.shelven.com/tuchuang/20230615/2.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 80%;" /><p>上图是华农王茂军老师课题组做的不同二倍体棉花的物种发生树和群体结构。</p><h3 id="2-2-群体遗传分化"><a href="#2-2-群体遗传分化" class="headerlink" title="2.2 群体遗传分化"></a>2.2 群体遗传分化</h3><h4 id="2-2-1-固定系数-Fst"><a href="#2-2-1-固定系数-Fst" class="headerlink" title="2.2.1 固定系数 Fst"></a>2.2.1 固定系数 Fst</h4><p>在明确一个物种存在群体结构后，通产需要量化该物种亚群间的分化程度。<strong>固定系数（Fst）反映群体等位基因杂合性水平，Fst越大，种群间遗传分化程度越大</strong>。</p><ul><li><strong>Fst&#x3D; (Ht-Hs）&#x2F;Ht</strong><br>Hs:亚群体中的平均杂合度<br>Ht:复合群体中的平均杂合度</li></ul><h4 id="2-2-2-核酸多态性-𝝅"><a href="#2-2-2-核酸多态性-𝝅" class="headerlink" title="2.2.2 核酸多态性 𝝅"></a>2.2.2 核酸多态性 𝝅</h4><p>做群体的文献中经常出现这个指标类似<code>𝝅野生/𝝅栽培</code>这样的系数，核酸多态性（Nucleotide diversity）是用于衡量群体的多态性的，为群体内平均每两个样本每个位点的差异核苷酸数量。一般称为𝝅，<strong>自然群体多态性一般高于栽培群体</strong>。</p><p>需要注意下这个𝝅的单位，一般都在 <strong>10^(-3)</strong> 这个数量级。</p><p>这些群体分化的相关系数计算可以用软件<code>Arlequin</code>、<code>FSTAT</code>、<code>VCFtools</code>等。</p><h3 id="2-3-基因流（渐渗）"><a href="#2-3-基因流（渐渗）" class="headerlink" title="2.3 基因流（渐渗）"></a>2.3 基因流（<strong>渐渗</strong>）</h3><p>基因流（也称为基因迁移）指从一个物种的一个种群向另一个种群引入遗传物质，从而改变群体的遗传组成。</p><p>当一个种群中的一个个体迁移到另一个群体，就会把基因带到新的群体，也就是产生“基因的流动”。基因流越大，群体间的相似性越大，会导致群体间基因频率和基因型频率呈现<strong>哈迪-温伯格平衡</strong>（在一个随机交配的大群体中，没有突变、选择等外界环境因素的影响，基因频率和基因型频率世代恒定）。</p><p>自然选择和遗传漂变会使群体之间的差异增加，而基因流的作用是“弱化”群体间的遗传差异，群体之间趋于一致。在植物中，种子扩散和花粉传播是植物基因流的最主要方式。从上面的描述也能看出，基因流与Fst成反比；与种群间地理距离成反比。检测方法主要有D-统计（ABBA-BABA）、Treemix、Migrate-N等。</p><h3 id="2-4-种群动态和进化历史"><a href="#2-4-种群动态和进化历史" class="headerlink" title="2.4 种群动态和进化历史"></a>2.4 种群动态和进化历史</h3><p><strong>种群动态</strong>指种群大小或密度随时间或空间的变化。</p><p><strong>有效群体大小（Ne）</strong>指与实际群体有相同基因频率方差或者相同杂合度衰减率的理想群体含量，通常小于绝对群体大小，决定群体平均近郊系数增量大小，<strong>反映群体遗传结构中基因的平均纯和速度</strong>。种群动态理论与方法主要包括种群大小及其变化、种群生长模式的量化描述，以及引起种群变化的外在环境因素。基于全基因组的种群历史动态分析方法主要有PSMC、MSMC等。</p><p><img src="https://www.shelven.com/tuchuang/20230615/3.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>上图展示了不同地理来源的拟南芥的有效群体大小变化。可以看到拟南芥在9万～12万年前，由祖先群体在非洲开始分离形成亚群。欧亚祖先群体在 8 万年前从非洲分化形成，然后欧亚拟南芥群体在4万年前进一步分化。这一模式与包括人类在内的多种物种分化时间模式非常相似，这意味着间冰期和洪积世时期（即9万～12万年前）的气候事件对物种分布十分重要。</p></div><h2 id="3-基因组选择信号"><a href="#3-基因组选择信号" class="headerlink" title="3. 基因组选择信号"></a>3. 基因组选择信号</h2><div class="story post-story"><p>自然群体区别于栽培群体的最大特征是丰富的遗传多样性。草本作物祖先自然群体多态性（𝝅）一般在 0.003~0.008，高于相应的驯化作物遗传多态性。</p><ul><li><p>遗传瓶颈效应：由于环境骤变或人类活动，某一生物种群的规模迅速减少，仅有少部分个体能够顺利通过瓶颈事件，之后可能经历一段恢复期并产生大量后代。由于连锁不平衡（LD）的作用，不仅仅是驯化基因的多态性降低，其侧翼区域遗传多样性也会降低。</p></li><li><p>有害性突变（deleterious SNP，dSNP）指导致生物个体的整体适合度（fitness）减低的突变。植物被驯化的过程中，基因组上有害突变的数量、频率会不断增加和累积，导致驯化后的作物在原本自然环境中适合度降低，称为作物的“驯化成本”。</p></li><li><p>在作物群体基因组中，一个明显的特征是存<strong>在大量来自野生祖先种的遗传渐渗</strong>。来自野生群体的基因渗入可以有效增加栽培种的环境适应性。</p></li></ul><p>选择分析可以在宏观和微观两个尺度下进行选择基因和信号鉴定。</p><h3 id="3-1-宏观进化尺度"><a href="#3-1-宏观进化尺度" class="headerlink" title="3.1 宏观进化尺度"></a>3.1 宏观进化尺度</h3><blockquote><p><strong>宏观进化尺度</strong></p><ul><li>基于基因：Ka&#x2F;Ks（非同义替换比同义替换）、MKT检验（比较物种内和物种间的Ka&#x2F;Ks值）</li><li>基于进化速率：HKA</li></ul></blockquote><p>宏观尺度检测选择信号的方法，<strong>通常在亲缘关系相近的物种之间进行同源基因序列的比较</strong>，判断基因是否在某一物种或进化分支上存在加速进化的情况。</p><p>判断加速进化的<strong>背景指标是Ka&#x2F;Ks</strong>，比较每个位点区域中非同义替换率与每个位点的同义替换率。同义突变总体是<strong>中性进化</strong>的（中性基准），如果存在过多的非同义突变意味着存在倾向于蛋白序列改变的正向选择（<strong>正选择表现为固定某种有利等位基因，负选择表现为清除不利的等位基因</strong>）。MKT检验本质是比较物种内和物种间的Ka&#x2F;Ks值，中性情况下相等，如果物种间的比值显著高于物种内比值，意味着物种中存在正向选择信号，如果是在作物驯化中，可能是人工选择的信号。</p><h3 id="3-2-微观进化尺度"><a href="#3-2-微观进化尺度" class="headerlink" title="3.2 微观进化尺度"></a>3.2 微观进化尺度</h3><blockquote><p><strong>微观进化尺度</strong></p><ul><li>基于等位基因频谱：Tajima’s D, Fu andLi’sD, Fay and Wu’sH, CLR, Hp</li><li>基于连锁不平衡：LRH、iHS、连锁不平衡衰减（LDD）、IBD分析</li><li>基于群体分化：LKT、LSBL</li><li>组合方法：CLR、XP-CLR（适合SNP大数据集）、DH检验、CMS</li></ul></blockquote><p>微观尺度鉴定方法，在正向选择的作用下，有利等位基因在群体中频率会变高甚至固定。当有利等位基因和周围变异达到较高频率的时候，这段区间在群体水品就会呈现遗传多态性降低的现象，也就是<strong>选择性清除</strong>（selective sweep）。</p><p>比如，栽培物种在选择性清除区域的遗传多样性显著降低，就是驯化区域的典型特征。选择性清除还会使<strong>连锁不平衡区块延长、群体间固定指数增大、Tajima‘s D值为负且显著偏离零</strong>。中性模型为基础的检测方法很多，Tajima‘s D检验是最经典的。</p><p>总体来说，选择信号检测原理和方法可以分为以下5类：</p><ul><li><p>A 基于群体多态性。原理：受选择位点两侧序列多态性因连带效应保持很低水平。在驯化选择区间内，𝝅野生&#x2F;𝝅栽培的值变高。</p></li><li><p>B 基于等位基因频谱。原理：有利突变不断在群体中固定，当完全固定时，周围可能由于随机突变出现稀有等位基因</p></li><li><p>C 基于连锁不平衡。原理：选择性清除会引起包含等位基因的单倍体纯和性提高，与周围变异的连锁不平衡程度变高。当群体处于正向选择作用下时，基因突变及其连锁位点在正选择的作用下，在短时间内会达到较高频率，形成大片段的纯合单倍型。</p></li><li><p>D 基于群体分化。随着受选择的等位基因频率上升，导致与原群体的Fst变大。Fst的取值范围为0-1，1表示群体间完全分化的位点，0表示在群体间完全没有分化的位点。</p></li><li><p>E 组合方法。</p></li></ul><p><img src="https://www.shelven.com/tuchuang/20230615/4.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><strong>在检测选择信号时，需要考虑遗传漂移（genetic drift）对选择信号的影响，为了降低该影响，通常在全基因组扫描窗口的基础上，仅考虑极端值（前5%）区域作为选择位点（这点很重要，后面实操的时候会说）。</strong></p><p>选择信号检测方法都是基于<strong>自下而上</strong>的，通过群体基因组扫描鉴定具有选择信号的基因组区域，从而挖掘可能与某种表型或者适应性相关联的基因，假阳性高。</p><p>也可以用<strong>自上而下</strong>的方法进行佐证，比如获得该物种多个时间点或者多个世代的群体基因组数据，就可以直接检测该位点等位基因频率变化加以验证，比如用QTL、GWAS等传统定位方法。</p></div><h2 id="4-连锁不平衡（LD）"><a href="#4-连锁不平衡（LD）" class="headerlink" title="4. 连锁不平衡（LD）"></a>4. 连锁不平衡（LD）</h2><div class="story post-story"><p>连锁不平衡理论对群体研究非常重要，前面说到基于连锁不平衡的原理检测选择信号，这里再加深一下理解。</p><p><strong>连锁不平衡（linkage disequilibrium，LD）：在某一群体中，两个基因同时遗传的频率大于随机组合的频率。</strong></p><p>连锁不平衡的三个衡量指标：</p><ul><li>D值：D &#x3D; P(AB) - P(A) X P(B)，也就是实际概率减去独立遗传的理论概率，D值绝对值越大，连锁程度越大。</li><li>D‘值：理解维归一化之后的D值，归一化之的值可以用于比较不同基因连锁程度的大小。0表示完全连锁平衡，独立遗传；1表示完全连锁不平衡。</li><li>r平方</li></ul><p>r值定义如下：</p><p><img src="https://www.shelven.com/tuchuang/20230615/5.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>通常文献里也是用r平方来表征连锁不平衡程度，<strong>r平方等于0时，表示完全连锁平衡，独立遗传；r平方等于1时, 表示完全连锁不平衡。</strong></p><p>这里就要引出另一个很重要的概念——LD衰减，也是做GWAS出现最多的图。</p><h3 id="4-1-LD衰减曲线"><a href="#4-1-LD衰减曲线" class="headerlink" title="4.1 LD衰减曲线"></a>4.1 LD衰减曲线</h3><p><strong>LD衰减指位点间由连锁不平衡到连锁平衡的演变过程</strong>；LD衰减的速度在不同物种间或同物种的不同亚群间差异非常大。所以，通常会使用“<strong>LD衰减距离</strong>”来描述LD衰减速度的快慢。</p><p><strong>衰减距离</strong>，是当平均LD系数衰减到一定大小的时候，对应的物理距离。（这个一定大小是没有特别规定的，比如可以到一半大小，可以到0.5，可以到0.1）</p><p><img src="https://www.shelven.com/tuchuang/20230615/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>上面的图描绘了不同水稻群体的LD衰减曲线，横坐标是物理距离（kb），纵坐标是LD系数（r^2）。</p><p>LD衰减曲线就是利用曲线图来呈现基因组上分子标记间的平均LD系数随着标记间距离增加而降低的过程。大概的计算原理就是先统计基因组上两两标记间的LD系数大小，再按照标记间的距离对LD系数进行分类，最终计算出一定距离的分子标记间的平均LD系数大小。</p><p>我们看左边的图，Japonic这个亚群（红色的线）在基因组100Kb距离的平均LD系数大小为0.35，到了200kb距离，对应的LD系数降低到了不到0.3。LD衰减速度在不同亚群是不一样，Japonica衰减速度最慢（其他亚群在物理距离很小的时候LD系数降就从0.35衰减到了0.3），衰减距离最大。</p><p>知道这个衰减速度快慢和衰减距离有什么用呢？</p><blockquote><p>LD衰减速度越慢，形成的单体型区块越大，关联分析中需要的群体和标记数目越少，但定位越不精准。此外，同一个连锁群上，LD衰减地慢说明该群体受到选择，一般来说，野生群体比驯化改良群体LD衰减快，遗传多样性高。而驯化选择会导致群体遗传多样性下降，位点间的相关性（连锁程度）加强。所以，<strong>驯化程度越高，选择强度越大的群体，LD衰减速度越慢</strong>。</p></blockquote><p>也就是说左边这个图的4个水稻品种中，Japonic是驯化程度最高的。</p><p><strong>LD衰减距离应用：</strong></p><ul><li>辅助分析进化和选择，同一个连锁群上，LD衰减地慢说明该群体受到选择。</li><li>一般而言，两个位点在基因组上离得<strong>越近</strong>，相关性就<strong>越强</strong>，LD系数就<strong>越大</strong>。反之，LD系数越小。也就是说，<strong>随着位点间的距离不断增加，LD系数通常情况下会慢慢下降</strong>。</li><li>一般而言，LD系数大于0.8就是强相关。如果LD系数小于0.1，则可以认为没有相关性。如果LD衰减到0.1这么大的区间内都没有标记覆盖的话，即使这个区间有一个效应很强的功能突变，也是检测不到关联信号的。所以，通常可以通过比较LD衰减（到0.1）距离和标记间的平均距离，来判断标记是否对全基因组有足够的覆盖度。</li><li>如果GWAS检测到显著关联的区间后，则可以通过进一步绘制局部的LD单倍型块图（这个后面讲），来进一步判断显著相关的SNP和目标基因间是否存在强LD关系。</li><li>基因组上那些受选择的区域相比普通的区域，LD衰减速度也是更慢的。</li><li>判断GWAS所需标记量，决定GWAS的检测效力以及精度； <strong>GWAS标记量 &#x3D; 基因组大小 &#x2F; LD衰减距离</strong>。</li></ul><h3 id="4-2-单倍型块（Haplotype-Block）"><a href="#4-2-单倍型块（Haplotype-Block）" class="headerlink" title="4.2 单倍型块（Haplotype Block）"></a>4.2 单倍型块（Haplotype Block）</h3><p>描述LD不平衡的另一个常用的图就是LD单倍型块图。</p><p><strong>单倍型块，即连锁不平衡区域，是指同一条染色体上处于连锁不平衡状态的一段连续的区域</strong>。单倍型块分析可以用于筛选tag SNP、确定候选基因的范围等。</p><p><img src="https://www.shelven.com/tuchuang/20230615/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>颜色从白色到红色，代表连锁程度从低到高，方框中的数值为LD系数r^2，为了美观，这里将 r2^2乘以了100。</p><p>上面的图中每个正方形是两个相邻SNP的LD值计算结果，如果大于设定的阈值（这里估计是大于94），那么就构成一个block，图中黑框为一个block，共有三个。可以从三个block中分别选择一个SNP作为Tag SNP来分别代表这三个block。</p></div><h2 id="5-全基因组关联分析（GWAS）"><a href="#5-全基因组关联分析（GWAS）" class="headerlink" title="5. 全基因组关联分析（GWAS）"></a>5. 全基因组关联分析（GWAS）</h2><div class="story post-story"><p>全基因组关联分析（Genome-Wide Association Study, GWAS），以连锁不平衡（linkage disequilibrium, LD）为基础，通过分析<strong>数百个或者数千个个体</strong>的高密度分子标记的分离特征（一般是上万个或者上百万个SNP标记），筛选与复杂性状表现型变异相关联的分子标记，进而分析分子标记对表现型的遗传效应。</p><p>插一句题外话，GWAS中最后一个字母已经是study，在写英文文章的时候不要写成GWAS study……</p><p>传统的<strong>QTL定位研究通常以2个亲本杂交群体为研究对象, 通过连锁作图定位目标性状位点</strong>。局限性是投入大量资源构建数量庞大的重组群体。而关联分析则可以利用个体在全基因组范围的遗传变异标记进行多态性检测，获得更高分辨率的定位结果（单碱基水平）, 遗传变异来源也更为广泛，根据统计量或者显著性P值筛选最有可能影响该性状的遗传变异，往往能定位到比双亲本作图群体中更多的性状关联位点（这可节省太多时间了）。</p><p>GWAS的局限性在于可以确定相关位点但不能直接确定基因本身，假阳性也比较高。解决这一局限性有两种策略，一是算法，二是群体的选取。</p><h3 id="5-1-GWAS算法模型"><a href="#5-1-GWAS算法模型" class="headerlink" title="5.1 GWAS算法模型"></a>5.1 GWAS算法模型</h3><p>目前用的算法模型有以下几种：</p><ul><li><p><strong>1.GLM （Generalized linear model；一般线性模型）</strong></p></li><li><p><strong>2.MLM （Mixed linear model；混合线性模型）</strong></p></li><li><p>3.GEMMA、CMLM、SUPER、FarmCPU、Blink</p></li></ul><p>主要介绍前两个，GLM模型以<strong>群体结构矩阵 Q或主成分分析矩阵PCs为协变量</strong>做回归拟合。</p><img src="https://www.shelven.com/tuchuang/20230615/8.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:50%;" /><p>如果两个表型差异很大，但群体本身还含有其他的遗传差异（如地域等），则<strong>那些与该表型无关的遗传差异也会影响到相关性</strong>。<strong>MLM模型可以把群体结构矩阵 Q、亲缘关系矩阵（kinship）或联合利用主成分分析矩阵PCs和亲缘关系矩阵为协变量</strong>，把这种位点校正掉（也就是抑制假关联）。</p><img src="https://www.shelven.com/tuchuang/20230615/9.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 67%;" /><p>其他模型大多是基于GLM和MLM进行优化，比如GEMMA 计算个体基因型相似性矩阵，排除了LD的干扰。其他暂时就不多说了，感兴趣再深入研究研究。</p><h3 id="5-2-GWAS群体选取"><a href="#5-2-GWAS群体选取" class="headerlink" title="5.2 GWAS群体选取"></a>5.2 GWAS群体选取</h3><p>群体中丰富的表型变异和充分的遗传重组是GWAS 成功的关键条件，有以下选取策略：</p><ul><li>(1) 群体内没有明显的群体结构，样本间没有过近的亲缘关系，同时具有丰富的表型变异</li><li>(2) 群体来自具有一定水平遗传分化的不同类群(如不同亚种与亚群)，具有丰富的遗传和表型变异，但同时不同类群之间存在频繁的遗传交流，保证目标性状在不同类群内部也存在一定水平的变异</li><li>目前GWAS样本量普遍大于100份</li></ul><p>前面也说过，同时要考虑GWAS标记量，计算公式<strong>GWAS标记量 &#x3D; 基因组大小 &#x2F; LD衰减距离</strong>。</p><p>在用GATK做基因分型的时候也要注意，<strong>结果一般保留maf值大于0.05的 SNP</strong>，通常认为这是在驯化选择区间内。</p><h3 id="5-3-GWAS结果图解"><a href="#5-3-GWAS结果图解" class="headerlink" title="5.3 GWAS结果图解"></a>5.3 GWAS结果图解</h3><p>还是先说明一下，做GWAS需要有三类数据：<strong>SNP数据、表型数据和群体结构</strong>。这些数据在实操会再次提到。</p><p>GWAS的结果通常以<strong>曼哈顿图</strong>和<strong>QQ图</strong>来展示。曼哈顿图显示每个SNP在关联分析中的显著性水平; QQ 图反映关联分析的效果。</p><p>以下图721份水稻GWAS结果图为例：</p><p><img src="https://www.shelven.com/tuchuang/20230615/10.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/10.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h4 id="5-3-1-曼哈顿图（Manhattan-Plot）"><a href="#5-3-1-曼哈顿图（Manhattan-Plot）" class="headerlink" title="5.3.1 曼哈顿图（Manhattan Plot）"></a>5.3.1 曼哈顿图（Manhattan Plot）</h4><p>图4（A）就是一个曼哈顿图，每个点代表一个SNP，x轴代表SNP在基因组上的遗传位置，y轴为–log10  (P-value)，显著性水平线有红蓝两条（P &#x3D; 0.01和P&#x3D; 0.05）。y轴值越大，说明该位点表型的关联程度越大，受到连锁不平衡（LD）的影响，<strong>基因组上强关联位点周围的SNP也会呈现出关联性由高到低连续变化的信号强度，从而在P值小的地方出现尖峰（peak）</strong>。</p><p>上面文章深入分析水稻6号染色体上与抽穗期相关的一个尖峰，将其定位在Hd3a附近, 估计候选区间大概在 2.68–4.62 Mb (图4C)。这个候选区间是如何确定的呢？</p><p>我们通常将显著关联SNP在<strong>N</strong> kb以内的位置确认为相关区间，这个N就是对应的<strong>LD衰减距离</strong>。确定GWAS鉴定的候选区间后，就可以在候选区间内找到基因功能注释和表型相关的基因，或者有其他组学或者功能研究支持的基因进行验证和深入研究。</p><h4 id="5-3-2-QQ图（QQ-Plot）"><a href="#5-3-2-QQ图（QQ-Plot）" class="headerlink" title="5.3.2 QQ图（QQ Plot）"></a>5.3.2 QQ图（QQ Plot）</h4><p>图4（B）是QQ图，<strong>本质上就是做两组数据的比较，判断是否一致</strong>。每个点代表一个SNP，横坐标是期望的P-value，纵坐标为实际观测到的P-value，虚线代表实际观测和期望的P-value值一致的情况。</p><p>我们做关联分析，当然是希望大部分的位点观测值和期望值一样（在对角线，也就是这里的虚线上），也就是这部分位点确定是与性状不关联的。一部分位点在虚线的上方，也就是观测值超过期望值，说明这些位点的效应超过随机效应，也就是这些位点是与性状显著相关的。也就是出现4（B）这个图才是理想的结果。</p><p>还有以下三种其他情况：</p><p><img src="https://www.shelven.com/tuchuang/20230615/11.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><ul><li>1 观察值低于期望值（点在对角线下方），可能是模型不合理，P-value被过度矫正。或者是群体中大量SNP位点间存在连锁不平衡，有效位点数（相互间不存在连锁不平衡的位点）明显低于实际位点数，所以P-value的期望值被低估了。</li><li>2 观察值和期望值相同，说明没有找到与性状显著关联的位点。</li><li>3 观察值显著高于期望值（点全都在对角线上方），也就是所有位点都与某个性状显著相关，说明分析模型不合理，假阳性太多了。</li></ul><p>现在基于GWAS分析还衍生出其他诸如TWAS（基因表达量做标记）、PWAS（蛋白做标记）、EWAS（甲基化表观信息做标记）等关联分析方法，做标记的信息不同，本质上也都是和表型做关联分析。</p></div><h2 id="6-泛基因组（Pan-Genome）"><a href="#6-泛基因组（Pan-Genome）" class="headerlink" title="6. 泛基因组（Pan-Genome）"></a>6. 泛基因组（Pan-Genome）</h2><div class="story post-story"><p>想了想还是把泛基因组也放了进来，虽然泛基因组研究方法和上面的研究方法不一样，但也是群体基因组学的一个重要分支，主要是开展群体基因组重测序和遗传变异的分析工作。</p><p>我们知道<strong>单一的参考基因组仅能代表物种基因组空间范围的一小部分</strong>（同一个物种不同亚群基因组存在差异），以线性参考基因组进行群体变异的分析就会错失一些变异位点（SV&amp;CNV&amp;PAV）。所以这个时候我们就需要获取一个物种的全部遗传信息（只能说是相对的全部），并解析每个个体间的遗传变异，这就诞生了泛基因组（Pan-Genome）研究。</p><h3 id="6-1-核心基因-x2F-非核心基因"><a href="#6-1-核心基因-x2F-非核心基因" class="headerlink" title="6.1 核心基因&#x2F;非核心基因"></a>6.1 核心基因&#x2F;非核心基因</h3><p>在泛基因组中有两个非常重要的概念：</p><ul><li>1 <strong>核心基因（core genome）</strong>：在物种所有个体内都存在的，保持生命体基本功能，代表物种基本表型特征。</li><li>2 <strong>非必需基因（dispensable genome）</strong>：使不同个体在表型，生活方式、代谢等多方面发生明显的分化，最终表现为丰富的遗传多样性。</li></ul><p><img src="https://www.shelven.com/tuchuang/20230615/12.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>上图可以看出核心基因和非必需基因的区别，以及最后融合成pan-genome。主要注意一点，<strong>核心基因是这个物种中所有个体都存在的，但不一定是必须基因</strong>，必须基因的概念比核心基因窄，核心基因包含了必须基因。</p><p>现在的pan-genome分析的文章一般还会对基因集做更进一步的细分：</p><ul><li><strong>core</strong> 核心基因，所有样本共享</li><li><strong>softcore</strong> 次核心基因，90%样本共享</li><li><strong>dispensable</strong> 非必需基因，多个样本共享但 &lt; 90%</li><li><strong>private</strong> 特有基因，1%，或者仅存在于一个样本中</li></ul><p><img src="https://www.shelven.com/tuchuang/20230615/13.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/13.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>对不类型基因集进行<strong>保守性分析</strong>，有助于挖掘适应性进化或驯化中发挥关键作用的基因。文章中用的比较多的还有核心基因&#x2F;非必需基因与<strong>重复序列相关性分析</strong>、<strong>表达水平分析</strong>等等，这些展开来说太多了，具体文章具体分析。</p><h3 id="6-2-泛基因组组装"><a href="#6-2-泛基因组组装" class="headerlink" title="6.2 泛基因组组装"></a>6.2 泛基因组组装</h3><p>泛基因组组装方式现在见的比较多的是两种：</p><h4 id="6-2-1-基于二代测序（迭代组装）"><a href="#6-2-1-基于二代测序（迭代组装）" class="headerlink" title="6.2.1 基于二代测序（迭代组装）"></a>6.2.1 基于二代测序（迭代组装）</h4><img src="https://www.shelven.com/tuchuang/20230615/14.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/14.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><p><a href="https://genomebiology.biomedcentral.com/articles/10.1186/s13059-020-02224-8">How the pan-genome is changing crop genomics and improvement | Genome Biology | Full Text (biomedcentral.com)</a></p><p>将多个样本二代下机数据与参考基因组比对，<strong>未比对上的reads组装成新的contigs</strong>，将这些contigs添加到原始参考序列中（一般直接放在最后），最终获的物种的泛基因图谱。</p><p>看得出来这种方式简单粗暴，可以快速得到泛基因组信息（也省钱），但是有二代数据的通病——<strong>如果物种的基因组比较大，或者测序深度不够深的话，组装的contigs连续性会比较差。</strong></p><h4 id="6-2-2-基于三代测序（从头组装-amp-图形泛基因组）"><a href="#6-2-2-基于三代测序（从头组装-amp-图形泛基因组）" class="headerlink" title="6.2.2 基于三代测序（从头组装&amp;图形泛基因组）"></a>6.2.2 基于三代测序（从头组装&amp;图形泛基因组）</h4><img src="https://www.shelven.com/tuchuang/20230615/15.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/15.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:67%;" /><p><a href="https://www.nature.com/articles/s41477-020-0733-0">Plant pan-genomes are the new reference | Nature Plants</a></p><p>对多个个体进行从头组装、注释，从全基因组层面识别变异信息，也是现在用的最广泛的方法。不依赖参考基因组，但是需要较高的测序深度（保证准确性），组装到染色体水平。图形泛基因组是在从头组装的基础上，<strong>基于图论的组装方法</strong>，利用有向图将物种基因组分为核心基因组和非必需基因组。</p><h3 id="6-3-泛基因组分析"><a href="#6-3-泛基因组分析" class="headerlink" title="6.3 泛基因组分析"></a>6.3 泛基因组分析</h3><p>主要可以分以下两部分：</p><p><img src="https://www.shelven.com/tuchuang/20230615/16.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230615/16.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这部分内容留到以后我做泛基因组组装实操再做详细解释和补充（先挖个坑）。</p><p>下篇笔记将简单实操一下GWAS分析，使用软件为<code>TASSEL</code>。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近看群体遗传学的文章，苦于不能理解研究者做的另人眼花缭乱的图表……哎，该补补基础了。这篇笔记先从樊龙江主编的《植物基因组学》教材开始学习基础概念，有部分摘自知乎和一些文献，加上这个领域论文图表的解读和自己的理解做汇总整理。下一篇笔记自己实操跑一下GWAS流程。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="群体基因组学" scheme="http://www.shelven.com/categories/%E7%BE%A4%E4%BD%93%E5%9F%BA%E5%9B%A0%E7%BB%84%E5%AD%A6/"/>
    
    
    <category term="群体基因组学" scheme="http://www.shelven.com/tags/%E7%BE%A4%E4%BD%93%E5%9F%BA%E5%9B%A0%E7%BB%84%E5%AD%A6/"/>
    
  </entry>
  
  <entry>
    <title>三维基因组学——如何用Hi-C数据分析拓扑关联结构域</title>
    <link href="http://www.shelven.com/2023/06/15/a.html"/>
    <id>http://www.shelven.com/2023/06/15/a.html</id>
    <published>2023-06-14T16:24:17.000Z</published>
    <updated>2023-06-16T08:49:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>本篇笔记主要记录三维基因组学的学习，以及演示如何利用Hi-C数据分析Compartment和拓扑关联结构域（TAD），所使用的分析Hi-C数据的软件为HiC-Pro，可视化软件为HiCPlotter和R包HiTC。</p><span id="more"></span><h2 id="1-三维基因组简介"><a href="#1-三维基因组简介" class="headerlink" title="1. 三维基因组简介"></a>1. 三维基因组简介</h2><div class="story post-story"><p>首先什么是三维基因组学？三维基因组学(Three-Dimensional Genomics, 3D Genomics)，是指在考虑基因组序列、基因结构及其调控元件的同时，对基因组序列在细胞核内的三维空间结构，及其对基因转录、复制、修复和调控等生物过程中功能的研究。</p><p>随着基因组学和表观基因组学的发展，基因组学研究的维度经历了从一维到三维的转变：</p><ul><li><strong>一维：</strong>基因组序列的测定与组装</li><li><strong>二维：</strong>调控序列&#x2F;转录因子—基因互作网络、染色质状态、表观修饰</li><li><strong>三维：</strong>基因组的三维空间结构</li></ul><p><img src="https://www.shelven.com/tuchuang/20230614/2.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>基因组不是简单的线性序列，是有三维空间结构的，而且这种三维空间结构可以对DNA辅助、基因转录调控、染色质浓缩分离等生物学过程产生重要的影响。</p><p>我们知道，真核生物的染色质结构由低级到高级可以分为4种：</p><ul><li><p><strong>一级结构：</strong>一系列核小体相互连接成的<strong>念珠状结构</strong></p></li><li><p><strong>二级结构：</strong>由核小体连接起来的纤维状结构经螺旋化形成中空的<strong>螺线管</strong></p></li><li><p><strong>三级结构：</strong>由螺线管螺旋化形成的筒状结构，称为<strong>超螺线管</strong></p></li><li><p><strong>四级结构：</strong>超螺线管进一步螺旋折叠形成<strong>染色单体</strong></p></li></ul><p><img src="https://www.shelven.com/tuchuang/20230614/1.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>三维基因组的层级结构类似于真核生物的染色质结构，在不同的分辨率下也可以划分为4个层级结构：</p><ul><li><p><strong>染色质环（Chromatin loops），分辨率：&lt;1 Kb - few Mb</strong>：染色质在空间中形成的环状结构，使相距很远的染色质区域在三维空间中可以聚集在一起。</p></li><li><p><strong>拓扑关联结构域（Topologically associating Domains, TAD），分辨率：40 Kb - 3 Mb</strong>：相互作用相对频繁的染色质区域。</p></li><li><p><strong>染色质区室（A&#x2F;B compartments），分辨率：1 - 100 Mb</strong>：A compartments：<strong>开放的染色质</strong>、表达活跃、基因丰富、较高的GC含量、激活型的组蛋白标记，通常位于细胞核内部；B compartments：<strong>关闭的染色质</strong>、表达不活跃、基因缺乏、结构紧凑、沉默基因的组蛋白标记，通常位于细胞核外围。</p></li><li><p><strong>染色质疆域（Chromosome Territory, CT），分辨率：~100 Mb</strong>：在真核生物中，细胞核内染色质分布并不是随机的，为了跨越较大距离实现相互作用，这些染色质会在三维空间中靠的更近，这就是染色质疆域。</p></li></ul><p><img src="https://www.shelven.com/tuchuang/20230614/3.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/3.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>不同层次分辨率下的研究重点不同，比如最小的loop层次对应的是基因级别甚至更小的元件互作；10kb级别一般就可以鉴定TAD之间的互作关系（也是研究比较多的）；更大一些的染色质区室也是研究比较多的内容；在染色质疆域这个层次主要就是研究染色体之间的互作关系了。相应的，分辨率越高，需要的有效互作数据量也越大。</p></div><h2 id="2-三维基因组技术"><a href="#2-三维基因组技术" class="headerlink" title="2. 三维基因组技术"></a>2. 三维基因组技术</h2><div class="story post-story"><p>目前三维基因组结构的检测时基于染色体构象捕获技术，也就是<strong>3C（chromosome conformation capture）技术</strong>，3C是所有染色体构象捕获技术的基础。根据染色质的互作类型，3C技术又可以大致分为5种方法：</p><ul><li><strong>1 versus 1</strong>：3C的由来，经过酶切、DNA片段绑定、反向交联后，通过qPCR确认互作位点。</li><li><strong>1 versus Many&#x2F;All</strong>：4C技术，3C技术的升级版。反向交联前和3C一样，经过了第二轮消化和绑定，通过特定位点的反向PCR检测特定位点与全基因组潜在位点互作情况。</li><li><strong>Many versus Many</strong>：5C技术，基于3C的另一升级版。5C技术的通量增大。</li><li><strong>Many versus All</strong>：Capture-C技术，最大不同是在互作片段对的捕捉技术上，它是利用<strong>生物素标记</strong>反向互补到限制酶酶切位点，从而进行对所有感兴趣的互作位点和全基因组位点之间互作对之间的捕捉。 </li><li><strong>All</strong> <strong>versus All</strong></li></ul><p>其中“1”“Many”以及“All”代表的是在一次实验中所涉及的位点，比如说 “1 versus All” 的意义就是该次实验调查的是一个位点和全基因组中所有可能潜在互作位点之间的互作情况。</p><blockquote><p>近年来all versus All也就是检测全局的互作技术发展比较快，有以下一些技术应用：</p><ol><li>Hi-C技术。近年最火的全基因组 3D 基因组测序技术，不仅可以用于检测全基因组的三维基因组结构和染色质互作，同时还可以用于辅助基因组组装（同样用的很多，现在组参考基因组都要测HiC，以组装到染色体水平）等。</li><li>ChIA-PET技术（ chromatin interaction analysis paired-end tag sequencing）：与3C基础上发展的其他技术不同，区别在于第一步对于互作位点的 DNA 破碎不是通过限制酶进行消化，而是利用超声波击碎。然后应用抗体对特定蛋白参与的互作区段进行富集，并对这些互作区段进行消化连接，提取含有接头的双端序列（ paired end tag， PET）进行互作检测。</li><li>DLO Hi-C技术（ digestion-ligation-only Hi-C）：该技术相对于传统的全基因组染色体构象捕获技术 Hi-C 而言更加高效简单，仅需要两轮的消化连接过程，无须生物素标记，未连接的 DNA 也可以被有效地去除，极大地提高了染色体构想捕获效率。 DLO Hi-C 技术更像是 Hi-C 技术的一个升级优化。 </li><li>原位Hi-C (<em>in situ</em> Hi-C)：使用完整的细胞核进行后续反应，减少了Hi-C中随机连接造成的背景噪音。使用四碱基酶Mbol进行酶切，提高了分辨率，实验时间由Hi-C的7天缩短至3天。</li><li>HiChIP (<em>in situ</em> Hi-C followed by chromatin immunoprecipitation)：该技术是一种利用原位Hi-C原理和转座酶介导构建文库来解析染色质构象的方法。</li></ol></blockquote><img src="https://www.shelven.com/tuchuang/20230614/4.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /></div><h2 id="3-利用Hi-C数据分析拓扑关联结构域（TAD）"><a href="#3-利用Hi-C数据分析拓扑关联结构域（TAD）" class="headerlink" title="3. 利用Hi-C数据分析拓扑关联结构域（TAD）"></a>3. 利用Hi-C数据分析拓扑关联结构域（TAD）</h2><div class="story post-story"><p>现在Hi-C测序是应用最广泛的三维基因组学技术，对Hi-C数据的处理，构建Hi-C互作图谱和鉴定TAD结构域是最关键的问题，也发展了一大批专门的生物信息学算法软件，我这里用经典的软件<code>HiC-Pro</code>、<code>HiCPlotter</code>和<code>R包HiTC</code>跑一遍Hi-C数据分析的流程。</p><p>为了快速得到结果，这里选择了<strong>Gossypium hirsutum</strong>四倍体陆地棉的两条染色体参考序列，和一部分Hi-C测序结果（50万条reads的双端测序结果）跑下流程。后续制作Hi-C互作矩阵，和分析Compartment和TAD的<code>.bed</code>后缀文件和<code>.matrix</code>后缀文件来自尤师姐（前面的这点数据做不出互作图，太少了，跑完所有数据又很慢……）。</p><p>两个软件安装过程就不说了，可以参考github官方，如果HiC-Pro很难安装依赖的话可以用官方提供的singularity镜像：</p><p><a href="https://github.com/nservant/HiC-Pro/tree/master">nservant&#x2F;HiC-Pro: HiC-Pro: An optimized and flexible pipeline for Hi-C data processing (github.com)</a></p><p>当前路径文件结构如下：</p><p><img src="https://www.shelven.com/tuchuang/20230614/5.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="3-1-获得染色质互作矩阵（HiC-Pro）"><a href="#3-1-获得染色质互作矩阵（HiC-Pro）" class="headerlink" title="3.1 获得染色质互作矩阵（HiC-Pro）"></a>3.1 获得染色质互作矩阵（HiC-Pro）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 1.准备酶切片段</span><br><span class="line">## dpnii是选择的限制性核酸内切酶，可以用别的，查看digest_genome.py源码</span><br><span class="line">python digest_genome.py Gh_genome.fa –r dpnii –o Gh_dpnii.bed</span><br><span class="line"># 2.统计酶切片段大小</span><br><span class="line">awk ’&#123;print $3-$2;&#125;’ Gh_dpnii.bed &gt; Gh_dpnii_size.txt</span><br><span class="line"># 3.构建参考基因组索引，生成基因组大小的文件</span><br><span class="line">samtools faidx Gh_genome.fa</span><br><span class="line">awk ‘&#123;print $1”\t”$2;&#125;’ Gh_genome.fa.fai &gt; Gh_size.txt</span><br></pre></td></tr></table></figure><p>这里酶切参考基因组生成的bed文件如下所示：</p><img src="https://www.shelven.com/tuchuang/20230614/6.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># 4.修改config文件</span><br><span class="line">## 主要修改基因组索引文件路径、基因组大小文件路径、酶切片段文件路径和分辨率</span><br><span class="line">## BOWTIE2_IDX_PATH、GENOME_SIZE、GENOME_FRAGMENT、BIN_SIZE</span><br><span class="line"></span><br><span class="line">vim config.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#######################################################################</span><br><span class="line">## Alignment options</span><br><span class="line">#######################################################################</span><br><span class="line"></span><br><span class="line">FORMAT = phred33</span><br><span class="line">MIN_MAPQ = 0</span><br><span class="line"></span><br><span class="line">BOWTIE2_IDX_PATH = /home/Bioinfor/Gh_index</span><br><span class="line">BOWTIE2_GLOBAL_OPTIONS = --very-sensitive -L 30 --score-min L,-0.6,-0.2 --end-to-end --reorder</span><br><span class="line">BOWTIE2_LOCAL_OPTIONS =  --very-sensitive -L 20 --score-min L,-0.6,-0.2 --end-to-end --reorder</span><br><span class="line"></span><br><span class="line">#######################################################################</span><br><span class="line">## Annotation files</span><br><span class="line">#######################################################################</span><br><span class="line"></span><br><span class="line">REFERENCE_GENOME = Gh</span><br><span class="line">GENOME_SIZE = /home/Bioinfor/Gh_size.txt</span><br><span class="line"></span><br><span class="line">#######################################################################</span><br><span class="line">## Digestion Hi-C</span><br><span class="line">#######################################################################</span><br><span class="line"></span><br><span class="line">GENOME_FRAGMENT = /home/Bioinfor/Gh_dpnii.bed</span><br><span class="line">LIGATION_SITE = AAGCTAGCTT</span><br><span class="line">MIN_FRAG_SIZE = 100</span><br><span class="line">MAX_FRAG_SIZE = 160000</span><br><span class="line">MIN_INSERT_SIZE = 200</span><br><span class="line">MAX_INSERT_SIZE = 600</span><br><span class="line"></span><br><span class="line">#######################################################################</span><br><span class="line">## Contact Maps</span><br><span class="line">#######################################################################</span><br><span class="line"></span><br><span class="line">BIN_SIZE = 5000 20000 100000</span><br><span class="line">MATRIX_FORMAT = upper</span><br></pre></td></tr></table></figure><p>主要是修改以上内容，但也要注意下Hi-C双端测序文件的后缀，要让软件能匹配上。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 5.运行HiC-Pro，获得染色质互作矩阵</span><br><span class="line">HiC-Pro -c config.txt -i Gh/ -o HiC_Pro_out</span><br></pre></td></tr></table></figure><p>HiC-Pro的主要结果放置在目录HiC_Pro_out&#x2F; hic_results&#x2F;matrix&#x2F;Gh&#x2F;下，为5000、20000、100000 分辨率下的<code>_abs.bed</code> 以及<code>_iced.matrix</code>后缀文件。其他结果文件和分析图片可以在hic_results文件夹里查看，这里不展示了。</p><p>主要展示后续用的文件，以下为Gh_5000_abs.bed文件：</p><img src="https://www.shelven.com/tuchuang/20230614/7.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>这个文件将染色体划分为5000 bp的bin，并且在第四列进行编号。</p><p>以下为Gh_5000_iced.matrix文件：</p><img src="https://www.shelven.com/tuchuang/20230614/8.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>这个文件第一列和第二列都是bin编号，第三列为两个bin之间归一化之后的互作强度。</p><h3 id="3-2-绘制染色质互作图（HiCPlotter）"><a href="#3-2-绘制染色质互作图（HiCPlotter）" class="headerlink" title="3.2 绘制染色质互作图（HiCPlotter）"></a>3.2 绘制染色质互作图（HiCPlotter）</h3><p>这里使用的是尤师姐提供的跑完了A01染色体的<code>Gh_20000_iced.matrix</code>与<code>Gh_20000_abs.bed</code>文件（我的示例Hi-C数据量太少）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># HiCPlotter绘制染色体互作图</span><br><span class="line">python HiCPlotter.py -f Gh_20000_iced.matrix -o Ghir_A01 -r 20000 -tri 1 -bed Gh_20000_abs.bed -n Ghir_A01 -chr Ghir_A01</span><br><span class="line">## HiCPlotter绘制染色质互作几个常用参数：</span><br><span class="line">-chr 染色体名称，如果染色体名称不是Chr*，-chr参数需传入对应的值</span><br><span class="line">-o 输出文件名</span><br><span class="line">-tri 默认值为0，1代表着传入的matrix和bed文件是HiC-Pro运行的结果</span><br><span class="line">-r 分辨率</span><br><span class="line">-n 任务名</span><br><span class="line"></span><br><span class="line"># ZModem协议传输文件</span><br><span class="line">sz Ghir_A01-Ghir_A01.ofBins\(0-5887\).20K.png</span><br></pre></td></tr></table></figure><p>染色体Ghir_A01内部的互作图<code>Ghir_A01-Ghir_A01.ofBins(0-5887).20K.png</code>如下所示。</p><img src="https://www.shelven.com/tuchuang/20230614/Ghir_A01-Ghir_A01.ofBins(0-5887).20K.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/Ghir_A01-Ghir_A01.ofBins(0-5887).20K.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 50%;" /><h3 id="3-3-鉴定TAD（HiCPlotter）"><a href="#3-3-鉴定TAD（HiCPlotter）" class="headerlink" title="3.3 鉴定TAD（HiCPlotter）"></a>3.3 鉴定TAD（HiCPlotter）</h3><p>这里使用的数据与3.2一样。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># HiCPlotter鉴定TAD</span><br><span class="line">python HiCPlotter.py -f Gh_20000_iced.matrix –bed Gh_20000_abs.bed –o TAD -r 20000 -n Ghir_A01 -chr Ghir_A01 -tri 1 -fh 0 -s 600 -e 900 -ptd 1 -pi 1</span><br><span class="line">## HiCPlotter绘制TAD几个常用参数：</span><br><span class="line">-ptd 默认0，输入1，调用绘制TAD算法</span><br><span class="line">-fh 输入文件中抬头需要删除的行数，没有header lines就是0</span><br><span class="line">-s 起始位点（第几个bin）</span><br><span class="line">-e 结束位点（第几个bin）</span><br><span class="line"></span><br><span class="line"># ZModem协议传输文件</span><br><span class="line">sz TAD-Ghir_A01.ofBins\(600-900\).20K.png</span><br></pre></td></tr></table></figure><p>染色体Ghir_A01的12Mb到18Mb之间TAD鉴定结果图<code>TAD-Ghir_A01.ofBins(600-900).20K.png</code>如下：</p><img src="https://www.shelven.com/tuchuang/20230614/TAD-Ghir_A01.ofBins(600-900).20K.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/TAD-Ghir_A01.ofBins(600-900).20K.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom: 50%;" /><h3 id="3-4-鉴定染色质区室和TAD（HiTC包）"><a href="#3-4-鉴定染色质区室和TAD（HiTC包）" class="headerlink" title="3.4 鉴定染色质区室和TAD（HiTC包）"></a>3.4 鉴定染色质区室和TAD（HiTC包）</h3><p>这里使用的数据来自尤师姐提供的<code>LG02_50000_abs.bed</code>与<code>LG02_50000_iced.matrix</code>文件，也是HiC-Pro跑出来的结果文件。</p><p>因为用到了R包，集群R有点问题，我暂时传到本地用自己电脑跑了下：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载和加载HiTC包</span></span><br><span class="line"><span class="operator">&gt;</span> BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;HiTC&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> setwd<span class="punctuation">(</span><span class="string">&quot;D:/zhuomian/D5_50Kb/D5_50Kb&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> library<span class="punctuation">(</span>HiTC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入数据（importC函数读取HiC-pro的结果）</span></span><br><span class="line"><span class="operator">&gt;</span> mydata <span class="operator">&lt;-</span> importC<span class="punctuation">(</span><span class="string">&quot;D:/zhuomian/D5_50Kb/D5_50Kb/LG02_50000_iced.matrix&quot;</span><span class="punctuation">,</span> xgi.bed <span class="operator">=</span> <span class="string">&quot;D:/zhuomian/D5_50Kb/D5_50Kb/LG02_50000_abs.bed&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主成分分析和鉴定Compartment</span></span><br><span class="line"><span class="operator">&gt;</span> pc <span class="operator">&lt;-</span> pca.hic<span class="punctuation">(</span>mydata<span class="operator">$</span>LG02LG02<span class="punctuation">,</span> npc <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> asGRangesList <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> write.csv<span class="punctuation">(</span>pc<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;D:/zhuomian/D5_50Kb/D5_50Kb/LG02_50k.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> mydata2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;D:/zhuomian/D5_50Kb/D5_50Kb/LG03_50k.csv&quot;</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;,&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> barplot<span class="punctuation">(</span>mydata2<span class="operator">$</span>score<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 热图展示</span></span><br><span class="line"><span class="operator">&gt;</span> mapC<span class="punctuation">(</span>mydata<span class="operator">$</span>LG02LG02<span class="punctuation">,</span> trim.range <span class="operator">=</span> <span class="number">0.94</span><span class="punctuation">,</span> col.pos <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>这里主成分分析得到的LG02_50k.csv，统计第一主成分score做条形图就可以鉴定染色质区室Compartment A&#x2F;B了，以下链接是提出者的文章。</p><p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2858594/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2858594/</a></p><img src="https://www.shelven.com/tuchuang/20230614/11.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>跑出来的互作热图如下：</p><img src="https://www.shelven.com/tuchuang/20230614/9.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>也可以选取染色体的一部分（一般是自己感兴趣的部分），做热图：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> data1 <span class="operator">&lt;-</span> extractRegion<span class="punctuation">(</span>mydata<span class="operator">$</span>LG02LG02<span class="punctuation">,</span>chr <span class="operator">=</span> <span class="string">&quot;LG02&quot;</span><span class="punctuation">,</span> from <span class="operator">=</span> <span class="number">1000</span><span class="punctuation">,</span> to <span class="operator">=</span> <span class="number">5000000</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> mapC<span class="punctuation">(</span>data1<span class="punctuation">,</span> trim.range <span class="operator">=</span> <span class="number">0.94</span><span class="punctuation">,</span>col.pos <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><img src="https://www.shelven.com/tuchuang/20230614/10.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230614/10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>关于如何用HiTC包分析Hi-C数据，也可以看bioconductor的一篇文章：</p><p><a href="https://bioconductor.org/packages/release/bioc/vignettes/HiTC/inst/doc/HiC_analysis.pdf">Analyzing Hi-C data with the HiTC BioC package (bioconductor.org)</a></p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;本篇笔记主要记录三维基因组学的学习，以及演示如何利用Hi-C数据分析Compartment和拓扑关联结构域（TAD），所使用的分析Hi-C数据的软件为HiC-Pro，可视化软件为HiCPlotter和R包HiTC。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="三维基因组学" scheme="http://www.shelven.com/categories/%E4%B8%89%E7%BB%B4%E5%9F%BA%E5%9B%A0%E7%BB%84%E5%AD%A6/"/>
    
    
    <category term="HiC-Pro" scheme="http://www.shelven.com/tags/HiC-Pro/"/>
    
    <category term="HiCPlotter" scheme="http://www.shelven.com/tags/HiCPlotter/"/>
    
    <category term="HiTC" scheme="http://www.shelven.com/tags/HiTC/"/>
    
  </entry>
  
  <entry>
    <title>单细胞转录组分析</title>
    <link href="http://www.shelven.com/2023/06/13/a.html"/>
    <id>http://www.shelven.com/2023/06/13/a.html</id>
    <published>2023-06-13T14:06:51.000Z</published>
    <updated>2023-06-16T08:50:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近因为学校网络信息中心升级防火墙，导致集群无法访问公网，我搭建的反向代理服务器也暂时无法使用（真的想吐槽学校的网络管理员，三个星期了还没能解决集群的网络问题）……近期要进行中期答辩，先用向日葵远程一下实验室闲置的电脑应急，顺便把最近的学习笔记补上。</p><p>这篇笔记主要记录下单细胞组学的学习，以及单细胞转录组（Single-cell RNA-sequencing，scRNA-seq）的分析流程。</p><span id="more"></span><h2 id="1-单细胞测序发展"><a href="#1-单细胞测序发展" class="headerlink" title="1. 单细胞测序发展"></a>1. 单细胞测序发展</h2><div class="story post-story"><p>我们做植物高通量测序做的最多的是RNA-seq，比较不同组织、不同时期或者不同处理下同一个组织基因的差异表达。我们做RNA-seq是建立在对一个<strong>组织</strong>的细胞进行测序的基础上，<strong>而组织是几类细胞的集合，因此我们得到的基因表达量是所有细胞的平均值。</strong></p><p>单细胞测序可以在单个细胞的水平上构建细胞图谱，让我们更深入了解植物组织的细胞类型，获取每个细胞的转录本信息，研究细胞的发育动态（比如细胞如何进行分化）等等。</p><p>Nature杂志每年都会总结每个领域最有价值的年度技术，<strong>2018年是单细胞转录组技术，2019年是单细胞多组学技术，2020年是空间转录组技术</strong>，可以看出带有单细胞和空间分辨率转录组技术应用的重要性。</p><img src="https://www.shelven.com/tuchuang/20230613/1.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>上图是单细胞技术在植物中的研究历程，最后一个2022年的<strong>Stereo-seq</strong>也就是华大自研的<strong>时空组学技术</strong>，据华大发表在cell上的文章<a href="https://www.sciencedirect.com/science/article/pii/S0092867422003993">Spatiotemporal transcriptomic atlas of mouse organogenesis using DNA nanoball-patterned arrays</a>描述，Stereo-seq的技术参数优于当前其他空间转录组技术，对空间异质性的描述更为灵敏和直观。</p><p>对于Stereo-seq我个人的理解是补上了部分空间转录组测序无法做到单个细胞分辨率的短板，真正做到对动植物的组织或者器官中的所有细胞进行转录组信息分析，鉴定不同类型细胞的差异基因表达，构建空间图谱来分辨不同细胞的发育轨迹。感兴趣可以看下面华大的这篇scStereo-seq技术用于拟南芥的文章：<a href="https://www.sciencedirect.com/science/article/pii/S1534580722002519">The single-cell stereo-seq reveals region-specific cell subtypes and transcriptome profiling in Arabidopsis leaves - ScienceDirect</a></p></div><h2 id="2-单细胞测序平台"><a href="#2-单细胞测序平台" class="headerlink" title="2. 单细胞测序平台"></a>2. 单细胞测序平台</h2><div class="story post-story"><ul><li><p><strong>10x Genomics Chromium</strong>  微流控芯片技术获得单细胞反应体系，并在传统文库构建的基础上引入标签，通过追溯标签序列将众多mRNA、表面蛋白信息定位回原来的单个细胞。捕获效率最高达65%</p></li><li><p><strong>BD</strong> <strong>Rhapsody™ Single-Cell Analysis System</strong>  能为单细胞中每个转录本标记特异性分子标签，实现单细胞水平上基因表达谱的绝对定量。捕获效率最高达80%</p></li><li><p><strong>Illumina® Bio-Rad® Single-Cell Sequencing</strong> <strong>Solution</strong>  捕获效率低，仅为3%，但测序成本相对较低</p></li><li><p><strong>ICELL8</strong> <strong>Single-Cell</strong> <strong>System</strong>  捕获效率为30%，成本相对较低</p></li><li><p><strong>C1™</strong> <strong>单细胞全自动制备系统</strong>  通量低、成本高、周期慢、对试验人员要求高，操作较繁琐和困难</p></li></ul></div><h2 id="3-单细胞测序分析流程"><a href="#3-单细胞测序分析流程" class="headerlink" title="3. 单细胞测序分析流程"></a>3. 单细胞测序分析流程</h2><div class="story post-story"><img src="https://www.shelven.com/tuchuang/20230613/2.jpg" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:80%;" /><p>质控部分和RNA-seq没有区别，去掉低质量的读序和测序接头。10X Genomics平台测的单细胞数据需要通过Cell Ranger回比到参考基因组，示例用法如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> cellranger count --id=sample345</span><br><span class="line">    --transcriptome=/opt/refdata-cellranger-GRCh38-3.0.0</span><br><span class="line">    --fastqs=/home/jdoe/runs/HAWT7ADXX/outs/fastq_path</span><br><span class="line">    --sample=mysample</span><br><span class="line"># --id  文件名</span><br><span class="line"># --transcriptome 参考基因组</span><br><span class="line"># --fastqs 转录组数据所在的路径</span><br><span class="line"># --sample 指定要使用的样本</span><br></pre></td></tr></table></figure><p>这里主要记录下细胞过滤到亚群定义和标记基因筛选所要用到的软件Seurat4。因为我自己没有这方面的实验数据，仅仅只是尝试跑下流程，以下分析流程和代码来自：</p><p><a href="https://zhuanlan.zhihu.com/p/359020041">单细胞转录组|Seurat 4.0 使用指南 - 知乎 (zhihu.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/465392721">《Seurat 4 R包源码解析》 总目录 | 单细胞转录组分析标准流程 - 知乎 (zhihu.com)</a></p><p>示例数据来自10X Genomics免费提供的外周血单核细胞(PBMC)数据集：<br><a href="https://cf.10xgenomics.com/samples/cell/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz">https://cf.10xgenomics.com/samples/cell/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz</a></p><p>将示例数据上传至集群，解压，得到如下文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">├── barcodes.tsv（10X Genomics测序的与细胞相关的barcode信息，用于标识细胞）</span><br><span class="line">├── genes.tsv（基因信息，包括了基因组数据库人类登记号和基因名称）</span><br><span class="line">└── matrix.mtx（基因表达量矩阵）</span><br></pre></td></tr></table></figure><ul><li>这三个文件实际上要通过软件<code>Cell Ranger</code>对10X Genomics单细胞测序的下机数据进行比对基因组，统计捕获的细胞数、测序量得到。详细可以参考官方Cell Ranger软件的用法和结果分析，这里用的是官方整理后的数据，只进行下一步Seurat分析的演示。</li></ul><p>以所在目录为工作目录，在linux中键入R进入交互命令行，运行Seurat。</p><h3 id="3-1-导入数据和初步过滤"><a href="#3-1-导入数据和初步过滤" class="headerlink" title="3.1 导入数据和初步过滤"></a>3.1 导入数据和初步过滤</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装和加载Seurat和dplyr（用于数据清洗）R包</span></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;Seurat&quot;</span><span class="punctuation">)</span> </span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;dplyr&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读入数据并初步筛选</span></span><br><span class="line">pbmc.data <span class="operator">&lt;-</span> Read10X<span class="punctuation">(</span>data.dir<span class="operator">=</span><span class="string">&quot;/path/to/yourfile&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Seurat对象，过滤检测少于200个基因的细胞，和少于3个细胞检测出的基因</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> CreateSeuratObject<span class="punctuation">(</span>counts <span class="operator">=</span> pbmc.data<span class="punctuation">,</span> project <span class="operator">=</span> <span class="string">&quot;pbmc3k&quot;</span><span class="punctuation">,</span> min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line">pbmc</span><br></pre></td></tr></table></figure><img src="https://www.shelven.com/tuchuang/20230613/1.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:150%;" /><p>可以看到初步过滤后，现在的一个数据集包含了2700个细胞的13714个基因。</p><h3 id="3-2-细胞过滤"><a href="#3-2-细胞过滤" class="headerlink" title="3.2 细胞过滤"></a>3.2 细胞过滤</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增一列percent.mt用于统计映射到线粒体基因组的reads百分比</span></span><br><span class="line">pbmc<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^MT-&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制细胞的三种特征，nFeature_RNA（每个细胞测到的特异基因数目）、nCount_RNA（每个细胞测到所有基因的表达量之和）、percent.mt的小提琴图</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;fig01_cell_feature.png&quot;</span><span class="punctuation">)</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 细胞特征间的相关性绘图</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;fig02_cell_feature_correlation.png&quot;</span><span class="punctuation">,</span> width<span class="operator">=</span><span class="number">1000</span><span class="punctuation">,</span> height<span class="operator">=</span><span class="number">400</span><span class="punctuation">)</span>  </span><br><span class="line">plot1 <span class="operator">&lt;-</span> FeatureScatter<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> feature1 <span class="operator">=</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> feature2 <span class="operator">=</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span></span><br><span class="line">plot2 <span class="operator">&lt;-</span> FeatureScatter<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> feature1 <span class="operator">=</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> feature2 <span class="operator">=</span> <span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">)</span></span><br><span class="line">CombinePlots<span class="punctuation">(</span>plots <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>plot1<span class="punctuation">,</span> plot2<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据特殊基因的数目以及线粒体基因比例过滤细胞，这里选取200 &lt; nFeature_RNA &lt; 2500 和percent.mt &lt; 5的数据</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">200</span> <span class="operator">&amp;</span> nFeature_RNA <span class="operator">&lt;</span> <span class="number">2500</span> <span class="operator">&amp;</span> percent.mt <span class="operator">&lt;</span> <span class="number">5</span><span class="punctuation">)</span> </span><br><span class="line">pbmc</span><br></pre></td></tr></table></figure><p>fig01_cell_feature.png如下所示：</p><p><img src="https://www.shelven.com/tuchuang/20230613/fig01_cell_feature.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/fig01_cell_feature.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这里可以看到有的细胞检测到的特异基因数特别多，可能是因为多个细胞被同时捕获了，而特异基因数特别少的可能是低质量细胞。而线粒体基因比例特别高的细胞，有可能是一些快要死亡的细胞。这些低质量的细胞需要在这一步被过滤。</p><p>fig02_cell_feature_correlation.png如下所示：</p><p><img src="https://www.shelven.com/tuchuang/20230613/fig02_cell_feature_correlation.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/fig02_cell_feature_correlation.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这两个图分别表示了每个细胞测到所有基因的表达量之和与线粒体基因组百分比呈负相关，每个细胞测到所有基因的表达量之和与每个细胞测到的特异基因数目呈正相关。</p><img src="https://www.shelven.com/tuchuang/20230613/2.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:150%;" /><p>这一步过滤后数据集剩下2638个细胞，共13714个基因。</p><h3 id="3-3-细胞群体聚类"><a href="#3-3-细胞群体聚类" class="headerlink" title="3.3 细胞群体聚类"></a>3.3 细胞群体聚类</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 表达水平标准化</span></span><br><span class="line"><span class="comment">## normalization.method  标准化方法，默认为“LogNormalize”</span></span><br><span class="line"><span class="comment">## scale.factor  比例因子，用以计算标准化值，默认为“10000”</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> normalization.method <span class="operator">=</span> <span class="string">&quot;LogNormalize&quot;</span><span class="punctuation">,</span> scale.factor <span class="operator">=</span> <span class="number">10000</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 鉴定mark基因（也就是特征基因）</span></span><br><span class="line"><span class="comment">## selection.method  mark基因筛选方法，“vst”为通过方差与均值比进行筛选</span></span><br><span class="line"><span class="comment">## nfeatures  要筛选的mark基因的数目</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> FindVariableFeatures<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> selection.method <span class="operator">=</span> <span class="string">&quot;vst&quot;</span><span class="punctuation">,</span> nfeatures <span class="operator">=</span> <span class="number">2000</span><span class="punctuation">)</span></span><br><span class="line">top10 <span class="operator">&lt;-</span> head<span class="punctuation">(</span>VariableFeatures<span class="punctuation">(</span>pbmc<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示mark基因</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;fig03_10marker_genes.png&quot;</span><span class="punctuation">,</span>width<span class="operator">=</span><span class="number">1000</span><span class="punctuation">,</span>height<span class="operator">=</span><span class="number">400</span><span class="punctuation">)</span></span><br><span class="line">plot1 <span class="operator">&lt;-</span> VariableFeaturePlot<span class="punctuation">(</span>pbmc<span class="punctuation">)</span></span><br><span class="line">plot2 <span class="operator">&lt;-</span> LabelPoints<span class="punctuation">(</span>plot <span class="operator">=</span> plot1<span class="punctuation">,</span> points <span class="operator">=</span> top10<span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">CombinePlots<span class="punctuation">(</span>plots <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>plot1<span class="punctuation">,</span> plot2<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>fig03_10marker_genes.png如下所示：</p><p><img src="https://www.shelven.com/tuchuang/20230613/fig03_10marker_genes.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/fig03_10marker_genes.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这里筛选出2000个mark基因用于后续的下游分析，并且展示区分能力最强的前10个mark基因</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mark基因权重标准化</span></span><br><span class="line"><span class="comment">## ScaleData 缩放基因的表达，给予基因同等的权重，使高表达基因不占据主导地位</span></span><br><span class="line">all.genes <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>pbmc<span class="punctuation">)</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> ScaleData<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> features <span class="operator">=</span> all.genes<span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># PCA主成分分析</span></span><br><span class="line"><span class="comment">## RunPCA 计算特征值，在细胞间具有高度表达差异的基因有助于区分不同类型的细胞</span></span><br><span class="line"><span class="comment">## 采用DimPlot方法可视化</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> RunPCA<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> features <span class="operator">=</span> VariableFeatures<span class="punctuation">(</span>object <span class="operator">=</span> pbmc<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;fig04_PCA.png&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>fig04_PCA.png如下所示：</p><p><img src="https://www.shelven.com/tuchuang/20230613/fig04_PCA.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/fig04_PCA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 评估主成分维度</span></span><br><span class="line"><span class="comment">## num.replicate  重采样次数</span></span><br><span class="line"><span class="comment">## dims  维度范围</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> JackStraw<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> num.replicate <span class="operator">=</span> <span class="number">100</span><span class="punctuation">)</span>  </span><br><span class="line">pbmc <span class="operator">&lt;-</span> ScoreJackStraw<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 评估主成分维度的方法1</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;fig05_PC_importance_01.png&quot;</span><span class="punctuation">,</span>width<span class="operator">=</span><span class="number">700</span><span class="punctuation">,</span>height<span class="operator">=</span><span class="number">400</span><span class="punctuation">)</span></span><br><span class="line">JackStrawPlot<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 评估主成分维度的方法2</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;fig05_PC_importance_02.png&quot;</span><span class="punctuation">,</span>width<span class="operator">=</span><span class="number">700</span><span class="punctuation">,</span>height<span class="operator">=</span><span class="number">400</span><span class="punctuation">)</span></span><br><span class="line">ElbowPlot<span class="punctuation">(</span>pbmc<span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>R包 Seurat 函数 <code>JackStraw</code> 、<code>ScoreJackStraw</code>进行重采样测试，评估用以进行细胞聚类的主成分维度。</p><p>fig05_PC_importance_01.png如下所示：</p><p><img src="https://www.shelven.com/tuchuang/20230613/fig05_PC_importance_01.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/fig05_PC_importance_01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>fig05_PC_importance_02.png如下所示：</p><p><img src="https://www.shelven.com/tuchuang/20230613/fig05_PC_importance_02.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/fig05_PC_importance_02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>上图是比较不同主成分（PC）的P值分布与均匀分布（虚线）；显著的主成分具有较低的P值（位于虚线上方）；似乎<strong>10-12</strong>个主成分后，主成分的重要性急剧下降。</p><p>下图是肘部法则以确定最佳主成分数量，9-10个主成分附近有个拐点，表明大部分真实信号是在前10个pc中捕获的。</p><p>所以这里选择<strong>10个主成分</strong>用于后续分析。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 细胞群体聚簇</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span> </span><br><span class="line">pbmc <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment">## 绘图</span></span><br><span class="line">pbmc <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span> </span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;fig06_cluster_UMAP.png&quot;</span><span class="punctuation">,</span>width<span class="operator">=</span><span class="number">700</span><span class="punctuation">,</span>height<span class="operator">=</span><span class="number">400</span><span class="punctuation">)</span> </span><br><span class="line">DimPlot<span class="punctuation">(</span>pbmc<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>fig06_cluster_UMAP.png如下所示</p><p><img src="https://www.shelven.com/tuchuang/20230613/fig06_cluster_UMAP.png" class="lazyload" data-srcset="https://www.shelven.com/tuchuang/20230613/fig06_cluster_UMAP.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>可以看到，根据mark基因的表达，所有细胞最终被分为了8种类型。</p><p>做完以上分析之后，还可以根据自己的研究目标新型不同的下游分析，具体来说可以筛选亚群的标记基因（与其他类别细胞的差异表达基因）、进行细胞的发育轨迹分析、做不同品种间细胞类型的比较等等。</p></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近因为学校网络信息中心升级防火墙，导致集群无法访问公网，我搭建的反向代理服务器也暂时无法使用（真的想吐槽学校的网络管理员，三个星期了还没能解决集群的网络问题）……近期要进行中期答辩，先用向日葵远程一下实验室闲置的电脑应急，顺便把最近的学习笔记补上。&lt;/p&gt;
&lt;p&gt;这篇笔记主要记录下单细胞组学的学习，以及单细胞转录组（Single-cell RNA-sequencing，scRNA-seq）的分析流程。&lt;/p&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="http://www.shelven.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="单细胞转录组" scheme="http://www.shelven.com/categories/%E5%8D%95%E7%BB%86%E8%83%9E%E8%BD%AC%E5%BD%95%E7%BB%84/"/>
    
    
    <category term="Seurat" scheme="http://www.shelven.com/tags/Seurat/"/>
    
  </entry>
  
</feed>
